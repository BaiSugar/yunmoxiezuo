# 系统配置管理 API

## 概述

系统配置管理提供全局配置参数的读取和更新功能。

**基础路径**: `/api/v1/system-settings`

---

## 1. 获取所有配置

### 接口信息

- **路径**: `GET /system-settings`
- **权限**: `system-settings:read`
- **描述**: 获取所有系统配置项

### 响应示例

```json
[
  {
    "id": 1,
    "category": "email",
    "key": "smtp_host",
    "value": "smtp.gmail.com",
    "type": "string",
    "label": "SMTP服务器地址",
    "description": "邮件发送服务器地址",
    "isEncrypted": false,
    "isPublic": false,
    "sortOrder": 1,
    "createdAt": "2024-01-30T10:00:00.000Z",
    "updatedAt": "2024-01-30T10:00:00.000Z"
  },
  {
    "id": 2,
    "category": "email",
    "key": "smtp_password",
    "value": "******",
    "type": "string",
    "label": "SMTP密码",
    "description": "邮件发送服务器密码",
    "isEncrypted": true,
    "isPublic": false,
    "sortOrder": 5,
    "createdAt": "2024-01-30T10:00:00.000Z",
    "updatedAt": "2024-01-30T10:00:00.000Z"
  }
]
```

---

## 2. 按分类获取配置

### 接口信息

- **路径**: `GET /system-settings/category/:category`
- **权限**: `system-settings:read`
- **描述**: 根据分类获取配置项

### URL 参数

| 参数     | 类型   | 必填 | 说明                          |
| -------- | ------ | ---- | ----------------------------- |
| category | string | 是   | 配置分类（如：email, system） |

### 响应示例

```json
[
  {
    "id": 1,
    "category": "email",
    "key": "smtp_host",
    "value": "smtp.gmail.com",
    "type": "string",
    "label": "SMTP服务器地址",
    "description": "邮件发送服务器地址",
    "isEncrypted": false,
    "isPublic": false,
    "sortOrder": 1,
    "createdAt": "2024-01-30T10:00:00.000Z",
    "updatedAt": "2024-01-30T10:00:00.000Z"
  }
]
```

---

## 3. 获取公开配置

### 接口信息

- **路径**: `GET /system-settings/public`
- **权限**: 公开接口（无需认证）
- **描述**: 获取标记为公开的配置项

### 响应示例

```json
{
  "system": {
    "site_name": "AI写作平台",
    "site_logo": "/logo.svg"
  },
  "email": {
    "verification_enabled": true
  }
}
```

---

## 4. 获取单个配置

### 接口信息

- **路径**: `GET /system-settings/:id`
- **权限**: `system-settings:read`
- **描述**: 根据 ID 获取单个配置项

### 响应示例

```json
{
  "id": 1,
  "category": "email",
  "key": "smtp_host",
  "value": "smtp.gmail.com",
  "type": "string",
  "label": "SMTP服务器地址",
  "description": "邮件发送服务器地址",
  "isEncrypted": false,
  "isPublic": false,
  "sortOrder": 1,
  "createdAt": "2024-01-30T10:00:00.000Z",
  "updatedAt": "2024-01-30T10:00:00.000Z"
}
```

---

## 5. 更新单个配置

### 接口信息

- **路径**: `PUT /system-settings/:id`
- **权限**: `system-settings:update`
- **描述**: 更新单个配置项的值

### 请求参数

```json
{
  "value": "smtp.qq.com"
}
```

### 响应示例

```json
{
  "id": 1,
  "category": "email",
  "key": "smtp_host",
  "value": "smtp.qq.com",
  "type": "string",
  "label": "SMTP服务器地址",
  "description": "邮件发送服务器地址",
  "isEncrypted": false,
  "isPublic": false,
  "sortOrder": 1,
  "createdAt": "2024-01-30T10:00:00.000Z",
  "updatedAt": "2024-01-30T11:00:00.000Z"
}
```

---

## 6. 上传页脚图片

### 接口信息

- **路径**: `POST /system-settings/upload/footer`
- **权限**: `system-settings:update`
- **描述**: 上传页脚图片（QQ群二维码、微信二维码等）
- **请求类型**: `multipart/form-data`

### 请求参数

| 参数 | 类型 | 必填 | 说明               |
| ---- | ---- | ---- | ------------------ |
| file | File | 是   | 图片文件           |

### 文件要求

- **格式**: JPG、JPEG、PNG、WebP
- **大小**: 最大 2MB
- **推荐尺寸**: 200x200 像素

### 响应示例

```json
{
  "success": true,
  "code": 200,
  "message": "上传成功",
  "data": {
    "url": "/uploads/footer/footer-1738244000000-123456789.png",
    "filename": "footer-1738244000000-123456789.png",
    "originalName": "qq-qrcode.png",
    "size": 45678,
    "mimeType": "image/png"
  },
  "timestamp": 1738244000000
}
```

---

## 7. 批量更新配置

### 接口信息

- **路径**: `PUT /system-settings/batch`
- **权限**: `system-settings:update-batch`
- **描述**: 批量更新多个配置项

### 请求参数

```json
{
  "settings": [
    {
      "id": 1,
      "value": "smtp.qq.com"
    },
    {
      "id": 2,
      "value": "587"
    }
  ]
}
```

### 响应示例

```json
[
  {
    "id": 1,
    "category": "email",
    "key": "smtp_host",
    "value": "smtp.qq.com",
    "type": "string",
    "label": "SMTP服务器地址",
    "description": "邮件发送服务器地址",
    "isEncrypted": false,
    "isPublic": false,
    "sortOrder": 1,
    "createdAt": "2024-01-30T10:00:00.000Z",
    "updatedAt": "2024-01-30T11:00:00.000Z"
  },
  {
    "id": 2,
    "category": "email",
    "key": "smtp_port",
    "value": "587",
    "type": "number",
    "label": "SMTP端口",
    "description": "邮件发送服务器端口",
    "isEncrypted": false,
    "isPublic": false,
    "sortOrder": 2,
    "createdAt": "2024-01-30T10:00:00.000Z",
    "updatedAt": "2024-01-30T11:00:00.000Z"
  }
]
```

---

## 8. 配置分类

### 邮件配置 (email)

| 配置键                       | 类型    | 说明                 | 加密 | 公开 |
| ---------------------------- | ------- | -------------------- | ---- | ---- |
| smtp_host                    | string  | SMTP 服务器地址      | ✗    | ✗    |
| smtp_port                    | number  | SMTP 端口            | ✗    | ✗    |
| smtp_secure                  | boolean | 是否使用 SSL         | ✗    | ✗    |
| smtp_user                    | string  | SMTP 用户名          | ✗    | ✗    |
| smtp_password                | string  | SMTP 密码            | ✓    | ✗    |
| from_name                    | string  | 发件人名称           | ✗    | ✗    |
| from_email                   | string  | 发件人邮箱           | ✗    | ✗    |
| verification_enabled         | boolean | 是否启用邮件验证     | ✗    | ✓    |
| verification_code_expire     | number  | 验证码过期时间（秒） | ✗    | ✗    |
| verification_resend_interval | number  | 重发间隔（秒）       | ✗    | ✗    |

### 系统配置 (system)

| 配置键           | 类型   | 说明      | 加密 | 公开 |
| ---------------- | ------ | --------- | ---- | ---- |
| site_name        | string | 网站名称  | ✗    | ✓    |
| site_logo        | string | 网站 Logo | ✗    | ✓    |
| site_description | string | 网站描述  | ✗    | ✓    |

### 页脚配置 (footer)

| 配置键          | 类型    | 说明                | 加密 | 公开 |
| --------------- | ------- | ------------------- | ---- | ---- |
| qq_group_image  | string  | QQ 群二维码图片 URL | ✗    | ✓    |
| qq_group_number | string  | QQ 群号             | ✗    | ✓    |
| wechat_image    | string  | 微信二维码图片 URL  | ✗    | ✓    |
| wechat_text     | string  | 微信说明文字        | ✗    | ✓    |
| show_qq         | boolean | 是否显示 QQ 群      | ✗    | ✓    |
| show_wechat     | boolean | 是否显示微信        | ✗    | ✓    |

**使用说明**：

- 图片 URL 可以使用相对路径（如 `/uploads/footer/qq.png`）或完整 URL
- 图片建议尺寸：二维码图片 200x200 像素
- 如果不需要显示某个联系方式，可以将对应的 `show_*` 设为 false

---

## 9. 配置类型

### 支持的类型

| 类型    | 说明      | 示例             |
| ------- | --------- | ---------------- |
| string  | 字符串    | "smtp.gmail.com" |
| number  | 数字      | 587              |
| boolean | 布尔值    | true / false     |
| json    | JSON 对象 | {"key": "value"} |

### 类型转换

- **boolean**: `true`, `false`, `1`, `0` 会被转换为布尔值
- **number**: 字符串会被转换为数字
- **json**: 字符串会被解析为 JSON 对象

---

## 10. 加密存储

对于敏感信息（如密码、密钥等），系统会自动进行 AES-256-CBC 加密存储。

### 加密字段特点

1. 存储时自动加密
2. 读取时自动解密
3. 列表接口中显示为 `******`
4. 详情接口中返回明文（需要权限）

---

## 11. 错误码

| 错误码 | 说明           |
| ------ | -------------- |
| 400    | 请求参数错误   |
| 401    | 未授权         |
| 403    | 无权限         |
| 404    | 配置项不存在   |
| 500    | 服务器内部错误 |

---

## 12. 使用示例

### 前端获取配置

```typescript
// 获取所有邮件配置
const response = await axios.get("/api/v1/system-settings/category/email");
const emailSettings = response.data;

// 更新配置
await axios.put("/api/v1/system-settings/1", {
  value: "new-value",
});

// 批量更新
await axios.put("/api/v1/system-settings/batch", {
  settings: [
    { id: 1, value: "value1" },
    { id: 2, value: "value2" },
  ],
});
```

### 前端获取公开配置

```typescript
// 无需认证，可在登录前调用
const response = await axios.get("/api/v1/system-settings/public");
const publicSettings = response.data;
```

---

### 上传页脚图片

```typescript
// 上传图片
const formData = new FormData();
formData.append('file', fileInput.files[0]);

const response = await axios.post(
  '/api/v1/system-settings/upload/footer',
  formData,
  {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
  }
);

const imageUrl = response.data.data.url; // 返回的图片URL

// 然后更新系统配置
await axios.put('/api/v1/system-settings/batch', {
  settings: [
    { id: 1, value: imageUrl }, // 更新QQ群二维码URL
  ],
});
```

---

## 13. 注意事项

1. **权限要求**

   - 读取配置需要 `system-settings:read` 权限
   - 更新配置需要 `system-settings:update` 权限
   - 批量更新需要 `system-settings:update-batch` 权限

2. **加密字段**

   - 加密字段在列表中不显示明文
   - 更新加密字段时，传入明文即可，系统会自动加密

3. **配置验证**

   - 系统会根据配置类型进行值验证
   - 类型不匹配会返回 400 错误

4. **缓存**

   - 配置更新后会立即生效
   - 不需要重启服务

5. **备份**
   - 修改重要配置前请做好备份
   - 可以通过导出功能备份配置
