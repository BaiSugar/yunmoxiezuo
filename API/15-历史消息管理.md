# 15. 历史消息管理 API

## 概述

历史消息管理模块提供完整的对话历史记录功能，支持消息的存储、管理、多版本生成（Swipes）、附件管理以及聊天的导入导出。

**基础路径**: `/api/v1`

## 认证方式

所有接口都需要 JWT 认证，请在请求头中携带 Token：

```
Authorization: Bearer <access_token>
```

---

## 一、聊天管理

### 1.1 创建聊天

**接口**: `POST /chat-histories`

**认证**: 必需 ✓

**请求体**:
```json
{
  "chatName": "与艾莉娅的对话",
  "characterCardId": 1,
  "characterName": "艾莉娅",
  "userPersonaName": "小明",
  "chatMetadata": {
    "scenario": "在图书馆的深处",
    "note": "讨论古代魔法",
    "talkativeness": 0.7
  }
}
```

**字段说明**:
| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| chatName | string | 否 | 聊天名称 |
| characterCardId | number | 否 | 关联的角色卡ID |
| characterName | string | 否 | 角色名称 |
| userPersonaName | string | 否 | 用户人设名称 |
| chatMetadata | object | 否 | 聊天元数据 |

**响应**:
```json
{
  "id": 1,
  "userId": 1,
  "chatName": "与艾莉娅的对话",
  "characterCardId": 1,
  "characterName": "艾莉娅",
  "userPersonaName": "小明",
  "chatMetadata": {
    "scenario": "在图书馆的深处",
    "note": "讨论古代魔法",
    "talkativeness": 0.7
  },
  "messageCount": 0,
  "lastMessageAt": null,
  "createdAt": "2025-01-23T10:00:00.000Z",
  "updatedAt": "2025-01-23T10:00:00.000Z"
}
```

---

### 1.2 查询聊天列表

**接口**: `GET /chat-histories`

**认证**: 必需 ✓

**查询参数**:
| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| page | number | 否 | 1 | 页码 |
| limit | number | 否 | 20 | 每页数量（最大100） |
| characterCardId | number | 否 | - | 按角色卡筛选 |
| search | string | 否 | - | 搜索关键词（聊天名称或角色名称） |

**请求示例**:
```
GET /chat-histories?page=1&limit=20&characterCardId=1&search=艾莉娅
```

**响应**:
```json
{
  "data": [
    {
      "id": 1,
      "chatName": "与艾莉娅的对话",
      "characterName": "艾莉娅",
      "messageCount": 15,
      "lastMessageAt": "2025-01-23T12:30:00.000Z",
      "createdAt": "2025-01-23T10:00:00.000Z"
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 20
}
```

---

### 1.3 获取聊天详情

**接口**: `GET /chat-histories/:id`

**认证**: 必需 ✓

**路径参数**:
- `id` - 聊天ID

**响应**:
```json
{
  "id": 1,
  "userId": 1,
  "chatName": "与艾莉娅的对话",
  "characterCardId": 1,
  "characterName": "艾莉娅",
  "userPersonaName": "小明",
  "chatMetadata": {
    "scenario": "在图书馆的深处",
    "note": "讨论古代魔法"
  },
  "messageCount": 15,
  "lastMessageAt": "2025-01-23T12:30:00.000Z",
  "createdAt": "2025-01-23T10:00:00.000Z",
  "updatedAt": "2025-01-23T12:30:00.000Z"
}
```

---

### 1.4 更新聊天

**接口**: `PUT /chat-histories/:id`

**认证**: 必需 ✓

**路径参数**:
- `id` - 聊天ID

**请求体**:
```json
{
  "chatName": "魔法学习记录",
  "chatMetadata": {
    "note": "已学习基础魔法"
  }
}
```

**响应**: 与创建聊天响应相同

---

### 1.5 删除聊天

**接口**: `DELETE /chat-histories/:id`

**认证**: 必需 ✓

**路径参数**:
- `id` - 聊天ID

**响应**: `204 No Content`

---

### 1.6 批量删除聊天

**接口**: `POST /chat-histories/batch-delete`

**认证**: 必需 ✓

**请求体**:
```json
{
  "ids": [1, 2, 3]
}
```

**响应**: `204 No Content`

---

### 1.7 获取聊天统计

**接口**: `GET /chat-histories/stats/summary`

**认证**: 必需 ✓

**响应**:
```json
{
  "totalChats": 10,
  "totalMessages": 150,
  "charactersUsed": 5
}
```

---

### 1.8 导出聊天

**接口**: `GET /chat-histories/:id/export`

**认证**: 必需 ✓

**路径参数**:
- `id` - 聊天ID

**查询参数**:
| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| format | string | 否 | jsonl | 导出格式：jsonl, txt, html, markdown |

**请求示例**:
```
GET /chat-histories/1/export?format=markdown
```

**响应**: 
- Content-Type: 根据格式不同
- Content-Disposition: attachment; filename="..."
- Body: 导出的文件内容

**支持的格式**:
- **jsonl** - SillyTavern原生格式
- **txt** - 纯文本格式
- **html** - 网页格式（带样式）
- **markdown** - Markdown格式

---

### 1.9 导入聊天

**接口**: `POST /chat-histories/import`

**认证**: 必需 ✓

**请求体**:
```json
{
  "data": "... JSONL或JSON字符串 ...",
  "source": "sillytavern",
  "characterCardId": 1
}
```

**字段说明**:
| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| data | string | 是 | 聊天数据（JSONL或JSON字符串） |
| source | string | 是 | 导入来源平台 |
| characterCardId | number | 否 | 关联的角色卡ID |

**支持的来源**:
- `sillytavern` - SillyTavern原生格式
- `ooba` - Text Generation WebUI格式
- `cai_tools` - Character.AI Tools格式
- `agnai` - Agnai格式
- `risuai` - RisuAI格式
- `chub` - Chub.ai格式
- `kobold_lite` - Kobold Lite格式

**响应**: 与创建聊天响应相同

---

## 二、消息管理

### 2.1 创建消息

**接口**: `POST /messages`

**认证**: 必需 ✓

**请求体**:
```json
{
  "chatId": 1,
  "name": "艾莉娅",
  "isUser": false,
  "mes": "*微笑* 你好，很高兴见到你！",
  "sendDate": 1706000000000,
  "messageType": "normal",
  "api": "openai",
  "model": "gpt-4-turbo",
  "extra": {
    "token_count": 15
  }
}
```

**字段说明**:
| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| chatId | number | 是 | 聊天ID |
| name | string | 是 | 发送者名称 |
| isUser | boolean | 是 | 是否为用户消息 |
| mes | string | 是 | 消息内容 |
| sendDate | number | 否 | 发送时间（时间戳，默认为当前时间） |
| messageType | string | 否 | 消息类型（normal, system, greeting, narrator, comment） |
| isSystem | boolean | 否 | 是否为系统消息（隐藏） |
| isName | boolean | 否 | 是否为名称标签 |
| forceAvatar | string | 否 | 强制使用的头像URL |
| genStarted | number | 否 | 生成开始时间 |
| genFinished | number | 否 | 生成结束时间 |
| genId | string | 否 | 生成ID |
| api | string | 否 | 使用的API |
| model | string | 否 | 使用的模型 |
| extra | object | 否 | 扩展信息 |

**响应**:
```json
{
  "id": 1,
  "chatId": 1,
  "mesId": 0,
  "name": "艾莉娅",
  "isUser": false,
  "mes": "*微笑* 你好，很高兴见到你！",
  "sendDate": 1706000000000,
  "messageType": "normal",
  "isSystem": false,
  "swipeId": 0,
  "api": "openai",
  "model": "gpt-4-turbo",
  "extra": {
    "token_count": 15
  },
  "createdAt": "2025-01-23T10:00:00.000Z",
  "updatedAt": "2025-01-23T10:00:00.000Z"
}
```

---

### 2.2 查询消息列表

**接口**: `GET /messages/chat/:chatId`

**认证**: 必需 ✓

**路径参数**:
- `chatId` - 聊天ID

**查询参数**:
| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| page | number | 否 | 1 | 页码 |
| limit | number | 否 | 50 | 每页数量 |

**响应**:
```json
{
  "data": [
    {
      "id": 1,
      "mesId": 0,
      "name": "艾莉娅",
      "isUser": false,
      "mes": "*微笑* 你好，很高兴见到你！",
      "sendDate": 1706000000000,
      "swipes": [
        {
          "id": 1,
          "swipeIndex": 0,
          "content": "*微笑* 你好，很高兴见到你！",
          "sendDate": 1706000000000
        }
      ],
      "swipeId": 0
    }
  ],
  "total": 15
}
```

---

### 2.3 获取消息详情

**接口**: `GET /messages/:id`

**认证**: 必需 ✓

**路径参数**:
- `id` - 消息ID

**响应**: 与创建消息响应相同，包含swipes数组

---

### 2.4 更新消息

**接口**: `PUT /messages/:id`

**认证**: 必需 ✓

**路径参数**:
- `id` - 消息ID

**请求体**:
```json
{
  "mes": "更新后的消息内容",
  "extra": {
    "note": "已编辑"
  }
}
```

**注意**: 
- 更新消息内容会同时更新当前选中的Swipe版本
- Token会自动重新计算

**响应**: 与创建消息响应相同

---

### 2.5 删除消息

**接口**: `DELETE /messages/:id`

**认证**: 必需 ✓

**路径参数**:
- `id` - 消息ID

**响应**: `204 No Content`

---

### 2.6 删除从某条消息开始的所有消息

**接口**: `DELETE /messages/:id/from`

**认证**: 必需 ✓

**路径参数**:
- `id` - 起始消息ID

**说明**: 删除指定消息及其之后的所有消息（用于重新生成对话）

**响应**: `204 No Content`

---

## 三、Swipes管理（多版本生成）

### 3.1 添加Swipe版本

**接口**: `POST /messages/:id/swipes`

**认证**: 必需 ✓

**路径参数**:
- `id` - 消息ID

**请求体**:
```json
{
  "content": "*点头* 你好呀，欢迎来到图书馆！",
  "sendDate": 1706000010000,
  "genStarted": 1706000008000,
  "genFinished": 1706000010000,
  "extra": {
    "api": "openai",
    "model": "gpt-4-turbo",
    "token_count": 18
  }
}
```

**字段说明**:
| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| content | string | 是 | Swipe内容 |
| sendDate | number | 否 | 发送时间（时间戳） |
| genStarted | number | 否 | 生成开始时间 |
| genFinished | number | 否 | 生成结束时间 |
| genId | string | 否 | 生成ID |
| extra | object | 否 | 扩展信息 |

**响应**: 返回更新后的完整消息对象，包含所有Swipes

---

### 3.2 切换Swipe版本

**接口**: `PUT /messages/:id/swipes/:swipeIndex`

**认证**: 必需 ✓

**路径参数**:
- `id` - 消息ID
- `swipeIndex` - Swipe索引（从0开始）

**说明**: 切换到指定的Swipe版本，消息的`mes`字段会更新为该版本的内容

**响应**: 返回更新后的消息对象

---

### 3.3 删除Swipe版本

**接口**: `DELETE /messages/:id/swipes/:swipeIndex`

**认证**: 必需 ✓

**路径参数**:
- `id` - 消息ID
- `swipeIndex` - Swipe索引

**说明**: 
- 不能删除最后一个Swipe版本
- 如果删除的是当前选中的版本，会自动切换到索引0

**响应**: `204 No Content`

---

## 四、数据结构

### 4.1 消息对象完整结构

```typescript
{
  // 基本信息
  id: number;
  chatId: number;
  mesId: number;                    // 在聊天内的索引
  name: string;                     // 发送者名称
  isUser: boolean;                  // 是否为用户消息
  mes: string;                      // 消息内容
  sendDate: number;                 // 发送时间（时间戳）
  
  // 消息类型
  messageType: 'normal' | 'system' | 'greeting' | 'narrator' | 'comment';
  isSystem: boolean;                // 是否为系统消息（隐藏）
  isName: boolean;                  // 是否为名称标签
  forceAvatar?: string;             // 强制头像URL
  
  // Swipes
  swipeId: number;                  // 当前选中的Swipe索引
  swipes: Array<{                   // Swipe版本数组
    id: number;
    swipeIndex: number;
    content: string;
    sendDate: number;
    genStarted?: number;
    genFinished?: number;
    genId?: string;
    extra?: object;
  }>;
  
  // 生成信息
  genStarted?: number;              // 生成开始时间
  genFinished?: number;             // 生成结束时间
  genId?: string;                   // 生成ID
  api?: string;                     // 使用的API
  model?: string;                   // 使用的模型
  
  // 扩展信息
  extra?: {
    token_count?: number;           // Token数量
    api?: string;
    model?: string;
    file?: {                        // 文件附件
      url: string;
      size?: number;
      name?: string;
      text?: string;
    };
    image?: string | string[];      // 图片附件
    inline_image?: string | string[];
    metadata?: object;
    [key: string]: any;
  };
  
  // 时间戳
  createdAt: string;
  updatedAt: string;
}
```

### 4.2 聊天元数据（chatMetadata）

```typescript
{
  integrity?: string;               // 完整性校验值
  note?: string;                    // 聊天备注
  scenario?: string;                // 自定义场景
  talkativeness?: number;           // 话痨度
  depth_prompt?: {                  // 深度提示配置
    depth?: number;
    prompt?: string;
    role?: string;
  };
  objective?: {                     // 任务目标配置
    text?: string;
    completed?: boolean;
  };
  memo?: string;                    // 记忆/备忘录
  extensions?: object;              // 扩展插件数据
}
```

---

## 五、错误响应

### 5.1 通用错误格式

```json
{
  "statusCode": 404,
  "message": "聊天不存在",
  "error": "Not Found"
}
```

### 5.2 常见错误码

| 状态码 | 说明 | 常见原因 |
|--------|------|----------|
| 400 | 请求参数错误 | 缺少必需字段、格式错误 |
| 401 | 未授权 | Token无效或过期 |
| 403 | 无权访问 | 尝试访问他人的聊天或消息 |
| 404 | 资源不存在 | 聊天或消息不存在 |
| 500 | 服务器错误 | 服务器内部错误 |

---

## 六、使用场景示例

### 6.1 完整对话流程

```typescript
// 1. 创建聊天
const chat = await createChat({
  characterName: '艾莉娅',
  userPersonaName: '小明',
});

// 2. 发送用户消息
const userMsg = await createMessage({
  chatId: chat.id,
  name: '小明',
  isUser: true,
  mes: '你好！',
});

// 3. 生成角色回复
const charMsg = await createMessage({
  chatId: chat.id,
  name: '艾莉娅',
  isUser: false,
  mes: '*微笑* 你好！',
  api: 'openai',
  model: 'gpt-4',
});

// 4. 对回复不满意，生成新版本
await addSwipe(charMsg.id, {
  content: '*热情地挥手* 你好呀！',
});

// 5. 切换到新版本
await switchSwipe(charMsg.id, 1);

// 6. 继续对话...
```

### 6.2 编辑和重新生成

```typescript
// 编辑用户消息
await updateMessage(userMsg.id, {
  mes: '你好，艾莉娅！',
});

// 删除该消息之后的所有内容
await deleteMessageFrom(charMsg.id);

// 重新生成回复
const newCharMsg = await createMessage({
  chatId: chat.id,
  name: '艾莉娅',
  isUser: false,
  mes: '新的回复内容',
});
```

### 6.3 导出和备份

```typescript
// 导出为Markdown
const markdown = await exportChat(chat.id, 'markdown');

// 导出为JSONL（原生格式，可重新导入）
const jsonl = await exportChat(chat.id, 'jsonl');

// 导入到新账户
const importedChat = await importChat({
  data: jsonl,
  source: 'sillytavern',
});
```

---

## 七、最佳实践

### 7.1 性能优化
- ✅ 使用分页加载消息（默认50条/页）
- ✅ 只在需要时加载Swipes关系
- ✅ 定期清理旧聊天和无用Swipes
- ✅ 使用批量删除减少请求次数

### 7.2 数据安全
- ✅ 所有操作都需要验证聊天所有权
- ✅ 不要在客户端存储敏感聊天内容
- ✅ 定期导出重要对话作为备份
- ✅ 使用HTTPS传输数据

### 7.3 用户体验
- ✅ 提供消息发送状态反馈
- ✅ 支持本地缓存减少网络请求
- ✅ 实现消息预加载提升响应速度
- ✅ 提供清晰的错误提示

---

## 八、变更日志

### v1.0.0 (2025-01-23)
- ✅ 实现完整的聊天历史管理功能
- ✅ 支持消息的CRUD操作
- ✅ 实现Swipes多版本生成系统
- ✅ 支持4种导出格式（JSONL, TXT, HTML, Markdown）
- ✅ 支持7种导入来源
- ✅ 实现Token自动计数
- ✅ 完整的权限验证和数据安全

---

## 相关文档

- [历史消息系统完整文档](../docs/历史消息系统完整文档.md)
- [模块README](../backend/src/chat-histories/README.md)
- [通用规范](./99-通用规范.md)
