# æç¤ºè¯æ„å»ºå¼•æ“ API

## æ¦‚è¿°

æç¤ºè¯æ„å»ºå¼•æ“æ˜¯ä¸€ä¸ªé«˜åº¦æ¨¡å—åŒ–çš„ç³»ç»Ÿï¼Œè´Ÿè´£å°†æç¤ºè¯ç»„ä»¶ï¼ˆç³»ç»Ÿæç¤ºã€è§’è‰²å®šä¹‰ã€å¯¹è¯å†å²ç­‰ï¼‰ç»„è£…æˆç¬¦åˆå„ç§å¤§è¯­è¨€æ¨¡å‹APIæ ¼å¼çš„å®Œæ•´æç¤ºè¯ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ğŸ“¦ ç»„ä»¶æ”¶é›†ï¼šä»å¤šä¸ªæ¥æºæ”¶é›†æç¤ºè¯ç»„ä»¶
- ğŸ“Š ä½ç½®åˆ†ç»„ï¼šæŒ‰12ä¸ªé¢„å®šä¹‰ä½ç½®åˆ†ç»„ç»„ä»¶
- âš–ï¸ Tokenç®¡ç†ï¼šæ™ºèƒ½æ§åˆ¶Tokené¢„ç®—ï¼Œè‡ªåŠ¨è£å‰ª
- ğŸ”§ æ¶ˆæ¯ç»„è£…ï¼šæŒ‰æ­£ç¡®é¡ºåºç»„è£…æ¶ˆæ¯æ•°ç»„
- ğŸ”„ æ ¼å¼è½¬æ¢ï¼šæ”¯æŒOpenAIã€Claudeã€Geminiç­‰æ ¼å¼
- ğŸ¯ å‚æ•°æ›¿æ¢ï¼šæ”¯æŒ`{{å‚æ•°å}}`å ä½ç¬¦æ›¿æ¢

---

## ä¸€ã€åŸºç¡€ç«¯ç‚¹

### 1.1 æ„å»ºæç¤ºè¯ï¼ˆå®Œæ•´ç‰ˆï¼‰

**æ¥å£**: `POST /api/v1/prompts/build`

**æƒé™**: éœ€è¦è®¤è¯ + `prompt:build` æƒé™

**åŠŸèƒ½**: åŸºäºæç¤ºè¯IDå’Œå¯¹è¯å†å²ï¼Œæ„å»ºå®Œæ•´çš„æç¤ºè¯æ¶ˆæ¯æ•°ç»„

**è¯·æ±‚ä½“**:
```json
{
  "promptId": 1,
  "userInput": "è¯·å¸®æˆ‘å†™ä¸€ä¸ªç§‘å¹»æ•…äº‹",
  "history": [
    {
      "role": "user",
      "content": "ä½ å¥½"
    },
    {
      "role": "assistant",
      "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
    }
  ],
  "options": {
    "apiFormat": "openai",
    "tokenBudget": {
      "total": 4096,
      "systemPrompts": 500,
      "characterDef": 1000,
      "examples": 500,
      "worldBookRatio": 0.25,
      "protectedHistoryCount": 5
    },
    "enableWorldBook": false,
    "worldBookScanDepth": 10,
    "worldBookMaxRecursion": 3,
    "debug": false
  }
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| promptId | number | âœ… | æç¤ºè¯ID |
| userInput | string | âŒ | ç”¨æˆ·è¾“å…¥æ–‡æœ¬ |
| history | array | âŒ | å¯¹è¯å†å²æ•°ç»„ |
| options | object | âŒ | æ„å»ºé€‰é¡¹ï¼ˆè§ä¸‹è¡¨ï¼‰ |

**æ„å»ºé€‰é¡¹ (options)**:

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| apiFormat | string | "openai" | APIæ ¼å¼ï¼šopenai/claude/gemini |
| tokenBudget | object | è§ä¸‹æ–¹ | Tokené¢„ç®—é…ç½® |
| enableWorldBook | boolean | false | æ˜¯å¦å¯ç”¨ä¸–ç•Œä¹¦æ¿€æ´» |
| worldBookScanDepth | number | 10 | ä¸–ç•Œä¹¦æ‰«ææ·±åº¦ï¼ˆæœ€è¿‘Næ¡æ¶ˆæ¯ï¼‰ |
| worldBookMaxRecursion | number | 3 | ä¸–ç•Œä¹¦é€’å½’æ‰«ææœ€å¤§è½®æ•° |
| debug | boolean | false | æ˜¯å¦è¿”å›è°ƒè¯•ä¿¡æ¯ |

**Tokené¢„ç®—é…ç½®**:

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| total | number | 4096 | æ€»Tokené¢„ç®— |
| systemPrompts | number | 500 | ç³»ç»Ÿæç¤ºé¢„ç®— |
| characterDef | number | 1000 | è§’è‰²å®šä¹‰é¢„ç®— |
| examples | number | 500 | ç¤ºä¾‹æ¶ˆæ¯é¢„ç®— |
| worldBookRatio | number | 0.25 | ä¸–ç•Œä¹¦é¢„ç®—æ¯”ä¾‹ï¼ˆ0-1ï¼‰ |
| protectedHistoryCount | number | 5 | ä¿æŠ¤çš„æœ€è¿‘å†å²æ¶ˆæ¯æ•°é‡ |

**å“åº”ç¤ºä¾‹ (OpenAIæ ¼å¼)**:
```json
{
  "result": {
    "messages": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç§‘å¹»å°è¯´ä½œå®¶..."
      },
      {
        "role": "user",
        "content": "ä½ å¥½"
      },
      {
        "role": "assistant",
        "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
      },
      {
        "role": "user",
        "content": "è¯·å¸®æˆ‘å†™ä¸€ä¸ªç§‘å¹»æ•…äº‹"
      }
    ]
  },
  "stats": {
    "total": 850,
    "systemPrompts": 300,
    "characterDef": 200,
    "examples": 0,
    "worldBook": 0,
    "history": 250,
    "authorNote": 0,
    "userInput": 100,
    "overBudget": false,
    "trimmedComponents": 0
  }
}
```

**å“åº”ç¤ºä¾‹ (Claudeæ ¼å¼)**:
```json
{
  "result": {
    "system": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç§‘å¹»å°è¯´ä½œå®¶...",
    "messages": [
      {
        "role": "user",
        "content": "ä½ å¥½"
      },
      {
        "role": "assistant",
        "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
      },
      {
        "role": "user",
        "content": "è¯·å¸®æˆ‘å†™ä¸€ä¸ªç§‘å¹»æ•…äº‹"
      }
    ]
  },
  "stats": { ... }
}
```

**å“åº”ç¤ºä¾‹ (Geminiæ ¼å¼)**:
```json
{
  "result": {
    "systemInstruction": {
      "parts": [
        {
          "text": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç§‘å¹»å°è¯´ä½œå®¶..."
        }
      ]
    },
    "contents": [
      {
        "role": "user",
        "parts": [{ "text": "ä½ å¥½" }]
      },
      {
        "role": "model",
        "parts": [{ "text": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ" }]
      },
      {
        "role": "user",
        "parts": [{ "text": "è¯·å¸®æˆ‘å†™ä¸€ä¸ªç§‘å¹»æ•…äº‹" }]
      }
    ]
  },
  "stats": { ... }
}
```

**é”™è¯¯å“åº”**:

- `404`: æç¤ºè¯ä¸å­˜åœ¨
- `403`: æ— æƒé™è®¿é—®
- `400`: å‚æ•°éªŒè¯å¤±è´¥

---

### 1.2 ç®€åŒ–æ„å»ºæç¤ºè¯

**æ¥å£**: `POST /api/v1/prompts/build/simple`

**æƒé™**: éœ€è¦è®¤è¯ + `prompt:build` æƒé™

**åŠŸèƒ½**: ä»…åŸºäºæç¤ºè¯å†…å®¹æ„å»ºï¼Œæ”¯æŒå‚æ•°æ›¿æ¢ï¼Œé€‚ç”¨äºä¸éœ€è¦å¯¹è¯å†å²çš„åœºæ™¯

**è¯·æ±‚ä½“**:
```json
{
  "promptId": 1,
  "parameters": {
    "name": "å¼ ä¸‰",
    "age": "25",
    "profession": "ç¨‹åºå‘˜"
  },
  "options": {
    "apiFormat": "openai",
    "tokenBudget": {
      "total": 2048
    }
  }
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| promptId | number | âœ… | æç¤ºè¯ID |
| parameters | object | âŒ | å‚æ•°æ›¿æ¢æ˜ å°„ï¼ˆé”®å€¼å¯¹ï¼‰ |
| options | object | âŒ | æ„å»ºé€‰é¡¹ |

**å‚æ•°æ›¿æ¢ç¤ºä¾‹**:

æç¤ºè¯å†…å®¹ï¼š
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„{{profession}}ï¼Œåå­—å«{{name}}ï¼Œä»Šå¹´{{age}}å²ã€‚
```

å‚æ•°æ˜ å°„ï¼š
```json
{
  "name": "å¼ ä¸‰",
  "age": "25",
  "profession": "ç¨‹åºå‘˜"
}
```

æ„å»ºç»“æœï¼š
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¨‹åºå‘˜ï¼Œåå­—å«å¼ ä¸‰ï¼Œä»Šå¹´25å²ã€‚
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "result": {
    "messages": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¨‹åºå‘˜ï¼Œåå­—å«å¼ ä¸‰ï¼Œä»Šå¹´25å²ã€‚"
      }
    ]
  },
  "stats": {
    "total": 50,
    "systemPrompts": 50,
    "characterDef": 0,
    "examples": 0,
    "worldBook": 0,
    "history": 0,
    "authorNote": 0,
    "userInput": 0,
    "overBudget": false,
    "trimmedComponents": 0
  }
}
```

---

## äºŒã€æ„å»ºæµç¨‹è¯¦è§£

### 2.1 å…­é˜¶æ®µæ„å»ºæµç¨‹

```
é˜¶æ®µ1: ç»„ä»¶æ”¶é›† â†’ é˜¶æ®µ2: ä½ç½®åˆ†ç»„ â†’ é˜¶æ®µ3: ä¼˜å…ˆçº§æ’åº
    â†“
é˜¶æ®µ4: Tokenæ§åˆ¶ â†’ é˜¶æ®µ5: æ¶ˆæ¯ç»„è£… â†’ é˜¶æ®µ6: æ ¼å¼è½¬æ¢
```

#### é˜¶æ®µ1: ç»„ä»¶æ”¶é›†

ä»å„ä¸ªæ¥æºæ”¶é›†ç»„ä»¶ï¼š
- æç¤ºè¯å†…å®¹ï¼ˆPromptContentï¼‰
- å¯¹è¯å†å²ï¼ˆhistoryï¼‰
- ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
- ç”¨æˆ·è¾“å…¥ï¼ˆuserInputï¼‰

#### é˜¶æ®µ2: ä½ç½®åˆ†ç»„

å°†ç»„ä»¶åˆ†åˆ°12ä¸ª"æ¡¶"ï¼š
1. systemPrompts - ç³»ç»Ÿæç¤º
2. beforeChar - è§’è‰²å®šä¹‰ä¹‹å‰
3. charDef - è§’è‰²å®šä¹‰
4. afterChar - è§’è‰²å®šä¹‰ä¹‹å
5. exampleTop - ç¤ºä¾‹æ¶ˆæ¯ä¹‹å‰
6. examples - ç¤ºä¾‹æ¶ˆæ¯
7. exampleBottom - ç¤ºä¾‹æ¶ˆæ¯ä¹‹å
8. history - å¯¹è¯å†å²
9. depthInjections - æ·±åº¦æ³¨å…¥
10. anTop - Author's Noteé¡¶éƒ¨
11. anBottom - Author's Noteåº•éƒ¨
12. latestInput - ç”¨æˆ·æœ€æ–°è¾“å…¥

#### é˜¶æ®µ3: ä¼˜å…ˆçº§æ’åº

åœ¨æ¯ä¸ªæ¡¶å†…æŒ‰`order`å­—æ®µæ’åºï¼š
- orderæ•°å€¼è¶Šå°è¶Šé å‰
- é»˜è®¤order=100
- å†å²å’Œç¤ºä¾‹æŒ‰æ—¶é—´é¡ºåº

#### é˜¶æ®µ4: Tokené¢„ç®—æ§åˆ¶

- è®¡ç®—æ‰€æœ‰ç»„ä»¶çš„Tokenæ•°é‡
- å¦‚æœè¶…å‡ºé¢„ç®—ï¼ŒæŒ‰ä¼˜å…ˆçº§è£å‰ªï¼š
  1. ä¸–ç•Œä¹¦ï¼ˆéå¸¸é©»æ¡ç›®ï¼‰
  2. å†å²æ¶ˆæ¯ï¼ˆä»æ—§åˆ°æ–°åˆ é™¤ï¼Œä¿æŠ¤æœ€è¿‘Næ¡ï¼‰
  3. ç¤ºä¾‹æ¶ˆæ¯

#### é˜¶æ®µ5: æ¶ˆæ¯ç»„è£…

æŒ‰æ¡¶é¡ºåºç»„è£…messagesæ•°ç»„ï¼š
1. ç³»ç»Ÿæç¤º
2. è§’è‰²å®šä¹‰ä¹‹å‰
3. è§’è‰²å®šä¹‰
4. è§’è‰²å®šä¹‰ä¹‹å
5. ç¤ºä¾‹æ¶ˆæ¯åŒºåŸŸ
6. å¯¹è¯å†å²ï¼ˆå«æ·±åº¦æ³¨å…¥ï¼‰
7. Author's Note
8. ç”¨æˆ·æœ€æ–°è¾“å…¥

#### é˜¶æ®µ6: æ ¼å¼è½¬æ¢

æ ¹æ®`apiFormat`è½¬æ¢ä¸ºç›®æ ‡æ ¼å¼ï¼š
- **OpenAI**: æ ‡å‡†messagesæ•°ç»„
- **Claude**: åˆ†ç¦»systemå’Œmessagesï¼Œç¡®ä¿äº¤æ›¿
- **Gemini**: systemInstruction + contentsï¼Œassistantâ†’model

---

## ä¸‰ã€ä½ç½®ç³»ç»Ÿè¯¦è§£

### 3.1 å…«ç§æ ‡å‡†ä½ç½®

| ä½ç½® | æ ‡è¯†ç¬¦ | é€‚ç”¨åœºæ™¯ | AIæ³¨æ„åŠ› |
|------|--------|----------|----------|
| before | è§’è‰²å®šä¹‰ä¹‹å‰ | ä¸–ç•Œè§‚ã€è§„åˆ™è®¾å®š | åŸºç¡€å½±å“ |
| after | è§’è‰²å®šä¹‰ä¹‹å | è§’è‰²èƒŒæ™¯è¡¥å…… | ä¸­ç­‰å½±å“ |
| atDepth | æŒ‡å®šæ·±åº¦ | åœºæ™¯è½¬æ¢ã€é˜¶æ®µæ€§æŒ‡ä»¤ | å®šå‘å½±å“ |
| anTop | ANé¡¶éƒ¨ | å³æ—¶è¡Œä¸ºæ§åˆ¶ | é«˜æ³¨æ„åŠ› |
| anBottom | ANåº•éƒ¨ | ç´§æ€¥æŒ‡ä»¤ã€æœ€åæé†’ | æœ€é«˜æ³¨æ„åŠ› |
| exampleTop | ç¤ºä¾‹å‰ | é£æ ¼è¯´æ˜ | é£æ ¼å½±å“ |
| exampleBottom | ç¤ºä¾‹å | æ ¼å¼ç¤ºä¾‹ | é£æ ¼å½±å“ |

### 3.2 æ·±åº¦æ³¨å…¥ï¼ˆatDepthï¼‰

æ·±åº¦å«ä¹‰ï¼š
- depth=0ï¼šæœ€æ–°æ¶ˆæ¯ä¹‹å
- depth=nï¼šå€’æ•°ç¬¬næ¡æ¶ˆæ¯ä¹‹å

æ’å…¥ç®—æ³•ï¼š
```
å†å²æ•°ç»„ï¼š[msg0(æœ€æ—©), ..., msgN(æœ€æ–°)]
æ³¨å…¥depth=dï¼šæ’åœ¨ç´¢å¼•(N-d)ä¹‹å
```

ç¤ºä¾‹ï¼š
```
10æ¡å†å²ï¼Œæ³¨å…¥depth=3ï¼š
æ’åœ¨ç´¢å¼•7ä¹‹å â†’ [msg0...msg7, ã€æ³¨å…¥ã€‘, msg8, msg9]
```

---

## å››ã€Tokenç®¡ç†

### 4.1 Tokenä¼°ç®—

ä½¿ç”¨ç®€åŒ–ç®—æ³•ä¼°ç®—ï¼š
- è‹±æ–‡ï¼šçº¦4å­—ç¬¦1token
- ä¸­æ–‡ï¼šçº¦1.5å­—ç¬¦1token
- å¹³å‡ï¼šçº¦2.5å­—ç¬¦1token

**æ³¨æ„**: å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é›†æˆ`tiktoken`ç­‰åº“è¿›è¡Œç²¾ç¡®è®¡ç®—ã€‚

### 4.2 è£å‰ªç­–ç•¥

**å›ºå®šç»„ä»¶ä¸è£å‰ª**ï¼š
- ç³»ç»Ÿæç¤º
- è§’è‰²å®šä¹‰
- ç”¨æˆ·æœ€æ–°è¾“å…¥

**ä¸–ç•Œä¹¦æŒ‰ä¼˜å…ˆçº§è£å‰ª**ï¼š
- æŒ‰orderä»å¤§åˆ°å°åˆ é™¤
- ä¿ç•™constant=trueçš„å¸¸é©»æ¡ç›®

**å†å²æ¶ˆæ¯ä»æ—§åˆ°æ–°è£å‰ª**ï¼š
- ä»æœ€æ—©æ¶ˆæ¯å¼€å§‹åˆ é™¤
- ä¿æŠ¤æœ€è¿‘Næ¡ï¼ˆé»˜è®¤5æ¡ï¼‰

**ç¤ºä¾‹æ¶ˆæ¯æŒ‰é¢„ç®—è£å‰ª**ï¼š
- ä»å‰åˆ°åä¿ç•™ï¼Œç›´åˆ°è¶…å‡ºé¢„ç®—

---

## äº”ã€ä½¿ç”¨ç¤ºä¾‹

### 5.1 åŸºç¡€ä½¿ç”¨

```typescript
// ç®€å•æ„å»ºï¼ˆåªä½¿ç”¨æç¤ºè¯å†…å®¹ï¼‰
const result = await axios.post('/api/v1/prompts/build/simple', {
  promptId: 1,
  parameters: {
    topic: 'äººå·¥æ™ºèƒ½',
    tone: 'ä¸“ä¸š',
  },
});

console.log(result.data.result.messages);
```

### 5.2 é«˜çº§ä½¿ç”¨ï¼ˆå«å¯¹è¯å†å²ï¼‰

```typescript
// å®Œæ•´æ„å»ºï¼ˆå«å†å²å’Œé…ç½®ï¼‰
const result = await axios.post('/api/v1/prompts/build', {
  promptId: 1,
  userInput: 'ç»§ç»­å†™ä¸‹å»',
  history: conversationHistory,
  options: {
    apiFormat: 'claude',
    tokenBudget: {
      total: 8192,
      protectedHistoryCount: 10,
    },
    debug: true,
  },
});

// ç›´æ¥å‘é€ç»™Claude API
const claudeResponse = await anthropic.messages.create({
  model: 'claude-3-opus-20240229',
  max_tokens: 1024,
  system: result.data.result.system,
  messages: result.data.result.messages,
});
```

### 5.3 ä¸åŒæ ¼å¼ç¤ºä¾‹

```typescript
// OpenAIæ ¼å¼
const openaiResult = await buildPrompt({
  promptId: 1,
  options: { apiFormat: 'openai' },
});

await openai.chat.completions.create({
  model: 'gpt-4',
  messages: openaiResult.result.messages,
});

// Geminiæ ¼å¼
const geminiResult = await buildPrompt({
  promptId: 1,
  options: { apiFormat: 'gemini' },
});

await genAI.getGenerativeModel({ model: 'gemini-pro' }).generateContent({
  systemInstruction: geminiResult.result.systemInstruction,
  contents: geminiResult.result.contents,
});
```

### 5.4 é«˜çº§Tokené¢„ç®—ç®¡ç†

**åœºæ™¯**ï¼šç²¾ç¡®æ§åˆ¶Tokenåˆ†é…ï¼Œä¼˜åŒ–æˆæœ¬å’Œæ€§èƒ½ã€‚

```typescript
// åŠ¨æ€è°ƒæ•´çš„é¢„ç®—é…ç½®
const result = await axios.post('/api/v1/prompts/build', {
  promptId: 1,
  userInput: 'ç»§ç»­å†™ä¸‹å»',
  history: conversationHistory,
  options: {
    tokenBudget: {
      total: 8192,
      
      // ä¸–ç•Œä¹¦é¢„ç®—ï¼ˆä¸‰ç§æ–¹å¼ï¼‰
      worldBookRatio: 0.25,         // æ–¹å¼1: ç™¾åˆ†æ¯”
      // worldBookBudget: 1024,     // æ–¹å¼2: å›ºå®šå€¼
      worldBookBudgetMin: 800,      // æ–¹å¼3: åŠ¨æ€è°ƒæ•´
      worldBookBudgetMax: 2048,
      
      // æ¿€æ´»æ§åˆ¶
      minActivations: 5,            // æœ€å°æ¿€æ´»5ä¸ªç»„ä»¶
      allowBudgetExpand: true,      // å…è®¸é¢„ç®—æ‰©å±•
      maxExpandTimes: 3,            // æœ€å¤šæ‰©å±•3æ¬¡
      
      // åˆ†é…ç­–ç•¥
      budgetPriority: 'relevance',  // æŒ‰ç›¸å…³æ€§è¯„åˆ†
      // 'order'                    // æŒ‰orderæ’åºï¼ˆé»˜è®¤ï¼‰
      // 'activation_order'         // æŒ‰æ¿€æ´»é¡ºåº
      // 'token_efficiency'         // æŒ‰Tokenæ•ˆç‡
      
      // å…¶ä»–é…ç½®
      protectedHistoryCount: 10,    // ä¿æŠ¤æœ€è¿‘10æ¡
      safetyMargin: 150,            // å®‰å…¨è¾¹ç•Œ
    },
  },
});

// æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡
console.log(result.data.stats.budgetDetails);
// {
//   allocatable: 7500,
//   worldBookBudget: 1875,
//   used: 7200,
//   remaining: 992,
//   percentage: 87.8
// }

console.log(result.data.stats.activationDetails);
// {
//   totalCandidates: 15,
//   activated: 10,
//   skippedBudget: 3,
//   ignoredBudget: 2
// }

// é¢„ç®—æ‰©å±•ä¿¡æ¯
if (result.data.stats.expansionInfo?.expanded) {
  console.log(result.data.stats.expansionInfo);
  // {
  //   expanded: true,
  //   times: 2,
  //   originalBudget: 8192,
  //   finalBudget: 9965
  // }
}
```

**é¢„ç®—åˆ†é…ç­–ç•¥è¯´æ˜**ï¼š

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `order` | æŒ‰orderå­—æ®µå‡åºæ’åº | æ‰‹åŠ¨è®¾ç½®ä¼˜å…ˆçº§ï¼Œæœ€å¸¸ç”¨ |
| `activation_order` | æŒ‰æ‰«æåˆ°çš„å…ˆåé¡ºåº | å¯¹è¯æµç•…æ€§ä¼˜å…ˆï¼Œå‰§æƒ…æ¨è¿› |
| `token_efficiency` | æŒ‰åŒ¹é…æ¬¡æ•°/Tokenæ¯”ç‡ | é¢„ç®—ç´§å¼ ï¼Œè¿½æ±‚æ•ˆç‡ |
| `relevance` | ç»¼åˆè¯„åˆ†ï¼ˆåŒ¹é…æ¬¡æ•°+åŠ åˆ†é¡¹ï¼‰ | æ™ºèƒ½æ’åºï¼Œå¤šå› ç´ è€ƒè™‘ |

**å¼ºåˆ¶æ¿€æ´»ï¼ˆignoreBudgetï¼‰**ï¼š

æŸäº›ç»„ä»¶å¯ä»¥è®¾ç½®`ignoreBudget: true`ï¼Œå¼ºåˆ¶æ¿€æ´»ä¸”ä¸è®¡å…¥é¢„ç®—ï¼š

```typescript
// åœ¨æç¤ºè¯å†…å®¹ä¸­æ ‡è®°
{
  "name": "æ ¸å¿ƒä¸–ç•Œè§‚",
  "role": "system",
  "content": "ä¸–ç•ŒåŸºç¡€è®¾å®š...",
  "ignoreBudget": true  // æ ‡è®°ä¸ºå¼ºåˆ¶æ¿€æ´»
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ `ignoreBudget`æ¡ç›®å»ºè®®ä¸è¶…è¿‡3ä¸ª
- âš ï¸ è¿‡å¤šä¼šå¯¼è‡´æ€»Tokenè¶…é™
- âœ… é€‚ç”¨äºæ ¸å¿ƒä¸–ç•Œè§‚ã€å…³é”®è§„åˆ™ç­‰å¿…éœ€å†…å®¹

---

## å…­ã€è°ƒè¯•åŠŸèƒ½

å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆ`debug: true`ï¼‰å¯è·å–é¢å¤–ä¿¡æ¯ï¼š

```json
{
  "result": { ... },
  "stats": { ... },
  "debug": {
    "components": 15,
    "bucket": {
      "systemPrompts": { "count": 1, "tokens": 300 },
      "beforeChar": { "count": 2, "tokens": 200 },
      "charDef": { "count": 3, "tokens": 500 },
      "afterChar": { "count": 1, "tokens": 150 },
      "history": { "count": 8, "tokens": 1200 }
    },
    "messages": 15
  }
}
```

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹

### 7.1 æƒé™è¦æ±‚

- æ‰€æœ‰æ„å»ºæ¥å£éœ€è¦`prompt:build`æƒé™
- ç”¨æˆ·å¿…é¡»ç™»å½•å¹¶é€šè¿‡JWTè®¤è¯
- å»ºè®®ä¸ºä¸åŒç”¨æˆ·ç»„è®¾ç½®ä¸åŒçš„Tokené¢„ç®—é™åˆ¶

### 7.2 æ€§èƒ½ä¼˜åŒ–

- Tokenä¼°ç®—æ˜¯CPUå¯†é›†å‹æ“ä½œï¼Œå¤§é‡è¯·æ±‚æ—¶è€ƒè™‘ç¼“å­˜
- å¯¹äºç›¸åŒçš„promptIdå’Œå‚æ•°ï¼Œå¯ä»¥ç¼“å­˜æ„å»ºç»“æœ
- å»ºè®®è®¾ç½®åˆç†çš„Tokené¢„ç®—ï¼Œé¿å…è¿‡å¤§çš„æ¶ˆæ¯æ•°ç»„

### 7.3 æœ€ä½³å®è·µ

1. **å‚æ•°å‘½å**: ä½¿ç”¨æ¸…æ™°çš„å‚æ•°åï¼Œå¦‚`{{user_name}}`è€Œä¸æ˜¯`{{n}}`
2. **Tokené¢„ç®—**: æ ¹æ®ç›®æ ‡æ¨¡å‹è®¾ç½®åˆç†é¢„ç®—ï¼ˆå¦‚GPT-4: 8192ï¼‰
3. **å†å²ä¿æŠ¤**: ä¿æŠ¤è¶³å¤Ÿçš„æœ€è¿‘å†å²ï¼ˆå»ºè®®5-10æ¡ï¼‰
4. **æ ¼å¼é€‰æ‹©**: æ ¹æ®å®é™…ä½¿ç”¨çš„æ¨¡å‹é€‰æ‹©æ­£ç¡®çš„apiFormat

---

## å…«ã€æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-23)

**æ–°å¢**:
- âœ… å®Œæ•´çš„å…­é˜¶æ®µæ„å»ºæµç¨‹
- âœ… æ”¯æŒOpenAIã€Claudeã€Geminiä¸‰ç§æ ¼å¼
- âœ… æ™ºèƒ½Tokenç®¡ç†å’Œè£å‰ª
- âœ… å‚æ•°æ›¿æ¢åŠŸèƒ½ï¼ˆ{{å‚æ•°å}}ï¼‰
- âœ… æ·±åº¦æ³¨å…¥æ”¯æŒ
- âœ… è°ƒè¯•æ¨¡å¼

**å¾…å¼€å‘**:
- ğŸ”„ ä¸–ç•Œä¹¦æ¿€æ´»åŠŸèƒ½ï¼ˆenableWorldBookï¼‰
- ğŸ”„ é€’å½’æ‰«æä¸–ç•Œä¹¦
- ğŸ”„ é›†æˆtiktokenè¿›è¡Œç²¾ç¡®Tokenè®¡ç®—
- ğŸ”„ ç¼“å­˜æœºåˆ¶

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [æç¤ºè¯æ„å»ºå¼•æ“åŸç†](../docs/æç¤ºè¯æ„å»ºå¼•æ“åŸç†.md) - è¯¦ç»†çš„ç†è®ºè¯´æ˜
- [06-æç¤ºè¯ç®¡ç†.md](./06-æç¤ºè¯ç®¡ç†.md) - æç¤ºè¯CRUDæ¥å£
- [99-é€šç”¨è§„èŒƒ.md](./99-é€šç”¨è§„èŒƒ.md) - APIé€šç”¨è§„èŒƒ
