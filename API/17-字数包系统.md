# 17. 字数包系统 API

## 概述

字数包系统提供 AI 字数购买、余额管理、消费记录等功能。

**模块路径**: 
- 字数包: `backend/src/token-packages/`
- 余额管理: `backend/src/token-balances/`

---

## 字数包管理

### 1. 创建字数包

**接口**: `POST /api/v1/token-packages`

**权限**: `token:package:create`

**请求体**:
```json
{
  "name": "大包50万字",
  "tokenAmount": 500000,
  "bonusTokens": 50000,
  "price": 49.90,
  "validDays": 365,
  "minMemberLevel": 0,
  "discount": 1.0,
  "sort": 1,
  "description": "超值字数包，赠送10%"
}
```

**响应**:
```json
{
  "id": 1,
  "name": "大包50万字",
  "tokenAmount": 500000,
  "bonusTokens": 50000,
  "price": 49.90,
  "validDays": 365,
  "minMemberLevel": 0,
  "discount": 1.0,
  "isActive": true,
  "sort": 1,
  "description": "超值字数包，赠送10%",
  "createdAt": "2025-01-26T10:00:00.000Z",
  "updatedAt": "2025-01-26T10:00:00.000Z"
}
```

---

### 2. 查询字数包列表

**接口**: `GET /api/v1/token-packages`

**认证**: 公开接口（无需登录）

**查询参数**:
- `isActive` (boolean, 可选): 是否上架

**响应**: 数组格式

---

### 3. 获取字数包详情

**接口**: `GET /api/v1/token-packages/:id`

**认证**: 公开接口（无需登录）

---

### 4. 更新字数包

**接口**: `PUT /api/v1/token-packages/:id`

**权限**: `token:package:update`

---

### 5. 删除字数包

**接口**: `DELETE /api/v1/token-packages/:id`

**权限**: `token:package:delete`

---

### 6. 上架/下架字数包

**接口**: 
- 上架: `POST /api/v1/token-packages/:id/activate`
- 下架: `POST /api/v1/token-packages/:id/deactivate`

**权限**: `token:package:update`

---

## 字数余额管理

### 7. 查询我的字数余额

**接口**: `GET /api/v1/token-balances/my`

**认证**: 必需

**响应**:
```json
{
  "id": 1,
  "userId": 10,
  "totalTokens": 1500000,
  "usedTokens": 200000,
  "giftTokens": 100000,
  "frozenTokens": 0,
  "lastConsumedAt": "2025-01-26T10:30:00.000Z",
  "createdAt": "2025-01-20T08:00:00.000Z",
  "updatedAt": "2025-01-26T10:30:00.000Z"
}
```

**字段说明**:
- `totalTokens`: 总余额（可用 + 冻结）
- `usedTokens`: 累计已使用字数
- `giftTokens`: 赠送字数余额（包含在 totalTokens 中）
- `frozenTokens`: 冻结字数（退款待处理等）
- **可用字数** = `totalTokens - frozenTokens`

---

### 8. 查询我的字数流水

**接口**: `GET /api/v1/token-balances/my/transactions`

**认证**: 必需

**查询参数**:
- `type` (enum, 可选): 流水类型
  - `recharge`: 充值
  - `consume`: 消费
  - `refund`: 退款
  - `expire`: 过期
  - `gift`: 赠送
- `page` (number, 可选, 默认: 1)
- `limit` (number, 可选, 默认: 20)

**响应**:
```json
{
  "data": [
    {
      "id": 101,
      "userId": 10,
      "type": "consume",
      "amount": -2500,
      "balanceBefore": 1502500,
      "balanceAfter": 1500000,
      "source": "ai-chat",
      "relatedId": 456,
      "modelName": "gpt-4",
      "remark": null,
      "createdAt": "2025-01-26T10:30:00.000Z"
    },
    {
      "id": 100,
      "userId": 10,
      "type": "recharge",
      "amount": 550000,
      "balanceBefore": 952500,
      "balanceAfter": 1502500,
      "source": "purchase",
      "relatedId": 123,
      "modelName": null,
      "remark": "购买字数包：大包50万字",
      "createdAt": "2025-01-26T09:00:00.000Z"
    }
  ],
  "total": 25,
  "page": 1,
  "limit": 20,
  "totalPages": 2
}
```

---

## 字数扣费规则

**优先级**:
1. 先扣除赠送字数 (`giftTokens`)
2. 再扣除购买字数 (`totalTokens - giftTokens`)

**示例**:
```
余额: totalTokens = 1000, giftTokens = 200
消费: 300 tokens

扣费顺序:
1. 先扣赠送: 200 tokens (giftTokens = 0)
2. 再扣购买: 100 tokens
最终: totalTokens = 700, giftTokens = 0
```

---

## 字数过期策略

- `validDays = 0`: 永久有效
- `validDays > 0`: 购买后 N 天过期
- 过期字数自动清零，记录 `expire` 类型流水

---

## 错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 充值/消费数量必须大于0 / 字数余额不足 / 字数包已下架 |
| 404 | 字数包不存在 / 用户余额记录不存在 |

---

**更新时间**: 2025-01-26  
**版本**: v1.0
