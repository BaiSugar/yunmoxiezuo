# 23. é‚€è¯·ç ç³»ç»Ÿ API

## æ¦‚è¿°

é‚€è¯·ç ç³»ç»Ÿå…è®¸ç”¨æˆ·é€šè¿‡åˆ†äº«é‚€è¯·ç é‚€è¯·æ–°ç”¨æˆ·æ³¨å†Œï¼ŒåŒæ–¹éƒ½å¯è·å¾—å­—æ•°å¥–åŠ±ã€‚

**æ¨¡å—è·¯å¾„**: `backend/src/users/` (é›†æˆåœ¨ç”¨æˆ·æ¨¡å—ä¸­)

---

## é‚€è¯·è§„åˆ™

### å¥–åŠ±æœºåˆ¶

| è§’è‰²     | å¥–åŠ±å­—æ•°  | è¯´æ˜                           |
| -------- | --------- | ------------------------------ |
| è¢«é‚€è¯·äºº | 80,000 å­— | é€šè¿‡é‚€è¯·ç æ³¨å†Œçš„æ–°ç”¨æˆ·         |
| é‚€è¯·äºº   | 8,000 å­—  | é‚€è¯·ç è¢«ä½¿ç”¨åï¼Œé‚€è¯·äººè·å¾—å¥–åŠ± |

### é™åˆ¶è§„åˆ™

- âœ… æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰å”¯ä¸€çš„é‚€è¯·ç ï¼ˆæ ¼å¼ï¼š`INV + ç”¨æˆ·ID(6ä½) + éšæœº4ä½`ï¼‰
- âœ… æ¯ä¸ªç”¨æˆ·åªèƒ½è¢«é‚€è¯·ä¸€æ¬¡ï¼ˆä¸å¯é‡å¤ä½¿ç”¨é‚€è¯·ç ï¼‰
- âŒ ä¸èƒ½ä½¿ç”¨è‡ªå·±çš„é‚€è¯·ç 
- âœ… é‚€è¯·ç åœ¨ç”¨æˆ·æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç”Ÿæˆ
- âœ… å¥–åŠ±åœ¨æ³¨å†ŒæˆåŠŸåç«‹å³å‘æ”¾

---

## ä¸€ã€æ³¨å†Œæ—¶ä½¿ç”¨é‚€è¯·ç 

### 1.1 æ³¨å†Œæ¥å£

**æ¥å£**: `POST /api/v1/auth/register`

**æƒé™**: å…¬å¼€æ¥å£ï¼ˆæ— éœ€ç™»å½•ï¼‰

**è¯·æ±‚ä½“**:

```json
{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "Password123!",
  "confirmPassword": "Password123!",
  "nickname": "å°æ˜",
  "inviteCode": "INV0000011A2B"
}
```

**å­—æ®µè¯´æ˜**:

- `inviteCode` (å¯é€‰): é‚€è¯·äººçš„é‚€è¯·ç 

**å“åº”**:

```json
{
  "accessToken": "eyJhbGc...",
  "refreshToken": "eyJhbGc...",
  "expiresIn": 3600,
  "user": {
    "id": 123,
    "email": "john@example.com",
    "username": "johndoe",
    "nickname": "å°æ˜",
    "inviteCode": "INV0001231X9Z",
    "invitedByCode": "INV0000011A2B",
    "roles": ["user"]
  }
}
```

### 1.2 é‚€è¯·ç éªŒè¯

æ³¨å†Œæ—¶å¦‚æœæä¾›äº†é‚€è¯·ç ï¼Œç³»ç»Ÿä¼šï¼š

1. âœ… éªŒè¯é‚€è¯·ç æ˜¯å¦å­˜åœ¨
2. âœ… æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„é‚€è¯·ç ï¼ˆä¸å…è®¸ï¼‰
3. âœ… æ£€æŸ¥æ˜¯å¦å·²ç»ä½¿ç”¨è¿‡é‚€è¯·ç ï¼ˆæ¯äººåªèƒ½è¢«é‚€è¯·ä¸€æ¬¡ï¼‰
4. âœ… åˆ›å»ºé‚€è¯·è®°å½•
5. âœ… è‡ªåŠ¨å‘æ”¾å¥–åŠ±ç»™åŒæ–¹

**é”™è¯¯æƒ…å†µ**:

| çŠ¶æ€ç  | é”™è¯¯ä¿¡æ¯             | è¯´æ˜               |
| ------ | -------------------- | ------------------ |
| 400    | é‚€è¯·ç æ— æ•ˆ           | é‚€è¯·ç ä¸å­˜åœ¨       |
| 400    | ä¸èƒ½ä½¿ç”¨è‡ªå·±çš„é‚€è¯·ç  | é˜²æ­¢ä½œå¼Š           |
| 400    | è¯¥è´¦æˆ·å·²ä½¿ç”¨è¿‡é‚€è¯·ç  | æ¯äººåªèƒ½è¢«é‚€è¯·ä¸€æ¬¡ |

---

## äºŒã€æŸ¥è¯¢æˆ‘çš„é‚€è¯·ä¿¡æ¯

### 2.1 è·å–ä¸ªäººä¿¡æ¯ï¼ˆåŒ…å«é‚€è¯·ç ï¼‰

**æ¥å£**: `GET /api/v1/users/me`

**æƒé™**: éœ€è¦ç™»å½•

**å“åº”**:

```json
{
  "id": 123,
  "username": "johndoe",
  "email": "john@example.com",
  "nickname": "å°æ˜",
  "inviteCode": "INV0001231X9Z",
  "invitedByCode": "INV0000011A2B",
  "status": "active",
  "emailVerified": true,
  "createdAt": "2025-10-28T10:00:00Z",
  "roles": [...]
}
```

---

## ä¸‰ã€æ•°æ®åº“è¡¨ç»“æ„

### 3.1 users è¡¨æ–°å¢å­—æ®µ

```sql
ALTER TABLE `users`
ADD COLUMN `invite_code` VARCHAR(20) NULL COMMENT 'æˆ‘çš„é‚€è¯·ç ï¼ˆå”¯ä¸€ï¼‰',
ADD COLUMN `invited_by_code` VARCHAR(20) NULL COMMENT 'æ³¨å†Œæ—¶ä½¿ç”¨çš„é‚€è¯·ç ',
ADD UNIQUE INDEX `idx_invite_code` (`invite_code`),
ADD INDEX `idx_invited_by_code` (`invited_by_code`);
```

### 3.2 user_invitations é‚€è¯·è®°å½•è¡¨

è®°å½•æ‰€æœ‰é‚€è¯·å…³ç³»å’Œå¥–åŠ±å‘æ”¾æƒ…å†µï¼š

```sql
CREATE TABLE `user_invitations` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `inviter_id` INT NOT NULL COMMENT 'é‚€è¯·äººID',
  `invitee_id` INT NOT NULL COMMENT 'è¢«é‚€è¯·äººID',
  `invite_code` VARCHAR(20) NOT NULL COMMENT 'ä½¿ç”¨çš„é‚€è¯·ç ',
  `inviter_reward` INT NOT NULL DEFAULT 8000 COMMENT 'é‚€è¯·äººå¥–åŠ±',
  `invitee_reward` INT NOT NULL DEFAULT 80000 COMMENT 'è¢«é‚€è¯·äººå¥–åŠ±',
  `inviter_rewarded` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'é‚€è¯·äººå¥–åŠ±å·²å‘æ”¾',
  `invitee_rewarded` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'è¢«é‚€è¯·äººå¥–åŠ±å·²å‘æ”¾',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX (`inviter_id`),
  INDEX (`invitee_id`),
  UNIQUE KEY (`invitee_id`)
);
```

**å…³é”®çº¦æŸ**:

- `UNIQUE(invitee_id)` - ä¿è¯æ¯ä¸ªç”¨æˆ·åªèƒ½è¢«é‚€è¯·ä¸€æ¬¡

---

## å››ã€é‚€è¯·ç æ ¼å¼

### æ ¼å¼è§„åˆ™

```
8ä½éšæœºå¤§å†™å­—æ¯+æ•°å­—ç»„åˆ
- è‡³å°‘ 3 ä¸ªå­—æ¯
- è‡³å°‘ 2 ä¸ªæ•°å­—
- éšæœºæ‰“ä¹±é¡ºåº
```

**ç¤ºä¾‹**:

- `A2BC9XYZ`
- `K1M2N3PQ`
- `XY89ABCD`

**ç”Ÿæˆè§„åˆ™**:

1. âœ… å…ˆç”Ÿæˆ 3 ä¸ªéšæœºå­—æ¯ï¼ˆç¡®ä¿ä¸ä¼šåªæœ‰ 1-2 ä¸ªå­—æ¯ï¼‰
2. âœ… å†ç”Ÿæˆ 2 ä¸ªéšæœºæ•°å­—ï¼ˆç¡®ä¿ä¸ä¼šæ˜¯çº¯å­—æ¯ï¼‰
3. âœ… å‰©ä½™ 3 ä½ä»å­—æ¯å’Œæ•°å­—ä¸­éšæœºé€‰æ‹©
4. âœ… å°†æ‰€æœ‰å­—ç¬¦éšæœºæ‰“ä¹±é¡ºåº

**ç‰¹ç‚¹**:

- âœ… å…¨å±€å”¯ä¸€ï¼ˆæ•°æ®åº“å”¯ä¸€çº¦æŸï¼‰
- âœ… å¯è¯»æ€§å¼ºï¼ˆé¿å…çº¯æ•°å­—ï¼‰
- âœ… é˜²æ­¢ç¢°æ’ï¼ˆ36^8 = 2.8 ä¸‡äº¿ç§ç»„åˆï¼‰
- âœ… å­—æ¯æ•°å­—åˆ†å¸ƒåˆç†ï¼ˆä¸ä¼šå‡ºç°çº¯æ•°å­—æˆ–åªæœ‰ 1-2 ä¸ªå­—æ¯ï¼‰

---

## äº”ã€ç»Ÿè®¡æŸ¥è¯¢

### 5.1 æŸ¥è¯¢æˆ‘çš„é‚€è¯·ç»Ÿè®¡ï¼ˆè§†å›¾ï¼‰

```sql
SELECT * FROM v_user_invitation_stats WHERE user_id = 123;
```

**è¿”å›å­—æ®µ**:

- `total_invitations` - æ€»é‚€è¯·äººæ•°
- `total_rewards` - ç´¯è®¡è·å¾—å¥–åŠ±
- `rewarded_count` - å·²å‘æ”¾å¥–åŠ±æ•°é‡
- `invited_by_username` - é‚€è¯·æˆ‘çš„äºº

### 5.2 æŸ¥è¯¢æˆ‘é‚€è¯·çš„æ‰€æœ‰äºº

```sql
SELECT
  inv.id,
  invitee.username,
  invitee.email,
  inv.inviter_reward,
  inv.created_at
FROM user_invitations inv
JOIN users invitee ON inv.invitee_id = invitee.id
WHERE inv.inviter_id = 123
ORDER BY inv.created_at DESC;
```

### 5.3 é‚€è¯·æ’è¡Œæ¦œ

```sql
SELECT
  u.username,
  u.invite_code,
  COUNT(inv.id) AS invitation_count,
  SUM(inv.inviter_reward) AS total_rewards
FROM users u
LEFT JOIN user_invitations inv ON u.id = inv.inviter_id
GROUP BY u.id
ORDER BY invitation_count DESC
LIMIT 10;
```

---

## å…­ã€å‰ç«¯é›†æˆ

### 6.1 æ³¨å†Œé¡µé¢

**URL æ ¼å¼**:

```
https://your-domain.com/register?inviteCode=INV0000011A2B
```

**åŠŸèƒ½**:

- è‡ªåŠ¨ä» URL å‚æ•°è¯»å–é‚€è¯·ç å¹¶å¡«å……åˆ°è¡¨å•
- æ‰‹åŠ¨è¾“å…¥é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰
- æ˜¾ç¤ºé‚€è¯·å¥–åŠ±æç¤º

### 6.2 ä¸ªäººè®¾ç½® - æˆ‘çš„é‚€è¯·ç 

åœ¨ `ä¸ªäººè®¾ç½® > åŸºæœ¬ä¿¡æ¯` Tab ä¸­æ˜¾ç¤ºï¼š

- ğŸ“‹ æ˜¾ç¤ºæˆ‘çš„é‚€è¯·ç 
- ğŸ”— ä¸€é”®å¤åˆ¶é‚€è¯·ç 
- ğŸ”— ä¸€é”®å¤åˆ¶é‚€è¯·é“¾æ¥
- ğŸ“Š æ˜¾ç¤ºå¥–åŠ±è¯´æ˜

---

## ä¸ƒã€ä¸šåŠ¡æµç¨‹

### æ³¨å†Œæµç¨‹ï¼ˆå¸¦é‚€è¯·ç ï¼‰

```
1. ç”¨æˆ·Aåˆ†äº«é‚€è¯·é“¾æ¥ç»™ç”¨æˆ·B
   â†“
2. ç”¨æˆ·Bç‚¹å‡»é“¾æ¥è®¿é—®æ³¨å†Œé¡µé¢
   â†“
3. URLå‚æ•°è‡ªåŠ¨å¡«å……é‚€è¯·ç åˆ°è¡¨å•
   â†“
4. ç”¨æˆ·Bå®Œæˆæ³¨å†Œ
   â†“
5. åç«¯éªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§
   â†“
6. åˆ›å»ºç”¨æˆ·è´¦å·
   â†“
7. ç”Ÿæˆç”¨æˆ·Bè‡ªå·±çš„é‚€è¯·ç 
   â†“
8. å‘æ”¾æ³¨å†Œå¥–åŠ±ï¼ˆ50ä¸‡å­—ï¼‰
   â†“
9. åˆ›å»ºé‚€è¯·è®°å½•
   â†“
10. å‘æ”¾é‚€è¯·å¥–åŠ±ï¼š
    - ç”¨æˆ·B: +80,000 å­—
    - ç”¨æˆ·A: +8,000 å­—
```

### å¥–åŠ±å‘æ”¾è®°å½•

æ‰€æœ‰å¥–åŠ±éƒ½ä¼šè®°å½•åœ¨ `token_transactions` è¡¨ä¸­ï¼š

```sql
-- æŸ¥çœ‹é‚€è¯·å¥–åŠ±è®°å½•
SELECT * FROM token_transactions
WHERE source = 'invite_reward'
AND user_id = 123;
```

---

## å…«ã€å®‰å…¨è€ƒè™‘

### é˜²ä½œå¼Šæœºåˆ¶

1. **ä¸€æ¬¡æ€§ä½¿ç”¨**: æ¯ä¸ªç”¨æˆ·åªèƒ½è¢«é‚€è¯·ä¸€æ¬¡ï¼ˆæ•°æ®åº“å”¯ä¸€çº¦æŸï¼‰
2. **ä¸èƒ½è‡ªé‚€**: ä¸å…è®¸ä½¿ç”¨è‡ªå·±çš„é‚€è¯·ç 
3. **äº‹åŠ¡ä¿è¯**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿å¥–åŠ±å‘æ”¾çš„åŸå­æ€§
4. **é‡å¤æ£€æŸ¥**: å‘æ”¾å¥–åŠ±å‰æ£€æŸ¥æ˜¯å¦å·²å‘æ”¾

### å¼‚å¸¸å¤„ç†

- é‚€è¯·å¥–åŠ±å‘æ”¾å¤±è´¥**ä¸å½±å“**æ³¨å†Œæµç¨‹
- å¤±è´¥ä¿¡æ¯ä¼šè®°å½•åœ¨æ—¥å¿—ä¸­
- ç®¡ç†å‘˜å¯ä»¥é€šè¿‡åå°è¡¥å‘å¥–åŠ±

---

## ä¹ã€ç›¸å…³æ–‡ä»¶

### åç«¯

- `backend/sql/add-invite-system.sql` - æ•°æ®åº“è„šæœ¬
- `backend/src/users/entities/user.entity.ts` - ç”¨æˆ·å®ä½“
- `backend/src/users/entities/user-invitation.entity.ts` - é‚€è¯·è®°å½•å®ä½“
- `backend/src/auth/auth.service.ts` - æ³¨å†Œé€»è¾‘
- `backend/src/auth/dto/register.dto.ts` - æ³¨å†Œ DTO

### å‰ç«¯

- `frontend/src/pages/auth/Register.tsx` - æ³¨å†Œé¡µé¢
- `frontend/src/components/settings/UserSettingsModal.tsx` - ä¸ªäººè®¾ç½®
- `frontend/src/types/index.ts` - ç±»å‹å®šä¹‰

---

## åã€ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç”¨æˆ·åˆ†äº«é‚€è¯·é“¾æ¥

```javascript
// ç”Ÿæˆé‚€è¯·é“¾æ¥
const inviteLink = `${window.location.origin}/register?inviteCode=${user.inviteCode}`;

// å¤åˆ¶åˆ°å‰ªè´´æ¿
navigator.clipboard.writeText(inviteLink);
```

### ç¤ºä¾‹ 2ï¼šæŸ¥è¯¢é‚€è¯·ç»Ÿè®¡

```sql
-- æŸ¥è¯¢ç”¨æˆ·123çš„é‚€è¯·ç»Ÿè®¡
SELECT
  COUNT(*) AS total_invitations,
  SUM(inviter_reward) AS total_rewards
FROM user_invitations
WHERE inviter_id = 123 AND inviter_rewarded = 1;
```

---

**æ›´æ–°æ—¶é—´**: 2025-10-28  
**ç‰ˆæœ¬**: v1.0
