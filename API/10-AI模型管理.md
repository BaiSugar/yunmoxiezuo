# 10 - AI 模型管理 API

## 概述

AI 模型管理系统提供统一的接口管理多种 AI 提供商和模型，支持智能参数适配和聊天补全功能。

**模块路径**: `backend/src/ai-models/`

## 1. AI 提供商管理

### 1.1 创建提供商

**接口**: `POST /api/v1/ai-providers`

**权限**: `ai:provider:create`

**请求体**:

```json
{
  "name": "openai-main",
  "source": "openai",
  "displayName": "OpenAI 主账号",
  "description": "OpenAI API 主账号",
  "status": "active",
  "config": {
    "baseUrl": "https://api.openai.com/v1",
    "authType": "bearer",
    "timeout": 30000,
    "maxRetries": 3,
    "rateLimit": {
      "requestsPerMinute": 500,
      "tokensPerMinute": 150000
    }
  },
  "capabilities": {
    "supportedParameters": [
      "temperature",
      "max_tokens",
      "top_p",
      "frequency_penalty"
    ],
    "maxTokens": 128000,
    "supportsStreaming": true,
    "supportsTools": true,
    "supportsJsonSchema": true,
    "supportsVision": true,
    "supportsWebSearch": false,
    "supportsThinking": false
  },
  "apiKey": "sk-xxx",
  "isDefault": true,
  "order": 0
}
```

**响应**: 201 Created

### 1.2 获取所有提供商

**接口**: `GET /api/v1/ai-providers`

**权限**: `ai:provider:read`

**响应**: 200 OK

```json
[
  {
    "id": 1,
    "name": "openai-main",
    "source": "openai",
    "displayName": "OpenAI 主账号",
    "description": "OpenAI API 主账号",
    "status": "active",
    "config": {...},
    "capabilities": {...},
    "isDefault": true,
    "order": 0,
    "createdAt": "2025-01-23T10:00:00Z",
    "updatedAt": "2025-01-23T10:00:00Z",
    "models": [...]
  }
]
```

### 1.3 获取活跃提供商

**接口**: `GET /api/v1/ai-providers/active`

**权限**: `ai:provider:read`

**说明**: 只返回状态为 `active` 的提供商

### 1.4 获取默认提供商

**接口**: `GET /api/v1/ai-providers/default`

**权限**: `ai:provider:read`

**说明**: 返回设置为默认的提供商

### 1.5 获取单个提供商

**接口**: `GET /api/v1/ai-providers/:id`

**权限**: `ai:provider:read`

**参数**:

- `id` (path): 提供商 ID

### 1.6 更新提供商

**接口**: `PUT /api/v1/ai-providers/:id`

**权限**: `ai:provider:update`

**请求体**: 与创建相同，所有字段可选

### 1.7 删除提供商

**接口**: `DELETE /api/v1/ai-providers/:id`

**权限**: `ai:provider:delete`

**响应**: 204 No Content

**注意**: 如果提供商下有模型，无法删除

### 1.8 测试提供商连接

**接口**: `POST /api/v1/ai-providers/:id/test`

**权限**: `ai:provider:test`

**响应**: 200 OK

```json
{
  "success": true,
  "message": "连接成功"
}
```

## 2. AI 模型管理

### 2.1 创建模型

**接口**: `POST /api/v1/ai-models`

**权限**: `ai:model:create`

**请求体**:

```json
{
  "modelId": "gpt-4-turbo",
  "displayName": "GPT-4 Turbo",
  "description": "最新的 GPT-4 Turbo 模型",
  "status": "active",
  "providerId": 1,
  "categoryId": 1,
  "baseUrl": "https://api.openai.com/v1",
  "apiKey": "sk-xxx",
  "version": "2024-01",
  "contextWindow": 128000,
  "maxOutputTokens": 4096,
  "pricing": {
    "inputTokenPrice": 0.01,
    "outputTokenPrice": 0.03,
    "currency": "USD"
  },
  "limits": {
    "maxInputTokens": 128000,
    "maxOutputTokens": 4096,
    "rateLimit": {
      "requestsPerMinute": 500,
      "tokensPerMinute": 150000
    }
  },
  "features": ["chat", "reasoning", "vision"],
  "supportsStreaming": true,
  "supportsTools": true,
  "supportsVision": true,
  "isDefault": true,
  "order": 0
}
```

**响应**: 201 Created

### 2.2 获取所有模型

**接口**: `GET /api/v1/ai-models`

**权限**: `ai:model:read`

### 2.3 获取活跃模型

**接口**: `GET /api/v1/ai-models/active`

**权限**: `ai:model:read`

### 2.3.1 获取活跃模型（基础信息）

**接口**: `GET /api/v1/ai-models/active/basic`

**权限**: `ai:model:read`

**说明**:

- 返回前端模型选择器所需的精简字段，不包含敏感配置
- 每个模型附带所属分类信息，前端会按分类分组展示

**响应**: 200 OK

```json
[
  {
    "id": 1,
    "displayName": "GPT-4o",
    "description": "综合型旗舰模型",
    "isDefault": true,
    "providerId": 1,
    "providerName": "OpenAI 主账号",
    "categoryId": 2,
    "categoryName": "长篇创作",
    "categoryIcon": "📖",
    "categoryDescription": "适合长篇内容与世界观创作",
    "categoryOrder": 20,
    "isFree": false,
    "inputRatio": 1.0,
    "outputRatio": 1.0
  }
]
```

### 2.3.2 测试模型连接

**接口**: `POST /api/v1/ai-models/test-connection`

**权限**: `ai:model:update`

**说明**:

- 后台模型配置界面可使用该接口实时检测连接是否可用
- `baseUrl`、`apiKey` 为可选字段，填写后将优先使用模型级配置；未填写则回退到提供商的默认配置
- 接口会以最小开销的对话请求（`max_tokens = 1`）验证 `modelId` 是否可用

**请求体**:

```json
{
  "providerId": 1,
  "modelId": "gpt-4o-mini",
  "baseUrl": "https://api.openai.com/v1",
  "apiKey": "sk-xxx"
}
```

**响应**:

```json
{
  "success": true,
  "message": "连接成功"
}
```

> ⚠️ 如果连接失败会返回 400，并在 `message` 中包含详细原因（如认证失败、域名解析失败、超时等）。

### 2.4 获取默认模型

**接口**: `GET /api/v1/ai-models/default`

**权限**: `ai:model:read`

### 2.5 获取指定提供商的模型

**接口**: `GET /api/v1/ai-models/provider/:providerId`

**权限**: `ai:model:read`

**参数**:

- `providerId` (path): 提供商 ID

### 2.6 获取指定分类的模型

**接口**: `GET /api/v1/ai-models/category/:categoryId`

**权限**: `ai:model:read`

**参数**:

- `categoryId` (path): 分类 ID

### 2.7 根据特性查询模型

**接口**: `GET /api/v1/ai-models/features?features=chat,vision`

**权限**: `ai:model:read`

**参数**:

- `features` (query): 特性列表，逗号分隔

### 2.8 获取单个模型

**接口**: `GET /api/v1/ai-models/:id`

**权限**: `ai:model:read`

### 2.9 更新模型

**接口**: `PUT /api/v1/ai-models/:id`

**权限**: `ai:model:update`

**请求体**: 与创建相同，所有字段可选。可以传入 `categoryId: null` 来移除分类。

### 2.10 删除模型

**接口**: `DELETE /api/v1/ai-models/:id`

**权限**: `ai:model:delete`

**响应**: 204 No Content

### 2.11 批量导入模型

**接口**: `POST /api/v1/ai-models/provider/:providerId/bulk-import`

**权限**: `ai:model:create`

**请求体**:

```json
[
  {
    "modelId": "gpt-4",
    "displayName": "GPT-4",
    ...
  },
  {
    "modelId": "gpt-3.5-turbo",
    "displayName": "GPT-3.5 Turbo",
    ...
  }
]
```

## 3. 模型分类管理

### 3.1 创建分类

**接口**: `POST /api/v1/model-categories`

**权限**: `ai:model:create`

**请求体**:

```json
{
  "name": "文本生成",
  "icon": "🤖",
  "description": "用于文本生成类模型",
  "order": 0
}
```

**响应**: 201 Created

### 3.2 获取所有分类

**接口**: `GET /api/v1/model-categories`

**权限**: 无需认证（公开接口）

**响应**: 200 OK

```json
[
  {
    "id": 1,
    "name": "文本生成",
    "icon": "🤖",
    "description": "用于文本生成类模型",
    "order": 0,
    "createdAt": "2025-01-24T10:00:00Z",
    "updatedAt": "2025-01-24T10:00:00Z",
    "models": [...]
  }
]
```

### 3.3 获取分类详情

**接口**: `GET /api/v1/model-categories/:id`

**权限**: 无需认证（公开接口）

**参数**:

- `id` (path): 分类 ID

### 3.4 更新分类

**接口**: `PATCH /api/v1/model-categories/:id`

**权限**: `ai:model:update`

**请求体**: 与创建相同，所有字段可选

### 3.5 删除分类

**接口**: `DELETE /api/v1/model-categories/:id`

**权限**: `ai:model:delete`

**响应**: 204 No Content

**注意**: 如果分类下有模型，无法删除

## 4. 聊天补全

### 3.1 创建聊天补全

**接口**: `POST /api/v1/chat/completions`

**权限**: `ai:chat:create`

**请求体**:

```json
{
  "model": "gpt-4-turbo",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant."
    },
    {
      "role": "user",
      "content": "Hello!"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 2048,
  "top_p": 0.9,
  "frequency_penalty": 0,
  "presence_penalty": 0,
  "stop": ["User:", "Assistant:"],
  "stream": false
}
```

**支持的参数**:

- **通用参数**: `model`, `messages`, `temperature`, `max_tokens`, `top_p`, `stream`
- **采样参数**: `top_k`, `top_a`, `min_p`
- **重复控制**: `frequency_penalty`, `presence_penalty`, `repetition_penalty`
- **其他参数**: `stop`, `seed`, `n`, `logit_bias`, `logprobs`
- **工具调用**: `tools`, `tool_choice`
- **结构化输出**: `response_format`
- **特殊功能**: `reasoning_effort`, `enable_web_search`, `thinking`

**响应** (非流式): 200 OK

```json
{
  "id": "chatcmpl-123",
  "object": "chat.completion",
  "created": 1677652288,
  "model": "gpt-4-turbo",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Hello! How can I help you today?"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 9,
    "total_tokens": 19
  }
}
```

**响应** (流式): 200 OK (SSE)

```
data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1677652288,"model":"gpt-4-turbo","choices":[{"index":0,"delta":{"role":"assistant","content":"Hello"},"finish_reason":null}]}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1677652288,"model":"gpt-4-turbo","choices":[{"index":0,"delta":{"content":"!"},"finish_reason":null}]}

data: [DONE]
```

### 3.2 获取可用模型列表

**接口**: `GET /api/v1/chat/completions/models`

**权限**: `ai:chat:read`

**响应**: 200 OK (返回活跃的模型列表)

### 3.3 获取默认模型

**接口**: `GET /api/v1/chat/completions/models/default`

**权限**: `ai:chat:read`

## 5. 数据结构

### 4.1 提供商来源 (ChatCompletionSource)

```typescript
enum ChatCompletionSource {
  OPENAI = "openai",
  CLAUDE = "claude",
  OPENROUTER = "openrouter",
  MAKERSUITE = "makersuite",
  VERTEXAI = "vertexai",
  MISTRALAI = "mistralai",
  COHERE = "cohere",
  PERPLEXITY = "perplexity",
  GROQ = "groq",
  DEEPSEEK = "deepseek",
  XAI = "xai",
  CUSTOM = "custom",
  // ... 更多
}
```

### 4.2 提供商状态 (ProviderStatus)

```typescript
enum ProviderStatus {
  ACTIVE = "active", // 活跃
  INACTIVE = "inactive", // 未激活
  ERROR = "error", // 错误
}
```

### 4.3 模型状态 (ModelStatus)

```typescript
enum ModelStatus {
  ACTIVE = "active", // 活跃
  INACTIVE = "inactive", // 未激活
  DEPRECATED = "deprecated", // 已弃用
}
```

## 6. 参数适配规则

系统会根据不同的提供商自动适配参数：

### 5.1 OpenAI → Claude

- `messages` 中的 `system` 角色 → `system` 字段
- `stop` → `stop_sequences`
- 自动检测思维模式（Claude 3.7+, Opus 4, Sonnet 4）
- 处理采样限制（Opus 4.1, Sonnet 4.5, Haiku 4.5）

### 5.2 OpenAI → Google

- `messages` → `contents` (角色转换: `assistant` → `model`)
- `system` → `systemInstruction`
- `max_tokens` → `maxOutputTokens`
- `top_p` → `topP`
- `top_k` → `topK`
- `stop` → `stopSequences` (最多 5 个，1-16 字符)
- 自动添加安全设置

### 5.3 OpenAI → OpenRouter

- 保持 OpenAI 格式
- 支持扩展参数: `top_k`, `top_a`, `min_p`, `repetition_penalty`
- 支持提供商选择: `provider`
- 支持路由策略: `route`, `transforms`

### 4.1 模型分类 (ModelCategory)

```typescript
interface ModelCategory {
  id: number;
  name: string;
  icon?: string;
  description?: string;
  order: number;
  createdAt: string;
  updatedAt: string;
  models?: AiModel[];
}
```

### 4.2 AI 模型 (AiModel)

模型实体包含以下新增字段：

- `categoryId`: 所属分类 ID（可选）
- `category`: 关联的分类对象
- `baseUrl`: API Base URL（可选，如果设置则优先使用）
- `apiKey`: API Key（加密存储，可选，如果设置则优先使用）
- `maskedApiKey`: API Key 脱敏显示（不存储到数据库）

## 7. 错误码

| 错误码 | 说明              |
| ------ | ----------------- |
| 400    | 请求参数错误      |
| 404    | 提供商/模型不存在 |
| 409    | 名称冲突          |
| 500    | AI 服务调用失败   |

## 8. 安全性

1. **认证**: 所有接口需要 JWT Token
2. **权限**: 基于角色的权限控制
3. **数据隔离**: 用户只能访问自己创建的资源（或系统级资源）
4. **API 密钥加密**: 敏感信息加密存储

## 9. 最佳实践

1. **提供商配置**:

   - 合理设置超时和重试次数
   - 配置速率限制避免超额
   - 定期测试连接状态

2. **模型选择**:

   - 根据任务选择合适的模型
   - 注意上下文窗口限制
   - 考虑成本因素

3. **参数调优**:

   - `temperature`: 0.7-1.0 适合创意任务，0.1-0.3 适合精确任务
   - `max_tokens`: 根据需求设置，避免浪费
   - `top_p`: 与 temperature 配合使用

4. **流式输出**:
   - 长文本生成建议使用流式
   - 注意处理流式连接断开
   - 前端需要支持 SSE

## 10. 示例代码

### 9.1 TypeScript (前端)

```typescript
import axios from "axios";

// 创建聊天补全
const response = await axios.post(
  "/api/v1/chat/completions",
  {
    model: "gpt-4-turbo",
    messages: [{ role: "user", content: "Hello!" }],
    temperature: 0.7,
    max_tokens: 2048,
    stream: false,
  },
  {
    headers: {
      Authorization: `Bearer ${token}`,
    },
  }
);

console.log(response.data.choices[0].message.content);
```

### 9.2 流式输出处理

```typescript
const eventSource = new EventSource("/api/v1/chat/completions");

eventSource.onmessage = (event) => {
  if (event.data === "[DONE]") {
    eventSource.close();
    return;
  }

  const chunk = JSON.parse(event.data);
  const content = chunk.choices[0].delta.content;

  // 渲染内容
  console.log(content);
};
```

## 11. 更新日志

### 2025-01-24 - 模型管理优化

#### 1. 模型分类功能

- **新增**: 模型分类管理系统
  - 创建、查询、更新、删除分类
  - 支持图标和描述
  - 分类排序功能
- **新增**: 模型可分配到指定分类
  - 创建/更新模型时可指定 `categoryId`
  - 支持按分类查询模型：`GET /api/v1/ai-models/category/:categoryId`
  - 模型列表显示分类信息

#### 2. 模型独立配置

- **新增**: 每个模型可配置独立的 `baseUrl` 和 `apiKey`
  - 如果模型设置了 `baseUrl`，优先使用模型的配置
  - 如果模型设置了 `apiKey`，优先使用模型的配置
  - 如果未设置，则使用提供商的配置
  - `apiKey` 自动加密存储，支持脱敏显示

#### 3. 前端优化

- **新增**: 模型分类管理页面
- **新增**: 模型列表支持按分类筛选
- **新增**: 模型编辑表单支持选择分类和配置 baseUrl/apiKey
- **优化**: 模型卡片显示分类信息和 baseUrl

参见 [CHANGELOG.md](./CHANGELOG.md)
