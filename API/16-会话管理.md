# 会话管理系统 API 文档

## 概述

会话管理系统是 SillyTavern 风格的完整对话管理解决方案，支持：

- **普通聊天**：用户与单个角色的一对一对话
- **AI 写作助手**：与小说关联的写作对话
- **创意工坊**：按提示词分类的生成历史（🆕 v2.0）
- **群聊**：用户与多个角色的群组对话
- **会话管理**：跨聊天和群聊的统一管理
- **备份恢复**：完整的会话备份和恢复功能

## 模块路径

`backend/src/chat-histories/`

## 数据库表

### 1. chat_histories（聊天历史表）

- 用户与角色的对话记录（角色扮演）
- 用户与 AI 的写作对话（AI 写作助手）
- 创意工坊的生成历史（🆕 按分类筛选）
- 支持自定义聊天名称和元数据

**字段说明**：

- `novel_id`: 关联小说 ID（AI 写作场景）
- `character_card_id`: 关联角色卡 ID（角色扮演场景）
- `category_id`: 🆕 关联提示词分类 ID（创意工坊场景）

### 2. group_chats（群聊表）

- 群组对话记录
- 支持多个角色成员
- 可归档管理

### 3. group_members（群聊成员表）

- 群聊中的角色成员
- 支持启用/禁用
- 可调整显示顺序

### 4. messages（消息表）

- 统一存储聊天和群聊消息
- 支持 Swipes 多版本生成
- 关联 chat_id 或 group_chat_id

---

## 零、普通聊天管理（🆕 补充）

### 0.1 创建聊天

**接口**: `POST /api/v1/chat-histories`

**权限**: 需要 JWT 认证

**请求体**:

```json
{
  "chatName": "与AI的对话",
  "novelId": 123, // 可选：AI写作场景
  "characterCardId": 456, // 可选：角色扮演场景
  "categoryId": 5, // 🆕 可选：创意工坊场景（如："书名"分类）
  "chatMetadata": {
    "scenarioType": "writing",
    "preview": "..."
  }
}
```

**响应**: `201 Created`

---

### 0.2 获取聊天列表

**接口**: `GET /api/v1/chat-histories`

**权限**: 需要 JWT 认证

**查询参数**:

- `page`: 页码（默认 1）
- `limit`: 每页数量（默认 20）
- `novelId`: 🔍 按小说 ID 筛选（AI 写作场景）
- `characterCardId`: 🔍 按角色卡 ID 筛选（角色扮演场景）
- `categoryId`: 🆕 🔍 按提示词分类 ID 筛选（创意工坊场景）
- `search`: 搜索关键词

**查询逻辑说明**：

1. **普通对话**（只传 `novelId`）：
   - 查询条件：`novelId=x AND categoryId IS NULL`
   - 只显示普通 AI 助手对话，**不包含**创意工坊对话
2. **创意工坊对话**（传 `categoryId`）：
   - 查询条件：`categoryId=x`
   - 显示该分类下的所有对话，**不受** `novelId` 限制
   - 首页创意工坊和编辑器创意工坊的历史记录共通
3. **编辑器内创意工坊**（同时传 `novelId` 和 `categoryId`）：
   - 查询条件：`novelId=x AND categoryId=y`
   - 显示该作品该分类下的对话

**响应**: `200 OK`

```json
{
  "data": [
    {
      "id": 1,
      "chatName": "书名生成记录",
      "categoryId": 5,
      "messageCount": 12,
      "lastMessageAt": "2025-10-31T10:00:00Z"
    }
  ],
  "total": 20,
  "page": 1,
  "limit": 20
}
```

**使用场景**：

```
// 场景1：普通对话（无筛选）
GET /api/v1/chat-histories?page=1&limit=20

// 场景2：AI写作助手（按作品筛选）
GET /api/v1/chat-histories?novelId=123

// 场景3：创意工坊（按分类筛选）- 🆕
GET /api/v1/chat-histories?categoryId=5

// 场景4：创意工坊+作品（双重筛选）- 🆕
GET /api/v1/chat-histories?novelId=123&categoryId=5
```

---

### 0.3 获取聊天详情

**接口**: `GET /api/v1/chat-histories/:id`

**权限**: 需要 JWT 认证，用户必须是聊天所有者

**响应**: `200 OK`

---

### 0.4 更新聊天

**接口**: `PUT /api/v1/chat-histories/:id`

**权限**: 需要 JWT 认证，用户必须是聊天所有者

---

### 0.5 删除聊天

**接口**: `DELETE /api/v1/chat-histories/:id`

**权限**: 需要 JWT 认证，用户必须是聊天所有者

**响应**: `204 No Content`

---

## 一、群聊管理

### 1.1 创建群聊

**接口**: `POST /api/v1/group-chats`

**权限**: 需要 JWT 认证

**请求体**:

```json
{
  "groupName": "冒险小队",
  "description": "一起探索魔法世界",
  "avatarUrl": "https://example.com/group-avatar.png",
  "members": [
    {
      "characterCardId": 1,
      "characterName": "艾莉娅",
      "avatarUrl": "https://example.com/avatar1.png",
      "displayOrder": 0
    },
    {
      "characterCardId": 2,
      "characterName": "莉莉丝",
      "avatarUrl": "https://example.com/avatar2.png",
      "displayOrder": 1
    }
  ],
  "groupMetadata": {
    "theme": "fantasy",
    "setting": "medieval"
  }
}
```

**响应**: `201 Created`

```json
{
  "id": 1,
  "userId": 1,
  "groupName": "冒险小队",
  "description": "一起探索魔法世界",
  "avatarUrl": "https://example.com/group-avatar.png",
  "groupMetadata": {},
  "messageCount": 0,
  "lastMessageAt": null,
  "isArchived": false,
  "members": [
    {
      "id": 1,
      "groupId": 1,
      "characterCardId": 1,
      "characterName": "艾莉娅",
      "avatarUrl": "https://example.com/avatar1.png",
      "displayOrder": 0,
      "isEnabled": true,
      "joinedAt": "2025-10-23T10:00:00Z"
    }
  ],
  "createdAt": "2025-10-23T10:00:00Z",
  "updatedAt": "2025-10-23T10:00:00Z"
}
```

---

### 1.2 获取群聊列表

**接口**: `GET /api/v1/group-chats`

**权限**: 需要 JWT 认证

**查询参数**:

- `page`: 页码（默认 1）
- `limit`: 每页数量（默认 20）
- `search`: 搜索关键词
- `includeArchived`: 是否包含归档（默认 false）

**响应**: `200 OK`

```json
{
  "data": [
    {
      "id": 1,
      "groupName": "冒险小队",
      "messageCount": 45,
      "lastMessageAt": "2025-10-23T14:30:00Z",
      "members": [...]
    }
  ],
  "total": 10,
  "page": 1,
  "limit": 20
}
```

---

### 1.3 获取群聊详情

**接口**: `GET /api/v1/group-chats/:id`

**权限**: 需要 JWT 认证，用户必须是群主

**响应**: `200 OK`

---

### 1.4 更新群聊信息

**接口**: `PUT /api/v1/group-chats/:id`

**权限**: 需要 JWT 认证，用户必须是群主

**请求体**:

```json
{
  "groupName": "新的群聊名称",
  "description": "更新后的描述",
  "avatarUrl": "https://example.com/new-avatar.png"
}
```

---

### 1.5 删除群聊

**接口**: `DELETE /api/v1/group-chats/:id`

**权限**: 需要 JWT 认证，用户必须是群主

**响应**: `204 No Content`

---

### 1.6 归档/取消归档群聊

**归档**: `POST /api/v1/group-chats/:id/archive`
**取消归档**: `POST /api/v1/group-chats/:id/unarchive`

**权限**: 需要 JWT 认证，用户必须是群主

**响应**: `200 OK`

---

### 1.7 添加群聊成员

**接口**: `POST /api/v1/group-chats/:id/members`

**权限**: 需要 JWT 认证，用户必须是群主

**请求体**:

```json
{
  "characterCardId": 3,
  "characterName": "萨拉",
  "avatarUrl": "https://example.com/avatar3.png",
  "displayOrder": 2
}
```

**响应**: `201 Created`

---

### 1.8 移除群聊成员

**接口**: `DELETE /api/v1/group-chats/:id/members/:memberId`

**权限**: 需要 JWT 认证，用户必须是群主

**响应**: `204 No Content`

---

### 1.9 启用/禁用成员

**接口**: `PUT /api/v1/group-chats/:id/members/:memberId/toggle`

**权限**: 需要 JWT 认证，用户必须是群主

**请求体**:

```json
{
  "isEnabled": false
}
```

**说明**: 禁用的成员不会参与对话生成，但会保留在群聊中

---

### 1.10 更新成员显示顺序

**接口**: `PUT /api/v1/group-chats/:id/members/order`

**权限**: 需要 JWT 认证，用户必须是群主

**请求体**:

```json
[
  { "memberId": 1, "displayOrder": 2 },
  { "memberId": 2, "displayOrder": 0 },
  { "memberId": 3, "displayOrder": 1 }
]
```

---

## 二、会话管理

### 2.1 获取最近会话

**接口**: `GET /api/v1/sessions/recent`

**权限**: 需要 JWT 认证

**查询参数**:

- `limit`: 返回数量（默认 10）

**响应**: `200 OK`

```json
[
  {
    "id": 1,
    "type": "chat",
    "name": "与艾莉娅的对话",
    "characterName": "艾莉娅",
    "characterCardId": 1,
    "avatarUrl": null,
    "messageCount": 45,
    "lastMessageAt": "2025-10-23T14:30:00Z",
    "lastMessage": "...最后一条消息预览",
    "createdAt": "2025-10-20T10:00:00Z"
  },
  {
    "id": 2,
    "type": "group",
    "name": "冒险小队",
    "avatarUrl": "https://example.com/group.png",
    "messageCount": 78,
    "lastMessageAt": "2025-10-22T10:00:00Z",
    "lastMessage": "...群聊最后消息",
    "createdAt": "2025-10-21T08:00:00Z"
  }
]
```

**说明**:

- 返回所有聊天和群聊，按最后消息时间排序
- 跨角色和群聊统一展示
- 用于"最近对话"面板

---

### 2.2 搜索会话

**接口**: `GET /api/v1/sessions/search`

**权限**: 需要 JWT 认证

**查询参数**:

- `q`: 搜索关键词（必填）

**响应**: `200 OK`

**说明**:

- 搜索会话名称、角色名称、群聊描述
- 返回格式同"获取最近会话"

---

### 2.3 获取会话统计

**接口**: `GET /api/v1/sessions/stats`

**权限**: 需要 JWT 认证

**响应**: `200 OK`

```json
{
  "totalChats": 15,
  "totalGroups": 3,
  "totalMessages": 1250,
  "activeSessions": 8
}
```

**说明**:

- `totalChats`: 普通聊天总数
- `totalGroups`: 群聊总数
- `totalMessages`: 所有消息总数
- `activeSessions`: 7 天内有消息的会话数

---

## 三、备份和恢复

### 3.1 备份普通聊天

**接口**: `POST /api/v1/sessions/backup/chat/:chatId`

**权限**: 需要 JWT 认证，用户必须是聊天所有者

**响应**: `200 OK`

```json
{
  "version": "1.0.0",
  "type": "chat",
  "timestamp": 1729670400000,
  "integrity": "abc123...",
  "data": {
    "chat": {...},
    "messages": [...],
    "swipes": [...]
  }
}
```

**说明**:

- 完整备份聊天、消息和 Swipes
- 包含完整性校验码
- 可用于恢复或迁移

---

### 3.2 备份群聊

**接口**: `POST /api/v1/sessions/backup/group/:groupId`

**权限**: 需要 JWT 认证，用户必须是群主

**响应**: `200 OK`

**说明**: 格式同普通聊天备份

---

### 3.3 从备份恢复

**接口**: `POST /api/v1/sessions/restore`

**权限**: 需要 JWT 认证

**请求体**:

```json
{
  "version": "1.0.0",
  "type": "chat",
  "timestamp": 1729670400000,
  "integrity": "abc123...",
  "data": {...}
}
```

**响应**: `201 Created`

```json
{
  "message": "恢复成功",
  "id": 16,
  "type": "chat"
}
```

**说明**:

- 自动验证备份完整性
- 创建新会话（不覆盖原会话）
- 会话名称会添加"(恢复)"后缀

---

## 四、权限控制

### 4.1 认证要求

- ✅ 所有接口都需要 JWT 认证（全局 Guard）
- ✅ 通过 Bearer Token 传递认证信息

### 4.2 所有权验证

- ✅ 普通聊天：用户只能访问自己的聊天
- ✅ 群聊：用户只能访问自己创建的群聊（作为群主）
- ✅ 消息：验证通过所属聊天/群聊间接验证

### 4.3 操作权限

- ✅ 创建：任何认证用户
- ✅ 查看：仅限所有者
- ✅ 修改：仅限所有者
- ✅ 删除：仅限所有者

---

## 五、错误码

| 状态码 | 说明         |
| ------ | ------------ |
| 400    | 请求参数错误 |
| 401    | 未认证       |
| 403    | 无权访问     |
| 404    | 资源不存在   |
| 500    | 服务器错误   |

**常见错误示例**:

```json
{
  "statusCode": 403,
  "message": "无权访问此群聊",
  "error": "Forbidden"
}
```

---

## 六、使用场景

### 场景 1：创建群聊并开始对话

1. 创建群聊，添加多个角色
2. 创建消息发送给群聊
3. 每个启用的成员都可能生成回复

### 场景 2：管理会话列表

1. 获取最近会话（包含聊天和群聊）
2. 显示在统一的会话列表中
3. 用户点击切换到对应会话

### 场景 3：备份和迁移

1. 定期备份重要会话
2. 导出备份数据
3. 在其他设备或账号上恢复

### 场景 4：群聊成员管理

1. 添加新角色到群聊
2. 调整成员显示顺序
3. 临时禁用某些成员
4. 移除不需要的成员

---

## 七、最佳实践

### 7.1 群聊管理

- ✅ 为群聊设置清晰的名称和描述
- ✅ 合理控制成员数量（建议 2-5 个）
- ✅ 定期清理不活跃的群聊
- ✅ 使用归档功能管理旧群聊

### 7.2 会话管理

- ✅ 定期查看"最近会话"快速定位
- ✅ 使用搜索功能查找特定会话
- ✅ 为重要会话命名便于识别

### 7.3 备份策略

- ✅ 定期备份重要会话
- ✅ 保存备份文件到安全位置
- ✅ 验证备份完整性
- ✅ 测试恢复流程

---

## 八、技术细节

### 8.1 消息关联

- 消息通过`chat_id`或`group_chat_id`关联
- 两者互斥，只能关联其中一个
- 查询时需明确指定类型

### 8.2 完整性校验

- 使用 SHA256 算法生成校验码
- 包含版本、类型、时间戳和数据
- 恢复时自动验证

### 8.3 级联删除

- 删除聊天/群聊时，自动删除所有消息
- 删除群聊时，自动删除所有成员
- 删除用户时，自动删除所有会话

---

## 九、集成系统

- **角色卡系统**: 群聊成员关联角色卡 ID
- **历史消息系统**: 统一的消息存储和管理
- **用户系统**: 认证和权限控制
- **宏系统**: 消息内容支持宏替换

---

## 十、相关文档

- [历史消息管理 API](./15-历史消息管理.md)
- [会话管理系统完整文档](../docs/会话管理系统完整文档.md)
- [更新日志](./CHANGELOG.md)
