# 字体管理 API - 用户上传功能 🆕

## 概述

除了管理员上传的系统字体，普通用户也可以上传自己的字体文件到服务器，实现跨设备字体一致性。

**基础路径**: `/api/v1/fonts`

---

## 1. 用户上传字体

### 接口信息

- **路径**: `POST /fonts/user/upload`
- **权限**: 已登录用户（无需特殊权限）
- **描述**: 用户上传字体文件到服务器，可在任何设备使用
- **Content-Type**: `multipart/form-data`

### 请求参数

| 参数        | 类型   | 必填 | 说明                             |
| ----------- | ------ | ---- | -------------------------------- |
| file        | File   | 是   | 字体文件（woff2/woff/ttf/otf）   |
| name        | string | 是   | 字体名称（用于 CSS font-family） |
| displayName | string | 是   | 显示名称                         |
| description | string | 否   | 字体描述                         |

### 限制说明

- ✅ 支持格式：.woff2, .woff, .ttf, .otf
- ✅ 文件大小：最大 10MB
- ✅ 数量限制：每个用户最多上传 5 个字体
- ✅ 自动分类：用户字体统一归类为"我的字体"
- ✅ 自动启用：上传后自动启用

### 请求示例

```javascript
const formData = new FormData();
formData.append("file", file);
formData.append("name", "MyCustomFont");
formData.append("displayName", "我的自定义字体");
formData.append("description", "适合正文阅读的宋体");

const response = await fetch("/api/v1/fonts/user/upload", {
  method: "POST",
  headers: {
    Authorization: "Bearer YOUR_TOKEN",
  },
  body: formData,
});
```

### 响应示例

```json
{
  "id": 15,
  "userId": 123,
  "name": "MyCustomFont",
  "displayName": "我的自定义字体",
  "category": "我的字体",
  "description": "适合正文阅读的宋体",
  "filePath": "fonts/1699999999-MyCustomFont.woff2",
  "format": "woff2",
  "fileSize": 2048576,
  "isEnabled": true,
  "isDefault": false,
  "sortOrder": 0,
  "url": "http://your-domain/uploads/fonts/1699999999-MyCustomFont.woff2",
  "createdAt": "2025-11-02T10:00:00.000Z",
  "updatedAt": "2025-11-02T10:00:00.000Z"
}
```

---

## 2. 获取我的字体列表

### 接口信息

- **路径**: `GET /fonts/user/my-fonts`
- **权限**: 已登录用户
- **描述**: 获取当前用户上传的所有字体

### 响应示例

```json
[
  {
    "id": 15,
    "userId": 123,
    "name": "MyCustomFont",
    "displayName": "我的自定义字体",
    "category": "我的字体",
    "description": "适合正文阅读的宋体",
    "filePath": "fonts/1699999999-MyCustomFont.woff2",
    "format": "woff2",
    "fileSize": 2048576,
    "isEnabled": true,
    "isDefault": false,
    "sortOrder": 0,
    "url": "http://your-domain/uploads/fonts/1699999999-MyCustomFont.woff2",
    "createdAt": "2025-11-02T10:00:00.000Z",
    "updatedAt": "2025-11-02T10:00:00.000Z"
  }
]
```

---

## 3. 删除我的字体

### 接口信息

- **路径**: `DELETE /fonts/user/:id`
- **权限**: 已登录用户（只能删除自己的字体）
- **描述**: 删除用户自己上传的字体

### 路径参数

| 参数 | 类型   | 说明    |
| ---- | ------ | ------- |
| id   | number | 字体 ID |

### 响应示例

```json
{
  "message": "字体已删除"
}
```

### 权限验证

- ✅ 用户只能删除自己上传的字体
- ❌ 不能删除系统字体
- ❌ 不能删除其他用户的字体

---

## 4. 获取可用字体列表（更新）

### 接口信息

- **路径**: `GET /fonts/enabled`
- **权限**: 公开接口（已登录用户会包含自己的字体）
- **描述**: 获取所有可用字体（系统字体 + 用户自己的字体）

### 响应示例

**未登录用户**：只返回系统字体

**已登录用户**：返回系统字体 + 用户自己的字体

```json
[
  {
    "id": 1,
    "userId": null,
    "name": "system-default",
    "displayName": "系统默认",
    "category": "推荐",
    "description": "根据操作系统自动选择最佳字体",
    "format": "system",
    "url": ""
  },
  {
    "id": 15,
    "userId": 123,
    "name": "MyCustomFont",
    "displayName": "我的自定义字体",
    "category": "我的字体",
    "description": "适合正文阅读的宋体",
    "filePath": "fonts/1699999999-MyCustomFont.woff2",
    "format": "woff2",
    "fileSize": 2048576,
    "url": "http://your-domain/uploads/fonts/1699999999-MyCustomFont.woff2"
  }
]
```

---

## 💡 使用场景

### 问题：跨设备字体不一致

**场景**：

- 用户在电脑上安装了"霞鹜文楷"字体
- 在编辑器设置中选择"霞鹜文楷"
- 在手机上打开编辑器，发现字体变成了默认字体（因为手机没有安装）

**解决方案**：用户上传字体到服务器

1. 用户在编辑器设置中点击"上传字体"
2. 选择"霞鹜文楷.woff2"文件
3. 填写字体名称和显示名称
4. 点击"上传字体"
5. 字体上传到服务器，现在在任何设备都能使用

### 优势对比

**自定义字体输入**（旧方案）：

- ❌ 需要每台设备都安装字体
- ❌ 跨设备不一致
- ❌ 手机端难以安装字体

**上传字体到服务器**（新方案）：

- ✅ 上传一次，所有设备都能用
- ✅ 完全一致的显示效果
- ✅ 手机、平板、电脑无缝同步

---

## 🔧 技术实现

### 数据库设计

```sql
ALTER TABLE `fonts`
ADD COLUMN `user_id` INT UNSIGNED NULL COMMENT '用户ID（NULL=系统字体，有值=用户私有字体）';

-- 修改唯一索引，允许不同用户使用相同的字体名称
ALTER TABLE `fonts`
DROP INDEX `uk_name`,
ADD UNIQUE KEY `uk_user_name` (`user_id`, `name`);
```

### 字体隔离

- **系统字体**：`user_id = NULL`，所有用户可见
- **用户字体**：`user_id = 具体用户ID`，只有该用户可见

### 前端加载逻辑

```typescript
// 1. 加载可用字体（包含系统字体 + 用户字体）
const fonts = await fontsApi.getEnabledFonts();

// 2. 动态加载字体文件
await FontLoader.loadFonts(fonts);

// 3. 应用到编辑器
style: `font-family: ${fontFamily};`;
```

---

## 📋 错误码

| 错误码 | 说明                                 |
| ------ | ------------------------------------ |
| 400    | 文件格式不支持、文件过大、数量超限等 |
| 401    | 未登录或 Token 失效                  |
| 403    | 无权限删除该字体                     |
| 404    | 字体不存在                           |
| 500    | 服务器内部错误                       |

---

## 🚀 版本历史

| 版本 | 日期       | 说明                 |
| ---- | ---------- | -------------------- |
| v1.1 | 2025-11-02 | 新增用户上传字体功能 |
| v1.0 | 2025-11-02 | 管理员字体管理功能   |
