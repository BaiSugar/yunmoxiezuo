# 邮件系统 API

## 概述

邮件系统提供邮件发送、验证码管理和邮件模板管理功能。

**基础路径**: `/api/v1`

---

## 1. 发送验证码

### 接口信息
- **路径**: `POST /api/v1/email/send-code`
- **权限**: 公开接口（无需认证）
- **描述**: 发送邮箱验证码

### 请求参数

```json
{
  "email": "user@example.com",
  "type": "register" // register | reset_password | change_email | verify_email
}
```

### 响应示例

**成功响应** (200)
```json
{
  "message": "验证码已发送，请查收邮件"
}
```

**错误响应** (400)
```json
{
  "statusCode": 400,
  "message": "邮件验证功能未启用",
  "error": "Bad Request"
}
```

---

## 2. 验证邮箱验证码

### 接口信息
- **路径**: `POST /api/v1/email/verify-code`
- **权限**: 需要登录
- **描述**: 验证邮箱验证码并更新用户邮箱验证状态

### 请求参数

```json
{
  "email": "user@example.com",
  "code": "123456",
  "type": "verify_email"
}
```

### 响应示例

**成功响应** (200)
```json
{
  "message": "验证成功"
}
```

**错误响应** (400)
```json
{
  "statusCode": 400,
  "message": "验证码无效或已过期",
  "error": "Bad Request"
}
```

---

## 3. 邮件模板管理

### 3.1 获取所有模板

- **路径**: `GET /api/v1/email-templates`
- **权限**: `email:template:view`
- **描述**: 获取所有邮件模板

### 响应示例

```json
[
  {
    "id": 1,
    "type": "register",
    "subject": "【写作平台】注册验证码",
    "htmlTemplate": "<!DOCTYPE html>...",
    "name": "注册验证码模板",
    "description": "用户注册时的邮件验证码模板",
    "variables": "{\"code\": \"验证码\", \"expireText\": \"过期时间文本\", \"year\": \"当前年份\"}",
    "isActive": true,
    "createdAt": "2024-01-30T10:00:00.000Z",
    "updatedAt": "2024-01-30T10:00:00.000Z"
  }
]
```

### 3.2 获取单个模板

- **路径**: `GET /api/v1/email-templates/:id`
- **权限**: `email:template:view`
- **描述**: 根据ID获取邮件模板

### 响应示例

```json
{
  "id": 1,
  "type": "register",
  "subject": "【写作平台】注册验证码",
  "htmlTemplate": "<!DOCTYPE html>...",
  "name": "注册验证码模板",
  "description": "用户注册时的邮件验证码模板",
  "variables": "{\"code\": \"验证码\", \"expireText\": \"过期时间文本\", \"year\": \"当前年份\"}",
  "isActive": true,
  "createdAt": "2024-01-30T10:00:00.000Z",
  "updatedAt": "2024-01-30T10:00:00.000Z"
}
```

### 3.3 创建模板

- **路径**: `POST /api/v1/email-templates`
- **权限**: `email:template:create`
- **描述**: 创建新的邮件模板

### 请求参数

```json
{
  "type": "register",
  "subject": "【写作平台】注册验证码",
  "htmlTemplate": "<!DOCTYPE html>...",
  "name": "注册验证码模板",
  "description": "用户注册时的邮件验证码模板",
  "variables": "{\"code\": \"验证码\", \"expireText\": \"过期时间文本\", \"year\": \"当前年份\"}",
  "isActive": true
}
```

### 3.4 更新模板

- **路径**: `PUT /api/v1/email-templates/:id`
- **权限**: `email:template:update`
- **描述**: 更新邮件模板

### 请求参数

```json
{
  "subject": "【写作平台】注册验证码",
  "htmlTemplate": "<!DOCTYPE html>...",
  "name": "注册验证码模板",
  "description": "用户注册时的邮件验证码模板",
  "isActive": true
}
```

### 3.5 删除模板

- **路径**: `DELETE /api/v1/email-templates/:id`
- **权限**: `email:template:delete`
- **描述**: 删除邮件模板

### 响应示例

```json
{
  "message": "删除成功"
}
```

---

## 4. 邮件模板变量说明

### 可用变量

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `{{code}}` | 验证码 | 123456 |
| `{{expireText}}` | 过期时间文本 | 5分钟 |
| `{{year}}` | 当前年份 | 2024 |

### 模板示例

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .code { font-size: 32px; font-weight: bold; color: #667eea; }
  </style>
</head>
<body>
  <div class="container">
    <h1>欢迎注册</h1>
    <p>您的验证码是：<span class="code">{{code}}</span></p>
    <p>验证码有效期为 {{expireText}}，请尽快使用。</p>
    <p>&copy; {{year}} 写作平台 版权所有</p>
  </div>
</body>
</html>
```

---

## 5. 系统配置（邮件相关）

### 邮件配置项

| 配置项 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `email.smtp_host` | string | SMTP服务器地址 | - |
| `email.smtp_port` | number | SMTP端口 | 587 |
| `email.smtp_secure` | boolean | 是否使用SSL | false |
| `email.smtp_user` | string | SMTP用户名 | - |
| `email.smtp_password` | string | SMTP密码（加密存储） | - |
| `email.from_name` | string | 发件人名称 | 写作平台 |
| `email.from_email` | string | 发件人邮箱 | - |
| `email.verification_enabled` | boolean | 是否启用邮件验证 | true |
| `email.verification_code_expire` | number | 验证码过期时间（秒） | 300 |
| `email.verification_resend_interval` | number | 重发间隔（秒） | 60 |

---

## 6. 错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 409 | 资源冲突（如模板类型已存在） |
| 500 | 服务器内部错误 |

---

## 7. 注意事项

1. **邮件配置**
   - 发送邮件前需要先在系统配置中设置SMTP参数
   - SMTP密码会加密存储在数据库中

2. **验证码发送频率**
   - 同一邮箱同一类型的验证码有重发间隔限制（默认60秒）
   - 验证码有效期默认为5分钟

3. **邮件模板**
   - 每种类型只能有一个启用的模板
   - 模板支持HTML和变量替换
   - 删除模板前请确保有备份

4. **权限要求**
   - 发送验证码接口无需认证
   - 模板管理接口需要相应的管理员权限

---

## 8. 使用流程

### 8.1 配置SMTP

1. 登录后台管理系统
2. 进入"系统配置" -> "邮件配置"
3. 填写SMTP服务器信息
4. 保存配置

### 8.2 自定义邮件模板

1. 进入"邮件模板"页面
2. 选择要编辑的模板
3. 修改主题和HTML内容
4. 预览效果
5. 保存模板

### 8.3 发送验证码

前端调用 `/api/v1/email/send-code` 接口，传入邮箱和类型即可。

```typescript
// 前端示例代码
import { sendVerificationCode } from '@/services/email.api';

await sendVerificationCode({
  email: 'user@example.com',
  type: 'register',
});
```

### 8.4 验证邮箱

登录后在强制弹窗中验证邮箱：

```typescript
// 前端示例代码
import { verifyEmailCode } from '@/services/email.api';

await verifyEmailCode({
  email: 'user@example.com',
  code: '123456',
  type: 'verify_email',
});
```

