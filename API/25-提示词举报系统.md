# 提示词举报系统 API 文档

## 概述

提示词举报系统允许用户举报违规的提示词，管理员可以审核举报并决定是否封禁提示词。

## 功能特性

- 用户可以举报违规提示词
- 管理员审核举报记录
- 管理员封禁/解封提示词
- WebSocket 实时通知作者封禁状态
- 批量管理提示词

---

## 1. 用户举报提示词

### 请求

- **方法**: `POST`
- **路径**: `/api/v1/prompts/reports/:promptId`
- **权限**: 需要登录，`prompt:report`

#### 参数

| 参数名      | 类型   | 必填 | 说明                                                                                                                                                                   |
| ----------- | ------ | ---- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| reason      | string | 是   | 举报原因：spam(垃圾信息)、inappropriate(不当内容)、violence(暴力内容)、hate_speech(仇恨言论)、pornography(色情内容)、copyright(版权侵犯)、fraud(欺诈内容)、other(其他) |
| description | string | 否   | 详细描述（最多 1000 字）                                                                                                                                               |

#### 示例请求

```json
{
  "reason": "inappropriate",
  "description": "该提示词包含不当内容，建议审核"
}
```

### 响应

#### 成功响应 (201)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "id": 1,
    "promptId": 123,
    "reporterId": 1,
    "reason": "inappropriate",
    "description": "该提示词包含不当内容，建议审核",
    "status": "pending",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

#### 错误响应

- `400` - 不能举报自己的提示词
- `400` - 您已经举报过该提示词，请等待审核
- `404` - 提示词不存在

---

## 2. 查询我的举报记录

### 请求

- **方法**: `GET`
- **路径**: `/api/v1/prompts/reports/my`
- **权限**: 需要登录，`prompt:report:view`

#### 查询参数

| 参数名   | 类型   | 必填 | 说明              |
| -------- | ------ | ---- | ----------------- |
| page     | number | 否   | 页码，默认 1      |
| pageSize | number | 否   | 每页数量，默认 20 |

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "data": [
      {
        "id": 1,
        "promptId": 123,
        "prompt": {
          "id": 123,
          "name": "示例提示词"
        },
        "reason": "inappropriate",
        "description": "包含不当内容",
        "status": "pending",
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 1,
      "totalPages": 1
    }
  }
}
```

---

## 3. 查询所有举报列表（管理员）

### 请求

- **方法**: `GET`
- **路径**: `/api/v1/prompts/reports`
- **权限**: 需要登录，`prompt:manage:all`

#### 查询参数

| 参数名   | 类型   | 必填 | 说明                                  |
| -------- | ------ | ---- | ------------------------------------- |
| page     | number | 否   | 页码，默认 1                          |
| pageSize | number | 否   | 每页数量，默认 20                     |
| status   | string | 否   | 状态筛选：pending、approved、rejected |
| promptId | number | 否   | 提示词 ID 筛选                        |

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "data": [
      {
        "id": 1,
        "promptId": 123,
        "prompt": {
          "id": 123,
          "name": "示例提示词",
          "authorId": 2,
          "isBanned": false
        },
        "reporter": {
          "id": 1,
          "username": "user1",
          "nickname": "用户1"
        },
        "reason": "inappropriate",
        "description": "包含不当内容",
        "status": "pending",
        "reviewer": null,
        "reviewNote": null,
        "reviewedAt": null,
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 1,
      "totalPages": 1
    }
  }
}
```

---

## 4. 审核举报（管理员）

### 请求

- **方法**: `PATCH`
- **路径**: `/api/v1/prompts/reports/:reportId/review`
- **权限**: 需要登录，`prompt:report:review`

#### 参数

| 参数名     | 类型   | 必填 | 说明                                     |
| ---------- | ------ | ---- | ---------------------------------------- |
| status     | string | 是   | 审核结果：approved(批准)、rejected(驳回) |
| reviewNote | string | 否   | 审核备注（最多 500 字）                  |

#### 示例请求

```json
{
  "status": "approved",
  "reviewNote": "确认违规，已下架"
}
```

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "id": 1,
    "status": "approved",
    "reviewerId": 1,
    "reviewNote": "确认违规，已下架",
    "reviewedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### 🔔 自动下架机制

**当举报审核通过（status = 'approved'）时，系统会自动执行以下操作：**

1. **自动下架提示词**：

   - 将提示词状态改为 `draft`（草稿）
   - 将 `isPublic` 设置为 `false`（不公开）
   - 将 `needsReview` 设置为 `true`（标记需要管理员审核）
   - 保存违规内容快照 `reviewSnapshot`（记录违规版本）
   - 设置 `reviewSubmittedAt = null`（作者还未提交审核）
   - **⚠️ 此时不通知管理员**，等待作者修改并提交审核

2. **限制作者发布**：

   - 被下架的提示词，作者无法直接发布或公开
   - 尝试发布时会提示：「该提示词因违规被下架，需要提交管理员审核后才能重新发布。请先保存修改，然后点击"提交审核"按钮」

3. **作者修改并提交审核**：

   - 作者修改提示词内容
   - 点击"提交审核"按钮 → `POST /api/v1/prompts/:id/submit-review`
   - 系统设置 `reviewSubmittedAt = 当前时间`（标记已提交）
   - **✅ 此时才通知管理员**（汇总通知，避免轰炸）

4. **管理员审核流程**：
   - 管理员在审核页面只看到 `reviewSubmittedAt != null` 的提示词
   - 查看内容对比：快照（违规版本）vs 当前内容（修改后版本）
   - 通过 `POST /api/v1/prompts/:id/approve` 接口审核通过
   - 审核通过后，清除 `needsReview`、`reviewSnapshot`、`reviewSubmittedAt`
   - 作者才能自行发布（或管理员直接自动发布）

### WebSocket 通知

审核完成后，会通过 WebSocket 向相关用户发送实时通知：

#### 1. 审核通过（approved）时

**通知举报者：**

```json
{
  "type": "notification",
  "data": {
    "id": 1,
    "userId": 1,
    "title": "举报已通过审核",
    "content": "您举报的提示词「示例提示词」已通过审核，感谢您的反馈",
    "category": "report-approved",
    "level": "success",
    "action": {
      "text": "查看详情",
      "url": "/dashboard/reports/1"
    },
    "extra": {
      "reportId": 1,
      "promptId": 123,
      "promptName": "示例提示词",
      "reviewNote": "确认违规，已封禁"
    }
  }
}
```

**通知提示词作者：**

```json
{
  "type": "notification",
  "data": {
    "id": 2,
    "userId": 2,
    "title": "您的提示词因违规已下架",
    "content": "您的提示词「示例提示词」因被举报并审核通过已自动下架。如需重新发布，请修改后提交管理员审核。",
    "category": "prompt-reported",
    "level": "warning",
    "action": {
      "text": "查看提示词",
      "url": "/dashboard/prompts/123"
    },
    "extra": {
      "reportId": 1,
      "promptId": 123,
      "promptName": "示例提示词",
      "reason": "inappropriate",
      "reviewNote": "确认违规，已下架"
    }
  }
}
```

#### 2. 审核拒绝（rejected）时

**通知举报者：**

```json
{
  "type": "notification",
  "data": {
    "id": 3,
    "userId": 1,
    "title": "举报未通过审核",
    "content": "您举报的提示词「示例提示词」未通过审核",
    "category": "report-rejected",
    "level": "info",
    "extra": {
      "reportId": 1,
      "promptId": 123,
      "promptName": "示例提示词",
      "reviewNote": "内容符合规范"
    }
  }
}
```

---

## 5. 封禁提示词（管理员）

### 请求

- **方法**: `POST`
- **路径**: `/api/v1/prompts/:id/ban`
- **权限**: 需要登录，`prompt:ban`

#### 参数

| 参数名 | 类型   | 必填 | 说明                    |
| ------ | ------ | ---- | ----------------------- |
| reason | string | 否   | 封禁原因（最多 500 字） |

#### 示例请求

```json
{
  "reason": "违反社区规范，包含不当内容"
}
```

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "id": 123,
    "name": "示例提示词",
    "isBanned": true,
    "bannedReason": "违反社区规范，包含不当内容",
    "bannedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### WebSocket 通知

封禁成功后，会通过 WebSocket 向提示词作者发送实时通知（支持离线用户，登录时推送）：

```json
{
  "type": "notification",
  "data": {
    "id": 1,
    "userId": 2,
    "title": "您的提示词已被封禁",
    "content": "您的提示词「示例提示词」因违规已被封禁",
    "category": "prompt-banned",
    "level": "error",
    "action": {
      "text": "查看详情",
      "url": "/dashboard/prompts/123"
    },
    "extra": {
      "promptId": 123,
      "promptName": "示例提示词",
      "reason": "违反社区规范，包含不当内容",
      "bannedAt": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

**通知机制：**

- ✅ **用户在线**：实时 WebSocket 推送 + 保存数据库
- ✅ **用户离线**：保存数据库，登录时自动推送

---

## 6. 解封提示词（管理员）

### 请求

- **方法**: `POST`
- **路径**: `/api/v1/prompts/:id/unban`
- **权限**: 需要登录，`prompt:unban`

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "id": 123,
    "name": "示例提示词",
    "isBanned": false,
    "bannedReason": null,
    "bannedAt": null
  }
}
```

### WebSocket 通知

解封成功后，会通过 WebSocket 向提示词作者发送实时通知（支持离线用户，登录时推送）：

```json
{
  "type": "notification",
  "data": {
    "id": 2,
    "userId": 2,
    "title": "您的提示词已解封",
    "content": "您的提示词「示例提示词」已恢复正常状态",
    "category": "prompt-unbanned",
    "level": "success",
    "action": {
      "text": "查看详情",
      "url": "/dashboard/prompts/123"
    },
    "extra": {
      "promptId": 123,
      "promptName": "示例提示词"
    }
  }
}
```

**通知机制：**

- ✅ **用户在线**：实时 WebSocket 推送 + 保存数据库
- ✅ **用户离线**：保存数据库，登录时自动推送

---

## 7. 提交提示词审核（作者）

### 请求

- **方法**: `POST`
- **路径**: `/api/v1/prompts/:id/submit-review`
- **权限**: 需要登录（作者本人）

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "id": 123,
    "name": "示例提示词",
    "needsReview": true,
    "status": "draft"
  }
}
```

#### 错误响应

- `400` - 该提示词不需要审核
- `403` - 只有作者可以提交审核
- `404` - 提示词不存在

### 🔔 通知机制

**提交审核后，系统会自动：**

1. **统计待审核数量**：查询当前所有 `needsReview = true` 的提示词数量
2. **获取管理员列表**：查询所有拥有 `prompt:manage:all` 权限的用户
3. **发送汇总通知**：给每个管理员发送一个汇总通知，格式如下：

```json
{
  "type": "notification",
  "data": {
    "userId": 1,
    "title": "提示词待审核",
    "content": "当前有 3 个提示词等待审核，请及时处理",
    "category": "prompt-review-pending",
    "level": "info",
    "action": {
      "text": "前往审核",
      "url": "/prompt-review"
    },
    "extra": {
      "count": 3
    }
  }
}
```

**优势**：

- ✅ **避免通知轰炸**：多个用户提交审核时，管理员只收到一个汇总通知
- ✅ **实时更新**：显示当前总共有多少个待审核
- ✅ **支持离线**：管理员离线时通知会保存到数据库，登录时自动推送

---

## 8. 审核通过提示词（管理员）

### 请求

- **方法**: `POST`
- **路径**: `/api/v1/prompts/:id/approve`
- **权限**: 需要登录，`prompt:manage:all`

#### 参数

| 参数名      | 类型    | 必填 | 说明                                                                  |
| ----------- | ------- | ---- | --------------------------------------------------------------------- |
| autoPublish | boolean | 否   | 是否自动发布（默认 false）。如果为 true，则自动将提示词改为已发布状态 |
| reviewNote  | string  | 否   | 审核备注                                                              |

#### 示例请求

```json
{
  "autoPublish": true,
  "reviewNote": "修改后已符合规范"
}
```

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "id": 123,
    "name": "示例提示词",
    "needsReview": false,
    "status": "published",
    "isPublic": true
  }
}
```

#### 错误响应

- `400` - 该提示词不需要审核
- `404` - 提示词不存在

### WebSocket 通知

审核通过后，会通过 WebSocket 向提示词作者发送实时通知（支持离线用户，登录时推送）：

**autoPublish = true（自动发布）时：**

```json
{
  "type": "notification",
  "data": {
    "id": 1,
    "userId": 2,
    "title": "您的提示词已审核通过并发布",
    "content": "您的提示词「示例提示词」已通过管理员审核并自动发布",
    "category": "prompt-approved",
    "level": "success",
    "action": {
      "text": "查看详情",
      "url": "/dashboard/prompts/123"
    },
    "extra": {
      "promptId": 123,
      "promptName": "示例提示词",
      "autoPublish": true,
      "reviewNote": "修改后已符合规范"
    }
  }
}
```

**autoPublish = false（仅解除审核限制）时：**

```json
{
  "type": "notification",
  "data": {
    "id": 1,
    "userId": 2,
    "title": "您的提示词已审核通过",
    "content": "您的提示词「示例提示词」已通过管理员审核，您可以自行发布",
    "category": "prompt-approved",
    "level": "success",
    "action": {
      "text": "查看详情",
      "url": "/dashboard/prompts/123"
    },
    "extra": {
      "promptId": 123,
      "promptName": "示例提示词",
      "autoPublish": false,
      "reviewNote": "修改后已符合规范"
    }
  }
}
```

**通知机制：**

- ✅ **用户在线**：实时 WebSocket 推送 + 保存数据库
- ✅ **用户离线**：保存数据库，登录时自动推送

### 功能说明

此接口用于审核那些因举报被下架的提示词。当举报审核通过后，提示词会被自动下架并标记为 `needsReview = true`。作者修改提示词后，可以联系管理员审核。管理员通过此接口审核通过后：

- 如果 `autoPublish = true`：提示词将自动发布并公开
- 如果 `autoPublish = false`：仅解除审核限制，作者可以自行决定是否发布

---

## 9. 拒绝提示词审核（管理员）

### 请求

- **方法**: `POST`
- **路径**: `/api/v1/prompts/:id/reject-review`
- **权限**: 需要登录，`prompt:manage:all`

#### 参数

| 参数名       | 类型   | 必填 | 说明     |
| ------------ | ------ | ---- | -------- |
| rejectReason | string | 否   | 拒绝原因 |

#### 示例请求

```json
{
  "rejectReason": "内容仍然包含不当描述，请进一步修改"
}
```

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "id": 123,
    "name": "示例提示词",
    "needsReview": true,
    "reviewSubmittedAt": null,
    "status": "draft"
  }
}
```

#### 错误响应

- `400` - 该提示词不需要审核
- `404` - 提示词不存在

### WebSocket 通知

拒绝审核后，会通过 WebSocket 向提示词作者发送实时通知（支持离线用户，登录时推送）：

```json
{
  "type": "notification",
  "data": {
    "id": 1,
    "userId": 2,
    "title": "提示词审核未通过",
    "content": "您的提示词「示例提示词」未通过管理员审核：内容仍然包含不当描述，请进一步修改。请根据要求修改后重新提交审核。",
    "category": "prompt-review-rejected",
    "level": "warning",
    "action": {
      "text": "修改提示词",
      "url": "/dashboard/prompts/123/edit"
    },
    "extra": {
      "promptId": 123,
      "promptName": "示例提示词",
      "rejectReason": "内容仍然包含不当描述，请进一步修改"
    }
  }
}
```

**通知机制：**

- ✅ **用户在线**：实时 WebSocket 推送 + 保存数据库
- ✅ **用户离线**：保存数据库，登录时自动推送

### 功能说明

拒绝审核后：

- `needsReview` 保持为 `true`（仍需审核）
- `reviewSnapshot` 保持不变（保留违规快照）
- `reviewSubmittedAt` 重置为 `null`（清除提交时间，允许重新提交）
- 作者收到通知后，可以修改内容并重新点击"提交审核"

---

## 10. 批量更新提示词

### 请求

- **方法**: `POST`
- **路径**: `/api/v1/prompts/batch-update`
- **权限**: 需要登录，`prompt:batch_update`（用户只能更新自己的，管理员可更新所有）

#### 参数

| 参数名             | 类型     | 必填 | 说明                     |
| ------------------ | -------- | ---- | ------------------------ |
| promptIds          | number[] | 是   | 要更新的提示词 ID 列表   |
| isPublic           | boolean  | 否   | 是否公开                 |
| isContentPublic    | boolean  | 否   | 内容是否公开             |
| requireApplication | boolean  | 否   | 是否需要申请             |
| isBanned           | boolean  | 否   | 是否封禁（仅管理员可用） |

#### 示例请求

```json
{
  "promptIds": [1, 2, 3],
  "isPublic": true,
  "isContentPublic": false
}
```

### 响应

#### 成功响应 (200)

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "success": 2,
    "failed": 1,
    "errors": [
      {
        "promptId": 3,
        "error": "无权修改此提示词"
      }
    ]
  }
}
```

---

## 11. 获取所有提示词列表（管理员）

### 请求

- **方法**: `GET`
- **路径**: `/api/v1/prompts/admin/all`
- **权限**: 需要登录，`prompt:manage:all`

#### 查询参数

与普通提示词列表相同，但管理员可以看到所有提示词（包括私有）

### 响应

返回格式与普通提示词列表相同

---

## 数据库结构

### prompt_reports 表

| 字段名      | 类型     | 说明                                  |
| ----------- | -------- | ------------------------------------- |
| id          | int      | 主键                                  |
| prompt_id   | int      | 被举报的提示词 ID                     |
| reporter_id | int      | 举报人 ID                             |
| reason      | enum     | 举报原因                              |
| description | text     | 详细描述                              |
| status      | enum     | 处理状态：pending、approved、rejected |
| reviewer_id | int      | 审核人 ID                             |
| review_note | text     | 审核备注                              |
| reviewed_at | datetime | 审核时间                              |
| created_at  | datetime | 创建时间                              |
| updated_at  | datetime | 更新时间                              |

### prompts 表新增字段

| 字段名              | 类型     | 说明                                                       |
| ------------------- | -------- | ---------------------------------------------------------- |
| is_banned           | boolean  | 是否被封禁                                                 |
| banned_reason       | text     | 封禁原因                                                   |
| banned_at           | datetime | 封禁时间                                                   |
| needs_review        | boolean  | 是否需要管理员审核才能发布                                 |
| review_snapshot     | json     | 审核快照（保存举报前的违规内容用于对比）                   |
| review_submitted_at | datetime | 提交审核时间（NULL=刚被举报还未提交，有值=已提交等待审核） |

---

## 权限说明

### 用户权限

- `prompt:report` - 举报提示词
- `prompt:report:view` - 查看自己的举报记录
- `prompt:batch_update` - 批量更新自己的提示词

### 管理员权限

- `prompt:manage:all` - 管理所有提示词
- `prompt:report:review` - 审核举报
- `prompt:ban` - 封禁提示词
- `prompt:unban` - 解封提示词

---

## 错误码

| 错误码 | 说明         |
| ------ | ------------ |
| 400    | 请求参数错误 |
| 401    | 未登录       |
| 403    | 无权限       |
| 404    | 资源不存在   |
| 500    | 服务器错误   |

---

## 通知类型汇总

| 通知类型                | 触发时机         | 通知对象   | 级别    | 离线支持 |
| ----------------------- | ---------------- | ---------- | ------- | -------- |
| `report-approved`       | 举报审核通过     | 举报者     | success | ✅       |
| `prompt-reported`       | 举报审核通过     | 提示词作者 | warning | ✅       |
| `report-rejected`       | 举报审核拒绝     | 举报者     | info    | ✅       |
| `prompt-banned`         | 管理员封禁       | 提示词作者 | error   | ✅       |
| `prompt-unbanned`       | 管理员解封       | 提示词作者 | success | ✅       |
| `prompt-approved`       | 管理员审核通过   | 提示词作者 | success | ✅       |
| `prompt-review-pending` | 提交审核（汇总） | 管理员     | info    | ✅       |

**所有通知都支持离线用户**：

- 用户在线：实时 WebSocket 推送 + 保存数据库
- 用户离线：保存到数据库，登录时自动推送
- 通知持久化：用户可以在通知列表中查看历史通知

---

## 注意事项

1. 用户不能举报自己的提示词
2. 同一用户对同一提示词只能有一个待处理的举报
3. **举报审核通过后，提示词会自动下架**：
   - 状态改为 `draft`（草稿）
   - `isPublic` 改为 `false`（不公开）
   - `needsReview` 改为 `true`（需要管理员审核）
   - 保存违规内容快照 `reviewSnapshot`
   - `reviewSubmittedAt` 为 `null`（等待作者提交）
4. **作者修改并提交审核**：
   - 作者修改提示词后，点击"提交审核"按钮
   - 系统设置 `reviewSubmittedAt`（标记已提交）
   - **此时才通知管理员**，而不是在举报通过时就通知
5. **管理员审核页面**：
   - 只显示 `reviewSubmittedAt != null` 的提示词
   - 可以对比快照（违规版本）vs 当前内容（修改后版本）
6. **广场过滤规则**：
   - 完全过滤掉 `needsReview=true` 的提示词（包括作者自己的）
   - 完全过滤掉 `status != 'published'` 的提示词（包括作者自己的草稿）
   - 作者的草稿只在"我的提示词"中显示
7. 封禁/解封操作会通过 WebSocket 实时通知提示词作者（支持离线用户）
8. 举报审核会同时通知举报者和提示词作者（审核通过时）
9. 管理员批量更新时可以设置 `isBanned` 字段，普通用户不可以
10. 被封禁的提示词仍然存在数据库中，但会在列表中标记为已封禁
11. 所有通知都会保存到数据库，离线用户登录后可以收到
