# API 21: AIç”Ÿæˆç³»ç»Ÿ

> **ç‰ˆæœ¬**: v1.0  
> **æœ€åæ›´æ–°**: 2025-01-24  
> **çŠ¶æ€**: âœ… å·²å®ç°ï¼ˆAIå†™ä½œæ¨¡å¼ï¼‰

---

## ğŸ“‹ æ¦‚è¿°

AIç”Ÿæˆç³»ç»Ÿæä¾›ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š
1. **AIå†™ä½œæ¨¡å¼**ï¼šåŸºäºæç¤ºè¯ç”Ÿæˆåˆ›æ„å†…å®¹ï¼Œæ”¯æŒäººç‰©å¡å’Œä¸–ç•Œè§‚å¼•ç”¨
2. **è§’è‰²æ‰®æ¼”æ¨¡å¼**ï¼ˆå¾…å®ç°ï¼‰ï¼šåŸºäºSillyTavernè®¾è®¡ï¼Œæ”¯æŒåŠ¨æ€ä¸–ç•Œä¹¦æ¿€æ´»

## ğŸ¯ AIå†™ä½œæ¨¡å¼

### æ ¸å¿ƒç‰¹æ€§

- âœ… æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ
- âœ… å‚æ•°æ›¿æ¢ï¼ˆ{{å‚æ•°å}}ï¼‰
- âœ… å†…ç½®äººç‰©å¡å¼•ç”¨
- âœ… å†…ç½®ä¸–ç•Œè§‚å¼•ç”¨
- âœ… å®ç³»ç»Ÿé›†æˆ
- âœ… Tokené¢„ç®—æ§åˆ¶
- âœ… æµå¼/éæµå¼è¾“å‡º
- âœ… å¤šè½®å¯¹è¯æ”¯æŒ
- âœ… **å­—æ•°è‡ªåŠ¨æ‰£è´¹**

### å­—æ•°æ¶ˆè€—è§„åˆ™

**æ‰£è´¹æ—¶æœº**ï¼š
- âœ… ç”ŸæˆæˆåŠŸåè‡ªåŠ¨æ‰£è´¹
- âœ… å†…å®¹è¢«å®‰å…¨ç­–ç•¥æˆªæ–­ï¼ˆ`finishReason: content_filter`ï¼‰ä»éœ€ä»˜è´¹
- âŒ æ— æ•ˆè¯·æ±‚ï¼ˆå¦‚å‚æ•°é”™è¯¯ã€æƒé™ä¸è¶³ï¼‰ä¸æ‰£è´¹

**è®¡ç®—è§„åˆ™**ï¼š
- æ¶ˆè€—å­—æ•° = (è¾“å…¥å­—ç¬¦æ•° Ã· è¾“å…¥å€ç‡) + (è¾“å‡ºå­—ç¬¦æ•° Ã· è¾“å‡ºå€ç‡)
- ä¼˜å…ˆä½¿ç”¨æ¯æ—¥å…è´¹é¢åº¦ï¼Œç”¨å®Œåä½¿ç”¨ä»˜è´¹é¢åº¦
- è¾“å…¥å°‘äº10000å­—ç¬¦ä¸æ¶ˆè€—è¾“å…¥å­—æ•°
- å…è´¹æ¨¡å‹æ— é¢åº¦æ¶ˆè€—
- ä¼šå‘˜äº«å—è¾“å‡ºå…è´¹ç‰¹æƒ

è¯¦ç»†è§„åˆ™è¯·å‚é˜…ï¼š[å­—æ•°æ¶ˆè€—ç³»ç»Ÿæ–‡æ¡£](./21-å­—æ•°æ¶ˆè€—ç³»ç»Ÿ.md)

### å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚
  â†“
åŠ è½½æç¤ºè¯åŠå†…å®¹
  â†“
è§£æäººç‰©å¡/ä¸–ç•Œè§‚å¼•ç”¨
  â†“
åº”ç”¨å®æ›¿æ¢ï¼ˆå‚æ•°å ä½ç¬¦ï¼‰
  â†“
æ„å»ºæ¶ˆæ¯æ•°ç»„
  â†“
è°ƒç”¨AIç”Ÿæˆ
  â†“
è¿”å›ç»“æœ
```

---

## ğŸ”Œ API æ¥å£

### åŸºç¡€ä¿¡æ¯

- **Base URL**: `/api/v1/generation/writing`
- **è®¤è¯**: éœ€è¦ Bearer Token
- **æƒé™**: `generation:writing:generate`

---

## ğŸ“ AIå†™ä½œç”Ÿæˆï¼ˆéæµå¼ï¼‰

### è¯·æ±‚

**POST** `/api/v1/generation/writing`

**Headers:**
```
Authorization: Bearer <token>
Content-Type: application/json
```

**Body:**
```json
{
  "promptId": 1,
  "parameters": {
    "ä¸»è§’åå­—": "ææ˜",
    "æ•…äº‹èƒŒæ™¯": "ç°ä»£éƒ½å¸‚",
    "å…¶ä»–è¡¥å……": "ç§‘å¹»å…ƒç´ "
  },
  "userInput": "è¯·å¸®æˆ‘å†™ä¸€ä¸ªæ•…äº‹å¼€å¤´",
  "modelId": "gpt-4-turbo",
  "temperature": 0.7,
  "maxTokens": 2048,
  "stream": false,
  "history": [
    {
      "role": "user",
      "content": "æˆ‘æƒ³å†™ä¸€ä¸ªç§‘å¹»æ•…äº‹"
    },
    {
      "role": "assistant",
      "content": "å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼ä½ æœ‰ä»€ä¹ˆå…·ä½“æƒ³æ³•å—ï¼Ÿ"
    }
  ]
}
```

**å‚æ•°è¯´æ˜:**

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| promptId | number | âœ… | æç¤ºè¯ID |
| parameters | object | âŒ | å‚æ•°æ›¿æ¢æ˜ å°„ï¼ˆç”¨äº {{å‚æ•°å}} å ä½ç¬¦ï¼‰ |
| userInput | string | âŒ | ç”¨æˆ·è¾“å…¥å†…å®¹ |
| modelId | string | âŒ | AIæ¨¡å‹IDï¼Œé»˜è®¤ gpt-4-turbo |
| temperature | number | âŒ | æ¸©åº¦å‚æ•°ï¼ˆ0-2ï¼‰ï¼Œé»˜è®¤ 0.7 |
| maxTokens | number | âŒ | æœ€å¤§ç”ŸæˆTokenæ•°ï¼Œé»˜è®¤ 2048 |
| stream | boolean | âŒ | æ˜¯å¦æµå¼è¾“å‡ºï¼Œé»˜è®¤ false |
| history | array | âŒ | å¯¹è¯å†å²ï¼ˆç”¨äºå¤šè½®å¯¹è¯ï¼‰ |

### å“åº”

**Success (200 OK):**
```json
{
  "content": "åœ¨ç¹åçš„éƒ½å¸‚ä¸­ï¼Œç¨‹åºå‘˜ææ˜çªç„¶å‘ç°...",
  "generationId": "gen_abc123",
  "model": "gpt-4-turbo",
  "usage": {
    "promptTokens": 512,
    "completionTokens": 256,
    "totalTokens": 768
  },
  "finishReason": "stop",
  "duration": 3500,
  "consumption": {
    "totalCost": 150,
    "inputCost": 125,
    "outputCost": 50,
    "usedDailyFree": 100,
    "usedPaid": 50,
    "memberBenefitApplied": false
  }
}
```

**å“åº”å­—æ®µ:**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| content | string | ç”Ÿæˆçš„å†…å®¹ |
| generationId | string | ç”ŸæˆIDï¼ˆç”¨äºè¿½è¸ªï¼‰ |
| model | string | ä½¿ç”¨çš„æ¨¡å‹ |
| usage | object | Tokenä½¿ç”¨ç»Ÿè®¡ |
| usage.promptTokens | number | æç¤ºè¯Tokenæ•° |
| usage.completionTokens | number | ç”ŸæˆTokenæ•° |
| usage.totalTokens | number | æ€»Tokenæ•° |
| finishReason | string | å®ŒæˆåŸå› ï¼ˆstop/length/content_filterï¼‰ |
| duration | number | ç”Ÿæˆè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ |
| **consumption** | **object** | **å­—æ•°æ¶ˆè€—ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰** |
| consumption.totalCost | number | æ€»æ¶ˆè€—å­—æ•° |
| consumption.inputCost | number | è¾“å…¥æ¶ˆè€—å­—æ•° |
| consumption.outputCost | number | è¾“å‡ºæ¶ˆè€—å­—æ•° |
| consumption.usedDailyFree | number | ä½¿ç”¨çš„æ¯æ—¥å…è´¹é¢åº¦ |
| consumption.usedPaid | number | ä½¿ç”¨çš„ä»˜è´¹é¢åº¦ |
| consumption.memberBenefitApplied | boolean | æ˜¯å¦åº”ç”¨äº†ä¼šå‘˜ç‰¹æƒ |

**Error (400 Bad Request):**
```json
{
  "statusCode": 400,
  "message": "æ— æƒä½¿ç”¨æ­¤æç¤ºè¯",
  "error": "Bad Request"
}
```

**Error (404 Not Found):**
```json
{
  "statusCode": 404,
  "message": "æç¤ºè¯ ID=999 ä¸å­˜åœ¨",
  "error": "Not Found"
}
```

---

## ğŸŒŠ AIå†™ä½œç”Ÿæˆï¼ˆæµå¼ï¼‰

### è¯·æ±‚

**POST** `/api/v1/generation/writing/stream`

**Headers:**
```
Authorization: Bearer <token>
Content-Type: application/json
```

**Body:** ä¸éæµå¼æ¥å£ç›¸åŒ

### å“åº”

**Success (200 OK):**

å“åº”ç±»å‹ï¼š`text/event-stream`

**SSE æ•°æ®æ ¼å¼:**
```
data: {"content":"åœ¨"}

data: {"content":"ç¹å"}

data: {"content":"çš„"}

data: {"content":"éƒ½å¸‚"}

data: [DONE]
```

æ¯ä¸ª `data:` è¡ŒåŒ…å«ä¸€ä¸ª JSON å¯¹è±¡ï¼š
- `content`: å½“å‰ç”Ÿæˆçš„æ–‡æœ¬ç‰‡æ®µ
- æœ€åå‘é€ `[DONE]` è¡¨ç¤ºç”Ÿæˆç»“æŸ

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•æ–‡æœ¬ç”Ÿæˆ

```typescript
// è¯·æ±‚
const response = await fetch('/api/v1/generation/writing', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    promptId: 1,
    userInput: 'å†™ä¸€ä¸ªç§‘å¹»æ•…äº‹çš„å¼€å¤´',
    temperature: 0.8,
    maxTokens: 500,
  }),
});

const result = await response.json();
console.log(result.content);
```

### ç¤ºä¾‹ 2: å¸¦å‚æ•°æ›¿æ¢

```typescript
const response = await fetch('/api/v1/generation/writing', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    promptId: 2,
    parameters: {
      'ä¸»è§’åå­—': 'å¼ ä¸‰',
      'ä¸»è§’èŒä¸š': 'ä¾¦æ¢',
      'æ•…äº‹èƒŒæ™¯': 'æ°‘å›½æ—¶æœŸ',
    },
    userInput: 'å¼€å§‹å†™ç¬¬ä¸€ç« ',
  }),
});
```

### ç¤ºä¾‹ 3: æµå¼è¾“å‡º

```typescript
const response = await fetch('/api/v1/generation/writing/stream', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    promptId: 1,
    userInput: 'å†™ä¸€æ®µæå†™',
    stream: true,
  }),
});

const reader = response.body.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  
  const chunk = decoder.decode(value);
  const lines = chunk.split('\n');
  
  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = line.slice(6);
      if (data === '[DONE]') {
        console.log('ç”Ÿæˆå®Œæˆ');
      } else {
        const json = JSON.parse(data);
        process.stdout.write(json.content);
      }
    }
  }
}
```

### ç¤ºä¾‹ 4: å¤šè½®å¯¹è¯

```typescript
// ç¬¬ä¸€è½®
const round1 = await fetch('/api/v1/generation/writing', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    promptId: 1,
    userInput: 'æˆ‘æƒ³å†™ä¸€ä¸ªæ‚¬ç–‘å°è¯´',
  }),
});

const result1 = await round1.json();

// ç¬¬äºŒè½®ï¼ˆå¸¦å†å²ï¼‰
const round2 = await fetch('/api/v1/generation/writing', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    promptId: 1,
    userInput: 'ä¸»è§’æ˜¯ä¸€åè®°è€…',
    history: [
      { role: 'user', content: 'æˆ‘æƒ³å†™ä¸€ä¸ªæ‚¬ç–‘å°è¯´' },
      { role: 'assistant', content: result1.content },
    ],
  }),
});
```

---

## ğŸ”— æç¤ºè¯å†…å®¹ç±»å‹

AIå†™ä½œæ¨¡å¼æ”¯æŒä¸‰ç§å†…å®¹ç±»å‹ï¼š

### 1. æ–‡æœ¬å†…å®¹ï¼ˆtextï¼‰

æ™®é€šæ–‡æœ¬å†…å®¹ï¼Œæ”¯æŒå‚æ•°å ä½ç¬¦ï¼š
```
ç³»ç»Ÿæç¤ºï¼šä½ æ˜¯ä¸€åä¸“ä¸šçš„å°è¯´ä½œå®¶...

æƒ…èŠ‚è®¾å®šï¼š{{æ•…äº‹èƒŒæ™¯}}ï¼Œä¸»è§’åä¸º{{ä¸»è§’åå­—}}...
```

### 2. äººç‰©å¡å¼•ç”¨ï¼ˆcharacterï¼‰

å¼•ç”¨å°è¯´é¡¹ç›®ä¸­çš„äººç‰©å¡ï¼š
```json
{
  "type": "character",
  "referenceId": 123,
  "name": "ä¸»è§’è®¾å®š"
}
```

è‡ªåŠ¨åŠ è½½äººç‰©å¡çš„æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µå¹¶æ ¼å¼åŒ–ä¸ºï¼š
```
ã€äººç‰©å¡ï¼šææ˜ã€‘
å§“å: ææ˜
å¹´é¾„: 28å²
èŒä¸š: ç¨‹åºå‘˜
æ€§æ ¼: å†…å‘ã€ç»†å¿ƒ
```

### 3. ä¸–ç•Œè§‚å¼•ç”¨ï¼ˆworldviewï¼‰

å¼•ç”¨å°è¯´é¡¹ç›®ä¸­çš„ä¸–ç•Œè§‚è®¾å®šï¼š
```json
{
  "type": "worldview",
  "referenceId": 456,
  "name": "ä¸–ç•Œè®¾å®š"
}
```

è‡ªåŠ¨åŠ è½½ä¸–ç•Œè§‚çš„æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µå¹¶æ ¼å¼åŒ–ã€‚

---

## ğŸ” æƒé™è¯´æ˜

### å¿…éœ€æƒé™

- `generation:writing:generate`: AIå†™ä½œç”Ÿæˆæƒé™

### æç¤ºè¯è®¿é—®æƒé™

- ç”¨æˆ·å¿…é¡»æ˜¯æç¤ºè¯ä½œè€…ï¼Œæˆ–è€…æç¤ºè¯æ˜¯å…¬å¼€çš„ï¼ˆ`isPublic: true`ï¼‰
- ç§æœ‰æç¤ºè¯åªèƒ½ç”±ä½œè€…ä½¿ç”¨

### äººç‰©å¡/ä¸–ç•Œè§‚è®¿é—®æƒé™

- å¼•ç”¨çš„äººç‰©å¡å’Œä¸–ç•Œè§‚å¿…é¡»å±äºç”¨æˆ·è‡ªå·±çš„å°è¯´é¡¹ç›®
- è·¨ç”¨æˆ·è®¿é—®ä¼šè¢«è‡ªåŠ¨è·³è¿‡ï¼Œä¸ä¼šæŠ›å‡ºé”™è¯¯

---

## âš™ï¸ æŠ€æœ¯å®ç°

### Tokené¢„ç®—ç®¡ç†

ç³»ç»Ÿä½¿ç”¨ `AdvancedTokenManagerService` è¿›è¡ŒTokenä¼°ç®—ï¼š
- æŒ‰ 3.35 å­—ç¬¦/token ä¼°ç®—ï¼ˆä¸ SillyTavern ä¸€è‡´ï¼‰
- æ”¯æŒä¸­è‹±æ–‡æ··åˆæ–‡æœ¬
- è¯¯å·®èŒƒå›´ Â±10%

### å®ç³»ç»Ÿé›†æˆ

æ”¯æŒä»¥ä¸‹å®æ›¿æ¢ï¼š
- å‚æ•°å®ï¼š`{{å‚æ•°å}}`
- æ—¶é—´å®ï¼š`{{time}}`, `{{date}}`
- éšæœºå®ï¼š`{{random::é€‰é¡¹1::é€‰é¡¹2}}`
- æ–‡æœ¬å®ï¼š`{{trim}}`

è¯¦è§ï¼š[API 14: å®ç³»ç»Ÿ](./14-å®ç³»ç»Ÿ.md)

### æ¶ˆæ¯ç»„è£…é¡ºåº

1. æç¤ºè¯å†…å®¹ï¼ˆæŒ‰ order æ’åºï¼‰
2. å¯¹è¯å†å²
3. ç”¨æˆ·è¾“å…¥

---

## ğŸš€ è§’è‰²æ‰®æ¼”æ¨¡å¼ï¼ˆå¾…å®ç°ï¼‰

è§’è‰²æ‰®æ¼”æ¨¡å¼å°†æ”¯æŒï¼š
- SillyTavern è§’è‰²å¡æ ¼å¼ï¼ˆV1/V2/V3ï¼‰
- åŠ¨æ€ä¸–ç•Œä¹¦æ¿€æ´»
- 8ç§ä½ç½®ç±»å‹
- é€’å½’æ‰«æ
- Tokené¢„ç®—æ§åˆ¶
- åŒ…å«ç»„å’Œæ—¶æ•ˆæ€§ç®¡ç†

è¯¦æƒ…è¯·å…³æ³¨åç»­æ›´æ–°ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [API 06: æç¤ºè¯ç®¡ç†](./06-æç¤ºè¯ç®¡ç†.md)
- [API 13: è§’è‰²å¡ç®¡ç†](./13-è§’è‰²å¡ç®¡ç†.md)
- [API 14: å®ç³»ç»Ÿ](./14-å®ç³»ç»Ÿ.md)
- [API 15: å†å²æ¶ˆæ¯ç®¡ç†](./15-å†å²æ¶ˆæ¯ç®¡ç†.md)
- [AIæ¨¡å‹ç®¡ç†](../backend/src/ai-models/README.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2025-01-24
- âœ… å®ç°AIå†™ä½œç”ŸæˆåŸºç¡€åŠŸèƒ½
- âœ… æ”¯æŒäººç‰©å¡å’Œä¸–ç•Œè§‚å¼•ç”¨
- âœ… é›†æˆå®ç³»ç»Ÿ
- âœ… æ”¯æŒæµå¼å’Œéæµå¼è¾“å‡º
- âœ… æ”¯æŒå¤šè½®å¯¹è¯
- âœ… æ·»åŠ æƒé™æ§åˆ¶
