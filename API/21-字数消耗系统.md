# 字数消耗系统 API 文档

## 概述

字数消耗系统实现基于模型倍率的字数计算，支持每日免费额度、会员特权等功能。

### 核心规则

**消耗计算公式**：

```
消耗字数 = (输入字符数 ÷ 输入倍率) + (生成字符数 ÷ 输出倍率)
```

**字符数统计方式**：

- **非流式生成**：优先使用 API 返回的 `token` 数据（更准确，包含推理过程等所有输出）
- **流式生成**：使用实际文本字符数统计（流式响应限制，可能无法包含隐藏的推理过程）

**消耗优先级**：

1. 优先使用每日免费额度
2. 用完后自动使用付费额度

**特殊规则**：

- 合计输入小于 10000 字符不消耗输入字数
- 输入倍率和输出倍率均为 0 的模型不消耗任何字数（但需余额>0）
- 免费模型无额度消耗

**会员特权**：

- 输出完全免费：会员用户的 AI 生成输出内容完全免费
- 输入免费额度：每次请求在会员免费字符数内的输入不消耗字数

**⚠️ 重要说明**：

- 使用 **thinking 模式**（如 Claude 3.7/4.x）或 **推理模式**（如 OpenAI o1）时，推理过程的 token 也会被正确计费
- 流式生成可能无法捕获推理过程的完整 token，建议对精确计费场景使用非流式生成

---

## 一、余额查询

### 1.1 查询用户余额

**接口**：`GET /api/v1/token-balances`

**权限**：需要登录

**响应**：

```json
{
  "id": 1,
  "userId": 123,
  "totalTokens": 10000,
  "usedTokens": 2000,
  "giftTokens": 1000,
  "paidTokens": 9000,
  "frozenTokens": 0,
  "dailyFreeQuota": 5000,
  "dailyUsedQuota": 2000,
  "quotaResetDate": "2025-01-25",
  "lastConsumedAt": "2025-01-25T10:30:00Z"
}
```

### 1.2 查询每日免费额度

**接口**：`GET /api/v1/token-balances/daily-quota`

**权限**：需要登录

**响应**：

```json
{
  "dailyFreeQuota": 5000,
  "dailyUsedQuota": 2000,
  "dailyRemainingQuota": 3000,
  "quotaResetDate": "2025-01-25T00:00:00Z"
}
```

---

## 二、消耗记录

### 2.1 查询消耗记录

**接口**：`GET /api/v1/token-balances/consumptions`

**权限**：`token-consumption:view-records`

**查询参数**：

| 参数      | 类型   | 必填 | 说明                            |
| --------- | ------ | ---- | ------------------------------- |
| source    | string | 否   | 来源过滤：chat/generation/agent |
| startDate | string | 否   | 开始日期：2025-01-01            |
| endDate   | string | 否   | 结束日期：2025-01-31            |
| page      | number | 否   | 页码，默认 1                    |
| limit     | number | 否   | 每页数量，默认 20               |

**响应**：

```json
{
  "data": [
    {
      "id": 1,
      "userId": 123,
      "modelId": 5,
      "inputChars": 500,
      "outputChars": 200,
      "inputRatio": 4.0,
      "outputRatio": 1.0,
      "calculatedInputCost": 125,
      "calculatedOutputCost": 200,
      "totalCost": 325,
      "usedDailyFree": 200,
      "usedPaid": 125,
      "isMember": true,
      "memberFreeInput": 5000,
      "source": "chat",
      "relatedId": 456,
      "createdAt": "2025-01-25T10:30:00Z"
    }
  ],
  "total": 100,
  "page": 1,
  "limit": 20,
  "totalPages": 5
}
```

### 2.2 查询消耗统计

**接口**：`GET /api/v1/token-balances/statistics`

**权限**：`token-consumption:view-statistics`

**查询参数**：

| 参数      | 类型   | 必填 | 说明     |
| --------- | ------ | ---- | -------- |
| startDate | string | 否   | 开始日期 |
| endDate   | string | 否   | 结束日期 |

**响应**：

```json
{
  "totalConsumed": 10000,
  "totalInputChars": 50000,
  "totalOutputChars": 10000,
  "totalDailyFreeUsed": 5000,
  "totalPaidUsed": 5000,
  "requestCount": 50,
  "bySource": {
    "chat": 6000,
    "generation": 3000,
    "agent": 1000
  }
}
```

---

## 三、AI 调用（自动扣费）

### 3.1 聊天补全

**接口**：`POST /api/v1/chat/completions`

**权限**：`ai:chat:create`

**请求体**：

```json
{
  "model": "5",
  "messages": [{ "role": "user", "content": "你好" }],
  "temperature": 0.7,
  "max_tokens": 2048
}
```

**响应**：

```json
{
  "id": "chatcmpl-123",
  "model": "gpt-4-turbo",
  "choices": [...],
  "usage": {
    "prompt_tokens": 50,
    "completion_tokens": 20,
    "total_tokens": 70
  },
  "consumption": {
    "totalCost": 150,
    "inputCost": 125,
    "outputCost": 50,
    "usedDailyFree": 100,
    "usedPaid": 50,
    "memberBenefitApplied": true
  }
}
```

---

## 四、管理端接口

### 4.1 设置用户每日免费额度

**接口**：`POST /api/v1/token-balances/:userId/daily-quota`

**权限**：`token-consumption:admin-manage`

**请求体**：

```json
{
  "quota": 10000
}
```

**响应**：

```json
{
  "message": "设置成功"
}
```

### 4.2 重置指定用户的每日免费额度

**接口**：`POST /api/v1/token-balances/admin/reset-daily-quota/:userId`

**权限**：`token-consumption:reset-quota`

**路径参数**：

| 参数   | 类型   | 必填 | 说明    |
| ------ | ------ | ---- | ------- |
| userId | number | ✅   | 用户 ID |

**响应**：

```json
{
  "success": true,
  "message": "用户 123 的每日免费额度已重置"
}
```

### 4.3 批量重置所有用户每日免费额度

**接口**：`POST /api/v1/token-balances/admin/reset-all-daily-quotas`

**权限**：`token-consumption:reset-quota`

**说明**：手动触发批量重置，效果与每天凌晨的定时任务相同。

**响应**：

```json
{
  "success": true,
  "message": "已重置 1234 个用户的每日免费额度",
  "affected": 1234
}
```

---

## 五、错误码

| 状态码 | 错误信息                               | 说明                      |
| ------ | -------------------------------------- | ------------------------- |
| 400    | 字数余额不足，请充值后继续使用         | 总余额不足                |
| 400    | 字数余额不足。需要 350 字，可用 200 字 | 详细余额信息              |
| 400    | 账户余额必须大于 0                     | 倍率为 0 的模型仍需余额>0 |
| 404    | 模型不存在                             | 模型 ID 错误              |

---

## 六、数据字典

### 消耗来源（source）

| 值         | 说明        |
| ---------- | ----------- |
| chat       | 聊天补全    |
| generation | AI 写作生成 |
| agent      | 智能体      |

### 模型配置字段

| 字段          | 说明               | 示例  |
| ------------- | ------------------ | ----- |
| inputRatio    | 输入倍率           | 4.0   |
| outputRatio   | 输出倍率           | 1.0   |
| isFree        | 是否免费模型       | false |
| minInputChars | 最小消耗输入字符数 | 10000 |

### 会员特权字段

| 字段                     | 说明                   | 示例 |
| ------------------------ | ---------------------- | ---- |
| freeInputCharsPerRequest | 每次请求免费输入字符数 | 5000 |
| outputFree               | 输出是否完全免费       | true |

---

## 七、计算示例

### 示例 1：普通用户，无会员

- 输入：10000 字，倍率 4.0
- 输出：1000 字，倍率 1.0
- 计算：
  - 输入消耗：10000 ÷ 4 = 2500 字
  - 输出消耗：1000 ÷ 1 = 1000 字
  - 总消耗：3500 字

### 示例 2：会员用户（输出免费）

- 输入：10000 字，倍率 4.0
- 输出：1000 字，倍率 1.0
- 会员特权：输出免费
- 计算：
  - 输入消耗：2500 字
  - 输出消耗：0 字（会员免费）
  - 总消耗：2500 字

### 示例 3：会员用户（输入部分免费）

- 输入：8000 字，倍率 4.0
- 输出：1000 字，倍率 1.0
- 会员特权：前 5000 字输入免费，输出免费
- 计算：
  - 免费输入：5000 ÷ 4 = 1250 字
  - 实际输入消耗：2000 - 1250 = 750 字
  - 输出消耗：0 字
  - 总消耗：750 字

### 示例 4：输入少于 10000 字

- 输入：5000 字，倍率 4.0
- 输出：1000 字，倍率 1.0
- 计算：
  - 输入消耗：0 字（少于阈值）
  - 输出消耗：1000 字
  - 总消耗：1000 字

---

## 八、数据库表结构

### ai_models 新增字段

- `input_ratio` DECIMAL(8,2) - 输入倍率
- `output_ratio` DECIMAL(8,2) - 输出倍率
- `is_free` BOOLEAN - 是否免费模型
- `min_input_chars` INT - 最小消耗输入字符数

### user_token_balances 新增字段

- `daily_free_quota` BIGINT - 每日免费额度
- `daily_used_quota` BIGINT - 今日已用免费额度
- `quota_reset_date` DATE - 额度重置日期
- `paid_tokens` BIGINT - 付费字数余额

### membership_plans 新增字段

- `free_input_chars_per_request` INT - 每次请求免费输入字符数
- `output_free` BOOLEAN - 输出是否完全免费

### token_consumption_records（新表）

完整的消耗记录表，记录每次 AI 调用的详细消耗信息。

---

## 九、权限说明

- `token-consumption:view-records` - 查看消耗记录（普通用户）
- `token-consumption:view-statistics` - 查看消耗统计（普通用户）
- `token-consumption:admin-manage` - 管理用户额度（管理员）
- `token-consumption:reset-quota` - 重置每日额度（管理员）

---

## 十、相关文档

- [总体规划](../docs/字数消耗系统/00-总体规划.md)
- [数据库改造](../docs/字数消耗系统/01-数据库改造.md)
- [模块 README](../backend/src/token-balances/README.md)
- [SQL 文件](../backend/sql/)
