# 19. 订单系统 API

## 概述

订单系统处理会员和字数包的购买、支付、退款等流程。

**模块路径**: `backend/src/orders/`

**注意**: 本系统为简化版，实际生产环境需对接第三方支付网关（支付宝、微信支付等）。

---

## 订单管理

### 1. 创建订单

**接口**: `POST /api/v1/orders`

**认证**: 必需

**请求体**:
```json
{
  "type": "membership",
  "productId": 2,
  "paymentMethod": "alipay",
  "remark": "备注信息"
}
```

**字段说明**:
- `type` (必需): 订单类型
  - `membership`: 会员订单
  - `token`: 字数包订单
- `productId` (必需): 产品ID（会员套餐ID 或 字数包ID）
- `paymentMethod` (可选): 支付方式（alipay/wechat/balance）
- `remark` (可选): 备注

**响应**:
```json
{
  "id": 1,
  "orderNo": "ORD17377000123450001",
  "userId": 10,
  "type": "membership",
  "productId": 2,
  "productName": "专业版",
  "amount": 99.00,
  "paymentMethod": "alipay",
  "status": "pending",
  "paidAt": null,
  "refundedAt": null,
  "transactionId": null,
  "remark": "备注信息",
  "createdAt": "2025-01-26T10:00:00.000Z",
  "updatedAt": "2025-01-26T10:00:00.000Z"
}
```

---

### 2. 支付订单

**接口**: `POST /api/v1/orders/:orderNo/pay`

**认证**: 必需

**请求体**:
```json
{
  "transactionId": "2025012622001234567890123456"
}
```

**字段说明**:
- `transactionId` (可选): 第三方支付平台的交易号

**响应**: 同创建订单

**说明**:
- 支付成功后自动发货（激活会员或充值字数）
- 实际生产环境应由支付网关回调触发

---

### 3. 申请退款

**接口**: `POST /api/v1/orders/:orderNo/refund`

**认证**: 必需

**响应**: 同创建订单

**说明**:
- 仅支持已支付订单退款
- 字数包退款会扣除对应字数
- 会员退款需单独处理（当前简化实现）

---

### 4. 取消订单

**接口**: `POST /api/v1/orders/:orderNo/cancel`

**认证**: 必需

**响应**: 同创建订单

**说明**:
- 仅支持待支付订单取消

---

### 5. 查询订单详情

**接口**: `GET /api/v1/orders/:orderNo`

**认证**: 必需

**响应**: 同创建订单

---

### 6. 查询我的订单

**接口**: `GET /api/v1/orders/my`

**认证**: 必需

**查询参数**:
- `status` (enum, 可选): 订单状态
  - `pending`: 待支付
  - `paid`: 已支付
  - `refunded`: 已退款
  - `cancelled`: 已取消
- `page` (number, 可选, 默认: 1)
- `limit` (number, 可选, 默认: 20)

**响应**: 分页列表格式

---

## 订单状态流转

```
pending (待支付)
  ├─> paid (已支付) ─> refunded (已退款)
  └─> cancelled (已取消)
```

**状态说明**:
- `pending`: 订单已创建，等待支付
- `paid`: 支付成功，已发货
- `refunded`: 已退款
- `cancelled`: 用户主动取消

---

## 订单号规则

**格式**: `ORD + 13位时间戳 + 4位随机数`

**示例**: `ORD17377000123450001`

**特性**:
- 全局唯一
- 可根据时间戳排序
- 长度固定20位

---

## 发货逻辑

### 会员订单
```typescript
// 自动激活会员
await userMembershipsService.activate(
  userId,
  planId,
  MembershipSource.PURCHASE,
  orderId
);
```

### 字数包订单
```typescript
// 自动充值字数（基础字数 + 赠送字数）
const totalTokens = tokenAmount + bonusTokens;
await tokenBalancesService.recharge(
  userId,
  totalTokens,
  bonusTokens > 0,  // 是否为赠送
  'purchase',
  orderId
);
```

---

## 退款逻辑

### 字数包退款
1. 检查用户是否已使用超过退款金额对应的字数
2. 扣除对应字数
3. 记录退款流水

### 会员退款
- 当前简化实现：仅更新订单状态
- 实际应处理：
  - 停用会员
  - 计算已使用天数
  - 按比例退款

---

## 错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 订单状态不允许该操作 / 该套餐已下架 / 该字数包已下架 |
| 404 | 订单不存在 |

---

## 集成支付网关

**推荐流程**:

1. **创建订单**: `POST /orders`
2. **调起支付**: 跳转到支付宝/微信支付
3. **支付回调**: 支付网关异步通知
4. **更新订单**: 验证签名后调用 `POST /orders/:orderNo/pay`
5. **自动发货**: 系统自动完成

**安全建议**:
- 验证支付回调签名
- 使用事务确保一致性
- 记录详细日志
- 实现幂等性（防止重复发货）

---

**更新时间**: 2025-01-26  
**版本**: v1.0
