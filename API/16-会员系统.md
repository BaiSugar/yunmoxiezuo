# 16. 会员系统 API

## 概述

会员系统提供完整的会员套餐管理和用户会员激活功能，支持多等级会员体系。

**模块路径**: `backend/src/memberships/`

---

## 会员套餐管理

### 1. 创建会员套餐

**接口**: `POST /api/v1/membership-plans`

**权限**: `membership:plan:create`

**请求体**:
```json
{
  "name": "专业版",
  "level": 2,
  "price": 99.00,
  "duration": 30,
  "tokenQuota": 1000000,
  "dailyTokenLimit": 50000,
  "maxConcurrentChats": 5,
  "canUseAdvancedModels": true,
  "priority": 7,
  "features": {
    "apiAccess": true,
    "customService": true
  },
  "sort": 1,
  "description": "适合专业用户使用"
}
```

**响应**:
```json
{
  "id": 1,
  "name": "专业版",
  "level": 2,
  "price": 99.00,
  "duration": 30,
  "tokenQuota": 1000000,
  "dailyTokenLimit": 50000,
  "maxConcurrentChats": 5,
  "canUseAdvancedModels": true,
  "priority": 7,
  "features": {
    "apiAccess": true,
    "customService": true
  },
  "isActive": true,
  "sort": 1,
  "description": "适合专业用户使用",
  "createdAt": "2025-01-26T10:00:00.000Z",
  "updatedAt": "2025-01-26T10:00:00.000Z"
}
```

---

### 2. 查询套餐列表

**接口**: `GET /api/v1/membership-plans`

**认证**: 公开接口（无需登录）

**查询参数**:
- `isActive` (boolean, 可选): 是否上架
- `minLevel` (number, 可选): 最低等级
- `maxLevel` (number, 可选): 最高等级
- `page` (number, 可选, 默认: 1): 页码
- `limit` (number, 可选, 默认: 20): 每页数量

**响应**:
```json
{
  "data": [
    {
      "id": 1,
      "name": "基础版",
      "level": 1,
      "price": 29.00,
      "duration": 30,
      "tokenQuota": 300000,
      "dailyTokenLimit": 20000,
      "maxConcurrentChats": 3,
      "canUseAdvancedModels": false,
      "priority": 5,
      "features": {},
      "isActive": true,
      "sort": 0,
      "description": "入门级会员"
    }
  ],
  "total": 3,
  "page": 1,
  "limit": 20,
  "totalPages": 1
}
```

---

### 3. 获取套餐详情

**接口**: `GET /api/v1/membership-plans/:id`

**认证**: 公开接口（无需登录）

**响应**: 同创建接口

---

### 4. 更新套餐

**接口**: `PUT /api/v1/membership-plans/:id`

**权限**: `membership:plan:update`

**请求体**: 同创建接口（所有字段可选）

---

### 5. 删除套餐

**接口**: `DELETE /api/v1/membership-plans/:id`

**权限**: `membership:plan:delete`

---

### 6. 上架/下架套餐

**接口**: 
- 上架: `POST /api/v1/membership-plans/:id/activate`
- 下架: `POST /api/v1/membership-plans/:id/deactivate`

**权限**: `membership:plan:update`

---

## 用户会员管理

### 7. 获取我的活跃会员

**接口**: `GET /api/v1/user-memberships/my/active`

**认证**: 必需

**响应**:
```json
{
  "id": 1,
  "userId": 10,
  "planId": 2,
  "level": 2,
  "startDate": "2025-01-26T00:00:00.000Z",
  "endDate": "2025-02-25T23:59:59.999Z",
  "isActive": true,
  "source": "purchase",
  "orderId": 123,
  "autoRenew": false,
  "plan": {
    "id": 2,
    "name": "专业版",
    "level": 2,
    "price": 99.00,
    "duration": 30,
    "tokenQuota": 1000000
  },
  "createdAt": "2025-01-26T10:00:00.000Z",
  "updatedAt": "2025-01-26T10:00:00.000Z"
}
```

**说明**:
- 返回当前用户最高等级的活跃会员
- 如无活跃会员，返回 `null`

---

### 8. 获取我的会员记录

**接口**: `GET /api/v1/user-memberships/my`

**认证**: 必需

**查询参数**:
- `page` (number, 可选, 默认: 1)
- `limit` (number, 可选, 默认: 20)

**响应**: 分页列表格式

---

### 9. 取消自动续费

**接口**: `POST /api/v1/user-memberships/:membershipId/cancel-auto-renew`

**认证**: 必需

---

## 会员等级说明

| 等级 | 说明 |
|------|------|
| 0 | 免费用户（未购买会员） |
| 1 | 基础会员 |
| 2 | 专业会员 |
| 3 | 企业会员 |
| 4+ | 自定义等级 |

**等级规则**:
- 数字越大，等级越高
- 高等级会员拥有低等级所有权益
- 同时购买多个会员，保留最高等级

---

## 会员叠加规则

1. **同等级叠加**: 延长有效期（时间累加）
2. **升级**: 立即生效，旧会员停用
3. **降级**: 拒绝购买（不允许降级）
4. **永久会员**: `duration = 0` 且 `endDate = null`

---

## 会员来源

- `purchase`: 购买获得
- `redeem`: 卡密兑换
- `gift`: 系统赠送
- `activity`: 活动获得

---

## 会员权限检查

### 功能说明

系统提供完整的会员权限检查服务，可在任何需要的地方使用。

**核心服务**: `MembershipPermissionsService`

### 检查方法

#### 1. 检查会员等级
```typescript
// 检查用户是否满足最低等级要求
await membershipPermissions.checkMinLevel(userId, 2);
// 返回: true/false
```

#### 2. 检查高级模型权限
```typescript
// 检查用户是否可以使用高级AI模型
await membershipPermissions.canUseAdvancedModels(userId);
// 返回: true/false
```

#### 3. 获取每日字数限制
```typescript
// 获取用户每日可用字数限制
await membershipPermissions.getDailyTokenLimit(userId);
// 返回: 50000（数字），0表示无限制
```

#### 4. 获取并发对话数
```typescript
// 获取用户最大并发对话数
await membershipPermissions.getMaxConcurrentChats(userId);
// 返回: 5（数字）
```

#### 5. 获取队列优先级
```typescript
// 获取用户请求队列优先级（1-10）
await membershipPermissions.getQueuePriority(userId);
// 返回: 7（数字越大优先级越高）
```

#### 6. 检查特定权益
```typescript
// 检查用户是否拥有特定权益
await membershipPermissions.hasFeature(userId, 'apiAccess');
// 返回: true/false
```

**常见权益**:
- `apiAccess`: API 访问
- `customService`: 专属客服
- `advancedAnalytics`: 高级分析
- `teamCollaboration`: 团队协作
- `prioritySupport`: 优先支持

#### 7. 获取所有权益
```typescript
// 获取用户所有会员权益
await membershipPermissions.getUserFeatures(userId);
```

**响应**:
```json
{
  "level": 2,
  "canUseAdvancedModels": true,
  "dailyTokenLimit": 50000,
  "maxConcurrentChats": 5,
  "priority": 7,
  "features": {
    "apiAccess": true,
    "customService": true
  }
}
```

---

### 在控制器中使用装饰器

```typescript
import { RequireMembershipLevel, RequireMembershipFeature } from '@common/decorators/require-membership.decorator';
import { MembershipGuard } from '@common/guards/membership.guard';

@Controller('advanced')
@UseGuards(JwtAuthGuard, MembershipGuard)
export class AdvancedController {
  
  // 要求 2 级或以上会员
  @Get('premium')
  @RequireMembershipLevel(2)
  getPremium() {
    return { message: '专业版功能' };
  }

  // 要求拥有 API 访问权益
  @Get('api')
  @RequireMembershipFeature('apiAccess')
  getApi() {
    return { message: 'API 访问' };
  }
}
```

---

### 使用场景

#### 场景 1: AI 模型限制
```typescript
// 根据会员等级提供不同模型
const canUseAdvanced = await membershipPermissions.canUseAdvancedModels(userId);
const models = canUseAdvanced 
  ? ['gpt-4', 'claude-2', 'gemini-pro']
  : ['gpt-3.5-turbo', 'claude-instant'];
```

#### 场景 2: 并发控制
```typescript
// 限制同时进行的对话数
const maxChats = await membershipPermissions.getMaxConcurrentChats(userId);
if (activeChats >= maxChats) {
  throw new ForbiddenException(`最多 ${maxChats} 个并发对话`);
}
```

#### 场景 3: 每日限额
```typescript
// 检查每日字数使用
const dailyLimit = await membershipPermissions.getDailyTokenLimit(userId);
if (dailyLimit > 0 && todayUsed >= dailyLimit) {
  throw new ForbiddenException('超过每日字数限制');
}
```

**详细文档**: `backend/src/memberships/MEMBERSHIP_PERMISSIONS.md`

---

## 错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 等级已存在 / 当前会员等级高于要开通的等级 |
| 404 | 套餐不存在 / 会员记录不存在 |

---

**更新时间**: 2025-01-26  
**版本**: v1.0
