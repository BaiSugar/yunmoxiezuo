# 权限管理模块 API

## 基础信息

- **模块路径**: `/api/v1/permissions`
- **接口数量**: 6
- **认证方式**: 所有接口都需要 Bearer Token

---

## 目录

1. [获取权限列表（平铺）](#1-获取权限列表平铺)
2. [获取权限树](#2-获取权限树)
3. [获取权限详情](#3-获取权限详情)
4. [创建权限](#4-创建权限)
5. [更新权限](#5-更新权限)
6. [删除权限](#6-删除权限)

---

## 1. 获取权限列表（平铺）

### 基本信息

- **接口路径**: `GET /api/v1/permissions`
- **接口说明**: 获取所有权限的平铺列表
- **所需权限**: `permission:list`

### 请求示例

```http
GET /api/v1/permissions
Authorization: Bearer {accessToken}
```

### 响应示例

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "parentId": null,
      "name": "用户管理",
      "code": "user",
      "type": "menu",
      "resource": null,
      "method": null,
      "description": "用户管理模块",
      "sortOrder": 0,
      "status": "active",
      "createdAt": "2024-01-01T10:00:00.000Z",
      "updatedAt": "2024-01-01T10:00:00.000Z"
    },
    {
      "id": 2,
      "parentId": 1,
      "name": "查看用户列表",
      "code": "user:list",
      "type": "api",
      "resource": "/api/v1/users",
      "method": "GET",
      "description": "查看用户列表权限",
      "sortOrder": 0,
      "status": "active",
      "createdAt": "2024-01-01T10:00:00.000Z",
      "updatedAt": "2024-01-01T10:00:00.000Z"
    }
  ],
  "timestamp": 1234567890
}
```

---

## 2. 获取权限树

### 基本信息

- **接口路径**: `GET /api/v1/permissions/tree`
- **接口说明**: 获取权限的树形结构
- **所需权限**: `permission:list`

### 请求示例

```http
GET /api/v1/permissions/tree
Authorization: Bearer {accessToken}
```

### 响应示例

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "parentId": null,
      "name": "用户管理",
      "code": "user",
      "type": "menu",
      "resource": null,
      "method": null,
      "description": "用户管理模块",
      "children": [
        {
          "id": 2,
          "parentId": 1,
          "name": "查看用户列表",
          "code": "user:list",
          "type": "api",
          "resource": "/api/v1/users",
          "method": "GET",
          "description": "查看用户列表权限",
          "children": []
        },
        {
          "id": 3,
          "parentId": 1,
          "name": "查看用户详情",
          "code": "user:view",
          "type": "api",
          "resource": "/api/v1/users/:id",
          "method": "GET",
          "description": "查看用户详情权限",
          "children": []
        }
      ]
    },
    {
      "id": 7,
      "parentId": null,
      "name": "权限管理",
      "code": "permission",
      "type": "menu",
      "resource": null,
      "method": null,
      "description": "权限管理模块",
      "children": [
        {
          "id": 8,
          "parentId": 7,
          "name": "查看权限列表",
          "code": "permission:list",
          "type": "api",
          "resource": "/api/v1/permissions",
          "method": "GET",
          "description": null,
          "children": []
        }
      ]
    }
  ],
  "timestamp": 1234567890
}
```

---

## 3. 获取权限详情

### 基本信息

- **接口路径**: `GET /api/v1/permissions/:id`
- **接口说明**: 获取指定权限的详细信息（含父权限和子权限）
- **所需权限**: `permission:list`

### 路径参数

| 参数名 | 类型   | 必填 | 说明    |
| ------ | ------ | ---- | ------- |
| id     | number | ✅   | 权限 ID |

### 请求示例

```http
GET /api/v1/permissions/1
Authorization: Bearer {accessToken}
```

### 响应示例

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "parentId": null,
    "name": "用户管理",
    "code": "user",
    "type": "menu",
    "resource": null,
    "method": null,
    "description": "用户管理模块",
    "sortOrder": 0,
    "status": "active",
    "createdAt": "2024-01-01T10:00:00.000Z",
    "updatedAt": "2024-01-01T10:00:00.000Z",
    "parent": null,
    "children": [
      {
        "id": 2,
        "parentId": 1,
        "name": "查看用户列表",
        "code": "user:list",
        "type": "api"
      }
    ]
  },
  "timestamp": 1234567890
}
```

---

## 4. 创建权限

### 基本信息

- **接口路径**: `POST /api/v1/permissions`
- **接口说明**: 创建新权限
- **所需权限**: `permission:create`

### 请求参数

| 参数名      | 类型   | 必填 | 说明                              |
| ----------- | ------ | ---- | --------------------------------- |
| parentId    | number | ❌   | 父权限 ID                         |
| name        | string | ✅   | 权限名称（最多 100 字符）         |
| code        | string | ✅   | 权限代码（最多 100 字符，唯一）   |
| type        | string | ✅   | 权限类型：`menu`、`api`、`button` |
| resource    | string | ❌   | 资源路径（最多 255 字符）         |
| method      | string | ❌   | HTTP 方法（最多 10 字符）         |
| description | string | ❌   | 权限描述（最多 255 字符）         |

### 请求示例

**创建一级权限（菜单）**

```http
POST /api/v1/permissions
Authorization: Bearer {accessToken}
Content-Type: application/json

{
  "name": "文章管理",
  "code": "article",
  "type": "menu",
  "description": "文章管理模块"
}
```

**创建二级权限（API）**

```http
POST /api/v1/permissions
Authorization: Bearer {accessToken}
Content-Type: application/json

{
  "parentId": 1,
  "name": "创建文章",
  "code": "article:create",
  "type": "api",
  "resource": "/api/v1/articles",
  "method": "POST",
  "description": "创建文章权限"
}
```

### 响应示例

```json
{
  "success": true,
  "code": 201,
  "message": "操作成功",
  "data": {
    "id": 10,
    "parentId": 1,
    "name": "创建文章",
    "code": "article:create",
    "type": "api",
    "resource": "/api/v1/articles",
    "method": "POST",
    "description": "创建文章权限",
    "sortOrder": 0,
    "status": "active",
    "createdAt": "2024-01-01T12:00:00.000Z",
    "updatedAt": "2024-01-01T12:00:00.000Z"
  },
  "timestamp": 1234567890
}
```

### 错误响应

**权限代码已存在 (409)**

```json
{
  "success": false,
  "code": 409,
  "message": "权限代码已存在",
  "data": {
    "error": "ConflictException"
  },
  "timestamp": 1234567890
}
```

**父权限不存在 (400)**

```json
{
  "success": false,
  "code": 400,
  "message": "父权限不存在",
  "data": {
    "error": "BadRequestException"
  },
  "timestamp": 1234567890
}
```

---

## 5. 更新权限

### 基本信息

- **接口路径**: `PATCH /api/v1/permissions/:id`
- **接口说明**: 更新权限信息
- **所需权限**: `permission:update`

### 路径参数

| 参数名 | 类型   | 必填 | 说明    |
| ------ | ------ | ---- | ------- |
| id     | number | ✅   | 权限 ID |

### 请求参数

| 参数名      | 类型   | 必填 | 说明      |
| ----------- | ------ | ---- | --------- |
| parentId    | number | ❌   | 父权限 ID |
| name        | string | ❌   | 权限名称  |
| code        | string | ❌   | 权限代码  |
| type        | string | ❌   | 权限类型  |
| resource    | string | ❌   | 资源路径  |
| method      | string | ❌   | HTTP 方法 |
| description | string | ❌   | 权限描述  |

### 请求示例

```http
PATCH /api/v1/permissions/10
Authorization: Bearer {accessToken}
Content-Type: application/json

{
  "name": "创建文章（更新）",
  "description": "创建文章权限（已更新）"
}
```

### 响应示例

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 10,
    "parentId": 1,
    "name": "创建文章（更新）",
    "code": "article:create",
    "type": "api",
    "resource": "/api/v1/articles",
    "method": "POST",
    "description": "创建文章权限（已更新）",
    "sortOrder": 0,
    "status": "active",
    "createdAt": "2024-01-01T12:00:00.000Z",
    "updatedAt": "2024-01-01T13:00:00.000Z"
  },
  "timestamp": 1234567890
}
```

### 错误响应

**不能移动到自己的子权限下 (400)**

```json
{
  "success": false,
  "code": 400,
  "message": "不能将权限移动到自己的子权限下",
  "data": {
    "error": "BadRequestException"
  },
  "timestamp": 1234567890
}
```

---

## 6. 删除权限

### 基本信息

- **接口路径**: `DELETE /api/v1/permissions/:id`
- **接口说明**: 删除权限（有子权限或被角色使用时不可删除）
- **所需权限**: `permission:delete`

### 路径参数

| 参数名 | 类型   | 必填 | 说明    |
| ------ | ------ | ---- | ------- |
| id     | number | ✅   | 权限 ID |

### 请求示例

```http
DELETE /api/v1/permissions/10
Authorization: Bearer {accessToken}
```

### 响应示例

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": null,
  "timestamp": 1234567890
}
```

### 错误响应

**权限下还有子权限 (400)**

```json
{
  "success": false,
  "code": 400,
  "message": "该权限下还有子权限，无法删除",
  "data": {
    "error": "BadRequestException"
  },
  "timestamp": 1234567890
}
```

**权限已被角色使用 (400)**

```json
{
  "success": false,
  "code": 400,
  "message": "该权限已被角色使用，无法删除",
  "data": {
    "error": "BadRequestException"
  },
  "timestamp": 1234567890
}
```

---

## 权限类型说明

### menu（菜单权限）

- 用于前端菜单显示
- 通常作为一级权限
- 不设置 `resource` 和 `method`
- 示例：`user`、`article`、`permission`

### api（接口权限）

- 用于后端接口鉴权
- 通常作为二级权限
- 需要设置 `resource` 和 `method`
- 示例：`user:list`、`user:create`

### button（按钮权限）

- 用于前端按钮显示控制
- 通常作为三级权限
- 可选设置 `resource` 和 `method`
- 示例：`user:delete:button`

## 权限代码规范

### 命名格式

```
<模块>:<操作>[:<类型>]
```

### 示例

```
user                    # 用户管理模块（menu）
user:list              # 查看用户列表（api）
user:view              # 查看用户详情（api）
user:create            # 创建用户（api）
user:update            # 更新用户（api）
user:delete            # 删除用户（api）
user:delete:button     # 删除按钮（button）
```

## 权限树形结构说明

```
用户管理（menu: user）
├── 查看用户列表（api: user:list）
├── 查看用户详情（api: user:view）
├── 创建用户（api: user:create）
├── 更新用户（api: user:update）
└── 删除用户（api: user:delete）
    └── 删除按钮（button: user:delete:button）
```

## 注意事项

1. **权限层级**

   - 最多支持 3 层嵌套
   - 一级：模块（menu）
   - 二级：API（api）
   - 三级：按钮（button）

2. **权限代码**

   - 必须唯一
   - 使用小写字母和冒号
   - 格式：`模块:操作:类型`

3. **循环引用检测**

   - 修改父权限时会检测循环引用
   - 不能将权限移动到自己的子权限下

4. **删除限制**

   - 有子权限的不能删除
   - 被角色使用的不能删除
   - 删除前需要先删除子权限或移除角色关联

5. **HTTP 方法**

   - GET: 查询操作
   - POST: 创建操作
   - PATCH/PUT: 更新操作
   - DELETE: 删除操作

6. **资源路径**
   - 使用完整的 API 路径
   - 支持路径参数，如：`/api/v1/users/:id`
   - 不包含域名和协议
