# å…¬å‘Šç³»ç»Ÿ API æ–‡æ¡£

## æ¦‚è¿°

å…¬å‘Šç³»ç»Ÿç”¨äºå‘å¸ƒç³»ç»Ÿå…¬å‘Šã€æ´»åŠ¨é€šçŸ¥ã€ç»´æŠ¤ä¿¡æ¯ç­‰ï¼Œæ”¯æŒå®æ—¶æ¨é€ã€é“¾æ¥è·³è½¬ã€ç›®æ ‡å—ä¼—ç­›é€‰å’Œé˜…è¯»ç»Ÿè®¡ã€‚

**åŸºç¡€è·¯å¾„**: `/api/v1/announcements`

---

## å…¬å‘Šç±»å‹

- `system` - ç³»ç»Ÿå…¬å‘Š
- `activity` - æ´»åŠ¨å…¬å‘Š
- `maintenance` - ç»´æŠ¤å…¬å‘Š
- `feature` - æ–°åŠŸèƒ½å…¬å‘Š
- `notice` - é€šçŸ¥å…¬å‘Š

## æç¤ºçº§åˆ«

- `info` - ä¿¡æ¯
- `warning` - è­¦å‘Š
- `error` - é”™è¯¯
- `success` - æˆåŠŸ

## ç›®æ ‡å—ä¼—ç±»å‹

- `all` - æ‰€æœ‰ç”¨æˆ·
- `role` - ç‰¹å®šè§’è‰²
- `user` - ç‰¹å®šç”¨æˆ·
- `membership` - ç‰¹å®šä¼šå‘˜ç­‰çº§

---

## ç®¡ç†ç«¯æ¥å£

### 1. åˆ›å»ºå…¬å‘Š

**æ¥å£**: `POST /announcements`

**æƒé™**: `announcement:create`

**è¯·æ±‚ä½“**:
```json
{
  "title": "ğŸ‰ æ–°æ˜¥æ´»åŠ¨å¼€å¯ï¼",
  "content": "<p>å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©</p>",
  "summary": "å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©",
  "type": "activity",
  "level": "success",
  "priority": 8,
  "hasLink": true,
  "linkUrl": "/activity/spring-2025",
  "linkText": "ç«‹å³å‚ä¸",
  "linkTarget": "_self",
  "linkPosition": "button",
  "isActive": true,
  "isTop": true,
  "isPush": true,
  "isPopup": true,
  "needRead": false,
  "startTime": "2025-01-26T00:00:00Z",
  "endTime": "2025-01-29T23:59:59Z",
  "targetType": "all",
  "styleConfig": {
    "backgroundColor": "#f0f9ff",
    "borderColor": "#3b82f6",
    "textColor": "#1e40af"
  }
}
```

**å“åº”**:
```json
{
  "id": 1,
  "title": "ğŸ‰ æ–°æ˜¥æ´»åŠ¨å¼€å¯ï¼",
  "content": "<p>å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©</p>",
  "type": "activity",
  "level": "success",
  "hasLink": true,
  "linkUrl": "/activity/spring-2025",
  "linkText": "ç«‹å³å‚ä¸",
  "isActive": true,
  "createdAt": "2025-01-26T10:00:00Z",
  "updatedAt": "2025-01-26T10:00:00Z"
}
```

---

### 2. æŸ¥è¯¢å…¬å‘Šåˆ—è¡¨ï¼ˆç®¡ç†ç«¯ï¼‰

**æ¥å£**: `GET /announcements`

**æƒé™**: `announcement:read`

**æŸ¥è¯¢å‚æ•°**:
- `type` - å…¬å‘Šç±»å‹ï¼ˆå¯é€‰ï¼‰
- `level` - æç¤ºçº§åˆ«ï¼ˆå¯é€‰ï¼‰
- `isActive` - æ˜¯å¦å¯ç”¨ï¼ˆå¯é€‰ï¼‰
- `isTop` - æ˜¯å¦ç½®é¡¶ï¼ˆå¯é€‰ï¼‰
- `page` - é¡µç ï¼Œé»˜è®¤ 1
- `limit` - æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 20

**ç¤ºä¾‹**: `GET /announcements?type=activity&isActive=true&page=1&limit=20`

**å“åº”**:
```json
{
  "data": [
    {
      "id": 1,
      "title": "ğŸ‰ æ–°æ˜¥æ´»åŠ¨å¼€å¯ï¼",
      "summary": "å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©",
      "type": "activity",
      "level": "success",
      "priority": 8,
      "isActive": true,
      "isTop": true,
      "viewCount": 1250,
      "readCount": 980,
      "clickCount": 320,
      "creator": {
        "id": 1,
        "username": "admin"
      },
      "createdAt": "2025-01-26T10:00:00Z"
    }
  ],
  "total": 15,
  "page": 1,
  "limit": 20,
  "totalPages": 1
}
```

---

### 3. æ›´æ–°å…¬å‘Š

**æ¥å£**: `PUT /announcements/:id`

**æƒé™**: `announcement:update`

**è¯·æ±‚ä½“**: ä¸åˆ›å»ºå…¬å‘Šç›¸åŒï¼ˆæ‰€æœ‰å­—æ®µå¯é€‰ï¼‰

---

### 4. åˆ é™¤å…¬å‘Š

**æ¥å£**: `DELETE /announcements/:id`

**æƒé™**: `announcement:delete`

**å“åº”**:
```json
{
  "message": "åˆ é™¤æˆåŠŸ"
}
```

---

### 5. å‘å¸ƒå…¬å‘Š

**æ¥å£**: `POST /announcements/:id/publish`

**æƒé™**: `announcement:update`

**è¯´æ˜**: å‘å¸ƒå…¬å‘Šåï¼Œå°†è®¾ç½® `publishedAt` æ—¶é—´å¹¶æ¿€æ´»å…¬å‘Š

**å“åº”**:
```json
{
  "id": 1,
  "publishedAt": "2025-01-26T10:00:00Z",
  "isActive": true
}
```

---

### 6. ç«‹å³æ¨é€å…¬å‘Š

**æ¥å£**: `POST /announcements/:id/push`

**æƒé™**: `announcement:update`

**è¯´æ˜**: ç«‹å³é€šè¿‡ WebSocket æ¨é€å…¬å‘Šç»™åœ¨çº¿ç”¨æˆ·

**å“åº”**:
```json
{
  "message": "æ¨é€æˆåŠŸ"
}
```

---

### 7. æŸ¥çœ‹å…¬å‘Šç»Ÿè®¡

**æ¥å£**: `GET /announcements/:id/stats`

**æƒé™**: `announcement:read`

**å“åº”**:
```json
{
  "viewCount": 1250,
  "readCount": 980,
  "clickCount": 320,
  "clickRate": 25.6,
  "readRate": 78.4
}
```

---

## ç”¨æˆ·ç«¯æ¥å£

### 1. è·å–å½“å‰æœ‰æ•ˆå…¬å‘Š

**æ¥å£**: `GET /announcements/active`

**è®¤è¯**: å¯é€‰ï¼ˆ`@OptionalAuth`ï¼‰

**è¯´æ˜**: 
- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹åˆ° `targetType = 'all'` çš„å…¬å‘Š
- å·²ç™»å½•ç”¨æˆ·æ ¹æ®è§’è‰²ã€ä¼šå‘˜ç­‰çº§ç­›é€‰

**å“åº”**:
```json
[
  {
    "id": 1,
    "title": "ğŸ‰ æ–°æ˜¥æ´»åŠ¨å¼€å¯ï¼",
    "summary": "å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©",
    "content": "<p>å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©</p>",
    "type": "activity",
    "level": "success",
    "priority": 8,
    "hasLink": true,
    "linkUrl": "/activity/spring-2025",
    "linkText": "ç«‹å³å‚ä¸",
    "linkTarget": "_self",
    "linkPosition": "button",
    "isTop": true,
    "isPopup": false,
    "needRead": false,
    "startTime": "2025-01-26T00:00:00Z",
    "endTime": "2025-01-29T23:59:59Z",
    "styleConfig": {},
    "isRead": false,
    "isClicked": false
  }
]
```

---

### 2. è·å–éœ€è¦å¼¹çª—çš„å…¬å‘Š

**æ¥å£**: `GET /announcements/popup`

**è®¤è¯**: å¯é€‰ï¼ˆ`@OptionalAuth`ï¼‰

**è¯´æ˜**: è¿”å› `isPopup = true` çš„æœ‰æ•ˆå…¬å‘Š

**å“åº”**: ä¸"è·å–å½“å‰æœ‰æ•ˆå…¬å‘Š"ç›¸åŒ

---

### 3. è·å–æœªè¯»æ•°é‡

**æ¥å£**: `GET /announcements/unread-count`

**è®¤è¯**: å¿…éœ€

**è¯´æ˜**: è¿”å›éœ€è¦ç¡®è®¤å·²è¯»ï¼ˆ`needRead = true`ï¼‰ä¸”ç”¨æˆ·æœªè¯»çš„å…¬å‘Šæ•°é‡

**å“åº”**:
```json
{
  "count": 3
}
```

---

### 4. æŸ¥çœ‹å…¬å‘Šè¯¦æƒ…

**æ¥å£**: `GET /announcements/:id`

**è®¤è¯**: å¯é€‰ï¼ˆ`@OptionalAuth`ï¼‰

**è¯´æ˜**: æŸ¥çœ‹å…¬å‘Šè¯¦æƒ…ï¼Œè‡ªåŠ¨å¢åŠ æµè§ˆæ¬¡æ•°

**å“åº”**:
```json
{
  "id": 1,
  "title": "ğŸ‰ æ–°æ˜¥æ´»åŠ¨å¼€å¯ï¼",
  "content": "<p>å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©</p>",
  "summary": "å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©",
  "type": "activity",
  "level": "success",
  "hasLink": true,
  "linkUrl": "/activity/spring-2025",
  "linkText": "ç«‹å³å‚ä¸",
  "viewCount": 1251,
  "creator": {
    "id": 1,
    "username": "admin"
  }
}
```

---

### 5. æ ‡è®°å·²è¯»

**æ¥å£**: `POST /announcements/:id/read`

**è®¤è¯**: å¿…éœ€

**è¯´æ˜**: æ ‡è®°å…¬å‘Šä¸ºå·²è¯»ï¼Œå¢åŠ å·²è¯»äººæ•°

**å“åº”**:
```json
{
  "message": "å·²æ ‡è®°ä¸ºå·²è¯»"
}
```

---

### 6. è®°å½•é“¾æ¥ç‚¹å‡»

**æ¥å£**: `POST /announcements/:id/click`

**è®¤è¯**: å¿…éœ€

**è¯·æ±‚ä½“**:
```json
{
  "linkUrl": "/activity/spring-2025",
  "referrer": "/dashboard"
}
```

**è¯´æ˜**: 
- è®°å½•ç”¨æˆ·ç‚¹å‡»é“¾æ¥
- è‡ªåŠ¨å¢åŠ ç‚¹å‡»æ¬¡æ•°
- è®°å½• IPã€User-Agent ç­‰ä¿¡æ¯

**å“åº”**:
```json
{
  "message": "å·²è®°å½•ç‚¹å‡»"
}
```

---

## æ•°æ®æ¨¡å‹

### Announcementï¼ˆå…¬å‘Šï¼‰

```typescript
{
  id: number;
  title: string;
  content: string;
  summary?: string;
  type: 'system' | 'activity' | 'maintenance' | 'feature' | 'notice';
  priority: number;              // 1-10
  level: 'info' | 'warning' | 'error' | 'success';
  
  // é“¾æ¥è·³è½¬
  hasLink: boolean;
  linkUrl?: string;
  linkText?: string;
  linkTarget: '_blank' | '_self';
  linkPosition: 'content' | 'button' | 'both';
  
  // æ˜¾ç¤ºæ§åˆ¶
  isActive: boolean;
  isTop: boolean;
  isPush: boolean;
  isPopup: boolean;
  needRead: boolean;
  
  // æ—¶é—´æ§åˆ¶
  startTime: Date;
  endTime?: Date;
  publishedAt?: Date;
  
  // ç›®æ ‡å—ä¼—
  targetType: 'all' | 'role' | 'user' | 'membership';
  targetIds?: number[];
  
  // ç»Ÿè®¡
  viewCount: number;
  readCount: number;
  clickCount: number;
  
  // æ ·å¼
  attachments?: any;
  styleConfig?: any;
  
  creatorId: number;
  createdAt: Date;
  updatedAt: Date;
}
```

---

## WebSocket äº‹ä»¶

### æ–°å…¬å‘Šæ¨é€

**äº‹ä»¶**: `announcement:new`

**æ•°æ®**:
```json
{
  "id": 1,
  "title": "ğŸ‰ æ–°æ˜¥æ´»åŠ¨å¼€å¯ï¼",
  "summary": "å……å€¼äº«8æŠ˜ä¼˜æƒ ï¼Œé™æ—¶3å¤©",
  "level": "success",
  "isPopup": true,
  "linkUrl": "/activity/spring-2025"
}
```

### å…¬å‘Šæ›´æ–°

**äº‹ä»¶**: `announcement:update`

**æ•°æ®**:
```json
{
  "id": 1,
  "title": "ğŸ‰ æ–°æ˜¥æ´»åŠ¨å»¶æœŸ",
  "summary": "æ´»åŠ¨å»¶æœŸè‡³1æœˆ31æ—¥"
}
```

### å…¬å‘Šåˆ é™¤

**äº‹ä»¶**: `announcement:delete`

**æ•°æ®**:
```json
{
  "id": 1
}
```

---

## é”™è¯¯ç 

- `404` - å…¬å‘Šä¸å­˜åœ¨
- `403` - æ— æƒæ“ä½œæ­¤å…¬å‘Š
- `400` - è¯·æ±‚å‚æ•°é”™è¯¯

---

## ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯å±•ç¤ºå…¬å‘Šåˆ—è¡¨

```typescript
// è·å–æœ‰æ•ˆå…¬å‘Š
const response = await api.get('/announcements/active');
const announcements = response.data;

// æ¸²æŸ“å…¬å‘Šå¡ç‰‡
announcements.forEach(announcement => {
  if (announcement.hasLink) {
    // æ˜¾ç¤ºé“¾æ¥æŒ‰é’®
    renderLinkButton(announcement);
  }
  
  if (announcement.isPopup && !announcement.isRead) {
    // æ˜¾ç¤ºå¼¹çª—
    showAnnouncementModal(announcement);
  }
});
```

### æ ‡è®°å·²è¯»

```typescript
async function markAsRead(announcementId: number) {
  await api.post(`/announcements/${announcementId}/read`);
  // æ›´æ–°UI
  updateUnreadBadge();
}
```

### è®°å½•é“¾æ¥ç‚¹å‡»

```typescript
async function handleLinkClick(announcement) {
  // è®°å½•ç‚¹å‡»
  await api.post(`/announcements/${announcement.id}/click`, {
    linkUrl: announcement.linkUrl,
    referrer: window.location.pathname,
  });
  
  // è·³è½¬
  if (announcement.linkTarget === '_blank') {
    window.open(announcement.linkUrl);
  } else {
    window.location.href = announcement.linkUrl;
  }
}
```

---

## æ›´æ–°æ—¥å¿—

### 2025-01-26
- åˆ›å»ºå…¬å‘Šç³»ç»Ÿ
- æ”¯æŒé“¾æ¥è·³è½¬åŠŸèƒ½
- æ”¯æŒå®æ—¶æ¨é€
- æ”¯æŒç›®æ ‡å—ä¼—ç­›é€‰
- æ”¯æŒé˜…è¯»å’Œç‚¹å‡»ç»Ÿè®¡
