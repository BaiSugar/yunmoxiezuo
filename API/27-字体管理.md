# 字体管理 API

## 概述

字体管理系统允许管理员上传和管理字体文件，前端通过 @font-face 加载这些字体，确保所有用户都能看到相同的字体效果。

**基础路径**: `/api/v1/fonts`

---

## 1. 获取所有启用的字体（公开接口）

### 接口信息

- **路径**: `GET /fonts/enabled`
- **权限**: 无需认证（公开接口）
- **描述**: 获取所有已启用的字体列表，包含下载 URL

### 响应示例

```json
[
  {
    "id": 1,
    "name": "system-default",
    "displayName": "系统默认",
    "category": "推荐",
    "description": "根据操作系统自动选择最佳字体",
    "filePath": "",
    "format": "system",
    "fileSize": 0,
    "isEnabled": true,
    "isDefault": true,
    "sortOrder": 1,
    "url": "",
    "createdAt": "2025-11-02T10:00:00.000Z",
    "updatedAt": "2025-11-02T10:00:00.000Z"
  },
  {
    "id": 2,
    "name": "SourceHanSerif",
    "displayName": "思源宋体",
    "category": "推荐",
    "description": "Adobe 开源宋体字体，适合正文阅读",
    "filePath": "fonts/1699999999-SourceHanSerif.woff2",
    "format": "woff2",
    "fileSize": 15728640,
    "isEnabled": true,
    "isDefault": false,
    "sortOrder": 2,
    "url": "http://your-domain/uploads/fonts/1699999999-SourceHanSerif.woff2",
    "createdAt": "2025-11-02T10:00:00.000Z",
    "updatedAt": "2025-11-02T10:00:00.000Z"
  }
]
```

---

## 2. 获取所有字体（管理员）

### 接口信息

- **路径**: `GET /fonts`
- **权限**: `font:view`（管理员）
- **描述**: 获取所有字体列表（包括已禁用的）

### 响应示例

同"获取所有启用的字体"，但包含已禁用的字体。

---

## 3. 上传字体文件

### 接口信息

- **路径**: `POST /fonts/upload`
- **权限**: `font:upload`（管理员）
- **描述**: 上传字体文件到服务器
- **Content-Type**: `multipart/form-data`

### 请求参数

| 参数        | 类型   | 必填 | 说明                                             |
| ----------- | ------ | ---- | ------------------------------------------------ |
| file        | File   | 是   | 字体文件（支持 .ttf, .otf, .woff, .woff2）       |
| name        | string | 是   | 字体名称（用于 CSS font-family，建议英文无空格） |
| displayName | string | 是   | 显示名称（用户看到的名称）                       |
| category    | string | 是   | 分类（推荐/中文/英文/特殊）                      |
| description | string | 否   | 字体描述                                         |
| sortOrder   | number | 否   | 排序顺序                                         |

### 请求示例

```http
POST /api/v1/fonts/upload
Authorization: Bearer <admin_token>
Content-Type: multipart/form-data

file: {font_file}
name: SourceHanSerif
displayName: 思源宋体
category: 推荐
description: Adobe 开源宋体字体
sortOrder: 2
```

### 响应示例

```json
{
  "id": 2,
  "name": "SourceHanSerif",
  "displayName": "思源宋体",
  "category": "推荐",
  "description": "Adobe 开源宋体字体",
  "filePath": "fonts/1699999999-SourceHanSerif.woff2",
  "format": "woff2",
  "fileSize": 15728640,
  "isEnabled": true,
  "isDefault": false,
  "sortOrder": 2,
  "url": "http://your-domain/uploads/fonts/1699999999-SourceHanSerif.woff2",
  "createdAt": "2025-11-02T10:00:00.000Z",
  "updatedAt": "2025-11-02T10:00:00.000Z"
}
```

---

## 4. 更新字体信息

### 接口信息

- **路径**: `PUT /fonts/:id`
- **权限**: `font:update`（管理员）
- **描述**: 更新字体的元信息（不能修改字体文件本身）

### 请求体

```json
{
  "displayName": "思源宋体 SC",
  "category": "推荐",
  "description": "Adobe 开源宋体字体，简体中文版",
  "isEnabled": true,
  "sortOrder": 1
}
```

### 响应示例

返回更新后的字体对象。

---

## 5. 设置默认字体

### 接口信息

- **路径**: `POST /fonts/:id/set-default`
- **权限**: `font:update`（管理员）
- **描述**: 将指定字体设为默认字体（同时取消其他字体的默认状态）

### 响应示例

返回设置为默认的字体对象。

---

## 6. 删除字体

### 接口信息

- **路径**: `DELETE /fonts/:id`
- **权限**: `font:delete`（管理员）
- **描述**: 删除字体记录和字体文件

### 响应示例

```json
{
  "message": "字体已删除"
}
```

**注意**: 删除字体时，服务器上的字体文件也会被删除（系统字体除外）。

---

## 字体格式说明

### 支持的格式

| 格式  | 说明               | 推荐度     | 兼容性     | 压缩率 |
| ----- | ------------------ | ---------- | ---------- | ------ |
| WOFF2 | Web 开放字体格式 2 | ⭐⭐⭐⭐⭐ | 现代浏览器 | 最高   |
| WOFF  | Web 开放字体格式   | ⭐⭐⭐⭐   | 几乎所有   | 中等   |
| TTF   | TrueType 字体      | ⭐⭐       | 所有       | 无     |
| OTF   | OpenType 字体      | ⭐⭐       | 所有       | 无     |

### 系统字体 vs Web 字体

**系统字体** (`format: 'system'`):

- 无需上传文件
- 使用字体回退栈
- 加载速度快
- 跨平台兼容
- 用户体验可能不一致

**Web 字体** (`format: 'woff2'` 等):

- 需要上传文件
- 所有用户效果一致
- 需要下载（首次慢，后续缓存）
- 文件大小: 中文字体 10-20MB

---

## 使用流程

### 前端加载字体

```typescript
// 1. 获取字体列表
const fonts = await fontsApi.getEnabledFonts();

// 2. 加载字体文件（自动生成 @font-face）
await FontLoader.loadFonts(fonts);

// 3. 应用到编辑器
const fontFamily = FontLoader.getFontFamily(selectedFont);
```

### 生成的 CSS

**系统字体**:

```css
font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
```

**Web 字体**:

```css
@font-face {
  font-family: "SourceHanSerif";
  src: url("http://server/uploads/fonts/xxx.woff2") format("woff2");
  font-display: swap;
}

font-family: "SourceHanSerif";
```

---

## 错误码

| 错误码 | 说明                                   |
| ------ | -------------------------------------- |
| 400    | 请求参数无效（文件格式不支持、超大等） |
| 401    | 未登录或 Token 失效                    |
| 403    | 无权限访问                             |
| 404    | 字体不存在                             |
| 409    | 字体名称已存在                         |
| 500    | 服务器内部错误                         |

---

## 管理员操作指南

### 1. 准备字体文件

**获取字体**:

- 思源宋体: https://github.com/adobe-fonts/source-han-serif
- 思源黑体: https://github.com/adobe-fonts/source-han-sans
- 霞鹜文楷: https://github.com/lxgw/LxgwWenKai

**格式转换**:

- 在线工具: https://cloudconvert.com/ttf-to-woff2
- 本地工具: fonttools

### 2. 上传字体

进入管理后台 → 字体管理 → 上传字体

1. 选择字体文件（推荐 WOFF2 格式）
2. 填写字体信息
3. 上传

### 3. 管理字体

- **启用/禁用**: 点击眼睛图标
- **设为默认**: 点击星星图标
- **编辑信息**: 点击编辑图标
- **删除字体**: 点击删除图标

---

## 注意事项

1. **字体文件大小**

   - 中文字体通常 10-20MB
   - 建议使用 WOFF2 格式（压缩 30%+）
   - 设置文件大小上限（如 50MB）

2. **字体版权**

   - 只上传有授权的字体
   - 开源字体需遵守许可证
   - 商业字体需购买授权

3. **性能优化**

   - 使用 `font-display: swap` 避免阻塞
   - 浏览器会自动缓存字体文件
   - 首次加载慢，后续访问快

4. **字体命名**
   - `name` 字段用于 CSS，建议英文无空格
   - `displayName` 可以使用中文

---

## 版本历史

| 版本 | 日期       | 说明                             |
| ---- | ---------- | -------------------------------- |
| v1.0 | 2025-11-02 | 初始版本，支持字体文件上传和管理 |
