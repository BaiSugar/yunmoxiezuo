# 13. 角色卡管理

## 概述

SillyTavern 角色卡管理系统，支持 V1/V2/V3 三种格式，提供完整的角色卡 CRUD、导入导出、格式转换等功能。

## 数据模型

### CharacterCard（角色卡）

```typescript
{
  id: number;                    // 角色卡 ID
  name: string;                  // 角色名称
  description: string;           // 角色描述
  spec: CharacterCardSpec;       // 规范版本（V1/V2/V3）
  specVersion: string;           // 版本号
  data: object;                  // 完整角色卡数据
  avatarUrl?: string;            // 立绘 URL
  pngData?: string;              // PNG 数据（Base64）
  authorId: number;              // 作者 ID
  isPublic: boolean;             // 是否公开
  status: CharacterCardStatus;   // 状态（draft/published/archived）
  viewCount: number;             // 浏览次数
  useCount: number;              // 使用次数
  likeCount: number;             // 点赞次数
  downloadCount: number;         // 下载次数
  tags: string[];                // 标签列表
  category?: string;             // 分类
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
  deletedAt?: Date;              // 删除时间
}
```

### CharacterCardV2Data（V2 格式数据）

```typescript
{
  // 基础必需字段
  name: string;                      // 角色名称
  description: string;               // 角色描述
  personality: string;               // 性格特征
  scenario: string;                  // 场景设定
  first_mes: string;                 // 首条消息
  mes_example: string;               // 示例对话
  
  // 高级可选字段
  creator_notes?: string;            // 创建者说明
  system_prompt?: string;            // 系统提示
  post_history_instructions?: string; // 历史后指令
  alternate_greetings?: string[];    // 替代开场白
  tags?: string[];                   // 标签
  creator?: string;                  // 创建者
  character_version?: string;        // 角色版本
  
  // 世界书
  character_book?: {
    name?: string;
    entries: WorldBookEntry[];
    extensions?: object;
  };
  
  // 扩展字段
  extensions?: {
    talkativeness?: number;          // 话痨度（0-1）
    fav?: boolean;                   // 是否收藏
    world?: string;                  // 关联世界
    depth_prompt?: {
      depth: number;
      prompt: string;
      role: 'system' | 'user' | 'assistant';
    };
    // ... 其他扩展
  };
}
```

## API 接口

### 1. 创建角色卡

**接口**: `POST /api/v1/character-cards`

**权限**: 需要登录

**请求体**:
```json
{
  "name": "艾莉娅",
  "description": "精灵法师",
  "spec": "chara_card_v2",
  "specVersion": "2.0",
  "data": {
    "name": "艾莉娅",
    "description": "25岁的精灵法师，银色长发，翠绿色眼睛",
    "personality": "好奇、聪慧、略显内向但待人温暖",
    "scenario": "你在银月城的古老图书馆中遇见了正在研究古代魔法文献的艾莉娅",
    "first_mes": "*抬起头，露出温和的微笑* 你好，很少有人来这个区域。你也对古代魔法感兴趣吗？",
    "mes_example": "<START>\n{{user}}: 你好\n{{char}}: *微笑* 你好呀，很高兴见到你",
    "creator_notes": "艾莉娅虽然温柔，但内心非常坚强",
    "tags": ["精灵", "法师", "奇幻"],
    "extensions": {
      "talkativeness": 0.5
    }
  },
  "tags": ["奇幻", "魔法", "精灵"],
  "category": "精灵",
  "isPublic": true
}
```

**响应**: `201 Created`
```json
{
  "id": 1,
  "name": "艾莉娅",
  "description": "精灵法师",
  "spec": "chara_card_v2",
  "specVersion": "2.0",
  "data": { ... },
  "authorId": 1,
  "isPublic": true,
  "status": "draft",
  "viewCount": 0,
  "useCount": 0,
  "likeCount": 0,
  "downloadCount": 0,
  "tags": ["奇幻", "魔法", "精灵"],
  "category": "精灵",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

---

### 2. 查询角色卡列表

**接口**: `GET /api/v1/character-cards`

**权限**: 可选认证（登录可看到自己的草稿）

**查询参数**:
- `keyword` (string, optional): 关键词搜索（名称、描述）
- `tags` (string, optional): 标签筛选（逗号分隔）
- `category` (string, optional): 分类筛选
- `authorId` (number, optional): 作者 ID
- `status` (enum, optional): 状态（draft/published/archived）
- `publicOnly` (boolean, optional): 仅查看公开的，默认 false
- `sortBy` (string, optional): 排序字段，默认 createdAt
- `sortOrder` (enum, optional): 排序方向（ASC/DESC），默认 DESC
- `page` (number, optional): 页码，默认 1
- `pageSize` (number, optional): 每页数量，默认 20

**响应**: `200 OK`
```json
{
  "data": [
    {
      "id": 1,
      "name": "艾莉娅",
      "description": "精灵法师",
      "avatarUrl": "https://example.com/avatar.png",
      "authorId": 1,
      "author": {
        "id": 1,
        "username": "作者名"
      },
      "isPublic": true,
      "status": "published",
      "viewCount": 100,
      "useCount": 50,
      "likeCount": 20,
      "downloadCount": 10,
      "tags": ["奇幻", "魔法"],
      "category": "精灵",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 1,
  "page": 1,
  "pageSize": 20,
  "totalPages": 1
}
```

---

### 3. 获取角色卡详情

**接口**: `GET /api/v1/character-cards/:id`

**权限**: 可选认证（公开角色卡无需登录，私有需作者身份）

**响应**: `200 OK`
```json
{
  "id": 1,
  "name": "艾莉娅",
  "description": "精灵法师",
  "spec": "chara_card_v2",
  "specVersion": "2.0",
  "data": {
    "name": "艾莉娅",
    "description": "...",
    "personality": "...",
    "scenario": "...",
    "first_mes": "...",
    "mes_example": "...",
    "character_book": {
      "entries": [...]
    },
    "extensions": { ... }
  },
  "avatarUrl": "https://example.com/avatar.png",
  "authorId": 1,
  "author": {
    "id": 1,
    "username": "作者名"
  },
  "isPublic": true,
  "status": "published",
  "viewCount": 101,
  "useCount": 50,
  "likeCount": 20,
  "downloadCount": 10,
  "tags": ["奇幻", "魔法"],
  "category": "精灵",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

---

### 4. 更新角色卡

**接口**: `PUT /api/v1/character-cards/:id`

**权限**: 需要登录且为作者

**请求体**: 同创建接口（所有字段可选）

**响应**: `200 OK`

---

### 5. 删除角色卡

**接口**: `DELETE /api/v1/character-cards/:id`

**权限**: 需要登录且为作者

**响应**: `204 No Content`

---

### 6. 发布角色卡

**接口**: `POST /api/v1/character-cards/:id/publish`

**权限**: 需要登录且为作者

**响应**: `200 OK`

---

### 7. 归档角色卡

**接口**: `POST /api/v1/character-cards/:id/archive`

**权限**: 需要登录且为作者

**响应**: `200 OK`

---

### 8. 点赞角色卡

**接口**: `POST /api/v1/character-cards/:id/like`

**权限**: 需要登录

**响应**: `204 No Content`

---

### 9. 取消点赞

**接口**: `DELETE /api/v1/character-cards/:id/like`

**权限**: 需要登录

**响应**: `204 No Content`

---

### 10. 收藏角色卡

**接口**: `POST /api/v1/character-cards/:id/favorite`

**权限**: 需要登录

**响应**: `204 No Content`

---

### 11. 取消收藏

**接口**: `DELETE /api/v1/character-cards/:id/favorite`

**权限**: 需要登录

**响应**: `204 No Content`

---

### 12. 记录使用

**接口**: `POST /api/v1/character-cards/:id/use`

**权限**: 需要登录

**说明**: 每次使用角色卡时调用，增加使用计数

**响应**: `204 No Content`

---

### 13. 导入角色卡

**接口**: `POST /api/v1/character-cards/import`

**权限**: 需要登录

**请求体**:
```json
{
  "pngData": "data:image/png;base64,iVBORw0KG...",
  "jsonData": "{\"spec\":\"chara_card_v2\",...}",
  "isPublic": true,
  "tags": "导入,测试",
  "category": "精灵"
}
```

**说明**:
- `pngData` 和 `jsonData` 二选一
- `pngData`: PNG 格式角色卡（带 tEXt 元数据）
- `jsonData`: JSON 格式角色卡字符串

**响应**: `201 Created`（返回创建的角色卡）

---

### 14. 导出角色卡

**接口**: `GET /api/v1/character-cards/:id/export`

**权限**: 可选认证（公开角色卡无需登录）

**查询参数**:
- `format` (enum, optional): 导出格式（json/png），默认 json
- `targetSpec` (enum, optional): 目标规范版本（chara_card_v1/chara_card_v2/chara_card_v3）
- `includeWorldBook` (boolean, optional): 是否包含世界书，默认 true

**响应**: `200 OK`

**Content-Type**:
- `application/json` (format=json)
- `image/png` (format=png)

**Content-Disposition**: `attachment; filename="角色名.json"` 或 `"角色名.png"`

---

## 错误码

| 状态码 | 说明 |
|--------|------|
| 400 | 请求参数错误 / 已点赞过 / 已收藏过 |
| 401 | 未授权 |
| 403 | 无权操作（不是作者） |
| 404 | 角色卡不存在 |

## 业务规则

### 1. 权限控制

- **创建**: 所有登录用户
- **查看**: 
  - 公开且已发布的角色卡：所有人
  - 草稿和归档：仅作者
- **编辑/删除/发布/归档**: 仅作者
- **点赞/收藏/使用**: 所有登录用户

### 2. 状态转换

```
draft（草稿）→ published（已发布）→ archived（已归档）
     ↑__________________|
```

- 草稿可以发布
- 已发布可以归档
- 归档可以重新发布（回到已发布状态）

### 3. 公开性

- `isPublic=true` 且 `status=published`: 所有人可见
- `isPublic=false` 或 `status!=published`: 仅作者可见

### 4. 格式兼容性

- 系统自动识别 V1/V2/V3 格式
- V1 格式导入时自动转换为 V2
- 导出时可指定目标格式

### 5. 世界书

- V2/V3 格式支持角色专属世界书
- 世界书条目存储在 `data.character_book.entries`
- 导出时可选择是否包含世界书

## 数据验证

### 创建/更新时必需字段

- `name`: 角色名称（最大 100 字符）
- `data`: 完整角色卡数据对象
- `data.name`: 数据中的角色名称
- `data.description`: 角色描述
- `data.personality`: 性格
- `data.scenario`: 场景
- `data.first_mes`: 首条消息
- `data.mes_example`: 示例对话

### 可选字段

- `description`: 简短描述（用于列表显示）
- `avatarUrl`: 立绘 URL
- `pngData`: PNG 数据
- `tags`: 标签数组
- `category`: 分类
- `isPublic`: 是否公开（默认 true）

## 使用场景

### 场景 1: 用户导入现有角色卡

1. 用户上传 PNG 文件或提供 JSON
2. 调用 `POST /import` 接口
3. 系统自动识别格式并转换
4. 返回创建的角色卡（草稿状态）
5. 用户可编辑后发布

### 场景 2: 用户创建新角色卡

1. 调用 `POST /character-cards` 创建草稿
2. 多次调用 `PUT /:id` 编辑完善
3. 调用 `POST /:id/publish` 发布
4. 其他用户可以查看和使用

### 场景 3: 用户浏览和使用角色卡

1. 调用 `GET /character-cards` 查看列表
2. 调用 `GET /:id` 查看详情
3. 调用 `POST /:id/like` 点赞
4. 调用 `POST /:id/favorite` 收藏
5. 调用 `GET /:id/export` 下载
6. 调用 `POST /:id/use` 记录使用

## 注意事项

1. **PNG 导出功能**: 需要安装 `sharp` 或 `png-chunk-text` 等库实现 tEXt 块写入
2. **大文件处理**: PNG 数据存储在 `longtext` 字段，注意数据库配置
3. **性能优化**: 列表查询时建议不返回完整 `data` 字段
4. **缓存策略**: 考虑对热门角色卡进行缓存
5. **版本控制**: 未来可考虑添加版本历史功能
