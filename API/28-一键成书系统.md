# ä¸€é”®æˆä¹¦ç³»ç»Ÿ API æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0.0  
> **çŠ¶æ€**: ğŸ“ å¾…å®ç°  
> **æ¨¡å—è·¯å¾„**: `/api/v1/book-creation`

---

## ğŸ“‹ æ¦‚è¿°

ä¸€é”®æˆä¹¦ç³»ç»Ÿæ˜¯é¢å‘ä¼šå‘˜ç”¨æˆ·çš„é«˜çº§åŠŸèƒ½ï¼Œé€šè¿‡ AI è¾…åŠ©å®Œæˆä»æƒ³æ³•åˆ°æˆä¹¦çš„å…¨æµç¨‹ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜æ‰€æœ‰ API æ¥å£çš„è°ƒç”¨æ–¹å¼ã€å‚æ•°å’Œå“åº”æ ¼å¼ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¤šé˜¶æ®µæ¸è¿›å¼ç”Ÿæˆ**ï¼š5 ä¸ªä¸»è¦é˜¶æ®µ
- âœ… **ç»“æ„åŒ–å¤§çº²ç®¡ç†**ï¼šä¸‰çº§å¤§çº²ï¼ˆå¤§çº² â†’ å·çº² â†’ ç»†çº²ï¼‰
- âœ… **æ™ºèƒ½ä¸Šä¸‹æ–‡å…³è”**ï¼šè‡ªåŠ¨å…³è”äººç‰©å¡ã€ä¸–ç•Œè§‚ã€å¤‡å¿˜å½•
- âœ… **è‡ªåŠ¨æå–äººç‰©å¡å’Œä¸–ç•Œè§‚**ï¼šä»å¤§çº²ä¸­æ™ºèƒ½æå–è§’è‰²å’Œä¸–ç•Œè§‚ä¿¡æ¯
- âœ… **å®æ—¶è¿›åº¦è¿½è¸ª**ï¼šWebSocket æ¨é€
- âœ… **å­—æ•°æ¶ˆè€—æ§åˆ¶**ï¼šç²¾ç¡®è®°å½•å’Œé¢„ä¼°

### æƒé™è¦æ±‚

æ‰€æœ‰æ¥å£éƒ½éœ€è¦ï¼š

- âœ“ **ç™»å½•è®¤è¯**ï¼šBearer Token
- âœ“ **å­—æ•°åŒ…ä½™é¢**ï¼šè¶³å¤Ÿçš„å­—æ•°åŒ…ä½™é¢ï¼ˆç³»ç»Ÿä¼šåœ¨æ¯æ¬¡ AI è°ƒç”¨å‰æ£€æŸ¥ï¼‰

---

## ğŸ” è®¤è¯

æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦åœ¨ Header ä¸­æºå¸¦ JWT Tokenï¼š

```http
Authorization: Bearer YOUR_JWT_TOKEN
```

---

## ğŸ“¡ API æ¥å£åˆ—è¡¨

### ä»»åŠ¡ç®¡ç†

| åºå· | æ–¹æ³•   | è·¯å¾„                                                    | è¯´æ˜           |
| ---- | ------ | ------------------------------------------------------- | -------------- |
| 1    | POST   | `/api/v1/book-creation/tasks`                           | åˆ›å»ºæˆä¹¦ä»»åŠ¡   |
| 2    | GET    | `/api/v1/book-creation/tasks/:taskId`                   | è·å–ä»»åŠ¡è¯¦æƒ…   |
| 3    | GET    | `/api/v1/book-creation/tasks`                           | è·å–ä»»åŠ¡åˆ—è¡¨   |
| 4    | POST   | `/api/v1/book-creation/tasks/:taskId/execute-stage`     | æ‰§è¡Œé˜¶æ®µ       |
| 5    | POST   | `/api/v1/book-creation/tasks/:taskId/pause`             | æš‚åœä»»åŠ¡       |
| 6    | POST   | `/api/v1/book-creation/tasks/:taskId/resume`            | æ¢å¤ä»»åŠ¡       |
| 7    | DELETE | `/api/v1/book-creation/tasks/:taskId`                   | å–æ¶ˆä»»åŠ¡       |
| 8    | PATCH  | `/api/v1/book-creation/tasks/:taskId/prompt-config`     | æ›´æ–°æç¤ºè¯é…ç½® |
| 8-2  | PATCH  | `/api/v1/book-creation/tasks/:taskId/title-synopsis` ğŸ†• | æ›´æ–°ä¹¦åå’Œç®€ä»‹ |

### æç¤ºè¯ç»„ç®¡ç†

| åºå· | æ–¹æ³•   | è·¯å¾„                                   | è¯´æ˜                 |
| ---- | ------ | -------------------------------------- | -------------------- |
| 17   | POST   | `/api/v1/prompt-groups`                | åˆ›å»ºæç¤ºè¯ç»„         |
| 18   | GET    | `/api/v1/prompt-groups`                | è·å–æç¤ºè¯ç»„åˆ—è¡¨     |
| 19   | GET    | `/api/v1/prompt-groups/:id`            | è·å–æç¤ºè¯ç»„è¯¦æƒ…     |
| 20   | GET    | `/api/v1/prompt-groups/:id/parameters` | è·å–æç¤ºè¯ç»„æ‰€æœ‰å‚æ•° |
| 21   | POST   | `/api/v1/prompt-groups/:id/apply`      | ç”³è¯·ä½¿ç”¨æç¤ºè¯ç»„     |
| 22   | POST   | `/api/v1/prompt-groups/:id/like`       | ç‚¹èµæç¤ºè¯ç»„         |
| 23   | DELETE | `/api/v1/prompt-groups/:id/like`       | å–æ¶ˆç‚¹èµ             |

### é˜¶æ®µä¼˜åŒ–

| åºå· | æ–¹æ³• | è·¯å¾„                                                                    | è¯´æ˜                        |
| ---- | ---- | ----------------------------------------------------------------------- | --------------------------- |
| 9    | POST | `/api/v1/book-creation/tasks/:taskId/stages/:stageType/optimize`        | ä¼˜åŒ–é˜¶æ®µäº§å‡ºï¼ˆéæµå¼ï¼‰      |
| 9-2  | POST | `/api/v1/book-creation/tasks/:taskId/stages/:stageType/optimize/stream` | ğŸ†• ä¼˜åŒ–é˜¶æ®µäº§å‡ºï¼ˆæµå¼è¾“å‡ºï¼‰ |

### å¤§çº²ç®¡ç†

| åºå· | æ–¹æ³•  | è·¯å¾„                                                        | è¯´æ˜         |
| ---- | ----- | ----------------------------------------------------------- | ------------ |
| 10   | GET   | `/api/v1/book-creation/tasks/:taskId/outline`               | è·å–å¤§çº²æ ‘   |
| 11   | PATCH | `/api/v1/book-creation/tasks/:taskId/outline-nodes/:nodeId` | ç¼–è¾‘å¤§çº²èŠ‚ç‚¹ |
| 12   | POST  | `/api/v1/book-creation/tasks/:taskId/outline/sync-to-novel` | åŒæ­¥åˆ°ä½œå“   |

### å†…å®¹ç”Ÿæˆ

| åºå· | æ–¹æ³• | è·¯å¾„                                                                 | è¯´æ˜                              |
| ---- | ---- | -------------------------------------------------------------------- | --------------------------------- |
| 13   | POST | `/api/v1/book-creation/tasks/:taskId/generate-chapters`              | æ‰¹é‡ç”Ÿæˆç« èŠ‚                      |
| 13-2 | POST | `/api/v1/book-creation/tasks/:taskId/generate-next-chapter`          | ğŸ†• æ­¥è¿›å¼ç”Ÿæˆå•ç« ï¼ˆäººå·¥å¹²é¢„æ¨¡å¼ï¼‰ |
| 13-3 | POST | `/api/v1/book-creation/tasks/:taskId/continue-next-chapter`          | ğŸ†• ç»§ç»­ä¸‹ä¸€ç« ï¼ˆäººå·¥ç¡®è®¤åï¼‰       |
| 14   | POST | `/api/v1/book-creation/tasks/:taskId/chapters/:chapterId/regenerate` | é‡æ–°ç”Ÿæˆç« èŠ‚                      |

### å®¡ç¨¿ä¼˜åŒ–

| åºå· | æ–¹æ³• | è·¯å¾„                                                               | è¯´æ˜     |
| ---- | ---- | ------------------------------------------------------------------ | -------- |
| 15   | POST | `/api/v1/book-creation/tasks/:taskId/chapters/:chapterId/review`   | å®¡ç¨¿ç« èŠ‚ |
| 16   | POST | `/api/v1/book-creation/tasks/:taskId/chapters/:chapterId/optimize` | ä¼˜åŒ–ç« èŠ‚ |

---

## 1. åˆ›å»ºæˆä¹¦ä»»åŠ¡

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks`
- **Method**: `POST`
- **æƒé™**: éœ€è¦ç™»å½•

### é‡è¦å˜æ›´

**âš ï¸ æ–°æ¶æ„è¯´æ˜**ï¼š

- ä¸å†éœ€è¦æ‰‹åŠ¨è¾“å…¥ `initialIdea`ï¼ˆæƒ³æ³•ï¼‰ï¼Œæƒ³æ³•ç°åœ¨ç”±è„‘æ´ç”Ÿæˆæç¤ºè¯çš„å‚æ•°æä¾›
- æ”¯æŒæç¤ºè¯ç»„å’Œå•ä¸ªæç¤ºè¯ä¸¤ç§æ¨¡å¼
- æ·»åŠ äº† 12 ä¸ªæç¤ºè¯ç±»å‹ï¼ŒåŒ…æ‹¬æ–°å¢çš„å¤§çº²/å·çº²/ç»†çº²ä¼˜åŒ–æç¤ºè¯

### è¯·æ±‚å‚æ•°

```typescript
{
  "promptGroupId": number,        // å¯é€‰ï¼Œæç¤ºè¯ç»„IDï¼ˆä¸€æ—¦è®¾ç½®ä¸å¯æ›´æ”¹ã€‚å¦‚ä¸è®¾ç½®ï¼Œéœ€åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡updatePromptConfigæ¥å£é…ç½®å•ä¸ªæç¤ºè¯ï¼‰
  "autoExecute": boolean,         // å¯é€‰ï¼Œæ˜¯å¦ç«‹å³æ‰§è¡Œç¬¬ä¸€é˜¶æ®µï¼Œé»˜è®¤false
  "taskConfig": {                 // å¯é€‰ï¼Œä»»åŠ¡é…ç½®
    "enableReview": boolean,      // æ˜¯å¦å¯ç”¨å®¡ç¨¿ï¼Œé»˜è®¤true
    "concurrencyLimit": number    // å¹¶å‘é™åˆ¶ï¼Œé»˜è®¤5
  }
}
```

### è¯·æ±‚ç¤ºä¾‹ 1ï¼ˆä½¿ç”¨æç¤ºè¯ç»„ï¼‰

```json
{
  "promptGroupId": 1,
  "autoExecute": true,
  "taskConfig": {
    "enableReview": true,
    "concurrencyLimit": 5
  }
}
```

### è¯·æ±‚ç¤ºä¾‹ 2ï¼ˆå•ä¸ªæç¤ºè¯æ¨¡å¼ - åˆ›å»ºç©ºä»»åŠ¡ï¼‰

```json
{
  "autoExecute": false,
  "taskConfig": {
    "enableReview": true,
    "concurrencyLimit": 5
  }
}
```

**è¯´æ˜**ï¼šå•ä¸ªæç¤ºè¯æ¨¡å¼ä¸‹ï¼Œåˆ›å»ºä»»åŠ¡æ—¶ä¸ä¼  `promptGroupId`ï¼Œä»»åŠ¡åˆ›å»ºåé€šè¿‡ `PATCH /api/v1/book-creation/tasks/:taskId/prompt-config` æ¥å£åœ¨æ‰§è¡Œæ¯ä¸ªé˜¶æ®µå‰é…ç½®å¯¹åº”çš„æç¤ºè¯ã€‚

### å“åº”å‚æ•°

```typescript
{
  "id": number,                          // ä»»åŠ¡ID
  "userId": number,                      // ç”¨æˆ·ID
  "promptGroupId": number | null,        // é€‰æ‹©çš„æç¤ºè¯ç»„IDï¼ˆä¸€æ—¦è®¾ç½®ä¸å¯æ›´æ”¹ï¼‰
  "status": string,                      // ä»»åŠ¡çŠ¶æ€
  "currentStage": string,                // å½“å‰é˜¶æ®µ
  "processedData": object,               // å„é˜¶æ®µäº§å‡ºæ•°æ®
  "promptConfig": object,                // æç¤ºè¯é…ç½®
  "taskConfig": object,                  // ä»»åŠ¡é…ç½®
  "totalCharactersConsumed": number,     // å·²æ¶ˆè€—å­—æ•°
  "createdAt": string,                   // åˆ›å»ºæ—¶é—´
  "updatedAt": string,                   // æ›´æ–°æ—¶é—´
  "completedAt": string | null           // å®Œæˆæ—¶é—´
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "id": 1,
  "userId": 10,
  "promptGroupId": 1,
  "status": "idea_generating",
  "currentStage": "stage_1_idea",
  "processedData": {},
  "promptConfig": {
    "ideaPromptId": 101,
    "titlePromptId": 102,
    "mainOutlinePromptId": 103,
    "volumeOutlinePromptId": 104,
    "chapterOutlinePromptId": 105,
    "contentPromptId": 106
  },
  "taskConfig": {
    "enableReview": true,
    "concurrencyLimit": 5
  },
  "totalCharactersConsumed": 0,
  "createdAt": "2025-11-03T10:00:00Z",
  "updatedAt": "2025-11-03T10:00:00Z",
  "completedAt": null
}
```

### é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç                | è¯´æ˜                     |
| ------ | -------------------- | ------------------------ |
| 400    | MAX_TASKS_REACHED    | å·²è¾¾åˆ°æœ€å¤§ä»»åŠ¡æ•°ï¼ˆ3 ä¸ªï¼‰ |
| 400    | INSUFFICIENT_BALANCE | å­—æ•°åŒ…ä½™é¢ä¸è¶³           |

---

## 2. è·å–ä»»åŠ¡è¯¦æƒ…

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId`
- **Method**: `GET`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è·¯å¾„å‚æ•°

- `taskId`: ä»»åŠ¡ ID

### å“åº”å‚æ•°

```typescript
{
  "id": number,
  "userId": number,
  "novelId": number | null,        // å…³è”çš„ä½œå“IDï¼ˆé˜¶æ®µ2åï¼‰
  "status": string,
  "currentStage": string,
  "initialIdea": string,
  "processedData": {
    "brainstorm": string,          // é˜¶æ®µ1äº§å‡º
    "titles": string[],            // é˜¶æ®µ2äº§å‡º
    "selectedTitle": string,       // é˜¶æ®µ2äº§å‡º
    "synopsis": string,            // é˜¶æ®µ2äº§å‡º
    // ... å…¶ä»–é˜¶æ®µäº§å‡º
  },
  "totalCharactersConsumed": number,
  "stages": [                      // é˜¶æ®µè®°å½•åˆ—è¡¨
    {
      "id": number,
      "stageType": string,
      "status": string,
      "charactersConsumed": number,
      "createdAt": string,
      "completedAt": string | null
    }
  ],
  "novel": {                       // å…³è”çš„ä½œå“ä¿¡æ¯
    "id": number,
    "name": string,
    "synopsis": string,
    // ...
  } | null,
  "createdAt": string,
  "updatedAt": string,
  "completedAt": string | null
}
```

### é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç          | è¯´æ˜           |
| ------ | -------------- | -------------- |
| 404    | TASK_NOT_FOUND | ä»»åŠ¡ä¸å­˜åœ¨     |
| 403    | FORBIDDEN      | æ— æƒè®¿é—®æ­¤ä»»åŠ¡ |

---

## 3. è·å–ä»»åŠ¡åˆ—è¡¨

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks`
- **Method**: `GET`
- **æƒé™**: å½“å‰ç”¨æˆ·

### æŸ¥è¯¢å‚æ•°

```typescript
{
  "status": string,      // å¯é€‰ï¼Œç­›é€‰çŠ¶æ€
  "page": number,        // å¯é€‰ï¼Œé¡µç ï¼Œé»˜è®¤1
  "limit": number        // å¯é€‰ï¼Œæ¯é¡µæ•°é‡ï¼Œé»˜è®¤20
}
```

### è¯·æ±‚ç¤ºä¾‹

```
GET /api/v1/book-creation/tasks?status=completed&page=1&limit=10
```

### å“åº”å‚æ•°

```typescript
{
  "data": [
    {
      "id": number,
      "status": string,
      "currentStage": string,
      "initialIdea": string,
      "totalCharactersConsumed": number,
      "createdAt": string,
      "updatedAt": string,
      "novel": {
        "id": number,
        "name": string
      } | null
    }
  ],
  "total": number,
  "page": number,
  "limit": number,
  "totalPages": number
}
```

---

## 4. æ‰§è¡Œé˜¶æ®µ

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/execute-stage`
- **Method**: `POST`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è¯·æ±‚å‚æ•°

```typescript
{
  "stageType": string | undefined  // å¯é€‰ï¼ŒæŒ‡å®šæ‰§è¡Œçš„é˜¶æ®µï¼Œé»˜è®¤æ‰§è¡Œä¸‹ä¸€é˜¶æ®µ
}
```

### é˜¶æ®µç±»å‹æšä¸¾

- `stage_1_idea`: I-â‘  æƒ³æ³•æ‰©å±•
- `stage_2_title`: I-â‘¡ ä¹¦åç®€ä»‹ç”Ÿæˆ
- `stage_3_outline`: I-â‘¢ å¤§çº²ç”Ÿæˆ
- `stage_4_content`: I-â‘£ æ­£æ–‡ç”Ÿæˆ
- `stage_5_review`: I-â‘¤ æ­£æ–‡ä¼˜åŒ–

### ç‰¹æ®Šè¯´æ˜

**é˜¶æ®µ 2ï¼ˆä¹¦åç®€ä»‹ç”Ÿæˆï¼‰çš„ç‰¹æ®Šæµç¨‹**ï¼š

- é˜¶æ®µ 2 æ‰§è¡Œå®Œæˆåï¼ŒAI ä¼šç”Ÿæˆå¤šä¸ªä¹¦åå€™é€‰å’Œç®€ä»‹
- **ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨é€‰æ‹©ä¹¦å**ï¼Œä»»åŠ¡çŠ¶æ€ä¼šå˜ä¸º `waiting_next_stage`ï¼Œå½“å‰é˜¶æ®µä¿æŒä¸º `stage_2_title`
- ç”¨æˆ·å¿…é¡»é€šè¿‡ **"æ›´æ–°ä¹¦åå’Œç®€ä»‹"** æ¥å£ï¼ˆ`PATCH /api/v1/book-creation/tasks/:taskId/title-synopsis`ï¼‰æ‰‹åŠ¨é€‰æ‹©ä¹¦å
- é€‰æ‹©ä¹¦ååï¼Œä»»åŠ¡ä¼šè‡ªåŠ¨è¿›å…¥é˜¶æ®µ 3ï¼ˆå¤§çº²ç”Ÿæˆï¼‰ï¼ŒçŠ¶æ€å˜ä¸º `waiting_next_stage`ï¼ˆç­‰å¾…æ‰§è¡Œé˜¶æ®µ 3ï¼‰

### å“åº”å‚æ•°

```typescript
{
  "success": boolean,
  "stage": string,
  "data": object,                  // è¯¥é˜¶æ®µçš„äº§å‡ºæ•°æ®
  "charactersConsumed": number,    // æœ¬æ¬¡æ¶ˆè€—å­—æ•°
  "message": string
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "stage": "stage_1_idea",
  "data": {
    "brainstorm": "åœ¨2157å¹´ï¼Œäººç±»æŒæ¡äº†é‡å­æ—¶é—´è·³è·ƒæŠ€æœ¯..."
  },
  "charactersConsumed": 1523,
  "message": "é˜¶æ®µ1æ‰§è¡ŒæˆåŠŸ"
}
```

### é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç                | è¯´æ˜           |
| ------ | -------------------- | -------------- |
| 400    | INVALID_STAGE        | é˜¶æ®µç±»å‹æ— æ•ˆ   |
| 400    | STAGE_NOT_READY      | å‰ç½®é˜¶æ®µæœªå®Œæˆ |
| 403    | INSUFFICIENT_BALANCE | å­—æ•°åŒ…ä½™é¢ä¸è¶³ |
| 500    | AI_GENERATION_FAILED | AI ç”Ÿæˆå¤±è´¥    |

---

## 8. æ›´æ–°æç¤ºè¯é…ç½®

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/prompt-config`
- **Method**: `PATCH`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è¯´æ˜

æ­¤æ¥å£ç”¨äºæ›´æ–°ä»»åŠ¡çš„æç¤ºè¯é…ç½®ã€‚**ä»…å…è®¸æ›´æ–°å•ä¸ªæç¤ºè¯ï¼Œä¸å…è®¸æ›´æ”¹æç¤ºè¯ç»„**ã€‚

### è¯·æ±‚å‚æ•°

```typescript
{
  // å¯ä»¥åªæ›´æ–°éƒ¨åˆ†å­—æ®µï¼Œæœªæä¾›çš„å­—æ®µä¿æŒä¸å˜
  "ideaPromptId": number,                    // å¯é€‰ï¼Œè„‘æ´ç”Ÿæˆæç¤ºè¯ID
  "ideaOptimizePromptId": number,            // å¯é€‰ï¼Œè„‘æ´ä¼˜åŒ–æç¤ºè¯ID
  "titlePromptId": number,                   // å¯é€‰ï¼Œä¹¦åç®€ä»‹ç”Ÿæˆæç¤ºè¯ID
  "mainOutlinePromptId": number,             // å¯é€‰ï¼Œä¸»å¤§çº²ç”Ÿæˆæç¤ºè¯ID
  "mainOutlineOptimizePromptId": number,     // å¯é€‰ï¼Œå¤§çº²ä¼˜åŒ–æç¤ºè¯ID
  "volumeOutlinePromptId": number,           // å¯é€‰ï¼Œå·çº²ç”Ÿæˆæç¤ºè¯ID
  "volumeOutlineOptimizePromptId": number,   // å¯é€‰ï¼Œå·çº²ä¼˜åŒ–æç¤ºè¯ID
  "chapterOutlinePromptId": number,          // å¯é€‰ï¼Œç»†çº²ç”Ÿæˆæç¤ºè¯ID
  "chapterOutlineOptimizePromptId": number,  // å¯é€‰ï¼Œç»†çº²ä¼˜åŒ–æç¤ºè¯ID
  "contentPromptId": number,                 // å¯é€‰ï¼Œç« èŠ‚æ­£æ–‡ç”Ÿæˆæç¤ºè¯ID
  "reviewPromptId": number,                  // å¯é€‰ï¼Œç« èŠ‚å®¡ç¨¿æç¤ºè¯ID
  "summaryPromptId": number                  // å¯é€‰ï¼Œç« èŠ‚æ¢—æ¦‚ç”Ÿæˆæç¤ºè¯ID
}
```

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "contentPromptId": 105,
  "reviewPromptId": 106
}
```

### å“åº”å‚æ•°

è¿”å›æ›´æ–°åçš„å®Œæ•´ä»»åŠ¡å¯¹è±¡ï¼Œæ ¼å¼ä¸"è·å–ä»»åŠ¡è¯¦æƒ…"æ¥å£ç›¸åŒã€‚

### é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç          | è¯´æ˜                                     |
| ------ | -------------- | ---------------------------------------- |
| 400    | INVALID_UPDATE | ä½¿ç”¨æç¤ºè¯ç»„çš„ä»»åŠ¡ä¸èƒ½æ›´æ”¹å•ä¸ªæç¤ºè¯é…ç½® |
| 404    | TASK_NOT_FOUND | ä»»åŠ¡ä¸å­˜åœ¨                               |
| 403    | FORBIDDEN      | æ— æƒè®¿é—®æ­¤ä»»åŠ¡                           |

---

## 8-2. æ›´æ–°ä¹¦åå’Œç®€ä»‹ ğŸ†•

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/title-synopsis`
- **Method**: `PATCH`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è¯´æ˜

åœ¨é˜¶æ®µ 2ï¼ˆä¹¦åç®€ä»‹ç”Ÿæˆï¼‰å®Œæˆåï¼ŒAI ä¼šç”Ÿæˆå¤šä¸ªä¹¦åé€‰é¡¹å’Œç®€ä»‹ã€‚**ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨é€‰æ‹©ä¹¦åï¼Œå¿…é¡»ç”±ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©**ã€‚

ç”¨æˆ·å¯ä»¥ï¼š

1. é€‰æ‹© AI ç”Ÿæˆçš„ä¹¦åä¹‹ä¸€
2. è‡ªå®šä¹‰ä¹¦å
3. ç¼–è¾‘ç®€ä»‹

**é‡è¦è¯´æ˜**ï¼š

- é˜¶æ®µ 2 å®Œæˆåï¼Œä»»åŠ¡çŠ¶æ€ä¼šå˜ä¸º `waiting_next_stage`ï¼Œå½“å‰é˜¶æ®µä¿æŒä¸º `stage_2_title`
- ç”¨æˆ·å¿…é¡»é€šè¿‡æ­¤æ¥å£é€‰æ‹©ä¹¦ååï¼Œä»»åŠ¡æ‰ä¼šè‡ªåŠ¨è¿›å…¥é˜¶æ®µ 3ï¼ˆå¤§çº²ç”Ÿæˆï¼‰
- æ­¤æ¥å£ä¼šåŒæ—¶æ›´æ–°ä»»åŠ¡çš„ `processedData` å’Œå…³è”çš„ `Novel` è®°å½•
- é€‰æ‹©ä¹¦ååï¼Œä»»åŠ¡ä¼šè‡ªåŠ¨è¿›å…¥é˜¶æ®µ 3ï¼ŒçŠ¶æ€å˜ä¸º `waiting_next_stage`ï¼ˆç­‰å¾…æ‰§è¡Œé˜¶æ®µ 3ï¼‰

### è¯·æ±‚å‚æ•°

```typescript
{
  "title": string,      // å¿…å¡«ï¼Œä¹¦å
  "synopsis": string    // å¯é€‰ï¼Œç®€ä»‹
}
```

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "title": "æ—¶é—´æ—…è¡Œè€…çš„å›°å¢ƒ",
  "synopsis": "åœ¨2157å¹´ï¼Œäººç±»æŒæ¡äº†é‡å­æ—¶é—´è·³è·ƒæŠ€æœ¯ï¼Œä½†æ—æ¸Šå´å‘ç°æ¯ä¸€æ¬¡ç©¿è¶Šéƒ½ä¼šç•™ä¸‹æ— æ³•ä¿®å¤çš„æ—¶é—´è£‚ç—•..."
}
```

### å“åº”å‚æ•°

è¿”å›æ›´æ–°åçš„å®Œæ•´ä»»åŠ¡å¯¹è±¡ï¼Œæ ¼å¼ä¸"è·å–ä»»åŠ¡è¯¦æƒ…"æ¥å£ç›¸åŒã€‚

### é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç               | è¯´æ˜                           |
| ------ | ------------------- | ------------------------------ |
| 400    | STAGE_NOT_COMPLETED | è¯·å…ˆå®Œæˆé˜¶æ®µ 2ï¼ˆä¹¦åç®€ä»‹ç”Ÿæˆï¼‰ |
| 404    | TASK_NOT_FOUND      | ä»»åŠ¡ä¸å­˜åœ¨                     |
| 403    | FORBIDDEN           | æ— æƒè®¿é—®æ­¤ä»»åŠ¡                 |

---

## 9. ä¼˜åŒ–é˜¶æ®µäº§å‡ºï¼ˆéæµå¼ï¼‰

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/stages/:stageType/optimize`
- **Method**: `POST`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è¯·æ±‚å‚æ•°

```typescript
{
  "userFeedback": string,    // å¿…å¡«ï¼Œç”¨æˆ·çš„åé¦ˆæ„è§
  "targetData": object       // å¯é€‰ï¼ŒæŒ‡å®šè¦ä¼˜åŒ–çš„æ•°æ®
}
```

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "userFeedback": "è„‘æ´å¤ªç®€å•äº†ï¼Œå¸Œæœ›å¢åŠ æ›´å¤šæ‚¬å¿µå’Œå¤æ‚çš„ä¸–ç•Œè§‚è®¾å®š",
  "targetData": null
}
```

### å“åº”å‚æ•°

```typescript
{
  "success": boolean,
  "stage": string,
  "data": object,              // ä¼˜åŒ–åçš„æ•°æ®
  "charactersConsumed": number,
  "message": string
}
```

---

## 9-2. ä¼˜åŒ–é˜¶æ®µäº§å‡ºï¼ˆæµå¼è¾“å‡ºï¼‰ğŸ†•

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/stages/:stageType/optimize/stream`
- **Method**: `POST`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…
- **å“åº”ç±»å‹**: `text/event-stream` (SSE)

### åŠŸèƒ½è¯´æ˜

å®æ—¶æµå¼è¾“å‡º AI ç”Ÿæˆå†…å®¹ï¼Œé€‚ç”¨äºä¸€é”®æˆä¹¦çš„é˜¶æ®µä¼˜åŒ–åœºæ™¯ã€‚å‰ç«¯å¯ä»¥å®æ—¶æ˜¾ç¤ºç”Ÿæˆè¿›åº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

### è¯·æ±‚å‚æ•°

```typescript
{
  "userFeedback": string,    // å¿…å¡«ï¼Œç”¨æˆ·çš„åé¦ˆæ„è§
  "targetData": object       // å¯é€‰ï¼ŒæŒ‡å®šè¦ä¼˜åŒ–çš„æ•°æ®
}
```

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "userFeedback": "è„‘æ´å¤ªç®€å•äº†ï¼Œå¸Œæœ›å¢åŠ æ›´å¤šæ‚¬å¿µå’Œå¤æ‚çš„ä¸–ç•Œè§‚è®¾å®š",
  "targetData": null
}
```

### SSE å“åº”æ ¼å¼

æµå¼å“åº”ä½¿ç”¨ Server-Sent Events (SSE) åè®®ï¼š

```
data: {"content":"åœ¨"}

data: {"content":"ä¸€ä¸ª"}

data: {"content":"æœªæ¥"}

data: {"type":"metadata","content":"å®Œæ•´å†…å®¹...","inputChars":1000,"outputChars":2000,"modelId":1}

data: [DONE]
```

æ¯ä¸ª `data:` è¡ŒåŒ…å«ä¸€ä¸ª JSON å¯¹è±¡ï¼š

- **æ™®é€šå†…å®¹å—**: `{"content": "æ–‡æœ¬ç‰‡æ®µ"}` - å®æ—¶ç”Ÿæˆçš„å†…å®¹
- **å…ƒæ•°æ®å—**: `{"type":"metadata", "content":"...", "inputChars":..., "outputChars":..., "modelId":...}` - åŒ…å«å®Œæ•´å†…å®¹å’Œå­—æ•°ç»Ÿè®¡
- **å®Œæˆä¿¡å·**: `[DONE]` - è¡¨ç¤ºç”Ÿæˆç»“æŸ

### WebSocket è¿›åº¦é€šçŸ¥

é™¤äº† SSE æµå¼è¾“å‡ºå¤–ï¼Œç³»ç»Ÿè¿˜ä¼šé€šè¿‡ WebSocket æ¨é€ä»¥ä¸‹äº‹ä»¶ï¼š

```typescript
// å¼€å§‹ä¼˜åŒ–
{
  "event": "stage_started",
  "stage": "stage_1_idea",
  "data": {
    "message": "å¼€å§‹è„‘æ´ä¼˜åŒ–"
  }
}

// ä¼˜åŒ–å®Œæˆ
{
  "event": "stage_completed",
  "stage": "stage_1_idea",
  "data": {
    "message": "è„‘æ´ä¼˜åŒ–å®Œæˆ",
    "result": { "brainstorm": "ä¼˜åŒ–åçš„å†…å®¹..." },
    "charactersConsumed": 2500
  }
}

// é”™è¯¯äº‹ä»¶
{
  "event": "error",
  "stage": "stage_1_idea",
  "data": {
    "error": "é”™è¯¯ä¿¡æ¯"
  }
}
```

### å‰ç«¯ä½¿ç”¨ç¤ºä¾‹

```typescript
// ä½¿ç”¨å‰ç«¯ API æœåŠ¡
const cancelStream = await bookCreationApi.optimizeStageStream(
  taskId,
  "stage_1_idea",
  "å¸Œæœ›å¢åŠ æ›´å¤šæ‚¬å¿µ...",
  // æ¥æ”¶å†…å®¹ç‰‡æ®µ
  (content) => {
    setStreamingContent((prev) => prev + content);
  },
  // å®Œæˆå›è°ƒ
  () => {
    console.log("ä¼˜åŒ–å®Œæˆ");
    refreshTask();
  },
  // é”™è¯¯å›è°ƒ
  (err) => {
    console.error("ä¼˜åŒ–å¤±è´¥:", err);
  }
);

// å¯ä»¥å–æ¶ˆæµå¼è¯·æ±‚
cancelStream();
```

### æ³¨æ„äº‹é¡¹

1. **å­—æ•°æ‰£è´¹**: æµå¼ç”Ÿæˆä¼šå®æ—¶æ‰£é™¤å­—æ•°ï¼Œå³ä½¿ä¸­é€”å–æ¶ˆä¹Ÿä¼šæŒ‰å·²ç”Ÿæˆçš„å†…å®¹æ‰£è´¹
2. **è¶…æ—¶è®¾ç½®**: é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º 10 åˆ†é’Ÿï¼ˆ600 ç§’ï¼‰
3. **å¹¶å‘é™åˆ¶**: åŒä¸€ç”¨æˆ·åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæµå¼è¯·æ±‚
4. **ä»»åŠ¡æ›´æ–°**: æµå¼å®Œæˆåï¼Œä»»åŠ¡æ•°æ®ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå‰ç«¯æ”¶åˆ° `stage_completed` äº‹ä»¶ååº”åˆ·æ–°ä»»åŠ¡è¯¦æƒ…

---

## 10. è·å–å¤§çº²æ ‘

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/outline`
- **Method**: `GET`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### å“åº”å‚æ•°

```typescript
{
  "nodes": [
    {
      "id": number,
      "level": 1 | 2 | 3,
      "title": string,
      "content": string,
      "order": number,
      "status": string,
      "volumeId": number | null,
      "chapterId": number | null,
      "children": [
        // é€’å½’ç»“æ„
      ]
    }
  ]
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "nodes": [
    {
      "id": 1,
      "level": 1,
      "title": "å´­æ–°çš„å¼€å§‹",
      "content": "æ—æ¸Šä½œä¸ºæ—¶é—´ä¿®å¤å‘˜æ‰§è¡Œå¸¸è§„ä»»åŠ¡...",
      "order": 0,
      "status": "optimized",
      "volumeId": null,
      "chapterId": null,
      "children": [
        {
          "id": 2,
          "level": 2,
          "title": "ç¬¬ä¸€å·ï¼šæ—¶é—´è£‚ç—•",
          "content": "æ—æ¸Šæ¥åˆ°ä¸€ä¸ªçœ‹ä¼¼æ™®é€šçš„ä¿®å¤ä»»åŠ¡...",
          "order": 0,
          "status": "generated",
          "volumeId": 1,
          "chapterId": null,
          "children": [
            {
              "id": 3,
              "level": 3,
              "title": "ç¬¬ä¸€ç«  æ—¥å¸¸ä»»åŠ¡",
              "content": "{\"summary\": \"...\", \"characters\": [...]}",
              "order": 0,
              "status": "generated",
              "volumeId": 1,
              "chapterId": 1,
              "children": []
            }
          ]
        }
      ]
    }
  ]
}
```

---

## 13. æ‰¹é‡ç”Ÿæˆç« èŠ‚

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/generate-chapters`
- **Method**: `POST`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è¯·æ±‚å‚æ•°

```typescript
{
  "chapterIds": number[],    // å¯é€‰ï¼ŒæŒ‡å®šç« èŠ‚IDåˆ—è¡¨
  "generateAll": boolean     // å¯é€‰ï¼Œç”Ÿæˆæ‰€æœ‰æœªç”Ÿæˆçš„ç« èŠ‚ï¼Œé»˜è®¤false
}
```

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "chapterIds": [1, 2, 3, 4, 5],
  "generateAll": false
}
```

æˆ–

```json
{
  "generateAll": true
}
```

### å“åº”å‚æ•°

```typescript
{
  "success": boolean,
  "totalGenerated": number,      // æˆåŠŸç”Ÿæˆæ•°é‡
  "totalFailed": number,         // å¤±è´¥æ•°é‡
  "charactersConsumed": number,  // æ€»æ¶ˆè€—å­—æ•°
  "failedChapters": [
    {
      "chapterId": number,
      "error": string
    }
  ],
  "message": string
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "totalGenerated": 5,
  "totalFailed": 0,
  "charactersConsumed": 15234,
  "failedChapters": [],
  "message": "æ‰¹é‡ç”Ÿæˆå®Œæˆï¼ŒæˆåŠŸ5ç« "
}
```

---

## 13-2. æ­¥è¿›å¼ç”Ÿæˆå•ç«  ğŸ†• ï¼ˆäººå·¥å¹²é¢„æ¨¡å¼ï¼‰

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/generate-next-chapter`
- **Method**: `POST`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è¯´æ˜

è¿™æ˜¯ä¸€ä¸ª**Human-in-the-loopï¼ˆäººåœ¨ç¯è·¯ä¸­ï¼‰**çš„åŠè‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿï¼Œé€‚åˆéœ€è¦ä¸¥æ ¼è´¨é‡æ§åˆ¶çš„åˆ›ä½œåœºæ™¯ã€‚

**å®Œæ•´å·¥ä½œæµ**ï¼š

1. âœ… **ç”Ÿæˆæ­£æ–‡** - ä½¿ç”¨å†…å®¹ç”Ÿæˆæç¤ºè¯ï¼Œå…³è”å‰é¢ç« èŠ‚çš„æ¢—æ¦‚
2. âœ… **æå–æ¢—æ¦‚** - ä½¿ç”¨æ¢—æ¦‚ç”Ÿæˆæç¤ºè¯æ€»ç»“æœ¬ç« è¦ç‚¹
3. âœ… **AI å®¡ç¨¿** - æ£€æŸ¥é€»è¾‘é”™è¯¯ã€è¿è´¯æ€§ã€è§’è‰²ä¸€è‡´æ€§ç­‰
4. â¸ï¸ **æš‚åœå¹¶è¿”å›å®¡ç¨¿æŠ¥å‘Š** - ç­‰å¾…äººå·¥æŸ¥çœ‹å’Œå†³ç­–
5. ğŸ‘¤ **äººå·¥å†³ç­–**ï¼š
   - æŸ¥çœ‹å®¡ç¨¿æŠ¥å‘Šå’Œé—®é¢˜
   - åœ¨ç¼–è¾‘å™¨ä¸­æ‰‹åŠ¨ä¿®æ”¹ç« èŠ‚ï¼ˆå¯é€‰ï¼‰
   - æˆ–è°ƒç”¨ä¼˜åŒ–æ¥å£è®© AI ä¿®æ”¹ï¼ˆå¯é€‰ï¼‰
   - ç¡®è®¤æ»¡æ„åï¼Œè°ƒç”¨"ç»§ç»­ä¸‹ä¸€ç« "æ¥å£

**ä¸å…¨è‡ªåŠ¨æ‰¹é‡ç”Ÿæˆçš„åŒºåˆ«**ï¼š

- âœ… æ¯ç« ç”Ÿæˆåéƒ½ä¼šæš‚åœï¼Œç­‰å¾…äººå·¥ç¡®è®¤
- âœ… å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­æ‰‹åŠ¨ä¿®æ”¹ç« èŠ‚
- âœ… æä¾›è¯¦ç»†çš„å®¡ç¨¿æŠ¥å‘Šä¾›å‚è€ƒ
- âœ… é¿å… AI ä¸€è·¯è·‘åï¼Œç¡®ä¿è´¨é‡å¯æ§

### è¯·æ±‚å‚æ•°

```typescript
{
  "chapterOrder": number  // å¯é€‰ï¼ŒæŒ‡å®šç« èŠ‚åºå·ï¼ˆä»1å¼€å§‹ï¼‰ï¼Œä¸ä¼ åˆ™è‡ªåŠ¨ç”Ÿæˆä¸‹ä¸€ç« 
}
```

### è¯·æ±‚ç¤ºä¾‹ 1ï¼ˆè‡ªåŠ¨ç”Ÿæˆä¸‹ä¸€ç« ï¼‰

```json
{}
```

æˆ–

```json
{
  "chapterOrder": null
}
```

### è¯·æ±‚ç¤ºä¾‹ 2ï¼ˆæŒ‡å®šç”Ÿæˆç¬¬ 5 ç« ï¼‰

```json
{
  "chapterOrder": 5
}
```

### å“åº”å‚æ•°

```typescript
{
  "success": boolean,
  "chapter": {
    "id": number,
    "order": number,          // ç« èŠ‚åºå·ï¼ˆä»1å¼€å§‹ï¼‰
    "title": string,          // ç« èŠ‚æ ‡é¢˜
    "content": string,        // ç« èŠ‚æ­£æ–‡
    "summary": string,        // ç« èŠ‚æ¢—æ¦‚
    "wordCount": number       // å­—æ•°
  },
  "reviewReport": {           // AIå®¡ç¨¿æŠ¥å‘Š
    "chapterId": number,
    "score": number,          // ç»¼åˆè¯„åˆ† 0-100
    "issues": [               // å‘ç°çš„é—®é¢˜
      {
        "type": "logic" | "character" | "continuity" | "style",
        "severity": "high" | "medium" | "low",
        "description": string,
        "location": string
      }
    ],
    "suggestions": string[],  // æ”¹è¿›å»ºè®®
    "strengths": string[]     // ä¼˜ç‚¹
  },
  "nextChapterOrder": number | null,  // ä¸‹ä¸€ç« åºå·ï¼ˆnullè¡¨ç¤ºå·²æ˜¯æœ€åä¸€ç« ï¼‰
  "charactersConsumed": number,
  "message": string
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "chapter": {
    "id": 42,
    "order": 5,
    "title": "ç¬¬äº”ç«  å†³æˆ˜æ—¶åˆ»",
    "content": "æ—æ¸Šç«™åœ¨æ—¶é—´è£‚ç—•å‰ï¼Œæ·±å¸ä¸€å£æ°”...",
    "summary": "æ—æ¸Šå†³å®šè¿›å…¥æ—¶é—´è£‚ç—•ï¼Œå°½ç®¡çŸ¥é“é£é™©å·¨å¤§ã€‚ç»è¿‡æ¿€çƒˆçš„å†…å¿ƒæŒ£æ‰ï¼Œä»–æœ€ç»ˆé€‰æ‹©ç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­ã€‚",
    "wordCount": 3245
  },
  "reviewReport": {
    "chapterId": 42,
    "score": 85,
    "issues": [
      {
        "type": "character",
        "severity": "medium",
        "description": "æ—æ¸Šçš„å¿ƒç†è½¬å˜è¿‡äºçªç„¶ï¼Œç¼ºå°‘é“ºå«",
        "location": "ç¬¬3æ®µ"
      },
      {
        "type": "logic",
        "severity": "low",
        "description": "æ—¶é—´è£‚ç—•çš„ç‰©ç†ç‰¹æ€§æè¿°å‰åä¸ä¸€è‡´",
        "location": "ç¬¬7æ®µ"
      }
    ],
    "suggestions": [
      "å»ºè®®åœ¨ç¬¬2-3æ®µä¹‹é—´å¢åŠ ä¸€æ®µå†…å¿ƒç‹¬ç™½ï¼Œè¯´æ˜æ—æ¸Šåšå‡ºå†³å®šçš„å¿ƒè·¯å†ç¨‹",
      "ç»Ÿä¸€æ—¶é—´è£‚ç—•çš„è§†è§‰æè¿°ï¼Œå»ºè®®ä½¿ç”¨ç¬¬1ç« çš„'è“ç´«è‰²å…‰èŠ’'è®¾å®š"
    ],
    "strengths": [
      "ç¯å¢ƒæå†™ç”ŸåŠ¨ï¼Œè¥é€ äº†ç´§å¼ çš„æ°›å›´",
      "å¯¹è¯è‡ªç„¶æµç•…",
      "èŠ‚å¥æŠŠæ§å¾—å½“ï¼Œæ‚¬å¿µè®¾ç½®åˆç†"
    ]
  },
  "nextChapterOrder": 6,
  "charactersConsumed": 3500,
  "message": "ç¬¬5ç« ç”Ÿæˆå®Œæˆï¼Œè¯·æŸ¥çœ‹å®¡ç¨¿æŠ¥å‘Š"
}
```

### WebSocket å®æ—¶æ¨é€

ç”Ÿæˆè¿‡ç¨‹ä¸­ä¼šæ¨é€è¯¦ç»†çš„è¿›åº¦äº‹ä»¶ï¼š

**1. å¼€å§‹ç”Ÿæˆ**

```json
{
  "event": "chapter_generation_started",
  "data": {
    "chapterId": 42,
    "chapterOrder": 5,
    "chapterTitle": "ç¬¬äº”ç«  å†³æˆ˜æ—¶åˆ»",
    "message": "å¼€å§‹ç”Ÿæˆç¬¬5ç« ï¼šå†³æˆ˜æ—¶åˆ»"
  }
}
```

**2. æ­¥éª¤è¿›åº¦**

```json
{
  "event": "step_progress",
  "data": {
    "chapterId": 42,
    "step": "generating", // generating | summarizing | reviewing
    "message": "æ­£åœ¨ç”Ÿæˆç¬¬5ç« æ­£æ–‡..."
  }
}
```

**3. ç”Ÿæˆå®Œæˆ**

```json
{
  "event": "chapter_generation_completed",
  "data": {
    "chapterId": 42,
    "chapterOrder": 5,
    "chapterTitle": "ç¬¬äº”ç«  å†³æˆ˜æ—¶åˆ»",
    "reviewReport": { ... },
    "hasNextChapter": true,
    "nextChapterOrder": 6,
    "message": "ç¬¬5ç« ç”Ÿæˆå®Œæˆï¼Œç­‰å¾…äººå·¥ç¡®è®¤"
  }
}
```

### å…¸å‹ä½¿ç”¨æµç¨‹

```javascript
// 1. è°ƒç”¨ç”Ÿæˆå•ç« æ¥å£
const result = await fetch(
  "/api/v1/book-creation/tasks/1/generate-next-chapter",
  {
    method: "POST",
    body: JSON.stringify({}),
  }
);

// 2. æŸ¥çœ‹å®¡ç¨¿æŠ¥å‘Š
console.log("å®¡ç¨¿è¯„åˆ†:", result.reviewReport.score);
console.log("å‘ç°é—®é¢˜:", result.reviewReport.issues);

// 3. äººå·¥å†³ç­–
if (result.reviewReport.score < 70) {
  // åˆ†æ•°ä½ï¼Œæ‰‹åŠ¨ä¿®æ”¹æˆ–è®©AIä¼˜åŒ–
  await fetch(
    `/api/v1/book-creation/tasks/1/chapters/${result.chapter.id}/optimize`,
    {
      method: "POST",
    }
  );
} else if (result.reviewReport.issues.some((i) => i.severity === "high")) {
  // æœ‰ä¸¥é‡é—®é¢˜ï¼Œåœ¨ç¼–è¾‘å™¨ä¸­æ‰‹åŠ¨ä¿®æ”¹
  window.location.href = `/editor/${result.chapter.id}`;
} else {
  // æ»¡æ„ï¼Œç»§ç»­ä¸‹ä¸€ç« 
  await fetch("/api/v1/book-creation/tasks/1/continue-next-chapter", {
    method: "POST",
  });
}
```

---

## 13-3. ç»§ç»­ä¸‹ä¸€ç«  ğŸ†•

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/continue-next-chapter`
- **Method**: `POST`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### è¯´æ˜

äººå·¥ç¡®è®¤å½“å‰ç« èŠ‚æ»¡æ„åï¼Œè°ƒç”¨æ­¤æ¥å£ç»§ç»­ç”Ÿæˆä¸‹ä¸€ç« ã€‚è¿™æ˜¯ä¸€ä¸ªå¿«æ·æ¥å£ï¼Œç­‰ä»·äºè°ƒç”¨ `generate-next-chapter` ä¸”ä¸æŒ‡å®šç« èŠ‚åºå·ã€‚

### è¯·æ±‚å‚æ•°

æ— éœ€è¯·æ±‚ä½“

### å“åº”å‚æ•°

ä¸ `generate-next-chapter` æ¥å£ç›¸åŒ

### ä½¿ç”¨ç¤ºä¾‹

```javascript
// äººå·¥ç¡®è®¤ç¬¬5ç« æ»¡æ„å
await fetch("/api/v1/book-creation/tasks/1/continue-next-chapter", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${token}`,
    "Content-Type": "application/json",
  },
});

// ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆç¬¬6ç« ï¼Œå¹¶è¿”å›æ–°çš„å®¡ç¨¿æŠ¥å‘Š
```

### é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç                | è¯´æ˜           |
| ------ | -------------------- | -------------- |
| 400    | NO_MORE_CHAPTERS     | å·²æ˜¯æœ€åä¸€ç«    |
| 403    | INSUFFICIENT_BALANCE | å­—æ•°åŒ…ä½™é¢ä¸è¶³ |
| 404    | TASK_NOT_FOUND       | ä»»åŠ¡ä¸å­˜åœ¨     |

---

## 15. å®¡ç¨¿ç« èŠ‚

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/book-creation/tasks/:taskId/chapters/:chapterId/review`
- **Method**: `POST`
- **æƒé™**: ä»»åŠ¡æ‰€æœ‰è€…

### å“åº”å‚æ•°

```typescript
{
  "success": boolean,
  "reviewReport": {
    "chapterId": number,
    "score": number,           // 0-100
    "issues": [
      {
        "type": "logic" | "character" | "continuity" | "style",
        "severity": "high" | "medium" | "low",
        "description": string,
        "location": string
      }
    ],
    "suggestions": string[],
    "strengths": string[]
  },
  "charactersConsumed": number
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "reviewReport": {
    "chapterId": 1,
    "score": 85,
    "issues": [
      {
        "type": "character",
        "severity": "medium",
        "description": "æ—æ¸Šåœ¨ç¬¬3æ®µçªç„¶è¡¨ç°å‡ºè¿‡åº¦çš„è‡ªä¿¡ï¼Œä¸å‰æ–‡è®¾å®šçš„è°¨æ…æ€§æ ¼ä¸ç¬¦",
        "location": "ç¬¬3æ®µ"
      }
    ],
    "suggestions": ["å»ºè®®åœ¨ç¬¬3æ®µå¢åŠ ä¸€æ®µå†…å¿ƒç‹¬ç™½ï¼Œè§£é‡Šæ—æ¸Šæ­¤æ—¶è‡ªä¿¡çš„æ¥æº"],
    "strengths": ["å¯¹è¯è‡ªç„¶æµç•…ï¼Œæ¨è¿›å‰§æƒ…æ•ˆç‡é«˜", "æ‚¬å¿µè®¾ç½®å¾—å½“ï¼Œç»“å°¾å¼•äººå…¥èƒœ"]
  },
  "charactersConsumed": 1023
}
```

---

## 17. åˆ›å»ºæç¤ºè¯ç»„

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/prompt-groups`
- **Method**: `POST`
- **æƒé™**: éœ€è¦ç™»å½•

### è¯·æ±‚å‚æ•°

```typescript
{
  "name": string,             // å¿…å¡«ï¼Œæç¤ºè¯ç»„åç§°
  "description": string,      // å¯é€‰ï¼Œæè¿°ï¼ˆæ”¯æŒMarkdownï¼‰
  "isPublic": boolean,        // å¯é€‰ï¼Œæ˜¯å¦å…¬å¼€åˆ°å¹¿åœºï¼Œé»˜è®¤true
  "requireApplication": boolean, // å¯é€‰ï¼Œæ˜¯å¦éœ€è¦ç”³è¯·ï¼Œé»˜è®¤false
  "categoryId": number,       // å¯é€‰ï¼Œåˆ†ç±»ID
  "status": "draft" | "published" | "archived", // å¯é€‰ï¼ŒçŠ¶æ€ï¼Œé»˜è®¤draft
  "items": [                  // å¿…å¡«ï¼Œæç¤ºè¯ç»„é¡¹åˆ—è¡¨
    {
      "promptId": number,     // æç¤ºè¯ID
      "stageType": string,    // é˜¶æ®µç±»å‹ï¼ˆå¦‚ideaPromptId, contentPromptIdç­‰ï¼‰
      "stageLabel": string,   // å¯é€‰ï¼Œé˜¶æ®µæ˜¾ç¤ºåç§°
      "order": number,        // å¯é€‰ï¼Œé¡ºåº
      "isRequired": boolean   // å¯é€‰ï¼Œæ˜¯å¦å¿…éœ€ï¼Œé»˜è®¤true
    }
  ]
}
```

### è¯´æ˜

**é‡è¦åŠŸèƒ½**ï¼š

- å½“ `requireApplication` è®¾ç½®ä¸º `true` æ—¶ï¼Œç»„å†…æ‰€æœ‰æç¤ºè¯ä¼šè‡ªåŠ¨åŒæ­¥è®¾ç½®ä¸ºéœ€è¦ç”³è¯·
- è¿™ç¡®ä¿äº†æç¤ºè¯ç»„å’Œå•ä¸ªæç¤ºè¯çš„æƒé™æ§åˆ¶ä¸€è‡´

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "name": "ç„å¹»å°è¯´åˆ›ä½œå¥—è£…",
  "description": "è¿™æ˜¯ä¸€å¥—ä¸“ä¸ºç„å¹»å°è¯´åˆ›ä½œä¼˜åŒ–çš„æç¤ºè¯ç»„ï¼ŒåŒ…å«12ä¸ªç²¾å¿ƒè°ƒé…çš„æç¤ºè¯ï¼Œè¦†ç›–ä»åˆ›æ„åˆ°æˆç¨¿çš„å…¨æµç¨‹ã€‚",
  "isPublic": true,
  "requireApplication": false,
  "categoryId": 1,
  "status": "published",
  "items": [
    {
      "promptId": 101,
      "stageType": "idea_generation",
      "stageLabel": "è„‘æ´ç”Ÿæˆæç¤ºè¯",
      "order": 0,
      "isRequired": true
    },
    {
      "promptId": 102,
      "stageType": "content_generation",
      "stageLabel": "ç« èŠ‚æ­£æ–‡ç”Ÿæˆæç¤ºè¯",
      "order": 1,
      "isRequired": true
    }
  ]
}
```

**stageType å¯é€‰å€¼**ï¼ˆ12 ä¸ªï¼‰ï¼š

- `idea_generation` - è„‘æ´ç”Ÿæˆ
- `idea_optimize` - è„‘æ´ä¼˜åŒ–
- `title_generation` - ä¹¦åç®€ä»‹ç”Ÿæˆ
- `main_outline_generation` - ä¸»å¤§çº²ç”Ÿæˆ
- `main_outline_optimize` - å¤§çº²ä¼˜åŒ–
- `volume_outline_generation` - å·çº²ç”Ÿæˆ
- `volume_outline_optimize` - å·çº²ä¼˜åŒ–
- `chapter_outline_generation` - ç»†çº²ç”Ÿæˆ
- `chapter_outline_optimize` - ç»†çº²ä¼˜åŒ–
- `content_generation` - ç« èŠ‚æ­£æ–‡ç”Ÿæˆ
- `review` - ç« èŠ‚å®¡ç¨¿
- `summary_generation` - ç« èŠ‚æ¢—æ¦‚ç”Ÿæˆ

### å“åº”å‚æ•°

```typescript
{
  "id": number,
  "userId": number,
  "name": string,
  "description": string,
  "isPublic": boolean,
  "requireApplication": boolean,
  "categoryId": number,
  "status": string,
  "viewCount": number,
  "useCount": number,
  "likeCount": number,
  "hotValue": number,
  "createdAt": string,
  "updatedAt": string,
  "items": [
    {
      "id": number,
      "groupId": number,
      "promptId": number,
      "stageType": string,
      "stageLabel": string,
      "order": number,
      "isRequired": boolean
    }
  ]
}
```

---

## 18. è·å–æç¤ºè¯ç»„åˆ—è¡¨

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/prompt-groups`
- **Method**: `GET`
- **æƒé™**: æ— éœ€ç™»å½•ï¼ˆç™»å½•åå¯æŸ¥çœ‹ç‚¹èµçŠ¶æ€ï¼‰

### æŸ¥è¯¢å‚æ•°

```typescript
{
  "page": number,          // å¯é€‰ï¼Œé¡µç ï¼Œé»˜è®¤1
  "pageSize": number,      // å¯é€‰ï¼Œæ¯é¡µæ•°é‡ï¼Œé»˜è®¤20
  "categoryId": number,    // å¯é€‰ï¼Œåˆ†ç±»ID
  "keyword": string,       // å¯é€‰ï¼Œå…³é”®è¯æœç´¢
  "isPublic": boolean,     // å¯é€‰ï¼Œæ˜¯å¦å…¬å¼€
  "userId": number,        // å¯é€‰ï¼Œåˆ›å»ºè€…ID
  "status": string,        // å¯é€‰ï¼ŒçŠ¶æ€
  "sortBy": string,        // å¯é€‰ï¼Œæ’åºå­—æ®µï¼ˆhotValue/createdAt/viewCount/useCount/likeCountï¼‰ï¼Œé»˜è®¤hotValue
  "sortOrder": "ASC" | "DESC" // å¯é€‰ï¼Œæ’åºæ–¹å‘ï¼Œé»˜è®¤DESC
}
```

### å“åº”å‚æ•°

```typescript
{
  "data": [
    {
      "id": number,
      "userId": number,
      "user": {
        "id": number,
        "username": string,
        "nickname": string
      },
      "name": string,
      "description": string,
      "isPublic": boolean,
      "requireApplication": boolean,
      "category": {
        "id": number,
        "name": string
      },
      "status": string,
      "viewCount": number,
      "useCount": number,
      "likeCount": number,
      "hotValue": number,
      "items": [...],
      "isLiked": boolean  // ç™»å½•ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€
    }
  ],
  "pagination": {
    "page": number,
    "pageSize": number,
    "total": number,
    "totalPages": number
  }
}
```

---

## 19. è·å–æç¤ºè¯ç»„è¯¦æƒ…

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/prompt-groups/:id`
- **Method**: `GET`
- **æƒé™**: æ— éœ€ç™»å½•ï¼ˆç™»å½•åå¯æŸ¥çœ‹ç‚¹èµçŠ¶æ€ï¼‰

### å“åº”å‚æ•°

ä¸è·å–åˆ—è¡¨çš„å•ä¸ªé¡¹ç›¸åŒï¼Œä½†ä¼šå¢åŠ æµè§ˆè®¡æ•°ã€‚

---

## 20. è·å–æç¤ºè¯ç»„æ‰€æœ‰å‚æ•°

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/prompt-groups/:id/parameters`
- **Method**: `GET`
- **æƒé™**: æ— éœ€ç™»å½•

### è¯´æ˜

æ­¤æ¥å£ç”¨äºè·å–æç¤ºè¯ç»„ä¸­æ‰€æœ‰æç¤ºè¯éœ€è¦çš„å‚æ•°ï¼Œç”¨äºåœ¨åˆ›å»ºä»»åŠ¡æ—¶æ¸²æŸ“å‚æ•°è¾“å…¥è¡¨å•ã€‚

### å“åº”å‚æ•°

```typescript
{
  "groupId": number,
  "groupName": string,
  "parameters": [
    {
      "name": string,         // å‚æ•°å
      "required": boolean,    // æ˜¯å¦å¿…éœ€
      "description": string,  // å‚æ•°æè¿°
      "stageType": string,    // æ‰€å±é˜¶æ®µ
      "stageLabel": string    // é˜¶æ®µæ˜¾ç¤ºåç§°
    }
  ]
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "groupId": 1,
  "groupName": "ç„å¹»å°è¯´åˆ›ä½œå¥—è£…",
  "parameters": [
    {
      "name": "ä¸»è§’åå­—",
      "required": true,
      "description": "è¯·è¾“å…¥ä¸»è§’çš„åå­—",
      "stageType": "contentPromptId",
      "stageLabel": "ç« èŠ‚æ­£æ–‡ç”Ÿæˆæç¤ºè¯"
    },
    {
      "name": "ä¸–ç•Œè§‚èƒŒæ™¯",
      "required": false,
      "description": "è¯·æè¿°å°è¯´çš„ä¸–ç•Œè§‚èƒŒæ™¯",
      "stageType": "ideaPromptId",
      "stageLabel": "è„‘æ´ç”Ÿæˆæç¤ºè¯"
    }
  ]
}
```

---

## 21. ç”³è¯·ä½¿ç”¨æç¤ºè¯ç»„

### æ¥å£ä¿¡æ¯

- **URL**: `/api/v1/prompt-groups/:id/apply`
- **Method**: `POST`
- **æƒé™**: éœ€è¦ç™»å½•

### è¯´æ˜

ä»…å½“æç¤ºè¯ç»„è®¾ç½®äº† `requireApplication: true` æ—¶éœ€è¦ç”³è¯·ã€‚

**æƒé™åŒæ­¥æœºåˆ¶**ï¼š

- å½“ç”³è¯·è¢«æ‰¹å‡†æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æˆäºˆç”¨æˆ·å¯¹æç¤ºè¯ç»„å’Œç»„å†…æ‰€æœ‰æç¤ºè¯çš„ USE æƒé™
- ç”¨æˆ·å¯ä»¥åœ¨æç¤ºè¯å¹¿åœºç›´æ¥ä½¿ç”¨è¿™äº›æç¤ºè¯

### è¯·æ±‚å‚æ•°

```typescript
{
  "reason": string  // å¯é€‰ï¼Œç”³è¯·ç†ç”±
}
```

### å“åº”å‚æ•°

```typescript
{
  "id": number,
  "groupId": number,
  "userId": number,
  "reason": string,
  "status": "pending",
  "createdAt": string
}
```

---

## ä½¿ç”¨æç¤ºè¯ç»„åˆ›å»ºä»»åŠ¡

### æ–°æ¶æ„è¯´æ˜

åœ¨åˆ›å»ºä»»åŠ¡æ—¶ï¼Œç°åœ¨æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

1. **æç¤ºè¯ç»„æ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼šä¼  `promptGroupId`ï¼Œåç«¯è‡ªåŠ¨åŠ è½½æç¤ºè¯ç»„çš„æ‰€æœ‰æç¤ºè¯
2. **å•ä¸ªæç¤ºè¯æ¨¡å¼**ï¼šä¸ä¼  `promptGroupId`ï¼Œåˆ›å»ºç©ºä»»åŠ¡ï¼Œåœ¨æ‰§è¡Œæ¯ä¸ªé˜¶æ®µå‰é€šè¿‡ `PATCH /prompt-config` æ¥å£é€‰æ‹©æç¤ºè¯

### é‡è¦å˜æ›´

- âœ… ç§»é™¤äº† `initialIdea` å­—æ®µï¼Œæƒ³æ³•ç”±è„‘æ´ç”Ÿæˆæç¤ºè¯çš„å‚æ•°æä¾›
- âœ… ç§»é™¤äº†åˆ›å»ºæ—¶çš„ `promptConfig` å‚æ•°ï¼Œä¸å†æ”¯æŒæ‰‹åŠ¨é…ç½®æç¤ºè¯ ID
- âœ… æç¤ºè¯ç»„ä¸€æ—¦è®¾ç½®ä¸å¯æ›´æ”¹ï¼Œç¡®ä¿ä»»åŠ¡ä½¿ç”¨ä¸€è‡´çš„æç¤ºè¯é…ç½®
- âœ… å•ä¸ªæç¤ºè¯æ¨¡å¼ä¸‹ï¼Œåœ¨æ‰§è¡Œé˜¶æ®µå‰åŠ¨æ€é…ç½®ï¼ˆä½¿ç”¨ PATCH æ¥å£ï¼‰
- âœ… æ–°å¢ 3 ä¸ªä¼˜åŒ–æç¤ºè¯ï¼šå¤§çº²ä¼˜åŒ–ã€å·çº²ä¼˜åŒ–ã€ç»†çº²ä¼˜åŒ–
- âœ… ç²¾ç®€ taskConfigï¼šåªä¿ç•™ enableReview å’Œ concurrencyLimit

### è¯·æ±‚ç¤ºä¾‹ 1ï¼ˆæç¤ºè¯ç»„æ¨¡å¼ï¼‰

```json
{
  "promptGroupId": 1,
  "autoExecute": true,
  "taskConfig": {
    "enableReview": true,
    "concurrencyLimit": 5
  }
}
```

### è¯·æ±‚ç¤ºä¾‹ 2ï¼ˆå•ä¸ªæç¤ºè¯æ¨¡å¼ï¼‰

**æ­¥éª¤ 1ï¼šåˆ›å»ºç©ºä»»åŠ¡**

```json
{
  "autoExecute": false,
  "taskConfig": {
    "enableReview": true,
    "concurrencyLimit": 5
  }
}
```

**æ­¥éª¤ 2ï¼šé…ç½®è„‘æ´ç”Ÿæˆæç¤ºè¯**

```http
PATCH /api/v1/book-creation/tasks/1/prompt-config
{
  "ideaPromptId": 101
}
```

**æ­¥éª¤ 3ï¼šæ‰§è¡Œé˜¶æ®µ**

```http
POST /api/v1/book-creation/tasks/1/execute-stage
{
  "stageType": "stage_1_idea"
}
```

---

## ğŸ”Œ WebSocket å®æ—¶æ¨é€

### è¿æ¥æ–¹å¼

```javascript
import { io } from "socket.io-client";

const socket = io("http://localhost:3000", {
  auth: {
    token: "YOUR_JWT_TOKEN",
  },
});

// åŠ å…¥ä»»åŠ¡æˆ¿é—´
socket.emit("join_book_creation_room", { taskId: 1 });

// ç›‘å¬è¿›åº¦æ›´æ–°
socket.on("book_creation_progress", (data) => {
  console.log("è¿›åº¦æ›´æ–°:", data);
});
```

### äº‹ä»¶ç±»å‹

#### å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯

| äº‹ä»¶å                     | æ•°æ®                 | è¯´æ˜         |
| -------------------------- | -------------------- | ------------ |
| `join_book_creation_room`  | `{ taskId: number }` | åŠ å…¥ä»»åŠ¡æˆ¿é—´ |
| `leave_book_creation_room` | `{ taskId: number }` | ç¦»å¼€ä»»åŠ¡æˆ¿é—´ |

#### æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯

| äº‹ä»¶å                   | æ•°æ®   | è¯´æ˜         |
| ------------------------ | ------ | ------------ |
| `book_creation_progress` | è§ä¸‹æ–‡ | ä»»åŠ¡è¿›åº¦æ›´æ–° |

### è¿›åº¦æ›´æ–°æ•°æ®æ ¼å¼

```typescript
{
  "taskId": number,
  "timestamp": string,
  "event": "task_created" | "stage_started" | "stage_progress" | "stage_completed" | "task_completed" | "task_failed" | "error",
  "stage": string | null,
  "data": {
    // eventä¸ºstage_progressæ—¶
    "current": number,
    "total": number,
    "percentage": number,
    "message": string,

    // eventä¸ºstage_completedæ—¶
    "result": object,

    // eventä¸ºerroræ—¶
    "error": string
  }
}
```

### äº‹ä»¶ç¤ºä¾‹

**é˜¶æ®µå¼€å§‹**:

```json
{
  "taskId": 1,
  "timestamp": "2025-11-03T10:05:00Z",
  "event": "stage_started",
  "stage": "stage_4_content",
  "data": {
    "message": "å¼€å§‹ç”Ÿæˆç« èŠ‚æ­£æ–‡"
  }
}
```

**é˜¶æ®µè¿›åº¦**:

```json
{
  "taskId": 1,
  "timestamp": "2025-11-03T10:10:00Z",
  "event": "stage_progress",
  "stage": "stage_4_content",
  "data": {
    "current": 5,
    "total": 10,
    "percentage": 50,
    "message": "æ­£åœ¨ç”Ÿæˆç¬¬5ç« ..."
  }
}
```

**é˜¶æ®µå®Œæˆ**:

```json
{
  "taskId": 1,
  "timestamp": "2025-11-03T10:20:00Z",
  "event": "stage_completed",
  "stage": "stage_4_content",
  "data": {
    "message": "ç« èŠ‚æ­£æ–‡ç”Ÿæˆå®Œæˆ",
    "result": {
      "totalGenerated": 10,
      "charactersConsumed": 25000
    }
  }
}
```

---

## ğŸ“Š çŠ¶æ€å’Œæšä¸¾

### ä»»åŠ¡çŠ¶æ€ï¼ˆTaskStatusï¼‰

| å€¼                   | è¯´æ˜           |
| -------------------- | -------------- |
| `idea_generating`    | æƒ³æ³•ç”Ÿæˆä¸­     |
| `title_generating`   | ä¹¦åç®€ä»‹ç”Ÿæˆä¸­ |
| `outline_generating` | å¤§çº²ç”Ÿæˆä¸­     |
| `content_generating` | æ­£æ–‡ç”Ÿæˆä¸­     |
| `review_optimizing`  | å®¡ç¨¿ä¼˜åŒ–ä¸­     |
| `completed`          | å·²å®Œæˆ         |
| `failed`             | å¤±è´¥           |
| `cancelled`          | å·²å–æ¶ˆ         |
| `paused`             | å·²æš‚åœ         |

### é˜¶æ®µç±»å‹ï¼ˆStageTypeï¼‰

| å€¼                | è¯´æ˜             |
| ----------------- | ---------------- |
| `stage_1_idea`    | I-â‘  æƒ³æ³•æ‰©å±•     |
| `stage_2_title`   | I-â‘¡ ä¹¦åç®€ä»‹ç”Ÿæˆ |
| `stage_3_outline` | I-â‘¢ å¤§çº²ç”Ÿæˆ     |
| `stage_4_content` | I-â‘£ æ­£æ–‡ç”Ÿæˆ     |
| `stage_5_review`  | I-â‘¤ æ­£æ–‡ä¼˜åŒ–     |

### é˜¶æ®µçŠ¶æ€ï¼ˆStageStatusï¼‰

| å€¼           | è¯´æ˜   |
| ------------ | ------ |
| `pending`    | å¾…æ‰§è¡Œ |
| `processing` | æ‰§è¡Œä¸­ |
| `completed`  | å·²å®Œæˆ |
| `failed`     | å¤±è´¥   |
| `skipped`    | å·²è·³è¿‡ |

---

## âš ï¸ é”™è¯¯ç 

### é€šç”¨é”™è¯¯

| çŠ¶æ€ç  | é”™è¯¯ç                 | è¯´æ˜                |
| ------ | --------------------- | ------------------- |
| 401    | UNAUTHORIZED          | æœªç™»å½•æˆ– Token æ— æ•ˆ |
| 403    | FORBIDDEN             | æ— æƒè®¿é—®            |
| 404    | NOT_FOUND             | èµ„æºä¸å­˜åœ¨          |
| 500    | INTERNAL_SERVER_ERROR | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯      |

### ä¸šåŠ¡é”™è¯¯

| çŠ¶æ€ç  | é”™è¯¯ç                | è¯´æ˜             |
| ------ | -------------------- | ---------------- |
| 400    | MAX_TASKS_REACHED    | å·²è¾¾åˆ°æœ€å¤§ä»»åŠ¡æ•° |
| 400    | INSUFFICIENT_BALANCE | å­—æ•°åŒ…ä½™é¢ä¸è¶³   |
| 400    | INVALID_STAGE        | é˜¶æ®µç±»å‹æ— æ•ˆ     |
| 400    | STAGE_NOT_READY      | å‰ç½®é˜¶æ®µæœªå®Œæˆ   |
| 500    | AI_GENERATION_FAILED | AI ç”Ÿæˆå¤±è´¥      |
| 404    | TASK_NOT_FOUND       | ä»»åŠ¡ä¸å­˜åœ¨       |
| 404    | CHAPTER_NOT_FOUND    | ç« èŠ‚ä¸å­˜åœ¨       |

---

## ğŸ“ ä½¿ç”¨æµç¨‹ç¤ºä¾‹

### å®Œæ•´æµç¨‹ï¼ˆJavaScriptï¼‰

```javascript
// 1. åˆ›å»ºä»»åŠ¡
const createResponse = await fetch("/api/v1/book-creation/tasks", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${token}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    initialIdea: "ä¸€ä¸ªå…³äºæ—¶é—´æ—…è¡Œè€…çš„ç§‘å¹»æ•…äº‹",
    autoExecute: true,
  }),
});
const task = await createResponse.json();

// 2. å»ºç«‹WebSocketè¿æ¥
const socket = io("http://localhost:3000", {
  auth: { token },
});
socket.emit("join_book_creation_room", { taskId: task.id });

socket.on("book_creation_progress", (data) => {
  if (data.event === "stage_completed") {
    console.log(`${data.stage} å®Œæˆï¼`);
  }
});

// 3. æ‰§è¡Œé˜¶æ®µ2
await fetch(`/api/v1/book-creation/tasks/${task.id}/execute-stage`, {
  method: "POST",
  headers: {
    Authorization: `Bearer ${token}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    stageType: "stage_2_title",
  }),
});

// 4. è·å–ä»»åŠ¡è¯¦æƒ…
const detailResponse = await fetch(`/api/v1/book-creation/tasks/${task.id}`, {
  headers: {
    Authorization: `Bearer ${token}`,
  },
});
const taskDetail = await detailResponse.json();
console.log("ä¹¦å:", taskDetail.processedData.selectedTitle);

// 5. ç»§ç»­æ‰§è¡Œå…¶ä»–é˜¶æ®µ...
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [åŠŸèƒ½å®ç°æ–‡æ¡£](../backend/src/book-creation/README.md)
- [å®æ–½è®¡åˆ’](../backend/src/book-creation/IMPLEMENTATION_PLAN.md)
- [æç¤ºè¯è®¾è®¡](../backend/src/book-creation/PROMPTS.md)
- [æ€»ä½“è§„åˆ’](../backend/src/book-creation/PLANNING.md)

---

**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-11-03  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
