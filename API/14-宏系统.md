# 14. 宏系统（参数替换）

## 概述

宏系统提供了 SillyTavern 风格的参数替换功能，用于在角色卡、世界书、提示词等内容中动态替换占位符。

## 模块信息

- **模块路径**: `backend/src/macros/`
- **主服务**: `MacroReplacerService`
- **模块化设计**: 按宏类型分离到独立服务文件

## 系统架构

### 模块结构

```
macros/
├── enums/                    # 枚举定义
│   └── macro-type.enum.ts   # 宏类型和替换阶段
├── interfaces/               # 接口定义
│   └── macro-context.interface.ts  # 宏上下文和处理器接口
├── services/                 # 服务实现
│   ├── character-macro.service.ts      # 角色相关宏
│   ├── time-macro.service.ts           # 时间相关宏
│   ├── conversation-macro.service.ts   # 对话相关宏
│   ├── random-macro.service.ts         # 随机与计算宏
│   ├── text-macro.service.ts           # 文本处理宏
│   ├── variable-macro.service.ts       # 变量宏
│   └── macro-replacer.service.ts       # 主替换服务
└── macros.module.ts          # 模块定义
```

### 宏处理器

每种类型的宏由独立的服务处理：

| 服务 | 负责的宏类型 | 文件 |
|------|------------|------|
| CharacterMacroService | 角色相关宏 | `character-macro.service.ts` |
| TimeMacroService | 时间相关宏 | `time-macro.service.ts` |
| ConversationMacroService | 对话相关宏 | `conversation-macro.service.ts` |
| RandomMacroService | 随机与计算宏 | `random-macro.service.ts` |
| TextMacroService | 文本处理宏 | `text-macro.service.ts` |
| VariableMacroService | 变量宏 | `variable-macro.service.ts` |
| MacroReplacerService | 主协调服务 | `macro-replacer.service.ts` |

## 支持的宏

### 1. 角色相关宏

| 宏 | 说明 | 示例 | 数据来源 |
|---|------|------|---------|
| `{{char}}` | 角色名 | 艾莉娅 | CharacterCard.name |
| `{{user}}` | 用户显示名称 | 小明 | **User.nickname** |
| `{{charIfNotGroup}}` | 单聊时角色名，群聊时为空 | 艾莉娅 / (空) | - |
| `{{charPrompt}}` | 角色卡完整提示词 | 完整描述 | CharacterCard 内容 |

**重要**: `{{user}}` 宏来自用户资料的 `nickname` 字段（昵称），而不是 `username`（用户名）。

### 2. 时间相关宏

| 宏 | 说明 | 格式示例 |
|---|------|---------|
| `{{time}}` | 当前时间 | 14:35 |
| `{{date}}` | 当前日期 | 2025年10月23日 |
| `{{weekday}}` | 星期几 | 星期三 |
| `{{isotime}}` | ISO格式时间 | 2025-10-23T14:35:00Z |

### 3. 对话相关宏

| 宏 | 说明 |
|---|------|
| `{{lastMessage}}` | 最后一条消息内容 |
| `{{lastMessageId}}` | 最后一条消息ID |
| `{{lastCharMessage}}` | 角色最后一条消息 |
| `{{lastUserMessage}}` | 用户最后一条消息 |
| `{{currentSwipeId}}` | 当前swipe索引 |

### 4. 随机与计算宏

| 宏 | 说明 | 示例 |
|---|------|------|
| `{{roll:公式}}` | 骰子掷骰 | `{{roll:1d20}}` → 15<br>`{{roll:2d6+3}}` → 10 |
| `{{random::选项1::选项2}}` | 随机选择 | `{{random::晴::雨}}` → 雨 |
| `{{pick::变量名}}` | 从列表随机选 | 配合变量使用 |

**骰子公式支持**:
- 格式: `NdM+X` 或 `NdM-X`
- N: 骰子数量（1-100）
- M: 骰子面数（2-1000）
- X: 修正值（可选）

### 5. 文本处理宏

| 宏 | 说明 | 示例 |
|---|------|------|
| `{{trim}}` | 去除整个文本前后空格 | - |
| `{{trim::文本}}` | 去除指定文本空格 | `{{trim::  hello  }}` → hello |
| `{{宏::uppercase}}` | 转大写 | `{{char::uppercase}}` → AILIYA |
| `{{宏::lowercase}}` | 转小写 | `{{char::lowercase}}` → ailiya |
| `{{宏::length}}` | 获取长度 | `{{char::length}}` → 3 |

### 6. 变量宏

| 宏 | 说明 | 示例 |
|---|------|------|
| `{{getvar::变量名}}` | 获取变量值 | `{{getvar::score}}` → 100 |
| `{{setvar::变量名::值}}` | 设置变量 | `{{setvar::score::100}}` |

## 宏替换顺序

宏按以下顺序执行替换（在 `MacroReplacerService.replaceAll` 中定义）：

1. **静态宏**（角色、用户名）- 基础信息
2. **变量宏**（setvar/getvar）- 变量存储
3. **对话引用宏** - 上下文信息
4. **时间宏** - 动态时间
5. **随机/计算宏** - 随机生成
6. **文本处理宏** - 最终格式化

## 宏替换阶段

系统支持三个替换阶段，适用于不同场景：

| 阶段 | 枚举值 | 说明 | 替换的宏 |
|------|-------|------|---------|
| **加载时** | `LOAD` | 角色卡加载时 | 静态宏（{{char}}, {{user}}） |
| **构建时** | `BUILD` | 构建提示词时 | 静态宏 + 变量 + 对话引用 |
| **发送前** | `BEFORE_SEND` | 发送到API前 | 所有宏（包括时间、随机） |

## 使用示例

### 基本用法

```typescript
import { MacroReplacerService, MacroContext } from './macros';

constructor(
  private readonly macroReplacer: MacroReplacerService,
) {}

// 创建上下文
const context: MacroContext = {
  userId: 1,
  userName: '小明',              // 来自 User.nickname
  characterName: '艾莉娅',
  characterPrompt: '艾莉娅是一位精灵法师...',
};

// 替换宏
const text = '{{char}}对{{user}}说："现在是{{time}}"';
const result = await this.macroReplacer.replace(text, context);
// 结果: "艾莉娅对小明说："现在是14:35""
```

### 分阶段替换

```typescript
import { MacroReplacementStage } from './macros';

// 加载时：只替换静态宏
const result = await this.macroReplacer.replace(
  text,
  context,
  MacroReplacementStage.LOAD,
);
```

### 批量替换

```typescript
const texts = [
  '{{char}}的描述',
  '{{user}}的人设',
  '场景：{{char}}和{{user}}在{{time}}见面',
];

const results = await this.macroReplacer.replaceMultiple(texts, context);
```

## 在其他模块中集成

### 角色卡模块

```typescript
// character-cards.service.ts
import { MacroReplacerService, MacroContext } from '../macros';

constructor(
  private readonly macroReplacer: MacroReplacerService,
) {}

async exportCharacterCard(cardId: number, userId: number) {
  const card = await this.findOne(cardId);
  const user = await this.usersService.findOne(userId);
  
  const context: MacroContext = {
    userId,
    userName: user.nickname,  // 重要：使用 nickname
    characterName: card.name,
  };
  
  // 替换描述中的宏
  card.description = await this.macroReplacer.replace(
    card.description,
    context,
  );
  
  return card;
}
```

### 提示词模块

```typescript
// prompts.service.ts
async buildPromptContent(prompt: Prompt, context: MacroContext) {
  const contents = await this.macroReplacer.replaceMultiple(
    prompt.contents.map(c => c.content),
    context,
  );
  
  return contents.join('\n');
}
```

### 世界书模块

```typescript
// world-books.service.ts
async processWorldBookEntry(entry: WorldBookEntry, context: MacroContext) {
  entry.content = await this.macroReplacer.replace(
    entry.content,
    context,
  );
  
  return entry;
}
```

## 宏上下文接口

```typescript
interface MacroContext {
  /** 当前用户ID */
  userId?: number;
  
  /** 用户显示名称（来自 User.nickname） */
  userName?: string;
  
  /** 角色名称 */
  characterName?: string;
  
  /** 角色卡完整提示词 */
  characterPrompt?: string;
  
  /** 是否群聊模式 */
  isGroupChat?: boolean;
  
  /** 最后一条消息内容 */
  lastMessage?: string;
  
  /** 最后一条消息ID */
  lastMessageId?: string;
  
  /** 角色最后一条消息 */
  lastCharMessage?: string;
  
  /** 用户最后一条消息 */
  lastUserMessage?: string;
  
  /** 当前swipe索引 */
  currentSwipeId?: number;
  
  /** 变量存储 */
  variables?: Record<string, any>;
  
  /** 额外的上下文数据 */
  [key: string]: any;
}
```

## 嵌套宏支持

系统支持嵌套宏，但建议不超过2-3层：

```typescript
// 有效的嵌套
{{random::{{char}}很开心::{{char}}很伤心}}

// 处理过程：
// 1. 先替换 {{char}} → 艾莉娅很开心 和 艾莉娅很伤心
// 2. 再执行 {{random}} → 随机选择一个
```

## 性能优化建议

1. **按需替换**: 使用 `MacroReplacementStage` 只执行需要的宏
2. **批量处理**: 使用 `replaceMultiple` 批量处理多个文本
3. **缓存上下文**: 同一个会话中重用 `MacroContext`
4. **检查宏存在**: 使用 `containsMacros()` 先检查是否包含宏

## 扩展自定义宏

如需添加新的宏类型：

1. 创建新服务实现 `MacroProcessor` 接口
2. 在 `MacrosModule` 中注册
3. 在 `MacroReplacerService.replaceAll` 中添加调用

示例：

```typescript
// custom-macro.service.ts
import { Injectable } from '@nestjs/common';
import { MacroProcessor, MacroContext } from '../interfaces';

@Injectable()
export class CustomMacroService implements MacroProcessor {
  process(text: string, context: MacroContext): string {
    return text.replace(/\{\{custom\}\}/gi, 'custom value');
  }
  
  getSupportedMacros(): string[] {
    return ['custom'];
  }
}
```

## 测试建议

每个宏处理服务都应该有单元测试：

```typescript
describe('CharacterMacroService', () => {
  let service: CharacterMacroService;
  
  beforeEach(() => {
    service = new CharacterMacroService();
  });
  
  it('should replace {{char}} macro', () => {
    const text = '{{char}}是一位法师';
    const context: MacroContext = {
      characterName: '艾莉娅',
    };
    
    const result = service.process(text, context);
    expect(result).toBe('艾莉娅是一位法师');
  });
  
  it('should replace {{user}} macro with user nickname', () => {
    const text = '你好，{{user}}';
    const context: MacroContext = {
      userName: '小明',  // 来自 User.nickname
    };
    
    const result = service.process(text, context);
    expect(result).toBe('你好，小明');
  });
});
```

## 注意事项

1. **{{user}} 数据来源**: 必须使用 `User.nickname`，而不是 `User.username`
2. **替换顺序重要**: 必须按照定义的顺序执行，避免相互干扰
3. **嵌套宏限制**: 建议最多2-3层嵌套，避免性能问题
4. **变量作用域**: 变量仅在当前 `MacroContext` 有效，不跨会话
5. **线程安全**: 每次替换使用独立的 context，避免并发问题
6. **错误处理**: 宏格式错误时保留原始文本，不抛出异常

## 相关文档

- 模块 README: `backend/src/macros/README.md`
- 完整宏文档: `docs/参数替换系统完整文档.md`
- 角色卡文档: `API/13-角色卡管理.md`
- 世界书文档: 待添加
