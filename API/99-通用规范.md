# API 通用规范

## 统一响应格式

所有 API 接口都遵循统一的响应格式规范。

### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {
    // 实际返回的数据
  },
  "timestamp": 1234567890
}
```

**字段说明**：

| 字段      | 类型    | 说明                    |
| --------- | ------- | ----------------------- |
| success   | boolean | 是否成功，true 表示成功 |
| code      | number  | HTTP 状态码             |
| message   | string  | 操作结果描述            |
| data      | any     | 实际返回的数据          |
| timestamp | number  | 响应时间戳（毫秒）      |

### 错误响应

```json
{
  "success": false,
  "code": 400,
  "message": "错误描述",
  "data": {
    "error": "错误类型",
    "details": ["详细错误信息1", "详细错误信息2"],
    "path": "/api/v1/users",
    "method": "POST"
  },
  "timestamp": 1234567890
}
```

**字段说明**：

| 字段         | 类型    | 说明                     |
| ------------ | ------- | ------------------------ |
| success      | boolean | 固定为 false             |
| code         | number  | HTTP 错误状态码          |
| message      | string  | 错误描述                 |
| data.error   | string  | 错误类型名称             |
| data.details | array   | 详细错误信息数组（可选） |
| data.path    | string  | 请求路径                 |
| data.method  | string  | 请求方法                 |

---

## HTTP 状态码

### 2xx 成功

| 状态码 | 说明    | 使用场景                       |
| ------ | ------- | ------------------------------ |
| 200    | OK      | 请求成功（GET、PATCH、DELETE） |
| 201    | Created | 创建成功（POST）               |

### 4xx 客户端错误

| 状态码 | 说明         | 使用场景                 |
| ------ | ------------ | ------------------------ |
| 400    | Bad Request  | 请求参数错误             |
| 401    | Unauthorized | 未认证或 Token 无效      |
| 403    | Forbidden    | 无权限访问               |
| 404    | Not Found    | 资源不存在               |
| 409    | Conflict     | 资源冲突（如邮箱已存在） |

### 5xx 服务器错误

| 状态码 | 说明                  | 使用场景       |
| ------ | --------------------- | -------------- |
| 500    | Internal Server Error | 服务器内部错误 |

---

## 业务错误码

除了 HTTP 状态码，还使用业务错误码标识具体错误：

| 错误类型                     | HTTP 状态码 | 说明         |
| ---------------------------- | ----------- | ------------ |
| BadRequestException          | 400         | 请求参数错误 |
| UnauthorizedException        | 401         | 未认证       |
| ForbiddenException           | 403         | 无权限       |
| NotFoundException            | 404         | 资源不存在   |
| ConflictException            | 409         | 资源冲突     |
| InternalServerErrorException | 500         | 服务器错误   |

---

## 分页响应格式

分页接口统一使用以下响应格式：

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {
    "data": [
      // 数据列表
    ],
    "total": 100,
    "page": 1,
    "pageSize": 10,
    "totalPages": 10
  },
  "timestamp": 1234567890
}
```

**分页字段说明**：

| 字段       | 类型   | 说明           |
| ---------- | ------ | -------------- |
| data       | array  | 当前页数据列表 |
| total      | number | 总记录数       |
| page       | number | 当前页码       |
| pageSize   | number | 每页数量       |
| totalPages | number | 总页数         |

**分页参数**：

| 参数名   | 类型   | 必填 | 默认值 | 说明                 |
| -------- | ------ | ---- | ------ | -------------------- |
| page     | number | ❌   | 1      | 页码（从 1 开始）    |
| pageSize | number | ❌   | 10     | 每页数量（最大 100） |

---

## 认证方式

### Bearer Token

所有需要认证的接口都使用 Bearer Token 方式：

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 全局认证机制

**系统已启用全局 JWT 认证 Guard，默认所有接口都需要携带有效的 Token 才能访问。**

#### 公开接口（无需认证）

以下接口使用 `@Public()` 装饰器标记，无需携带 Token：

1. **注册**: `POST /api/v1/auth/register`
2. **登录**: `POST /api/v1/auth/login`  
3. **管理员登录**: `POST /api/v1/auth/admin/login`
4. **刷新Token**: `POST /api/v1/auth/refresh`
5. **健康检查**: `GET /`
6. **分类列表**: `GET /api/v1/prompt-categories`
7. **分类详情**: `GET /api/v1/prompt-categories/:id`
8. **提示词统计**: `GET /api/v1/prompts/:id/stats`

#### 可选认证接口

以下接口使用 `@OptionalAuth()` 装饰器，支持登录和未登录两种状态：

1. **提示词列表**: `GET /api/v1/prompts` - 未登录可查看公开提示词，登录后可查看自己的私有提示词
2. **提示词详情**: `GET /api/v1/prompts/:id` - 未登录可查看公开内容，登录后可查看自己的草稿

**可选认证逻辑**：
- 有 Token：验证 Token 并注入用户信息
- 无 Token：允许访问，用户信息为 null

#### 必须认证接口

除上述公开和可选认证接口外，**所有其他接口都必须携带有效 Token**，包括但不限于：

- 用户管理相关接口
- 作品管理相关接口
- 提示词创建/编辑/删除
- 点赞、收藏、申请等操作

### Token 获取

通过以下接口获取 Token：

1. **注册**: `POST /api/v1/auth/register`
2. **登录**: `POST /api/v1/auth/login`
3. **刷新**: `POST /api/v1/auth/refresh`

### Token 类型

| Token 类型   | 有效期  | 用途             |
| ------------ | ------- | ---------------- |
| accessToken  | 10 小时 | 访问 API         |
| refreshToken | 7 天    | 刷新 accessToken |

### Token 刷新流程

1. accessToken 过期后收到 401 响应
2. 使用 refreshToken 调用刷新接口
3. 获取新的 accessToken
4. 使用新 Token 重新请求

### 权限验证

在认证之后，系统还会通过全局 PermissionsGuard 进行权限验证：

- 使用 `@RequirePermissions()` 装饰器的接口会检查用户权限
- 管理员操作（如创建分类、用户管理）需要特定权限
- 资源操作会验证用户是否为资源所有者或拥有相应权限

---

## 请求头规范

### 必需请求头

| 请求头        | 值               | 说明                       |
| ------------- | ---------------- | -------------------------- |
| Content-Type  | application/json | 请求体格式                 |
| Authorization | Bearer {token}   | 认证令牌（需要认证的接口） |

### 可选请求头

| 请求头          | 值           | 说明     |
| --------------- | ------------ | -------- |
| Accept-Language | zh-CN, en-US | 语言偏好 |

---

## 数据验证

### 通用验证规则

1. **邮箱格式**

   - 必须符合邮箱格式
   - 示例：`user@example.com`

2. **密码规则**

   - 长度：6-50 字符
   - 必须包含字母和数字
   - 示例：`Password123`

3. **字符串长度**

   - username: 最多 50 字符
   - nickname: 最多 100 字符
   - avatar: 最多 500 字符
   - bio: 最多 500 字符

4. **数字范围**
   - page: 最小 1
   - pageSize: 1-100
   - level: 1-100

### 验证错误响应

```json
{
  "success": false,
  "code": 400,
  "message": "Validation failed",
  "data": {
    "error": "Bad Request",
    "details": [
      "email must be an email",
      "password must be longer than or equal to 6 characters"
    ],
    "path": "/api/v1/auth/register",
    "method": "POST"
  },
  "timestamp": 1234567890
}
```

---

## 日期时间格式

所有日期时间字段统一使用 ISO 8601 格式：

```
2024-01-01T12:00:00.000Z
```

时区：UTC+0（服务器时间）

---

## 排序规范

支持排序的接口使用以下参数：

| 参数名 | 类型   | 说明     | 示例            |
| ------ | ------ | -------- | --------------- |
| sortBy | string | 排序字段 | `createdAt`     |
| order  | string | 排序方向 | `ASC` 或 `DESC` |

示例：

```http
GET /api/v1/users?sortBy=createdAt&order=DESC
```

---

## 搜索规范

支持搜索的接口使用以下参数：

| 参数名 | 类型   | 说明       |
| ------ | ------ | ---------- |
| search | string | 搜索关键词 |

搜索行为：

- 支持模糊搜索
- 搜索多个字段（如用户名、邮箱、昵称）
- 不区分大小写

---

## 筛选规范

支持筛选的接口使用具体字段名作为参数：

```http
GET /api/v1/users?status=active&roleCode=admin
```

筛选支持：

- 精确匹配
- 枚举值筛选
- 关联数据筛选

---

## 错误处理最佳实践

### 1. 参数验证错误 (400)

```json
{
  "success": false,
  "code": 400,
  "message": "Validation failed",
  "data": {
    "error": "Bad Request",
    "details": ["email must be an email"]
  }
}
```

### 2. 认证失败 (401)

```json
{
  "success": false,
  "code": 401,
  "message": "Unauthorized",
  "data": {
    "error": "UnauthorizedException",
    "details": null
  }
}
```

### 3. 权限不足 (403)

```json
{
  "success": false,
  "code": 403,
  "message": "权限不足",
  "data": {
    "error": "ForbiddenException",
    "details": null
  }
}
```

### 4. 资源不存在 (404)

```json
{
  "success": false,
  "code": 404,
  "message": "用户不存在",
  "data": {
    "error": "NotFoundException",
    "details": null
  }
}
```

### 5. 资源冲突 (409)

```json
{
  "success": false,
  "code": 409,
  "message": "邮箱已被注册",
  "data": {
    "error": "ConflictException",
    "details": null
  }
}
```

---

## 请求限流

### 限流规则

| 接口类型 | 限制   | 时间窗口 |
| -------- | ------ | -------- |
| 登录     | 5 次   | 1 分钟   |
| 注册     | 3 次   | 1 分钟   |
| API 查询 | 100 次 | 1 分钟   |
| API 写入 | 30 次  | 1 分钟   |

### 限流响应

```json
{
  "success": false,
  "code": 429,
  "message": "请求过于频繁，请稍后再试",
  "data": {
    "error": "TooManyRequestsException",
    "retryAfter": 60
  }
}
```

---

## 跨域 (CORS)

服务器已配置 CORS 支持：

- 允许的源：配置在 `.env` 的 `CORS_ORIGIN`
- 允许的方法：GET, POST, PATCH, PUT, DELETE
- 允许的头：Content-Type, Authorization

---

## API 版本控制

当前使用路径版本控制：

```
/api/v1/users
/api/v2/users
```

版本策略：

- v1: 当前稳定版本
- v2: 新功能开发版本
- 不同版本可以共存
- 废弃版本会提前 3 个月通知

---

## 开发与测试

### Swagger UI

访问地址：`http://localhost:3000/api/docs`

功能：

- 查看所有接口文档
- 在线测试接口
- 自动携带 Token

### Postman

提供 Postman Collection（可选）

### cURL 示例

```bash
# 注册
curl -X POST http://localhost:3000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123456"}'

# 登录
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123456"}'

# 获取用户列表
curl -X GET http://localhost:3000/api/v1/users \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

---

## 最佳实践

### 客户端实现建议

1. **Token 管理**

   - 存储在安全的地方（如 localStorage、sessionStorage）
   - 实现自动刷新机制
   - 监听 401 响应自动刷新

2. **错误处理**

   - 统一错误提示
   - 区分业务错误和系统错误
   - 记录错误日志

3. **请求重试**

   - 网络错误自动重试
   - 401 错误刷新 Token 后重试
   - 其他错误提示用户

4. **性能优化**
   - 使用分页加载
   - 实现请求缓存
   - 避免重复请求

### 安全建议

1. **Token 安全**

   - 不要在 URL 中传递 Token
   - HTTPS 传输
   - 定期刷新 Token

2. **数据验证**

   - 前端验证
   - 后端再次验证
   - 防止 SQL 注入、XSS

3. **敏感信息**
   - 不在响应中返回密码
   - 不在日志中记录密码
   - 使用 HTTPS 加密传输

---

## 联系与支持

- **API 文档**: `http://localhost:3000/api/docs`
- **项目文档**: `backend/docs/`
- **开发计划**: `backend/docs/plans/DEVELOPMENT_PLAN.md`
