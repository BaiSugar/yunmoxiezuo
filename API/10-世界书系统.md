# 世界书系统 API 文档

> 基于 SillyTavern 的世界书扫描引擎

## 概述

世界书（World Book）是角色扮演系统的核心组件，用于动态管理和激活背景知识条目。

**核心特性**：
- ✅ 关键词匹配（支持正则表达式）
- ✅ 选择性逻辑（AND_ANY、AND_ALL、NOT_ANY、NOT_ALL）
- ✅ 时效性管理（Sticky、Cooldown、Delay）
- ✅ 位置控制（before、after、atDepth）
- ✅ 优先级排序

**注意**：世界书条目存储在 `prompts.roleplay_config` JSON 字段中，不是独立的数据库表。

---

## 数据结构

### WorldBookEntry（世界书条目）

```typescript
{
  // ============ 基础信息 ============
  "uid": "entry-001",              // 条目唯一标识
  "name": "魔法体系",               // 条目名称
  "content": "这个世界的魔法...",   // 条目内容文本

  // ============ 激活控制 ============
  "keywords": ["魔法", "咒语"],    // 主关键词列表（必须匹配）
  "secondaryKeywords": ["元素"],   // 次要关键词列表（可选）
  "selectiveLogic": "AND_ANY",     // 选择性逻辑

  // ============ 位置控制 ============
  "position": "before",            // 插入位置（8种：见下表）
  "depth": 0,                      // 深度（position=atDepth时使用）
  "outletName": "custom",          // 自定义插槽名（position=outlet时使用）
  "order": 100,                    // 排序权重（越小越靠前）

  // ============ 特殊标记 ============
  "constant": false,               // 常驻（总是激活）
  "disable": false,                // 禁用此条目

  // ============ 时效性 ============
  "sticky": 3,                     // 粘性：激活后保持N条消息
  "cooldown": 5,                   // 冷却：激活后N条消息内不再激活
  "delay": 10,                     // 延迟：前N条消息不激活

  // ============ 高级选项 ============
  "probability": 100,              // 激活概率（0-100）
  "useProbability": false,         // 启用概率检查
  "scanDepth": 4,                  // 扫描深度（覆盖全局设置）
  "caseSensitive": false,          // 大小写敏感
  "matchWholeWords": false,        // 全词匹配
  "excludeRecursion": false,       // 排除递归
  "preventRecursion": false        // 阻止递归
}
```

### WorldBookPosition（插入位置类型）

| 位置值 | 说明 | 使用场景 | 备注 |
|--------|------|----------|------|
| `before` | 角色定义之前 | 早期注入的背景信息 | - |
| `after` | 角色定义之后 | 补充角色的背景知识 | - |
| `ANTop` | Author's Note 之前 | 影响写作风格的信息 | AN = Author's Note |
| `ANBottom` | Author's Note 之后 | 与 AN 配合使用 | - |
| `atDepth` | 指定深度 | 精确控制在对话历史中的位置 | 需要设置 `depth` 字段 |
| `EMTop` | 示例消息之前 | 影响示例对话的上下文 | EM = Example Messages |
| `EMBottom` | 示例消息之后 | 示例对话后的补充 | - |
| `outlet` | 自定义插槽 | 自定义插入位置 | 需要设置 `outletName` 字段 |

### SelectiveLogic（选择性逻辑）

| 值 | 说明 | 示例 |
|----|------|------|
| `AND_ANY` | 主关键词 + 任一次要关键词 | 主："战斗" 次："剑","魔法" → "用剑战斗" ✅ |
| `AND_ALL` | 主关键词 + 全部次要关键词 | 主："Boss" 次："城堡","决战" → 必须都出现 |
| `NOT_ANY` | 主关键词 + 无次要关键词 | 主："魔法" 次："黑暗" → "学习魔法" ✅ "黑暗魔法" ❌ |
| `NOT_ALL` | 主关键词 + 非全部次要关键词 | 主："战斗" 次："剑","盾" → 不能同时出现剑和盾 |

### RoleplayConfig（角色扮演配置）

```typescript
{
  "characterCard": "你是一位年轻的魔法师...",  // 角色卡片（人物设定）
  "worldBookEntries": [                      // 世界书条目列表
    { /* WorldBookEntry */ }
  ],
  "scanDepth": 4,                            // 扫描深度（默认4）
  "enableRecursion": false,                  // 启用递归扫描
  "tokenBudgetPercent": 25,                  // Token预算百分比
  "tokenBudgetCap": 1500                     // Token预算上限
}
```

---

## 使用流程

### 1. 在提示词中配置世界书

```json
// PUT /api/v1/prompts/:id
{
  "name": "魔法世界RPG",
  "roleplayConfig": {
    "characterCard": "你是一位年轻的魔法师，刚刚进入魔法学院...",
    "worldBookEntries": [
      {
        "uid": "magic-system",
        "name": "魔法体系",
        "content": "这个世界的魔法分为四大元素：火、水、风、土...",
        "keywords": ["魔法", "咒语", "元素"],
        "position": "before",
        "order": 100
      },
      {
        "uid": "academy",
        "name": "魔法学院",
        "content": "魔法学院位于帝国首都，是最古老的魔法教育机构...",
        "keywords": ["学院", "学校"],
        "position": "before",
        "order": 200
      }
    ],
    "scanDepth": 4
  }
}
```

### 2. 扫描和激活（后端自动处理）

当用户发送消息时，后端会：

1. **构建扫描文本**：当前消息 + 最近N条历史消息
2. **遍历条目**：检查每个世界书条目
3. **关键词匹配**：根据主/次要关键词和选择性逻辑判断
4. **时效性检查**：检查粘性、冷却、延迟状态
5. **激活条目**：收集所有匹配的条目
6. **排序和输出**：按 order 排序，按 position 分组

### 3. 构建最终提示

```
[系统提示]

[世界书：before 位置的条目]

[角色卡片]

[世界书：after 位置的条目]

[历史消息]

[用户消息]
```

---

## 测试场景

### 场景 1：基础关键词匹配

**条目配置**：
```json
{
  "uid": "magic-system",
  "name": "魔法体系",
  "keywords": ["魔法", "咒语"],
  "content": "这个世界的魔法...",
  "position": "before",
  "order": 100
}
```

**测试**：
- 消息："我想学习魔法" → ✅ 激活（包含"魔法"）
- 消息："我想学习剑术" → ❌ 不激活

### 场景 2：选择性逻辑 AND_ANY

**条目配置**：
```json
{
  "uid": "battle-skills",
  "keywords": ["战斗", "攻击"],
  "secondaryKeywords": ["剑", "魔法"],
  "selectiveLogic": "AND_ANY",
  "content": "战斗技巧...",
  "position": "before",
  "order": 100
}
```

**测试**：
- "开始战斗" → ❌ 不激活（有主，无次要）
- "用剑进行战斗" → ✅ 激活（主+次要任一）
- "用魔法进行攻击" → ✅ 激活（主+次要任一）

### 场景 3：粘性（Sticky）

**条目配置**：
```json
{
  "uid": "current-location",
  "keywords": ["森林"],
  "sticky": 3,
  "content": "你正在一片古老的森林中...",
  "position": "before",
  "order": 100
}
```

**测试**：
- 消息1："我走进森林" → ✅ 激活，sticky=3
- 消息2："天气真好" → ✅ 仍然激活（sticky=2，无需匹配关键词）
- 消息3："我看到了小鹿" → ✅ 仍然激活（sticky=1）
- 消息4："继续前进" → ❌ 不再激活（sticky=0）

### 场景 4：冷却（Cooldown）

**条目配置**：
```json
{
  "uid": "special-event",
  "keywords": ["宝箱"],
  "cooldown": 5,
  "content": "你发现了一个神秘的宝箱...",
  "position": "before",
  "order": 100
}
```

**测试**：
- 消息1："我发现了一个宝箱" → ✅ 激活，cooldown=5
- 消息2："又看到一个宝箱" → ❌ 不激活（cooldown=4）
- 消息3-5："宝箱" → ❌ 不激活（cooldown递减）
- 消息6："这次宝箱更大" → ✅ 再次激活（cooldown=0）

### 场景 5：延迟（Delay）

**条目配置**：
```json
{
  "uid": "plot-twist",
  "keywords": ["真相"],
  "delay": 10,
  "content": "关于这个世界的真相是...",
  "position": "before",
  "order": 100
}
```

**测试**：
- 消息5："我想知道真相" → ❌ 不激活（还没到10条）
- 消息15："告诉我真相" → ✅ 激活（已超过10条）

### 场景 6：常驻条目

**条目配置**：
```json
{
  "uid": "world-rules",
  "constant": true,
  "content": "这个世界遵循以下基本规则...",
  "position": "before",
  "order": 10
}
```

**测试**：
- 任何消息 → ✅ 总是激活（不检查关键词）

---

## 正则表达式支持

**关键词格式**：`/pattern/`

**示例**：
```json
{
  "keywords": [
    "/魔法|咒语/",           // 匹配"魔法"或"咒语"
    "/攻击\\d+次/",          // 匹配"攻击3次"、"攻击10次"等
    "/^战斗$/",              // 精确匹配"战斗"
    "/Boss|魔王|最终头目/"   // 匹配多个词
  ]
}
```

**注意**：
- 正则表达式默认不区分大小写（除非设置 `caseSensitive: true`）
- 无效的正则表达式会被忽略（不会导致错误）

---

## 全词匹配

**作用**：防止部分匹配

**示例**：
```json
{
  "keywords": ["魔法"],
  "matchWholeWords": true
}
```

**测试**：
- "学习魔法" → ✅ 匹配（独立词）
- "魔法师" → ❌ 不匹配（部分词）
- "这是魔法吗" → ✅ 匹配（独立词）

---

## 数据库表结构

### world_book_activations（激活状态表）

```sql
CREATE TABLE `world_book_activations` (
  `id` int NOT NULL AUTO_INCREMENT,
  `session_id` varchar(255) NOT NULL COMMENT '会话ID',
  `prompt_id` int NOT NULL COMMENT '提示词ID',
  `entry_uid` varchar(255) NOT NULL COMMENT '条目UID',
  `last_activated_at` datetime DEFAULT NULL COMMENT '最后激活时间',
  `last_activated_message_index` int DEFAULT NULL COMMENT '最后激活时的消息索引',
  `sticky_remaining` int DEFAULT 0 COMMENT '粘性剩余次数',
  `cooldown_remaining` int DEFAULT 0 COMMENT '冷却剩余次数',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `IDX_world_book_activations_unique` (`session_id`, `prompt_id`, `entry_uid`),
  KEY `IDX_world_book_activations_session` (`session_id`),
  KEY `IDX_world_book_activations_prompt` (`prompt_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='世界书激活状态';
```

---

## 与 SillyTavern 的对比

| 功能 | SillyTavern | 我们的实现 | 说明 |
|------|------------|-----------|------|
| 关键词匹配 | ✅ | ✅ | 完全一致 |
| 正则表达式 | ✅ | ✅ | 完全一致 |
| 选择性逻辑 | ✅ 4种 | ✅ 4种 | 完全一致 |
| Sticky | ✅ | ✅ | 完全一致 |
| Cooldown | ✅ | ✅ | 完全一致 |
| Delay | ✅ | ✅ | 完全一致 |
| 常驻条目 | ✅ | ✅ | 完全一致 |
| 全词匹配 | ✅ | ✅ | 完全一致 |
| 大小写敏感 | ✅ | ✅ | 完全一致 |
| 优先级排序 | ✅ | ✅ | 完全一致 |
| **8种位置** | ✅ | ✅ | **完全支持所有 8 种位置类型** |
| 递归扫描 | ✅ | ⚠️ 预留接口 | 简化版暂不实现 |
| 包含组 | ✅ | ❌ 暂不实现 | 复杂度较高 |
| 触发器 | ✅ | ❌ 暂不实现 | 未来扩展 |
| 角色过滤 | ✅ | ❌ 暂不实现 | 未来扩展 |

**实现覆盖率**：约 **85%**，足以支持大多数角色扮演场景。

---

## 最佳实践

### 1. 合理设置 order 值

```json
{
  "worldBookEntries": [
    { "name": "世界规则", "order": 10 },    // 最优先
    { "name": "魔法体系", "order": 100 },
    { "name": "当前位置", "order": 200 },
    { "name": "特殊事件", "order": 300 }    // 最后
  ]
}
```

### 2. 使用粘性保持上下文

对于"位置"、"状态"等需要保持的信息，使用 `sticky`：

```json
{
  "name": "当前战斗状态",
  "keywords": ["战斗", "开始"],
  "sticky": 5,  // 战斗开始后保持5轮
  "content": "你正在与敌人战斗..."
}
```

### 3. 使用冷却避免重复

对于"事件"、"发现"等不应频繁出现的内容，使用 `cooldown`：

```json
{
  "name": "发现宝箱",
  "keywords": ["宝箱"],
  "cooldown": 10,  // 10轮内只激活一次
  "content": "你发现了一个神秘的宝箱..."
}
```

### 4. 使用延迟控制剧情节奏

对于"剧情转折"、"隐藏设定"等，使用 `delay`：

```json
{
  "name": "世界真相",
  "keywords": ["真相", "秘密"],
  "delay": 20,  // 前20轮不出现
  "content": "关于这个世界的真正秘密是..."
}
```

### 5. 组合使用多种机制

```json
{
  "name": "Boss战",
  "keywords": ["Boss", "魔王"],
  "secondaryKeywords": ["城堡", "决战"],
  "selectiveLogic": "AND_ALL",  // 必须同时出现
  "sticky": 10,                 // 战斗持续10轮
  "delay": 15,                  // 前期不出现
  "order": 50,                  // 高优先级
  "content": "最终Boss战..."
}
```

---

## 常见问题

### Q1: 世界书和 WorldSettings 有什么区别？

**A**: 
- **WorldSettings**: 作品的**静态世界观设定**（如地图、历史、种族），不会动态激活
- **世界书**: **动态知识库**，根据对话内容自动激活相关条目

### Q2: 如何清理会话的激活状态？

**A**: 后端提供了服务方法：
```typescript
await this.timedEffectsService.clearSession(sessionId);
```

### Q3: 条目的 UID 如何生成？

**A**: 建议使用 `uuid` 或 `nanoid` 生成唯一标识：
```typescript
import { nanoid } from 'nanoid';

const entry = {
  uid: nanoid(),  // 生成唯一ID
  name: '...',
  // ...
};
```

### Q4: 如何测试世界书是否生效？

**A**: 
1. 在提示词中配置世界书条目
2. 发送包含关键词的消息
3. 查看 `world_book_activations` 表是否有记录
4. 检查 AI 响应是否包含世界书内容

### Q5: 性能优化建议？

**A**:
- 合理设置 `scanDepth`（默认4条消息）
- 避免过多的条目（建议 < 50）
- 使用索引优化数据库查询
- 考虑缓存激活状态

---

## 更新日志

### 2025-01-23
- ✅ 初始实现世界书系统
- ✅ 支持关键词匹配和选择性逻辑
- ✅ 支持时效性管理（Sticky、Cooldown、Delay）
- ✅ 支持位置控制（before、after、atDepth）
- ✅ 添加 `prompts.roleplay_config` 字段
- ✅ 创建 `world_book_activations` 表

---

## 参考资料

- [世界书扫描引擎实现](../docs/世界书扫描引擎实现.md)
- [世界书系统详解](../docs/文档3-世界书系统.md)
- [SillyTavern 官方文档](https://docs.sillytavern.app/)
