# API 24: Agent æ™ºèƒ½åŠ©æ‰‹ç³»ç»Ÿ

> **ç‰ˆæœ¬**: v1.0  
> **æœ€åæ›´æ–°**: 2025-10-31  
> **çŠ¶æ€**: ğŸš§ è§„åˆ’ä¸­

---

## ğŸ“‹ æ¦‚è¿°

Agent æ™ºèƒ½åŠ©æ‰‹ç³»ç»Ÿæ˜¯ç±»ä¼¼ Cursor çš„ AI ç¼–ç¨‹åŠ©æ‰‹åœ¨å†™ä½œåœºæ™¯ä¸­çš„å®ç°ï¼Œä¸ºä½œå“ç¼–è¾‘å™¨æä¾›ï¼š

- **å†…è”è¡¥å…¨**ï¼šå†™ä½œæ—¶å®æ—¶æç¤ºç»­å†™ï¼ˆInline Completionï¼‰
- **å¯¹è¯åä½œ**ï¼šä¾§è¾¹æ ä¸ Agent è®¨è®ºæƒ…èŠ‚ï¼ˆChat Panelï¼‰
- **å¿«é€Ÿæ“ä½œ**ï¼šé€‰ä¸­æ–‡æœ¬å¿«é€Ÿæ”¹å†™ï¼ˆQuick Actionsï¼‰
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šæ™ºèƒ½ç†è§£ç« èŠ‚ã€äººç‰©ã€ä¸–ç•Œè§‚
- **è‡ªå®šä¹‰ Agent**ï¼šç”¨æˆ·å¯åˆ›å»ºå’Œåˆ†äº«è‡ªå·±çš„ Agent

### æ ¸å¿ƒç‰¹æ€§

- âœ… ä¸æç¤ºè¯ç³»ç»Ÿæ·±åº¦é›†æˆ
- âœ… æ”¯æŒå¼•ç”¨å·²æœ‰æç¤ºè¯æˆ–è‡ªå®šä¹‰
- âœ… ä¸‰ç§äº¤äº’æ¨¡å¼ï¼ˆå†…è”/å¯¹è¯/å¿«é€Ÿæ“ä½œï¼‰
- âœ… æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º
- âœ… Agent å¸‚åœºï¼ˆåˆ†äº«ä¸å‘ç°ï¼‰
- âœ… å®æ—¶ WebSocket æ¨é€
- âœ… å­—æ•°æ¶ˆè€—è‡ªåŠ¨æ‰£è´¹

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå†…è”è¡¥å…¨

```
ç”¨æˆ·æ­£åœ¨å†™ä½œ â†’ åœé¡¿2ç§’ â†’ Agentè‡ªåŠ¨æç¤ºç»­å†™ â†’
æŒ‰Tabæ¥å— / æŒ‰Escæ‹’ç»
```

### åœºæ™¯ 2ï¼šå¯¹è¯åä½œ

```
ç”¨æˆ·é€‰ä¸­ä¸€æ®µå¯¹è¯ â†’ æ‰“å¼€Agentä¾§è¾¹æ  â†’
"è¿™æ®µå¯¹è¯å¤ªå¹³æ·¡ï¼Œæ€ä¹ˆæ”¹è¿›ï¼Ÿ" â†’ Agentç»™å‡ºå»ºè®®å’Œæ”¹å†™ç‰ˆæœ¬ â†’
ç”¨æˆ·ç‚¹å‡»æ’å…¥åˆ°ç¼–è¾‘å™¨
```

### åœºæ™¯ 3ï¼šå¿«é€Ÿæ“ä½œ

```
ç”¨æˆ·é€‰ä¸­ä¸€æ®µæå†™ â†’ å³é”®èœå• â†’ é€‰æ‹©"AIæ‰©å†™" â†’
Agentæ‰©å†™ç»†èŠ‚ â†’ ç¼–è¾‘å™¨æ˜¾ç¤ºDiff â†’ ç”¨æˆ·æ¥å—æˆ–æ‹’ç»
```

---

## ğŸ”Œ API æ¥å£

### åŸºç¡€ä¿¡æ¯

- **Base URL**: `/api/v1/agents`
- **è®¤è¯**: éœ€è¦ Bearer Token
- **æƒé™**: æ ¹æ®æ“ä½œç±»å‹ä¸åŒ

---

## ä¸€ã€Agent ç®¡ç†

### 1.1 åˆ›å»º Agent

**POST** `/api/v1/agents`

**æƒé™**: éœ€è¦ç™»å½•

**è¯·æ±‚ä½“**:

```json
{
  "name": "å¯¹è¯å¤§å¸ˆ",
  "description": "æ“…é•¿å†™äººç‰©å¯¹è¯å’Œäº’åŠ¨åœºæ™¯",
  "icon": "ğŸ’¬",

  "systemPromptType": "custom",
  "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å†™äººç‰©å¯¹è¯çš„å°è¯´åŠ©æ‰‹...",

  "modelId": "gemini-2.0-flash",
  "temperature": 0.8,

  "capabilities": {
    "inlineCompletion": true,
    "chat": true,
    "quickActions": ["continue", "rewrite", "expand"]
  },

  "contextConfig": {
    "includeCharacters": true,
    "includeWorldSettings": false,
    "includeOutline": true,
    "historyLength": 1,
    "maxContextTokens": 4000
  },

  "promptReferences": [
    {
      "promptId": 123,
      "position": "system",
      "enabled": true
    }
  ],

  "customPrompts": [
    {
      "name": "è¡¥å…¨æç¤ºè¯",
      "type": "completion",
      "content": "åŸºäºä»¥ä¸‹å†…å®¹ç»­å†™ï¼Œä¿æŒäººç‰©æ€§æ ¼ä¸€è‡´ï¼š\n{{input}}"
    },
    {
      "name": "æ”¹å†™æç¤ºè¯",
      "type": "rewrite",
      "content": "æ”¹å†™ä»¥ä¸‹å¯¹è¯ï¼Œä½¿å…¶æ›´ç”ŸåŠ¨ï¼š\n{{input}}"
    }
  ],

  "isPublic": false,
  "requireApplication": false
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ                    | ç±»å‹    | å¿…éœ€ | è¯´æ˜                                                        |
| ----------------------- | ------- | ---- | ----------------------------------------------------------- |
| name                    | string  | âœ…   | Agent åç§°ï¼Œæœ€å¤š 50 å­—ç¬¦                                    |
| description             | string  | âŒ   | æè¿°ï¼Œæœ€å¤š 500 å­—ç¬¦                                         |
| icon                    | string  | âŒ   | å›¾æ ‡ emoji                                                  |
| **systemPromptType**    | string  | âœ…   | ç³»ç»Ÿæç¤ºè¯ç±»å‹ï¼š`custom`(è‡ªå®šä¹‰) / `prompt`(å¼•ç”¨å·²æœ‰æç¤ºè¯) |
| **systemPromptContent** | string  | âš ï¸   | è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆtype=custom æ—¶å¿…å¡«ï¼‰                      |
| **systemPromptId**      | number  | âš ï¸   | å¼•ç”¨çš„æç¤ºè¯ IDï¼ˆtype=prompt æ—¶å¿…å¡«ï¼‰                       |
| modelId                 | string  | âŒ   | ä½¿ç”¨çš„æ¨¡å‹ï¼Œé»˜è®¤ gemini-2.0-flash                           |
| temperature             | number  | âŒ   | åˆ›é€ æ€§ï¼ˆ0-2ï¼‰ï¼Œé»˜è®¤ 0.7                                     |
| capabilities            | object  | âœ…   | èƒ½åŠ›é…ç½®                                                    |
| contextConfig           | object  | âœ…   | ä¸Šä¸‹æ–‡é…ç½®                                                  |
| promptReferences        | array   | âŒ   | å¼•ç”¨çš„æç¤ºè¯åˆ—è¡¨                                            |
| customPrompts           | array   | âŒ   | è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿                                            |
| isPublic                | boolean | âŒ   | æ˜¯å¦å…¬å¼€ï¼Œé»˜è®¤ false                                        |
| requireApplication      | boolean | âŒ   | æ˜¯å¦éœ€è¦ç”³è¯·ä½¿ç”¨ï¼Œé»˜è®¤ false                                |

**èƒ½åŠ›é…ç½® (capabilities)**:

| å­—æ®µ                  | ç±»å‹     | è¯´æ˜                                                     |
| --------------------- | -------- | -------------------------------------------------------- |
| inlineCompletion      | boolean  | æ”¯æŒå†…è”è¡¥å…¨                                             |
| enableInlineByDefault | boolean  | é»˜è®¤å¼€å¯å†…è”è¡¥å…¨ï¼ˆå¯åœ¨ç¼–è¾‘å™¨ä¸­å…³é—­ï¼‰                     |
| showThoughts          | boolean  | æ˜¾ç¤º Agent æ€è€ƒè¿‡ç¨‹ï¼ˆç±»ä¼¼ Cursor çš„ Thoughtï¼‰            |
| chat                  | boolean  | æ”¯æŒå¯¹è¯æ¨¡å¼                                             |
| quickActions          | string[] | æ”¯æŒçš„å¿«é€Ÿæ“ä½œï¼šcontinue/rewrite/expand/polish/summarize |
| structureOperations   | string[] | æ”¯æŒçš„ç»“æ„æ“ä½œï¼šè§ä¸‹è¡¨                                   |

**ä¸Šä¸‹æ–‡é…ç½® (contextConfig)**:

| å­—æ®µ                 | ç±»å‹    | é»˜è®¤å€¼ | è¯´æ˜                  |
| -------------------- | ------- | ------ | --------------------- |
| includeCharacters    | boolean | true   | åŒ…å«äººç‰©å¡            |
| includeWorldSettings | boolean | true   | åŒ…å«ä¸–ç•Œè§‚            |
| includeOutline       | boolean | false  | åŒ…å«ç« èŠ‚å¤§çº²          |
| historyLength        | number  | 1      | åŒ…å«å‰å‡ ç« å†…å®¹ï¼ˆ0-5ï¼‰ |
| maxContextTokens     | number  | 4000   | ä¸Šä¸‹æ–‡æœ€å¤§ token æ•°   |

**æç¤ºè¯å¼•ç”¨ (promptReferences)**:

| å­—æ®µ     | ç±»å‹    | è¯´æ˜                      |
| -------- | ------- | ------------------------- |
| promptId | number  | å¼•ç”¨çš„æç¤ºè¯ ID           |
| position | string  | ä½ç½®ï¼šsystem/before/after |
| enabled  | boolean | æ˜¯å¦å¯ç”¨                  |

**è‡ªå®šä¹‰æç¤ºè¯ (customPrompts)**:

| å­—æ®µ    | ç±»å‹   | è¯´æ˜                                             |
| ------- | ------ | ------------------------------------------------ |
| name    | string | æç¤ºè¯åç§°                                       |
| type    | string | ç±»å‹ï¼šcompletion/rewrite/expand/polish/summarize |
| content | string | æç¤ºè¯å†…å®¹ï¼Œæ”¯æŒå®å ä½ç¬¦                         |

**ç»“æ„æ“ä½œç±»å‹ (structureOperations)**:

| æ“ä½œç±»å‹         | è¯´æ˜             | ç¤ºä¾‹                     |
| ---------------- | ---------------- | ------------------------ |
| createVolume     | åˆ›å»ºåˆ†å·         | "å¸®æˆ‘åˆ›å»ºç¬¬äºŒå·"         |
| createChapter    | åˆ›å»ºç« èŠ‚         | "æ–°å»ºä¸€ç« "               |
| createCharacter  | åˆ›å»ºäººç‰©å¡       | "æ·»åŠ ä¸€ä¸ªåæ´¾è§’è‰²"       |
| createWorld      | åˆ›å»ºä¸–ç•Œè§‚       | "åˆ›å»ºä¸€ä¸ªåœ°ç‚¹è®¾å®š"       |
| createMemo       | åˆ›å»ºå¤‡å¿˜å½•       | "è®°å½•ä¸€ä¸ªå‰§æƒ…ç‚¹"         |
| updateChapter    | æ›´æ–°ç« èŠ‚å†…å®¹     | "ä¿®æ”¹ç¬¬ä¸‰ç« çš„æ ‡é¢˜"       |
| deleteChapter    | åˆ é™¤ç« èŠ‚         | "åˆ é™¤è¿™ä¸€ç« "             |
| moveChapter      | ç§»åŠ¨ç« èŠ‚é¡ºåº     | "æŠŠè¿™ç« ç§»åˆ°å‰é¢"         |
| generateOutline  | ç”Ÿæˆç« èŠ‚å¤§çº²     | "ä¸ºä¸‹ä¸€ç« ç”Ÿæˆå¤§çº²"       |
| analyzeStructure | åˆ†æä½œå“ç»“æ„     | "åˆ†æå½“å‰ä½œå“çš„ç»“æ„é—®é¢˜" |
| suggestPlot      | å»ºè®®å‰§æƒ…å‘å±•     | "æ¥ä¸‹æ¥æƒ…èŠ‚æ€ä¹ˆå‘å±•ï¼Ÿ"   |
| checkConsistency | æ£€æŸ¥ä¸€è‡´æ€§       | "æ£€æŸ¥äººç‰©è®¾å®šæ˜¯å¦çŸ›ç›¾"   |
| autoSummary      | è‡ªåŠ¨ç”Ÿæˆç« èŠ‚æ¢—æ¦‚ | "ä¸ºå‰ä¸‰ç« ç”Ÿæˆæ¢—æ¦‚"       |

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "userId": 123,
    "name": "å¯¹è¯å¤§å¸ˆ",
    "description": "æ“…é•¿å†™äººç‰©å¯¹è¯å’Œäº’åŠ¨åœºæ™¯",
    "icon": "ğŸ’¬",
    "systemPromptType": "custom",
    "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å†™äººç‰©å¯¹è¯çš„å°è¯´åŠ©æ‰‹...",
    "modelId": "gemini-2.0-flash",
    "temperature": 0.8,
    "capabilities": {
      "inlineCompletion": true,
      "chat": true,
      "quickActions": ["continue", "rewrite", "expand"]
    },
    "contextConfig": {
      "includeCharacters": true,
      "includeWorldSettings": false,
      "includeOutline": true,
      "historyLength": 1,
      "maxContextTokens": 4000
    },
    "usageCount": 0,
    "rating": null,
    "isPublic": false,
    "requireApplication": false,
    "createdAt": "2025-10-31T10:00:00.000Z",
    "updatedAt": "2025-10-31T10:00:00.000Z"
  }
}
```

---

### 1.2 è·å–æˆ‘çš„ Agent åˆ—è¡¨

**GET** `/api/v1/agents`

**æƒé™**: éœ€è¦ç™»å½•

**æŸ¥è¯¢å‚æ•°**:

| å‚æ•°     | ç±»å‹    | å¿…éœ€ | è¯´æ˜              |
| -------- | ------- | ---- | ----------------- |
| page     | number  | âŒ   | é¡µç ï¼Œé»˜è®¤ 1      |
| limit    | number  | âŒ   | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 20 |
| search   | string  | âŒ   | æœç´¢å…³é”®è¯        |
| isPublic | boolean | âŒ   | ç­›é€‰å…¬å¼€/ç§æœ‰     |

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "items": [
      {
        "id": 1,
        "name": "å¯¹è¯å¤§å¸ˆ",
        "description": "æ“…é•¿å†™äººç‰©å¯¹è¯å’Œäº’åŠ¨åœºæ™¯",
        "icon": "ğŸ’¬",
        "usageCount": 156,
        "rating": 4.8,
        "isPublic": true,
        "createdAt": "2025-10-31T10:00:00.000Z"
      }
    ],
    "total": 5,
    "page": 1,
    "limit": 20
  }
}
```

---

### 1.3 è·å– Agent è¯¦æƒ…

**GET** `/api/v1/agents/:id`

**æƒé™**:

- ä½œè€…å¯æŸ¥çœ‹
- å…¬å¼€ Agent æ‰€æœ‰äººå¯æŸ¥çœ‹
- éœ€è¦ç”³è¯·çš„ Agentï¼Œå·²æˆæƒç”¨æˆ·å¯æŸ¥çœ‹

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "id": 1,
    "userId": 123,
    "name": "å¯¹è¯å¤§å¸ˆ",
    "description": "æ“…é•¿å†™äººç‰©å¯¹è¯å’Œäº’åŠ¨åœºæ™¯",
    "icon": "ğŸ’¬",
    "systemPromptType": "custom",
    "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å†™äººç‰©å¯¹è¯çš„å°è¯´åŠ©æ‰‹...",
    "modelId": "gemini-2.0-flash",
    "temperature": 0.8,
    "capabilities": { ... },
    "contextConfig": { ... },
    "promptReferences": [
      {
        "id": 1,
        "promptId": 123,
        "prompt": {
          "id": 123,
          "name": "äººç‰©å¯¹è¯æ¨¡æ¿",
          "description": "..."
        },
        "position": "system",
        "enabled": true
      }
    ],
    "customPrompts": [ ... ],
    "usageCount": 156,
    "rating": 4.8,
    "isPublic": true,
    "author": {
      "id": 123,
      "username": "ä½œè€…å"
    },
    "createdAt": "2025-10-31T10:00:00.000Z",
    "updatedAt": "2025-10-31T10:00:00.000Z"
  }
}
```

---

### 1.4 æ›´æ–° Agent

**PUT** `/api/v1/agents/:id`

**æƒé™**: ä»…é™ä½œè€…

**è¯·æ±‚ä½“**: ä¸åˆ›å»º Agent ç›¸åŒï¼ˆæ‰€æœ‰å­—æ®µå¯é€‰ï¼‰

---

### 1.5 åˆ é™¤ Agent

**DELETE** `/api/v1/agents/:id`

**æƒé™**: ä»…é™ä½œè€…

**å“åº”**:

```json
{
  "code": 200,
  "message": "åˆ é™¤æˆåŠŸ"
}
```

---

## äºŒã€Agent äº¤äº’ API

### 2.1 å†…è”è¡¥å…¨

**POST** `/api/v1/agents/:id/complete`

**æƒé™**: `agent:use`

**åŠŸèƒ½**: è·å–å†™ä½œè¡¥å…¨å»ºè®®

**è¯·æ±‚ä½“**:

```json
{
  "text": "å¥¹èµ°è¿›æˆ¿é—´ï¼Œçœ‹åˆ°...",
  "context": {
    "novelId": 123,
    "chapterId": 456,
    "cursorPosition": 1250,
    "selectedText": null
  },
  "maxLength": 100
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ      | ç±»å‹   | å¿…éœ€ | è¯´æ˜                           |
| --------- | ------ | ---- | ------------------------------ |
| text      | string | âœ…   | å…‰æ ‡å‰çš„æ–‡æœ¬ï¼ˆæœ€å¤š 1000 å­—ç¬¦ï¼‰ |
| context   | object | âœ…   | ç¼–è¾‘å™¨ä¸Šä¸‹æ–‡                   |
| maxLength | number | âŒ   | æœ€å¤§è¡¥å…¨é•¿åº¦ï¼Œé»˜è®¤ 100         |

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "text": "ä¸€ä¸ªç¥ç§˜çš„èº«å½±ç«™åœ¨çª—è¾¹ï¼ŒèƒŒå¯¹ç€å¥¹ã€‚",
    "usage": {
      "inputChars": 523,
      "outputChars": 18,
      "cost": 15
    }
  }
}
```

---

### 2.2 å¯¹è¯åä½œ

**POST** `/api/v1/agents/:id/chat`

**æƒé™**: `agent:use`

**åŠŸèƒ½**: ä¸ Agent å¯¹è¯ï¼Œè·å–å†™ä½œå»ºè®®

**è¯·æ±‚ä½“**:

```json
{
  "message": "è¿™æ®µå¯¹è¯å¤ªå¹³æ·¡äº†ï¼Œæ€ä¹ˆæ”¹è¿›ï¼Ÿ",
  "context": {
    "novelId": 123,
    "chapterId": 456,
    "selectedText": "\"ä½ å¥½ã€‚\"\n\"ä½ å¥½ã€‚\"",
    "currentParagraph": "..."
  },
  "history": [
    {
      "role": "user",
      "content": "å¸®æˆ‘å†™ä¸€æ®µå¯¹è¯"
    },
    {
      "role": "assistant",
      "content": "å¥½çš„ï¼Œä½ æƒ³å†™ä»€ä¹ˆåœºæ™¯çš„å¯¹è¯ï¼Ÿ"
    }
  ],
  "sessionId": 789
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ      | ç±»å‹   | å¿…éœ€ | è¯´æ˜                        |
| --------- | ------ | ---- | --------------------------- |
| message   | string | âœ…   | ç”¨æˆ·æ¶ˆæ¯                    |
| context   | object | âœ…   | ç¼–è¾‘å™¨ä¸Šä¸‹æ–‡                |
| history   | array  | âŒ   | å¯¹è¯å†å²ï¼ˆæœ€è¿‘ 10 è½®ï¼‰      |
| sessionId | number | âŒ   | ä¼šè¯ IDï¼ˆç”¨äºè®°å½•å¯¹è¯å†å²ï¼‰ |

**å“åº”ç¤ºä¾‹**:

````json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "text": "æˆ‘çœ‹åˆ°ä½ é€‰ä¸­çš„æ˜¯ææ˜å’Œè‰¾è‰å¨…çš„å¯¹è¯ã€‚å»ºè®®ï¼š\n\n1. åŠ å…¥æƒ…ç»ªå†²çªï¼šè‰¾è‰å¨…å¯ä»¥è´¨ç–‘ææ˜çš„åŠ¨æœº\n2. ä½¿ç”¨åŠ¨ä½œæå†™ï¼šè¾¹è¯´è¯è¾¹åšäº‹ï¼Œå¢åŠ ç”»é¢æ„Ÿ\n3. åŸ‹ä¼ç¬”ï¼šæåŠ\"é‚£ä»¶äº‹\"ä½†ä¸è¯´ç ´\n\næˆ‘å¸®ä½ æ”¹å†™ä¸€ä¸‹å§ï¼Ÿ\n\n```\n\"ä½ çœŸçš„å†³å®šäº†ï¼Ÿ\"è‰¾è‰å¨…åœä¸‹æ‰‹ä¸­çš„èŒ¶æ¯ï¼Œçœ¼ç¥å¤æ‚åœ°çœ‹ç€ä»–ã€‚\nææ˜æ²‰é»˜ç‰‡åˆ»ï¼š\"æˆ‘å¿…é¡»å»ã€‚ä½ çŸ¥é“çš„ï¼Œé‚£ä»¶äº‹...\"\n\"åˆ«å†æé‚£ä»¶äº‹ï¼\"å¥¹æ‰“æ–­ä»–ï¼Œå£°éŸ³å¾®å¾®é¢¤æŠ–ã€‚\n```",
    "sessionId": 789,
    "usage": {
      "inputChars": 856,
      "outputChars": 142,
      "cost": 38
    }
  }
}
````

---

### 2.3 å¿«é€Ÿæ“ä½œ

**POST** `/api/v1/agents/:id/quick-action`

**æƒé™**: `agent:use`

**åŠŸèƒ½**: å¯¹é€‰ä¸­æ–‡æœ¬æ‰§è¡Œå¿«é€Ÿæ“ä½œ

**è¯·æ±‚ä½“**:

```json
{
  "action": "rewrite",
  "text": "å¥¹èµ°è¿›æˆ¿é—´ã€‚",
  "context": {
    "novelId": 123,
    "chapterId": 456
  },
  "parameters": {
    "style": "æ›´ç»†è…»",
    "addDetails": true
  }
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ       | ç±»å‹   | å¿…éœ€ | è¯´æ˜                                               |
| ---------- | ------ | ---- | -------------------------------------------------- |
| action     | string | âœ…   | æ“ä½œç±»å‹ï¼šcontinue/rewrite/expand/polish/summarize |
| text       | string | âœ…   | é€‰ä¸­çš„æ–‡æœ¬                                         |
| context    | object | âœ…   | ç¼–è¾‘å™¨ä¸Šä¸‹æ–‡                                       |
| parameters | object | âŒ   | æ“ä½œå‚æ•°                                           |

**æ“ä½œç±»å‹è¯´æ˜**:

| æ“ä½œ      | è¯´æ˜ | é€‚ç”¨åœºæ™¯               |
| --------- | ---- | ---------------------- |
| continue  | ç»­å†™ | åœ¨é€‰ä¸­æ–‡æœ¬åç»§ç»­å†™     |
| rewrite   | æ”¹å†™ | æ”¹å†™é€‰ä¸­å†…å®¹ï¼Œä¿æŒæ„æ€ |
| expand    | æ‰©å†™ | æ‰©å±•ç»†èŠ‚æå†™           |
| polish    | æ¶¦è‰² | ä¼˜åŒ–æ–‡ç¬”               |
| summarize | æ€»ç»“ | æ€»ç»“ä¸ºæ¢—æ¦‚             |

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "original": "å¥¹èµ°è¿›æˆ¿é—´ã€‚",
    "result": "å¥¹è½»è½»æ¨å¼€æˆ¿é—¨ï¼Œèµ°è¿›è¿™é—´å……æ»¡å›å¿†çš„æˆ¿é—´ã€‚å¤•é˜³çš„ä½™æ™–é€è¿‡çª—å¸˜æ´’åœ¨åœ°æ¿ä¸Šï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æ·¡æ·¡çš„æª€é¦™å‘³ã€‚",
    "usage": {
      "inputChars": 234,
      "outputChars": 56,
      "cost": 12
    }
  }
}
```

---

### 2.4 æµå¼ç”Ÿæˆï¼ˆå¯¹è¯å’Œå¿«é€Ÿæ“ä½œï¼‰

**POST** `/api/v1/agents/:id/chat/stream`  
**POST** `/api/v1/agents/:id/quick-action/stream`

**å“åº”ç±»å‹**: `text/event-stream`

**SSE æ•°æ®æ ¼å¼**:

```
data: {"content":"æˆ‘"}

data: {"content":"çœ‹åˆ°"}

data: {"content":"ä½ "}

data: [DONE]
```

---

### 2.5 Agent Thoughtsï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰

**åŠŸèƒ½**: å½“ Agent é…ç½®äº† `showThoughts: true` æ—¶ï¼Œä¼šåœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­è¿”å›æ€è€ƒè¿‡ç¨‹

**SSE æ•°æ®æ ¼å¼ï¼ˆå¸¦ Thoughtsï¼‰**:

```
data: {"type":"thought","content":"æ­£åœ¨åˆ†æå½“å‰ç« èŠ‚çš„äººç‰©å…³ç³»..."}

data: {"type":"thought","content":"å‘ç°ææ˜å’Œè‰¾è‰å¨…çš„å¯¹è¯ç¼ºå°‘æƒ…ç»ªå†²çª"}

data: {"type":"thought","content":"å‡†å¤‡åŠ å…¥åŠ¨ä½œæå†™å’Œå¿ƒç†æ´»åŠ¨"}

data: {"type":"content","content":"\"ä½ çœŸçš„å†³å®šäº†ï¼Ÿ\""}

data: {"type":"content","content":"è‰¾è‰å¨…åœä¸‹æ‰‹ä¸­çš„èŒ¶æ¯"}

data: [DONE]
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ    | ç±»å‹   | è¯´æ˜                                          |
| ------- | ------ | --------------------------------------------- |
| type    | string | æ¶ˆæ¯ç±»å‹ï¼šthoughtï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰/contentï¼ˆå†…å®¹ï¼‰ |
| content | string | å…·ä½“å†…å®¹                                      |

**å‰ç«¯å±•ç¤ºç¤ºä¾‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’­ Agent æ­£åœ¨æ€è€ƒ...             â”‚
â”‚ â€¢ æ­£åœ¨åˆ†æå½“å‰ç« èŠ‚çš„äººç‰©å…³ç³»...  â”‚
â”‚ â€¢ å‘ç°ææ˜å’Œè‰¾è‰å¨…çš„å¯¹è¯ç¼ºå°‘æƒ…ç»ªå†²çª â”‚
â”‚ â€¢ å‡†å¤‡åŠ å…¥åŠ¨ä½œæå†™å’Œå¿ƒç†æ´»åŠ¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "ä½ çœŸçš„å†³å®šäº†ï¼Ÿ"è‰¾è‰å¨…åœä¸‹æ‰‹ä¸­çš„èŒ¶æ¯... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.6 ç»“æ„æ“ä½œ

**POST** `/api/v1/agents/:id/structure-operation`

**æƒé™**: `agent:use` + å¯¹åº”çš„æ“ä½œæƒé™

**åŠŸèƒ½**: Agent æ‰§è¡Œç»“æ„æ“ä½œï¼ˆåˆ›å»ºåˆ†å·ã€ç« èŠ‚ã€äººç‰©å¡ç­‰ï¼‰

**è¯·æ±‚ä½“**:

```json
{
  "operation": "createChapter",
  "context": {
    "novelId": 123,
    "volumeId": 456
  },
  "parameters": {
    "title": "ç¬¬å››ç«  è½¬æŠ˜",
    "summary": "ææ˜å‘ç°äº†çœŸç›¸",
    "autoGenerate": true
  },
  "userMessage": "å¸®æˆ‘åˆ›å»ºä¸‹ä¸€ç« ï¼Œè¦æœ‰è½¬æŠ˜"
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ        | ç±»å‹   | å¿…éœ€ | è¯´æ˜                           |
| ----------- | ------ | ---- | ------------------------------ |
| operation   | string | âœ…   | æ“ä½œç±»å‹ï¼ˆè§ä¸Šè¡¨ï¼‰             |
| context     | object | âœ…   | æ“ä½œä¸Šä¸‹æ–‡                     |
| parameters  | object | âŒ   | æ“ä½œå‚æ•°                       |
| userMessage | string | âŒ   | ç”¨æˆ·çš„åŸå§‹æ¶ˆæ¯ï¼ˆç”¨äºç†è§£æ„å›¾ï¼‰ |

**æ“ä½œç¤ºä¾‹**:

#### ç¤ºä¾‹ 1ï¼šåˆ›å»ºç« èŠ‚

```json
{
  "operation": "createChapter",
  "context": {
    "novelId": 123,
    "volumeId": 456
  },
  "parameters": {
    "title": "ç¬¬å››ç«  è½¬æŠ˜",
    "summary": "ææ˜å‘ç°äº†çœŸç›¸",
    "autoGenerate": true,
    "targetLength": 2000
  }
}
```

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "operationType": "createChapter",
    "result": {
      "id": 789,
      "title": "ç¬¬å››ç«  è½¬æŠ˜",
      "summary": "ææ˜å‘ç°äº†çœŸç›¸",
      "content": "...Agentè‡ªåŠ¨ç”Ÿæˆçš„å†…å®¹...",
      "wordCount": 2050
    },
    "thoughts": [
      "åˆ†æäº†å‰ä¸‰ç« çš„å‰§æƒ…èµ°å‘",
      "ç¡®å®šç¬¬å››ç« éœ€è¦ä¸€ä¸ªé‡å¤§è½¬æŠ˜",
      "é€‰æ‹©è®©ææ˜å‘ç°çœŸç›¸ä½œä¸ºè½¬æŠ˜ç‚¹",
      "è®¾è®¡äº†3ä¸ªåœºæ™¯ï¼šå‘ç°çº¿ç´¢ã€éªŒè¯çœŸç›¸ã€å†…å¿ƒæŒ£æ‰"
    ],
    "suggestions": ["å»ºè®®åœ¨ç¬¬äº”ç« åŠ å…¥è‰¾è‰å¨…çš„ååº”", "å¯ä»¥è€ƒè™‘åŸ‹ä¸‹æ–°çš„ä¼ç¬”"]
  }
}
```

#### ç¤ºä¾‹ 2ï¼šåˆ›å»ºäººç‰©å¡

```json
{
  "operation": "createCharacter",
  "context": {
    "novelId": 123
  },
  "parameters": {
    "role": "åæ´¾",
    "brief": "ä¸€ä¸ªç¥ç§˜çš„å•†äºº"
  },
  "userMessage": "å¸®æˆ‘åˆ›å»ºä¸€ä¸ªåæ´¾è§’è‰²ï¼Œæ˜¯ä¸ªç¥ç§˜å•†äºº"
}
```

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "operationType": "createCharacter",
    "result": {
      "id": 234,
      "name": "é™ˆé»˜",
      "category": "åæ´¾",
      "fields": {
        "æ€§åˆ«": "ç”·",
        "å¹´é¾„": "45å²",
        "èŒä¸š": "å¤è‘£å•†äºº",
        "æ€§æ ¼": "æ·±æ²‰ã€ç‹¡è¯ˆã€æœ‰åŸåºœ",
        "å¤–è²Œ": "ä¸­ç­‰èº«æï¼Œæ€»æ˜¯ç©¿ç€å¾—ä½“çš„è¥¿è£…ï¼Œçœ¼ç¥æ·±é‚ƒ",
        "èƒ½åŠ›": "å–„äºæ“çºµäººå¿ƒï¼Œç²¾é€šå¤è‘£é‰´å®š",
        "èƒŒæ™¯": "è¡¨é¢ä¸Šç»è¥å¤è‘£åº—ï¼Œå®åˆ™æ˜¯åœ°ä¸‹åŠ¿åŠ›çš„å¹•åæ“çºµè€…",
        "åŠ¨æœº": "å¯»æ‰¾ä¼ è¯´ä¸­çš„ç¥å™¨",
        "å¼±ç‚¹": "è¿‡äºè‡ªä¿¡ï¼Œè½»æ•Œ"
      }
    },
    "thoughts": [
      "æ ¹æ®'ç¥ç§˜å•†äºº'çš„è®¾å®šï¼Œé€‰æ‹©å¤è‘£è¡Œä¸šä½œä¸ºä¼ªè£…",
      "ä½œä¸ºåæ´¾éœ€è¦æœ‰æ˜ç¡®çš„åŠ¨æœºå’Œç›®æ ‡",
      "è®¾è®¡äº†å¤æ‚çš„èƒŒæ™¯ä»¥å¢åŠ æ·±åº¦",
      "æ·»åŠ äº†æ€§æ ¼å¼±ç‚¹ä½¿è§’è‰²æ›´ç«‹ä½“"
    ]
  }
}
```

#### ç¤ºä¾‹ 3ï¼šåˆ†æä½œå“ç»“æ„

```json
{
  "operation": "analyzeStructure",
  "context": {
    "novelId": 123
  }
}
```

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "operationType": "analyzeStructure",
    "result": {
      "summary": "æ•´ä½“ç»“æ„è¾ƒå®Œæ•´ï¼Œä½†å­˜åœ¨ä¸€äº›é—®é¢˜",
      "strengths": [
        "å¼€ç¯‡å¼•äººå…¥èƒœï¼Œæ‚¬å¿µè®¾ç½®æ°å½“",
        "äººç‰©å…³ç³»æ¸…æ™°ï¼Œä¸»çº¿æ˜ç¡®",
        "å‰ä¸‰ç« èŠ‚å¥æŠŠæ§è‰¯å¥½"
      ],
      "weaknesses": [
        "ç¬¬äºŒç« å’Œç¬¬ä¸‰ç« ä¹‹é—´è¡”æ¥ç•¥æ˜¾ç”Ÿç¡¬",
        "åæ´¾è§’è‰²å‡ºåœºè¿‡æ™šï¼Œç¼ºå°‘é“ºå«",
        "ä¸–ç•Œè§‚ä»‹ç»è¿‡äºé›†ä¸­ï¼Œå½±å“é˜…è¯»ä½“éªŒ"
      ],
      "suggestions": [
        "åœ¨ç¬¬ä¸€ç« æœ«å°¾å¯ä»¥åŸ‹ä¸‹åæ´¾çš„ä¼ç¬”",
        "å»ºè®®å°†éƒ¨åˆ†ä¸–ç•Œè§‚è®¾å®šèå…¥å‰§æƒ…å±•å¼€",
        "ç¬¬äºŒç« ç»“å°¾å¯ä»¥å¢åŠ ä¸€ä¸ªå°é«˜æ½®",
        "è€ƒè™‘å¢åŠ ä¸€ä¸ªé…è§’æ¥ä¸°å¯Œæ•…äº‹å±‚æ¬¡"
      ],
      "pacing": {
        "èµ·": "ä¼˜ç§€",
        "æ‰¿": "è‰¯å¥½",
        "è½¬": "å¾…åŠ å¼º",
        "åˆ": "æœªåˆ°è¾¾"
      }
    },
    "thoughts": [
      "å·²é˜…è¯»å…¨éƒ¨3ä¸ªç« èŠ‚ï¼Œå…±è®¡8500å­—",
      "åˆ†æäº†èµ·æ‰¿è½¬åˆçš„ç»“æ„å®Œæ•´æ€§",
      "æ£€æŸ¥äº†äººç‰©å¡ä¸ç« èŠ‚å†…å®¹çš„ä¸€è‡´æ€§",
      "è¯„ä¼°äº†èŠ‚å¥æ§åˆ¶å’Œæ‚¬å¿µè®¾ç½®"
    ]
  }
}
```

#### ç¤ºä¾‹ 4ï¼šæ£€æŸ¥ä¸€è‡´æ€§

```json
{
  "operation": "checkConsistency",
  "context": {
    "novelId": 123,
    "checkScope": ["characters", "worldSettings"]
  }
}
```

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "operationType": "checkConsistency",
    "result": {
      "hasIssues": true,
      "issues": [
        {
          "type": "character_inconsistency",
          "severity": "high",
          "description": "äººç‰©'ææ˜'çš„å¤–è²Œæè¿°ä¸ä¸€è‡´",
          "details": "ç¬¬1ç« æè¿°ä¸º'é»‘å‘é»‘çœ¸'ï¼Œç¬¬3ç« å˜æˆäº†'é‡‘è‰²çŸ­å‘'",
          "locations": [
            { "chapter": 1, "position": 245 },
            { "chapter": 3, "position": 1028 }
          ],
          "suggestion": "å»ºè®®ç»Ÿä¸€ä¸º'é»‘å‘é»‘çœ¸'ï¼Œç¬¦åˆäººç‰©å¡è®¾å®š"
        },
        {
          "type": "world_inconsistency",
          "severity": "medium",
          "description": "åœ°ç‚¹'ä¸œæµ·'çš„ä½ç½®æè¿°çŸ›ç›¾",
          "details": "ä¸–ç•Œè§‚ä¸­è®¾å®šåœ¨'å¤§é™†ä¸œéƒ¨'ï¼Œç¬¬2ç« å´è¯´'è¥¿è¾¹çš„æµ·åŸŸ'",
          "locations": [{ "chapter": 2, "position": 567 }],
          "suggestion": "ä¿®æ”¹ä¸º'ä¸œè¾¹çš„æµ·åŸŸ'æˆ–æ›´æ–°ä¸–ç•Œè§‚è®¾å®š"
        }
      ],
      "summary": "å‘ç°2å¤„ä¸ä¸€è‡´é—®é¢˜ï¼Œå»ºè®®ä¿®æ­£"
    },
    "thoughts": [
      "æ‰«æäº†æ‰€æœ‰ç« èŠ‚å†…å®¹",
      "å¯¹æ¯”äº†äººç‰©å¡ä¸­çš„è®¾å®š",
      "æ£€æŸ¥äº†ä¸–ç•Œè§‚çš„åœ°ç†æè¿°",
      "æ ‡è®°äº†ä¸ä¸€è‡´çš„ä½ç½®"
    ]
  }
}
```

---

### 2.7 Agent åä½œå’Œç¼–æ’

**åŠŸèƒ½**: ä¸» Agent å¯ä»¥è°ƒç”¨å­ Agent ååŒå®Œæˆå¤æ‚ä»»åŠ¡

#### åä½œæ¨¡å¼

**1. ä¸²è¡Œåä½œ** - æŒ‰é¡ºåºæ‰§è¡Œå¤šä¸ª Agent

```
ä¸»Agent â†’ å­Agent1 â†’ å­Agent2 â†’ è¿”å›ç»“æœ
```

**2. å¹¶è¡Œåä½œ** - åŒæ—¶æ‰§è¡Œå¤šä¸ª Agent

```
ä¸»Agent â†’ [å­Agent1, å­Agent2, å­Agent3] â†’ åˆå¹¶ç»“æœ
```

**3. æ¡ä»¶åä½œ** - æ ¹æ®æ¡ä»¶é€‰æ‹© Agent

```
ä¸»Agent â†’ åˆ¤æ–­æ¡ä»¶ â†’ é€‰æ‹©å­Agent â†’ æ‰§è¡Œ
```

#### API æ¥å£

**POST** `/api/v1/agents/:id/orchestrate`

**æƒé™**: `agent:use`

**åŠŸèƒ½**: æ‰§è¡Œå¤š Agent åä½œä»»åŠ¡

**è¯·æ±‚ä½“**:

```json
{
  "task": "åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ç« èŠ‚ï¼ŒåŒ…å«äººç‰©å¯¹è¯å’Œåœºæ™¯æå†™",
  "context": {
    "novelId": 123,
    "volumeId": 456
  },
  "workflow": {
    "mode": "sequential",
    "agents": [
      {
        "agentId": 10,
        "name": "æƒ…èŠ‚å¤§å¸ˆ",
        "task": "ç”Ÿæˆç« èŠ‚å¤§çº²å’Œä¸»è¦æƒ…èŠ‚",
        "output": "outline"
      },
      {
        "agentId": 5,
        "name": "å¯¹è¯å¤§å¸ˆ",
        "task": "åŸºäºå¤§çº²å†™äººç‰©å¯¹è¯",
        "input": ["outline"],
        "output": "dialogue"
      },
      {
        "agentId": 8,
        "name": "æå†™å¤§å¸ˆ",
        "task": "è¡¥å……åœºæ™¯æå†™å’Œæ°›å›´æ¸²æŸ“",
        "input": ["outline", "dialogue"],
        "output": "description"
      }
    ],
    "finalizer": {
      "agentId": 1,
      "task": "æ•´åˆæ‰€æœ‰å†…å®¹ï¼Œæ¶¦è‰²å¹¶ç”Ÿæˆæœ€ç»ˆç« èŠ‚",
      "input": ["outline", "dialogue", "description"]
    }
  }
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ     | ç±»å‹   | å¿…éœ€ | è¯´æ˜       |
| -------- | ------ | ---- | ---------- |
| task     | string | âœ…   | æ€»ä»»åŠ¡æè¿° |
| context  | object | âœ…   | ä¸Šä¸‹æ–‡ä¿¡æ¯ |
| workflow | object | âœ…   | å·¥ä½œæµé…ç½® |

**å·¥ä½œæµé…ç½® (workflow)**:

| å­—æ®µ      | ç±»å‹   | è¯´æ˜                                                          |
| --------- | ------ | ------------------------------------------------------------- |
| mode      | string | æ¨¡å¼ï¼šsequentialï¼ˆä¸²è¡Œï¼‰/parallelï¼ˆå¹¶è¡Œï¼‰/conditionalï¼ˆæ¡ä»¶ï¼‰ |
| agents    | array  | å­ Agent åˆ—è¡¨                                                 |
| finalizer | object | æœ€ç»ˆå¤„ç† Agentï¼ˆå¯é€‰ï¼‰                                        |

**å­ Agent é…ç½®**:

| å­—æ®µ      | ç±»å‹     | è¯´æ˜                             |
| --------- | -------- | -------------------------------- |
| agentId   | number   | Agent ID                         |
| name      | string   | Agent åç§°ï¼ˆç”¨äºè¯†åˆ«ï¼‰           |
| task      | string   | è¯¥ Agent çš„å…·ä½“ä»»åŠ¡              |
| input     | string[] | è¾“å…¥æ¥æºï¼ˆå‰é¢ Agent çš„ outputï¼‰ |
| output    | string   | è¾“å‡ºæ ‡è¯†                         |
| condition | object   | æ¡ä»¶åˆ¤æ–­ï¼ˆæ¡ä»¶æ¨¡å¼æ—¶ä½¿ç”¨ï¼‰       |

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "orchestrationId": "orch_123",
    "status": "completed",
    "steps": [
      {
        "step": 1,
        "agentId": 10,
        "agentName": "æƒ…èŠ‚å¤§å¸ˆ",
        "status": "completed",
        "result": {
          "outline": "ç¬¬å››ç« å¤§çº²ï¼š\n1. ææ˜å‘ç°çº¿ç´¢\n2. éªŒè¯çœŸç›¸\n3. å†…å¿ƒæŒ£æ‰"
        },
        "duration": 3500,
        "thoughts": ["åˆ†æäº†å‰ä¸‰ç« çš„å‰§æƒ…å‘å±•", "ç¡®å®šç¬¬å››ç« éœ€è¦ä¸€ä¸ªè½¬æŠ˜ç‚¹"]
      },
      {
        "step": 2,
        "agentId": 5,
        "agentName": "å¯¹è¯å¤§å¸ˆ",
        "status": "completed",
        "result": {
          "dialogue": "\"è¿™æ€ä¹ˆå¯èƒ½ï¼Ÿ\"ææ˜ç›¯ç€æ‰‹ä¸­çš„æ–‡ä»¶...\n\"æˆ‘æ—©è¯¥æƒ³åˆ°çš„ã€‚\"ä»–å–ƒå–ƒè‡ªè¯­ã€‚"
        },
        "duration": 4200,
        "thoughts": ["æ ¹æ®å¤§çº²è®¾è®¡äº†3æ®µå¯¹è¯", "åŠ å…¥äº†ææ˜çš„å¿ƒç†æ´»åŠ¨"]
      },
      {
        "step": 3,
        "agentId": 8,
        "agentName": "æå†™å¤§å¸ˆ",
        "status": "completed",
        "result": {
          "description": "æ˜æš—çš„æˆ¿é—´é‡Œï¼Œåªæœ‰æ¡Œä¸Šçš„å°ç¯æ•£å‘ç€å¾®å¼±çš„å…‰..."
        },
        "duration": 5100,
        "thoughts": ["è¥é€ äº†ç´§å¼ çš„æ°›å›´", "ä½¿ç”¨äº†å…‰å½±å¯¹æ¯”"]
      }
    ],
    "finalResult": {
      "chapterId": 789,
      "title": "ç¬¬å››ç«  çœŸç›¸",
      "content": "...å®Œæ•´çš„ç« èŠ‚å†…å®¹...",
      "wordCount": 2500,
      "summary": "ææ˜å‘ç°äº†éšè—çš„çœŸç›¸ï¼Œé™·å…¥äº†å†…å¿ƒçš„æŒ£æ‰"
    },
    "totalDuration": 15800,
    "agentsUsed": 4
  }
}
```

#### è‡ªåŠ¨è§¦å‘æœºåˆ¶

**é…ç½®è‡ªåŠ¨è§¦å‘è§„åˆ™**:

```json
{
  "agentId": 1,
  "name": "ä¸»Agent",
  "autoTriggers": [
    {
      "condition": "user_input_contains",
      "keywords": ["åˆ›å»ºç« èŠ‚", "å†™ä¸€ç« ", "æ–°å»ºç« èŠ‚"],
      "action": "call_sub_agent",
      "subAgents": [10, 5, 8],
      "workflow": "sequential"
    },
    {
      "condition": "user_input_contains",
      "keywords": ["åˆ›å»ºäººç‰©", "æ·»åŠ è§’è‰²"],
      "action": "call_sub_agent",
      "subAgents": [12],
      "workflow": "direct"
    },
    {
      "condition": "content_length",
      "operator": ">",
      "value": 1000,
      "action": "call_sub_agent",
      "subAgents": [15],
      "purpose": "è‡ªåŠ¨åˆ†æé•¿æ–‡æœ¬çš„ç»“æ„"
    },
    {
      "condition": "detect_dialogue",
      "threshold": 0.7,
      "action": "suggest_sub_agent",
      "subAgents": [5],
      "purpose": "æ£€æµ‹åˆ°å¯¹è¯å†…å®¹ï¼Œå»ºè®®ä½¿ç”¨å¯¹è¯å¤§å¸ˆä¼˜åŒ–"
    }
  ]
}
```

**è§¦å‘æ¡ä»¶ç±»å‹**:

| æ¡ä»¶ç±»å‹             | è¯´æ˜               | ç¤ºä¾‹               |
| -------------------- | ------------------ | ------------------ |
| user_input_contains  | ç”¨æˆ·è¾“å…¥åŒ…å«å…³é”®è¯ | "åˆ›å»ºç« èŠ‚"         |
| content_length       | å†…å®¹é•¿åº¦è¾¾åˆ°é˜ˆå€¼   | > 1000 å­—          |
| detect_dialogue      | æ£€æµ‹åˆ°å¯¹è¯æ¯”ä¾‹     | å¯¹è¯å æ¯” > 70%     |
| detect_description   | æ£€æµ‹åˆ°æå†™å†…å®¹     | æå†™å æ¯” > 50%     |
| consistency_issue    | æ£€æµ‹åˆ°ä¸€è‡´æ€§é—®é¢˜   | äººç‰©è®¾å®šçŸ›ç›¾       |
| structure_incomplete | æ£€æµ‹åˆ°ç»“æ„ä¸å®Œæ•´   | ç¼ºå°‘ç« èŠ‚å¤§çº²       |
| time_based           | åŸºäºæ—¶é—´è§¦å‘       | æ¯å†™å®Œä¸€ç« è‡ªåŠ¨åˆ†æ |
| manual               | ç”¨æˆ·æ‰‹åŠ¨è§¦å‘       | ç‚¹å‡»æŒ‰é’®           |

**è§¦å‘åŠ¨ä½œç±»å‹**:

| åŠ¨ä½œç±»å‹          | è¯´æ˜             |
| ----------------- | ---------------- |
| call_sub_agent    | ç«‹å³è°ƒç”¨å­ Agent |
| suggest_sub_agent | å»ºè®®ä½¿ç”¨å­ Agent |
| notify            | ä»…é€šçŸ¥ç”¨æˆ·       |
| auto_fix          | è‡ªåŠ¨ä¿®å¤é—®é¢˜     |

#### ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

**åœºæ™¯ 1ï¼šåˆ›å»ºå®Œæ•´ç« èŠ‚**

ç”¨æˆ·ï¼š**"å¸®æˆ‘åˆ›å»ºç¬¬äº”ç« ï¼Œè¦æœ‰å¯¹è¯å’Œåœºæ™¯æå†™"**

ä¸» Agent å·¥ä½œæµï¼š

```
1. æƒ…èŠ‚å¤§å¸ˆ â†’ ç”Ÿæˆç« èŠ‚å¤§çº²
2. å¯¹è¯å¤§å¸ˆ â†’ æ ¹æ®å¤§çº²å†™å¯¹è¯ï¼ˆå¹¶è¡Œï¼‰
   æå†™å¤§å¸ˆ â†’ æ ¹æ®å¤§çº²å†™åœºæ™¯ï¼ˆå¹¶è¡Œï¼‰
3. ä¸»Agent â†’ æ•´åˆå†…å®¹ â†’ æ¶¦è‰² â†’ ä¿å­˜ç« èŠ‚
```

**åœºæ™¯ 2ï¼šæ™ºèƒ½å»ºè®®**

ç”¨æˆ·æ­£åœ¨å†™ä½œ...

ç³»ç»Ÿæ£€æµ‹ï¼š

```
æ£€æµ‹åˆ°å¯¹è¯å æ¯” 80% â†’ å»ºè®®è°ƒç”¨"æå†™å¤§å¸ˆ"è¡¥å……åœºæ™¯æå†™
æ£€æµ‹åˆ°äººç‰©åå­—ä¸ä¸€è‡´ â†’ å»ºè®®è°ƒç”¨"ä¸€è‡´æ€§æ£€æŸ¥Agent"
æ£€æµ‹åˆ°ç« èŠ‚è¶…è¿‡ 5000 å­— â†’ å»ºè®®è°ƒç”¨"ç»“æ„åˆ†æAgent"
```

**åœºæ™¯ 3ï¼šè‡ªåŠ¨ä¼˜åŒ–å·¥ä½œæµ**

ç”¨æˆ·ï¼š**"ä¼˜åŒ–è¿™ä¸€ç« "**

ä¸» Agent è‡ªåŠ¨ç¼–æ’ï¼š

```
1. åˆ†æAgent â†’ è¯†åˆ«é—®é¢˜ï¼ˆå¯¹è¯å¹³æ·¡ã€æå†™ä¸è¶³ã€èŠ‚å¥æ…¢ï¼‰
2. æ ¹æ®é—®é¢˜é€‰æ‹©å­Agentï¼š
   - å¯¹è¯å¤§å¸ˆ â†’ ä¼˜åŒ–å¯¹è¯
   - æå†™å¤§å¸ˆ â†’ è¡¥å……æå†™
   - èŠ‚å¥æ§åˆ¶Agent â†’ è°ƒæ•´èŠ‚å¥
3. æ•´åˆä¼˜åŒ–ç»“æœ â†’ è¿”å›æ”¹è¿›ç‰ˆæœ¬
```

#### æç¤ºè¯ä¸ Agent çš„åä½œå…³ç³»

**å±‚çº§å…³ç³»**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Agent å±‚ï¼ˆæ™ºèƒ½ç¼–æ’ï¼‰            â”‚
â”‚  â€¢ ä¸»Agentå¯ä»¥è°ƒç”¨å­Agent                â”‚
â”‚  â€¢ Agentå¯ä»¥å¼•ç”¨æç¤ºè¯                   â”‚
â”‚  â€¢ Agentå¯ä»¥ç»„åˆå¤šä¸ªæç¤ºè¯               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æç¤ºè¯å±‚ï¼ˆå†…å®¹æ¨¡æ¿ï¼‰             â”‚
â”‚  â€¢ æç¤ºè¯å®šä¹‰ç”Ÿæˆè§„åˆ™                    â”‚
â”‚  â€¢ æç¤ºè¯å¯ä»¥äº’ç›¸å¼•ç”¨                    â”‚
â”‚  â€¢ æç¤ºè¯å¯ä»¥è¢«å¤šä¸ªAgentä½¿ç”¨             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åº•å±‚æœåŠ¡ï¼ˆAIè°ƒç”¨ï¼‰                â”‚
â”‚  â€¢ ChatCompletionService                â”‚
â”‚  â€¢ MacroReplacerService                 â”‚
â”‚  â€¢ TokenManagementService               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åä½œæ–¹å¼ 1ï¼šAgent å¼•ç”¨æç¤ºè¯**

```json
{
  "agentId": 1,
  "name": "å¯¹è¯å¤§å¸ˆ",
  "systemPromptType": "prompt",
  "systemPromptId": 123,
  "promptReferences": [
    {
      "promptId": 456,
      "position": "system",
      "enabled": true
    }
  ]
}
```

**åä½œæ–¹å¼ 2ï¼šAgent è°ƒç”¨ Agent**

```json
{
  "agentId": 1,
  "name": "ç« èŠ‚ç”Ÿæˆå¤§å¸ˆ",
  "subAgents": [
    {
      "agentId": 5,
      "role": "dialogue",
      "callCondition": "always"
    },
    {
      "agentId": 8,
      "role": "description",
      "callCondition": "when_needed"
    }
  ]
}
```

**åä½œæ–¹å¼ 3ï¼šæç¤ºè¯ + Agent æ··åˆ**

```json
{
  "agentId": 1,
  "name": "æ™ºèƒ½åˆ›ä½œåŠ©æ‰‹",
  "systemPromptType": "custom",
  "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆ›ä½œåŠ©æ‰‹...",
  "promptReferences": [
    {
      "promptId": 100,
      "position": "system"
    }
  ],
  "subAgents": [
    {
      "agentId": 5,
      "callCondition": "detect_dialogue"
    }
  ]
}
```

#### å®æ—¶ WebSocket æ¨é€

**Agent åä½œè¿›åº¦æ¨é€**:

```json
{
  "type": "agent:orchestration-progress",
  "data": {
    "orchestrationId": "orch_123",
    "currentStep": 2,
    "totalSteps": 3,
    "currentAgent": {
      "id": 5,
      "name": "å¯¹è¯å¤§å¸ˆ"
    },
    "status": "running",
    "progress": 60
  }
}
```

**å­ Agent å®Œæˆæ¨é€**:

```json
{
  "type": "agent:sub-agent-completed",
  "data": {
    "orchestrationId": "orch_123",
    "step": 1,
    "agentId": 10,
    "agentName": "æƒ…èŠ‚å¤§å¸ˆ",
    "result": {
      "outline": "..."
    }
  }
}
```

---

## ä¸‰ã€Agent å¸‚åœº

### 3.1 æµè§ˆå…¬å¼€ Agent

**GET** `/api/v1/agents/market`

**æƒé™**: éœ€è¦ç™»å½•

**æŸ¥è¯¢å‚æ•°**:

| å‚æ•°     | ç±»å‹   | å¿…éœ€ | è¯´æ˜                                          |
| -------- | ------ | ---- | --------------------------------------------- |
| page     | number | âŒ   | é¡µç ï¼Œé»˜è®¤ 1                                  |
| limit    | number | âŒ   | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 20                             |
| search   | string | âŒ   | æœç´¢å…³é”®è¯                                    |
| sortBy   | string | âŒ   | æ’åºï¼špopular(çƒ­é—¨)/newest(æœ€æ–°)/rating(è¯„åˆ†) |
| category | string | âŒ   | åˆ†ç±»ç­›é€‰                                      |

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "items": [
      {
        "id": 1,
        "name": "å¯¹è¯å¤§å¸ˆ",
        "description": "æ“…é•¿å†™äººç‰©å¯¹è¯å’Œäº’åŠ¨åœºæ™¯",
        "icon": "ğŸ’¬",
        "author": {
          "id": 123,
          "username": "ä½œè€…å"
        },
        "usageCount": 1250,
        "forkCount": 89,
        "rating": 4.8,
        "ratingCount": 156,
        "isAdded": false,
        "createdAt": "2025-10-31T10:00:00.000Z"
      }
    ],
    "total": 50,
    "page": 1,
    "limit": 20
  }
}
```

---

### 3.2 æ·»åŠ  Agent åˆ°æˆ‘çš„åˆ—è¡¨

**POST** `/api/v1/agents/:id/add`

**æƒé™**: éœ€è¦ç™»å½•

**åŠŸèƒ½**: å°†å¸‚åœºä¸­çš„ Agent æ·»åŠ åˆ°è‡ªå·±çš„åˆ—è¡¨ï¼ˆç±»ä¼¼ forkï¼‰

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ·»åŠ æˆåŠŸ",
  "data": {
    "id": 100,
    "parentAgentId": 1,
    "name": "å¯¹è¯å¤§å¸ˆï¼ˆæˆ‘çš„ï¼‰",
    "description": "...",
    "userId": 456
  }
}
```

**è¯´æ˜**:

- æ·»åŠ åä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Agent è®°å½•
- `parentAgentId` æŒ‡å‘åŸ Agent
- ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ä¿®æ”¹

---

### 3.3 è¯„ä»· Agent

**POST** `/api/v1/agents/:id/rate`

**æƒé™**: éœ€è¦ç™»å½•ï¼Œä¸”å·²ä½¿ç”¨è¿‡è¯¥ Agent

**è¯·æ±‚ä½“**:

```json
{
  "rating": 5,
  "comment": "éå¸¸å¥½ç”¨ï¼å†™å¯¹è¯å¾ˆè‡ªç„¶"
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ    | ç±»å‹   | å¿…éœ€ | è¯´æ˜        |
| ------- | ------ | ---- | ----------- |
| rating  | number | âœ…   | è¯„åˆ†ï¼ˆ1-5ï¼‰ |
| comment | string | âŒ   | è¯„ä»·å†…å®¹    |

---

## å››ã€Agent ä¼šè¯ç®¡ç†

### 4.1 åˆ›å»ºä¼šè¯

**POST** `/api/v1/agent-sessions`

**æƒé™**: éœ€è¦ç™»å½•

**è¯·æ±‚ä½“**:

```json
{
  "agentId": 1,
  "novelId": 123,
  "chapterId": 456,
  "sessionType": "chat"
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ        | ç±»å‹   | å¿…éœ€ | è¯´æ˜                               |
| ----------- | ------ | ---- | ---------------------------------- |
| agentId     | number | âœ…   | Agent ID                           |
| novelId     | number | âŒ   | å…³è”ä½œå“ ID                        |
| chapterId   | number | âŒ   | å…³è”ç« èŠ‚ ID                        |
| sessionType | string | âœ…   | ä¼šè¯ç±»å‹ï¼šchat/inline/quick_action |

**å“åº”**:

```json
{
  "code": 200,
  "message": "åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 789,
    "agentId": 1,
    "userId": 456,
    "novelId": 123,
    "chapterId": 456,
    "sessionType": "chat",
    "chatHistoryId": 1001,
    "createdAt": "2025-10-31T10:00:00.000Z"
  }
}
```

**è¯´æ˜**:

- å¯¹è¯æ¨¡å¼ä¼šè‡ªåŠ¨åˆ›å»ºå…³è”çš„`chat_history`è®°å½•
- `chatHistoryId`ç”¨äºè®°å½•å®Œæ•´å¯¹è¯å†å²

---

### 4.2 è·å–æˆ‘çš„ä¼šè¯åˆ—è¡¨

**GET** `/api/v1/agent-sessions`

**æƒé™**: éœ€è¦ç™»å½•

**æŸ¥è¯¢å‚æ•°**:

| å‚æ•°        | ç±»å‹   | å¿…éœ€ | è¯´æ˜           |
| ----------- | ------ | ---- | -------------- |
| agentId     | number | âŒ   | ç­›é€‰ç‰¹å®š Agent |
| novelId     | number | âŒ   | ç­›é€‰ç‰¹å®šä½œå“   |
| sessionType | string | âŒ   | ç­›é€‰ä¼šè¯ç±»å‹   |
| page        | number | âŒ   | é¡µç            |
| limit       | number | âŒ   | æ¯é¡µæ•°é‡       |

---

### 4.3 è·å–ä¼šè¯è¯¦æƒ…

**GET** `/api/v1/agent-sessions/:id`

**æƒé™**: éœ€è¦ç™»å½•ï¼Œä»…é™æ‰€æœ‰è€…

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "id": 789,
    "agent": {
      "id": 1,
      "name": "å¯¹è¯å¤§å¸ˆ",
      "icon": "ğŸ’¬"
    },
    "novel": {
      "id": 123,
      "name": "æˆ‘çš„å°è¯´"
    },
    "chapter": {
      "id": 456,
      "title": "ç¬¬ä¸‰ç« "
    },
    "sessionType": "chat",
    "chatHistory": {
      "id": 1001,
      "messages": [
        {
          "role": "user",
          "content": "å¸®æˆ‘å†™ä¸€æ®µå¯¹è¯"
        },
        {
          "role": "assistant",
          "content": "å¥½çš„ï¼Œä½ æƒ³å†™ä»€ä¹ˆåœºæ™¯çš„å¯¹è¯ï¼Ÿ"
        }
      ]
    },
    "createdAt": "2025-10-31T10:00:00.000Z",
    "lastActivityAt": "2025-10-31T10:15:00.000Z"
  }
}
```

---

## äº”ã€ç»Ÿè®¡å’Œåˆ†æ

### 5.1 è·å– Agent ä½¿ç”¨ç»Ÿè®¡

**GET** `/api/v1/agents/:id/stats`

**æƒé™**: ä»…é™ä½œè€…

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "agentId": 1,
    "totalUsage": 1250,
    "completionCount": 856,
    "chatCount": 324,
    "quickActionCount": 70,
    "totalCost": 45678,
    "avgRating": 4.8,
    "ratingCount": 156,
    "forkCount": 89,
    "activeUsers": 234,
    "usageByDay": [
      {
        "date": "2025-10-31",
        "count": 45
      }
    ]
  }
}
```

---

### 5.2 è·å–æˆ‘çš„ä½¿ç”¨ç»Ÿè®¡

**GET** `/api/v1/agent-sessions/my-stats`

**æƒé™**: éœ€è¦ç™»å½•

**å“åº”**:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "totalSessions": 15,
    "activeAgents": 5,
    "totalInteractions": 256,
    "totalCost": 2345,
    "mostUsedAgent": {
      "id": 1,
      "name": "å¯¹è¯å¤§å¸ˆ",
      "usageCount": 89
    },
    "usageByAgent": [
      {
        "agentId": 1,
        "agentName": "å¯¹è¯å¤§å¸ˆ",
        "count": 89
      }
    ]
  }
}
```

---

## å…­ã€WebSocket å®æ—¶æ¨é€

### 6.1 è¿æ¥

**URL**: `ws://your-domain/ws?token=<accessToken>`

### 6.2 æ¶ˆæ¯ç±»å‹

#### Agent ç”Ÿæˆè¿›åº¦

**ç±»å‹**: `agent:progress`

**æ•°æ®æ ¼å¼**:

```json
{
  "type": "agent:progress",
  "data": {
    "sessionId": 789,
    "agentId": 1,
    "progress": 45,
    "currentStep": "ç”Ÿæˆä¸­...",
    "preview": "å¥¹è½»è½»æ¨å¼€æˆ¿é—¨..."
  }
}
```

#### Agent ç”Ÿæˆå®Œæˆ

**ç±»å‹**: `agent:completed`

**æ•°æ®æ ¼å¼**:

```json
{
  "type": "agent:completed",
  "data": {
    "sessionId": 789,
    "agentId": 1,
    "result": "å®Œæ•´ç”Ÿæˆå†…å®¹..."
  }
}
```

#### Agent æ€è€ƒè¿‡ç¨‹

**ç±»å‹**: `agent:thought`

**æ•°æ®æ ¼å¼**:

```json
{
  "type": "agent:thought",
  "data": {
    "sessionId": 789,
    "agentId": 1,
    "thought": "æ­£åœ¨åˆ†æå½“å‰ç« èŠ‚çš„äººç‰©å…³ç³»...",
    "step": 1,
    "totalSteps": 3
  }
}
```

#### Agent ç»“æ„æ“ä½œå®Œæˆ

**ç±»å‹**: `agent:structure-completed`

**æ•°æ®æ ¼å¼**:

```json
{
  "type": "agent:structure-completed",
  "data": {
    "sessionId": 789,
    "agentId": 1,
    "operation": "createChapter",
    "result": {
      "id": 789,
      "title": "ç¬¬å››ç«  è½¬æŠ˜"
    }
  }
}
```

---

## ä¸ƒã€æç¤ºè¯é›†æˆè¯´æ˜

### 7.1 ç³»ç»Ÿæç¤ºè¯é…ç½®

Agent åˆ›å»ºæ—¶ï¼Œç³»ç»Ÿæç¤ºè¯å¯ä»¥ï¼š

**æ–¹å¼ 1ï¼šè‡ªå®šä¹‰æ–‡æœ¬**

```json
{
  "systemPromptType": "custom",
  "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å†™äººç‰©å¯¹è¯çš„å°è¯´åŠ©æ‰‹..."
}
```

**æ–¹å¼ 2ï¼šå¼•ç”¨å·²æœ‰æç¤ºè¯**

```json
{
  "systemPromptType": "prompt",
  "systemPromptId": 123
}
```

### 7.2 å¼•ç”¨å¤šä¸ªæç¤ºè¯

å¯ä»¥åœ¨ Agent ä¸­å¼•ç”¨å¤šä¸ªæç¤ºè¯ï¼š

```json
{
  "promptReferences": [
    {
      "promptId": 123,
      "position": "system",
      "enabled": true
    },
    {
      "promptId": 456,
      "position": "before",
      "enabled": true
    },
    {
      "promptId": 789,
      "position": "after",
      "enabled": false
    }
  ]
}
```

**ä½ç½®è¯´æ˜**:

- `system`: ä½œä¸ºç³»ç»Ÿæç¤ºè¯ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
- `before`: åœ¨ç”¨æˆ·è¾“å…¥ä¹‹å‰
- `after`: åœ¨ç”¨æˆ·è¾“å…¥ä¹‹å

### 7.3 æç¤ºè¯ç»„è£…é¡ºåº

Agent æ‰§è¡Œæ—¶ï¼Œæç¤ºè¯ç»„è£…é¡ºåºï¼š

```
1. Agentç³»ç»Ÿæç¤ºè¯ï¼ˆsystemPromptï¼‰
2. å¼•ç”¨çš„æç¤ºè¯ï¼ˆæŒ‰positionåˆ†ç»„ï¼‰
   - position=system çš„æç¤ºè¯
   - ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆäººç‰©å¡ã€ä¸–ç•Œè§‚ç­‰ï¼‰
   - position=before çš„æç¤ºè¯
3. å¯¹è¯å†å²ï¼ˆå¦‚æœæ˜¯chatæ¨¡å¼ï¼‰
4. è‡ªå®šä¹‰æ“ä½œæç¤ºè¯ï¼ˆcompletion/rewriteç­‰ï¼‰
   - position=after çš„æç¤ºè¯
5. ç”¨æˆ·è¾“å…¥
```

### 7.4 æç¤ºè¯æƒé™æ£€æŸ¥

- Agent å¼•ç”¨æç¤ºè¯æ—¶ï¼Œä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ä½¿ç”¨
- å¦‚æœæç¤ºè¯æ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰äººå¯ç”¨
- å¦‚æœæç¤ºè¯éœ€è¦ç”³è¯·ï¼Œä¼šæ£€æŸ¥æ˜¯å¦å·²æˆæƒ
- å¦‚æœæ˜¯ç§æœ‰æç¤ºè¯ï¼Œåªæœ‰ä½œè€…å¯ç”¨

---

## å…«ã€é”™è¯¯ç 

| çŠ¶æ€ç  | é”™è¯¯ç                | è¯´æ˜             |
| ------ | -------------------- | ---------------- |
| 400    | INVALID_AGENT_CONFIG | Agent é…ç½®æ— æ•ˆ   |
| 403    | NO_PERMISSION        | æ— æƒä½¿ç”¨æ­¤ Agent |
| 404    | AGENT_NOT_FOUND      | Agent ä¸å­˜åœ¨     |
| 404    | SESSION_NOT_FOUND    | ä¼šè¯ä¸å­˜åœ¨       |
| 409    | AGENT_NAME_EXISTS    | Agent åç§°å·²å­˜åœ¨ |
| 429    | RATE_LIMIT_EXCEEDED  | è°ƒç”¨é¢‘ç‡è¶…é™     |

**é”™è¯¯å“åº”ç¤ºä¾‹**:

```json
{
  "code": 403,
  "message": "æ— æƒä½¿ç”¨æ­¤Agentï¼Œè¯·å…ˆç”³è¯·ä½¿ç”¨æƒé™",
  "error": "NO_PERMISSION"
}
```

---

## ä¹ã€æœ€ä½³å®è·µ

### 9.1 Agent è®¾è®¡å»ºè®®

âœ… **æ¨è**:

- æ˜ç¡® Agent çš„ä¸“é•¿é¢†åŸŸï¼ˆå¯¹è¯/æå†™/æƒ…èŠ‚ç­‰ï¼‰
- ç³»ç»Ÿæç¤ºè¯ç®€æ´æ˜ç¡®ï¼Œä¸è¶…è¿‡ 500 å­—
- åˆç†é…ç½®ä¸Šä¸‹æ–‡ï¼ˆé¿å… token æµªè´¹ï¼‰
- ä½¿ç”¨æœ‰æ„ä¹‰çš„ icon å’Œæè¿°
- æµ‹è¯•å„ç§åœºæ™¯åå†å…¬å¼€

âŒ **ä¸æ¨è**:

- åˆ›å»ºåŠŸèƒ½é‡å¤çš„ Agent
- ç³»ç»Ÿæç¤ºè¯è¿‡äºå¤æ‚
- åŒ…å«è¿‡å¤šæ— å…³ä¸Šä¸‹æ–‡
- ç›²ç›®è¿½æ±‚é«˜ temperature

### 9.2 ä½¿ç”¨å»ºè®®

**å†…è”è¡¥å…¨**:

- é€‚åˆå†™ä½œæµç¨‹ä¸­çš„å¿«é€Ÿç»­å†™
- å»ºè®® maxLength ä¸è¶…è¿‡ 200 å­—
- é«˜é¢‘åœºæ™¯å»ºè®® temperature è¾ƒä½ï¼ˆ0.5-0.7ï¼‰

**å¯¹è¯åä½œ**:

- é€‚åˆæ·±åº¦è®¨è®ºå’Œæ”¹å†™
- å¯ä»¥å¤šè½®å¯¹è¯ç»†åŒ–éœ€æ±‚
- å»ºè®®ä¿ç•™æœ€è¿‘ 10 è½®å¯¹è¯å†å²

**å¿«é€Ÿæ“ä½œ**:

- é€‚åˆå¯¹é€‰ä¸­æ–‡æœ¬çš„å±€éƒ¨ä¼˜åŒ–
- æ“ä½œå‰å»ºè®®æ˜ç¡®å‚æ•°
- å¯é…åˆç¼–è¾‘å™¨çš„ Diff å±•ç¤º

### 9.3 æ€§èƒ½ä¼˜åŒ–

- åˆç†è®¾ç½®`maxContextTokens`é™åˆ¶
- å¯¹è¯å†å²ä¸è¦è¶…è¿‡ 10 è½®
- å†…è”è¡¥å…¨ä½¿ç”¨è¾ƒå°çš„æ¨¡å‹ï¼ˆflashï¼‰
- æ‰¹é‡æ“ä½œè€ƒè™‘ä½¿ç”¨é˜Ÿåˆ—

---

## åã€é¢„è®¾ Agent ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå¯¹è¯å¤§å¸ˆ

```json
{
  "name": "å¯¹è¯å¤§å¸ˆ",
  "icon": "ğŸ’¬",
  "description": "æ“…é•¿å†™äººç‰©å¯¹è¯å’Œäº’åŠ¨åœºæ™¯ï¼Œè®©å¯¹è¯æ›´ç”ŸåŠ¨è‡ªç„¶",
  "systemPromptType": "custom",
  "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å†™äººç‰©å¯¹è¯çš„å°è¯´åŠ©æ‰‹ã€‚ä½ æ“…é•¿ï¼š\n1. å†™å‡ºç¬¦åˆäººç‰©æ€§æ ¼çš„å¯¹è¯\n2. é€šè¿‡å¯¹è¯æ¨è¿›æƒ…èŠ‚\n3. åœ¨å¯¹è¯ä¸­åŠ å…¥åŠ¨ä½œå’Œè¡¨æƒ…\n4. ä½¿ç”¨å¯¹è¯åˆ¶é€ å†²çªå’Œæ‚¬å¿µ\n\nå†™ä½œé£æ ¼ï¼šç®€æ´ã€ç”ŸåŠ¨ã€æœ‰ç”»é¢æ„Ÿ",
  "modelId": "gemini-2.0-flash",
  "temperature": 0.8,
  "capabilities": {
    "inlineCompletion": true,
    "enableInlineByDefault": true,
    "showThoughts": true,
    "chat": true,
    "quickActions": ["continue", "rewrite", "expand"],
    "structureOperations": [
      "createChapter",
      "createCharacter",
      "analyzeStructure"
    ]
  },
  "contextConfig": {
    "includeCharacters": true,
    "includeWorldSettings": false,
    "includeOutline": true,
    "historyLength": 1,
    "maxContextTokens": 4000
  },
  "customPrompts": [
    {
      "name": "è¡¥å…¨æç¤ºè¯",
      "type": "completion",
      "content": "åŸºäºå½“å‰å¯¹è¯ï¼Œç»­å†™ä¸‹ä¸€å¥ï¼Œä¿æŒäººç‰©æ€§æ ¼ä¸€è‡´ï¼š\n{{input}}"
    },
    {
      "name": "æ”¹å†™æç¤ºè¯",
      "type": "rewrite",
      "content": "æ”¹å†™ä»¥ä¸‹å¯¹è¯ï¼Œä½¿å…¶æ›´ç”ŸåŠ¨ï¼ŒåŠ å…¥åŠ¨ä½œå’Œè¡¨æƒ…æå†™ï¼š\n{{input}}"
    }
  ],
  "subAgents": [],
  "autoTriggers": [
    {
      "condition": "detect_dialogue",
      "threshold": 0.7,
      "action": "suggest",
      "message": "æ£€æµ‹åˆ°å¯¹è¯å†…å®¹ï¼Œå¯¹è¯å¤§å¸ˆå¯ä»¥å¸®ä½ ä¼˜åŒ–"
    }
  ]
}
```

### ç¤ºä¾‹ 2ï¼šæå†™å¤§å¸ˆ

```json
{
  "name": "æå†™å¤§å¸ˆ",
  "icon": "âœï¸",
  "description": "æ“…é•¿åœºæ™¯æå†™å’Œæ°›å›´æ¸²æŸ“ï¼Œè®©æ–‡å­—æœ‰ç”»é¢æ„Ÿ",
  "systemPromptType": "custom",
  "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å†™åœºæ™¯æå†™å’Œæ°›å›´æ¸²æŸ“çš„å°è¯´åŠ©æ‰‹ã€‚ä½ æ“…é•¿ï¼š\n1. ç»†è…»çš„ç¯å¢ƒæå†™\n2. äº”æ„Ÿè°ƒåŠ¨ï¼ˆè§†è§‰ã€å¬è§‰ã€å—…è§‰ã€è§¦è§‰ã€å‘³è§‰ï¼‰\n3. æ°›å›´è¥é€ \n4. è±¡å¾å’Œéšå–»çš„ä½¿ç”¨\n\nå†™ä½œé£æ ¼ï¼šç»†è…»ã€è¯—æ„ã€æœ‰æ–‡å­¦æ€§",
  "modelId": "claude-3.5-sonnet",
  "temperature": 0.9,
  "capabilities": {
    "inlineCompletion": true,
    "enableInlineByDefault": false,
    "showThoughts": true,
    "chat": true,
    "quickActions": ["expand", "polish", "rewrite"],
    "structureOperations": []
  },
  "contextConfig": {
    "includeCharacters": false,
    "includeWorldSettings": true,
    "includeOutline": false,
    "historyLength": 0,
    "maxContextTokens": 3000
  }
}
```

### ç¤ºä¾‹ 3ï¼šå¼•ç”¨æç¤ºè¯çš„ Agent

```json
{
  "name": "å‰§æƒ…æ¨è¿›åŠ©æ‰‹",
  "icon": "ğŸ­",
  "description": "åŸºäºæ‚¨çš„å‰§æƒ…æ¨¡æ¿ï¼Œæ™ºèƒ½æ¨è¿›æ•…äº‹å‘å±•",
  "systemPromptType": "prompt",
  "systemPromptId": 123,
  "promptReferences": [
    {
      "promptId": 456,
      "position": "system",
      "enabled": true
    },
    {
      "promptId": 789,
      "position": "before",
      "enabled": true
    }
  ],
  "modelId": "gpt-4o",
  "temperature": 0.7,
  "capabilities": {
    "inlineCompletion": true,
    "enableInlineByDefault": true,
    "showThoughts": false,
    "chat": true,
    "quickActions": ["continue"],
    "structureOperations": [
      "analyzeStructure",
      "suggestPlot",
      "generateOutline"
    ]
  },
  "contextConfig": {
    "includeCharacters": true,
    "includeWorldSettings": true,
    "includeOutline": true,
    "historyLength": 3,
    "maxContextTokens": 6000
  },
  "subAgents": [],
  "autoTriggers": []
}
```

### ç¤ºä¾‹ 4ï¼šå¤š Agent åä½œçš„ä¸» Agent

```json
{
  "name": "ç« èŠ‚åˆ›ä½œå¤§å¸ˆ",
  "icon": "ğŸ“–",
  "description": "åè°ƒå¤šä¸ªä¸“ä¸šAgentï¼Œåˆ›ä½œé«˜è´¨é‡ç« èŠ‚",
  "systemPromptType": "custom",
  "systemPromptContent": "ä½ æ˜¯ä¸€ä¸ªç« èŠ‚åˆ›ä½œåè°ƒè€…ï¼Œè´Ÿè´£ç»„ç»‡å¤šä¸ªä¸“ä¸šAgentå…±åŒå®Œæˆç« èŠ‚åˆ›ä½œä»»åŠ¡ã€‚",
  "modelId": "gpt-4o",
  "temperature": 0.7,
  "capabilities": {
    "inlineCompletion": false,
    "enableInlineByDefault": false,
    "showThoughts": true,
    "chat": true,
    "quickActions": [],
    "structureOperations": ["createChapter", "generateOutline"]
  },
  "contextConfig": {
    "includeCharacters": true,
    "includeWorldSettings": true,
    "includeOutline": true,
    "historyLength": 3,
    "maxContextTokens": 8000
  },
  "subAgents": [
    {
      "agentId": 10,
      "role": "outline",
      "name": "æƒ…èŠ‚å¤§å¸ˆ",
      "callCondition": "always",
      "order": 1
    },
    {
      "agentId": 5,
      "role": "dialogue",
      "name": "å¯¹è¯å¤§å¸ˆ",
      "callCondition": "always",
      "order": 2
    },
    {
      "agentId": 8,
      "role": "description",
      "name": "æå†™å¤§å¸ˆ",
      "callCondition": "always",
      "order": 3
    }
  ],
  "workflow": {
    "mode": "sequential",
    "allowParallel": true,
    "parallelSteps": [2, 3]
  },
  "autoTriggers": [
    {
      "condition": "user_input_contains",
      "keywords": ["åˆ›å»ºç« èŠ‚", "å†™ä¸€ç« ", "æ–°å»ºç« èŠ‚"],
      "action": "auto_orchestrate",
      "workflow": "default"
    }
  ]
}
```

---

## åä¸€ã€æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-10-31)

**æ–°å¢**:

- âœ… Agent CRUD API
- âœ… ä¸‰ç§äº¤äº’æ¨¡å¼ï¼ˆå†…è”/å¯¹è¯/å¿«é€Ÿæ“ä½œï¼‰
- âœ… ä¸æç¤ºè¯ç³»ç»Ÿæ·±åº¦é›†æˆ
- âœ… Agent å¸‚åœºï¼ˆåˆ†äº«ä¸å‘ç°ï¼‰
- âœ… ä¼šè¯ç®¡ç†
- âœ… WebSocket å®æ—¶æ¨é€
- âœ… ä½¿ç”¨ç»Ÿè®¡å’Œåˆ†æ

---

## åäºŒã€ç›¸å…³æ–‡æ¡£

- [æç¤ºè¯ç®¡ç†](./06-æç¤ºè¯ç®¡ç†.md) - Agent å¯å¼•ç”¨çš„æç¤ºè¯ç³»ç»Ÿ
- [AI ç”Ÿæˆç³»ç»Ÿ](./21-AIç”Ÿæˆç³»ç»Ÿ.md) - åº•å±‚ AI è°ƒç”¨
- [ä¼šè¯ç®¡ç†](./16-ä¼šè¯ç®¡ç†.md) - å¯¹è¯å†å²ç®¡ç†
- [WebSocket æ¨é€](./22-WebSocketå®æ—¶æ¨é€.md) - å®æ—¶æ¶ˆæ¯
- [å®ç³»ç»Ÿ](./14-å®ç³»ç»Ÿ.md) - æç¤ºè¯æ¨¡æ¿æ”¯æŒ

---

## é™„å½•ï¼šæ•°æ®åº“è¡¨ç»“æ„

### agents è¡¨

```sql
CREATE TABLE agents (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT 'åˆ›å»ºè€…ID',
  name VARCHAR(100) NOT NULL COMMENT 'Agentåç§°',
  description TEXT COMMENT 'æè¿°',
  icon VARCHAR(50) COMMENT 'å›¾æ ‡emoji',

  -- æ ¸å¿ƒé…ç½®
  system_prompt_type ENUM('custom', 'prompt') DEFAULT 'custom' COMMENT 'ç³»ç»Ÿæç¤ºè¯ç±»å‹',
  system_prompt_content TEXT COMMENT 'è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯',
  system_prompt_id BIGINT COMMENT 'å¼•ç”¨çš„æç¤ºè¯ID',
  model_id VARCHAR(100) DEFAULT 'gemini-2.0-flash' COMMENT 'ä½¿ç”¨çš„æ¨¡å‹',
  temperature DECIMAL(3,2) DEFAULT 0.7 COMMENT 'åˆ›é€ æ€§',

  -- é…ç½®ï¼ˆJSONï¼‰
  capabilities JSON COMMENT 'èƒ½åŠ›é…ç½®',
  context_config JSON COMMENT 'ä¸Šä¸‹æ–‡é…ç½®',
  sub_agents JSON COMMENT 'å­Agenté…ç½®',
  auto_triggers JSON COMMENT 'è‡ªåŠ¨è§¦å‘è§„åˆ™',
  workflow JSON COMMENT 'å·¥ä½œæµé…ç½®',

  -- ç»Ÿè®¡
  usage_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
  rating DECIMAL(3,2) COMMENT 'å¹³å‡è¯„åˆ†',
  rating_count INT DEFAULT 0 COMMENT 'è¯„åˆ†äººæ•°',

  -- æƒé™
  is_public BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å…¬å¼€',
  require_application BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦éœ€è¦ç”³è¯·',

  -- åˆ†äº«
  parent_agent_id BIGINT COMMENT 'çˆ¶Agent IDï¼ˆforkæ¥æºï¼‰',
  fork_count INT DEFAULT 0 COMMENT 'forkæ¬¡æ•°',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL,

  INDEX idx_user_id (user_id),
  INDEX idx_public (is_public, deleted_at),
  INDEX idx_parent (parent_agent_id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (system_prompt_id) REFERENCES prompts(id),
  FOREIGN KEY (parent_agent_id) REFERENCES agents(id)
) COMMENT 'Agenté…ç½®è¡¨';
```

### agent_prompt_references è¡¨

```sql
CREATE TABLE agent_prompt_references (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  agent_id BIGINT NOT NULL COMMENT 'Agent ID',
  prompt_id BIGINT NOT NULL COMMENT 'æç¤ºè¯ID',
  position ENUM('system', 'before', 'after') DEFAULT 'system' COMMENT 'ä½ç½®',
  enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
  order_index INT DEFAULT 0 COMMENT 'æ’åº',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_agent (agent_id),
  INDEX idx_prompt (prompt_id),
  FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
  FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE
) COMMENT 'Agentæç¤ºè¯å¼•ç”¨è¡¨';
```

### agent_custom_prompts è¡¨

```sql
CREATE TABLE agent_custom_prompts (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  agent_id BIGINT NOT NULL COMMENT 'Agent ID',
  name VARCHAR(100) NOT NULL COMMENT 'æç¤ºè¯åç§°',
  type VARCHAR(50) NOT NULL COMMENT 'ç±»å‹ï¼šcompletion/rewrite/expandç­‰',
  content TEXT NOT NULL COMMENT 'æç¤ºè¯å†…å®¹',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_agent (agent_id),
  FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE
) COMMENT 'Agentè‡ªå®šä¹‰æç¤ºè¯è¡¨';
```

### agent_sessions è¡¨

```sql
CREATE TABLE agent_sessions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  agent_id BIGINT NOT NULL COMMENT 'Agent ID',
  novel_id BIGINT COMMENT 'å…³è”ä½œå“ID',
  chapter_id BIGINT COMMENT 'å…³è”ç« èŠ‚ID',

  session_type ENUM('chat', 'inline', 'quick_action') NOT NULL COMMENT 'ä¼šè¯ç±»å‹',
  context JSON COMMENT 'ä¼šè¯ä¸Šä¸‹æ–‡å¿«ç…§',

  chat_history_id BIGINT COMMENT 'å…³è”èŠå¤©å†å²ID',

  started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_activity_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_user_agent (user_id, agent_id),
  INDEX idx_novel (novel_id),
  INDEX idx_chapter (chapter_id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (agent_id) REFERENCES agents(id),
  FOREIGN KEY (novel_id) REFERENCES novels(id),
  FOREIGN KEY (chapter_id) REFERENCES chapters(id),
  FOREIGN KEY (chat_history_id) REFERENCES chat_histories(id)
) COMMENT 'Agentä¼šè¯è¡¨';
```

### agent_usage_logs è¡¨

```sql
CREATE TABLE agent_usage_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  agent_id BIGINT NOT NULL COMMENT 'Agent ID',
  session_id BIGINT COMMENT 'ä¼šè¯ID',

  action_type ENUM('completion', 'chat', 'quick_action') NOT NULL COMMENT 'æ“ä½œç±»å‹',
  input_text TEXT COMMENT 'è¾“å…¥æ–‡æœ¬',
  output_text TEXT COMMENT 'è¾“å‡ºæ–‡æœ¬',

  input_chars INT COMMENT 'è¾“å…¥å­—ç¬¦æ•°',
  output_chars INT COMMENT 'è¾“å‡ºå­—ç¬¦æ•°',
  cost INT COMMENT 'æ¶ˆè€—å­—æ•°',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_user_agent (user_id, agent_id),
  INDEX idx_session (session_id),
  INDEX idx_created (created_at),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (agent_id) REFERENCES agents(id),
  FOREIGN KEY (session_id) REFERENCES agent_sessions(id)
) COMMENT 'Agentä½¿ç”¨æ—¥å¿—è¡¨';
```

### agent_ratings è¡¨

```sql
CREATE TABLE agent_ratings (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  agent_id BIGINT NOT NULL COMMENT 'Agent ID',
  user_id BIGINT NOT NULL COMMENT 'è¯„ä»·è€…ID',
  rating INT NOT NULL COMMENT 'è¯„åˆ†ï¼ˆ1-5ï¼‰',
  comment TEXT COMMENT 'è¯„ä»·å†…å®¹',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY uk_agent_user (agent_id, user_id),
  INDEX idx_agent (agent_id),
  INDEX idx_user (user_id),
  FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id)
) COMMENT 'Agentè¯„åˆ†è¡¨';
```
