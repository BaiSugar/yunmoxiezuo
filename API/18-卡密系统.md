# 18. 卡密系统 API

## 概述

卡密系统支持批量生成卡密、用户兑换、使用记录追踪等功能。

**模块路径**: `backend/src/redemption-codes/`

---

## 卡密管理

### 1. 创建单个卡密

**接口**: `POST /api/v1/redemption-codes`

**权限**: `redemption:code:create`

**请求体**:
```json
{
  "type": "mixed",
  "membershipPlanId": 2,
  "tokenAmount": 500000,
  "batchId": "BATCH-2025-001",
  "maxUseCount": 1,
  "validFrom": "2025-01-26T00:00:00.000Z",
  "validTo": "2025-12-31T23:59:59.999Z",
  "remark": "春节活动卡密"
}
```

**字段说明**:
- `type` (必需): 卡密类型
  - `membership`: 仅会员
  - `token`: 仅字数
  - `mixed`: 会员 + 字数
- `membershipPlanId`: 会员套餐ID（type 为 membership 或 mixed 时必需）
- `tokenAmount`: 赠送字数（type 为 token 或 mixed 时必需）
- `batchId`: 批次号（可选，系统自动生成）
- `maxUseCount`: 最大使用次数（1=一次性，-1=无限）
- `validFrom`: 生效时间（可选）
- `validTo`: 过期时间（可选）

**响应**:
```json
{
  "id": 1,
  "code": "ABCD-1234-EFGH-5678",
  "type": "mixed",
  "membershipPlanId": 2,
  "tokenAmount": 500000,
  "batchId": "BATCH-2025-001",
  "maxUseCount": 1,
  "usedCount": 0,
  "validFrom": "2025-01-26T00:00:00.000Z",
  "validTo": "2025-12-31T23:59:59.999Z",
  "isActive": true,
  "creatorId": 1,
  "remark": "春节活动卡密",
  "createdAt": "2025-01-26T10:00:00.000Z",
  "updatedAt": "2025-01-26T10:00:00.000Z"
}
```

---

### 2. 批量创建卡密

**接口**: `POST /api/v1/redemption-codes/batch`

**权限**: `redemption:code:create`

**请求体**:
```json
{
  "count": 100,
  "type": "token",
  "tokenAmount": 100000,
  "batchId": "BATCH-2025-002",
  "maxUseCount": 1,
  "validTo": "2025-06-30T23:59:59.999Z",
  "remark": "新用户注册赠送"
}
```

**响应**: 卡密数组（100个）

---

### 3. 查询批次卡密

**接口**: `GET /api/v1/redemption-codes/batch/:batchId`

**权限**: `redemption:code:view`

**查询参数**:
- `page` (number, 可选, 默认: 1)
- `limit` (number, 可选, 默认: 50)

**响应**: 分页列表格式

---

### 4. 查询卡密使用记录

**接口**: `GET /api/v1/redemption-codes/:id/records`

**权限**: `redemption:code:view`

**查询参数**:
- `page` (number, 可选, 默认: 1)
- `limit` (number, 可选, 默认: 20)

**响应**:
```json
{
  "data": [
    {
      "id": 1,
      "codeId": 1,
      "codeStr": "ABCD-1234-EFGH-5678",
      "userId": 10,
      "membershipId": 5,
      "tokenAmount": 500000,
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "createdAt": "2025-01-26T10:30:00.000Z",
      "user": {
        "id": 10,
        "username": "user01",
        "nickname": "小明"
      }
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 20,
  "totalPages": 1
}
```

---

### 5. 停用卡密

**接口**: `POST /api/v1/redemption-codes/:id/deactivate`

**权限**: `redemption:code:update`

---

## 用户兑换

### 6. 兑换卡密

**接口**: `POST /api/v1/redemption-codes/redeem`

**认证**: 必需

**请求体**:
```json
{
  "code": "ABCD-1234-EFGH-5678"
}
```

**响应**:
```json
{
  "membershipId": 5,
  "tokenAmount": 500000,
  "message": "获得会员：专业版，获得字数：500,000"
}
```

**说明**:
- 自动完成会员激活和字数充值
- 记录使用IP和User-Agent
- 更新卡密使用次数

---

## 卡密格式

**格式**: `XXXX-XXXX-XXXX-XXXX`（16位，4段）

**字符集**: 大写字母 + 数字（去除易混淆字符：0O1I）

**示例**:
- `ABCD-1234-EFGH-5678`
- `P9K3-LMN7-QRS4-TUV8`

---

## 卡密类型说明

| 类型 | 说明 | 必需字段 |
|------|------|----------|
| `membership` | 仅激活会员 | `membershipPlanId` |
| `token` | 仅充值字数 | `tokenAmount` |
| `mixed` | 会员 + 字数 | `membershipPlanId` + `tokenAmount` |

---

## 使用限制

1. **一次性卡密** (`maxUseCount = 1`):
   - 用户只能使用一次
   - 使用后立即失效

2. **多次使用卡密** (`maxUseCount > 1`):
   - 可被多个用户使用
   - 达到次数限制后失效

3. **无限使用卡密** (`maxUseCount = -1`):
   - 永久有效（除非手动停用）
   - 适用于活动推广码

---

## 错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 卡密不存在 / 卡密已停用 / 卡密尚未生效 / 卡密已过期 / 已达到最大使用次数 / 该卡密您已使用过 / 会员卡密必须指定会员套餐 / 字数卡密必须指定字数数量 |

---

**更新时间**: 2025-01-26  
**版本**: v1.0
