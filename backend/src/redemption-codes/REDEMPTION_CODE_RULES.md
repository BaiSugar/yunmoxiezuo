# 兑换码系统规则详解

## 一、卡密类型

### 1. 会员卡密 (MEMBERSHIP)

- **用途**: 仅兑换会员权益
- **字段**: `membershipPlanId`（必须）
- **示例**: 购买1个月VIP会员

### 2. 字数卡密 (TOKEN)

- **用途**: 仅兑换字数余额
- **字段**: `tokenAmount`（必须 > 0）
- **示例**: 兑换10000字

### 3. 混合卡密 (MIXED)

- **用途**: 同时兑换会员和字数
- **字段**: `membershipPlanId` + `tokenAmount`
- **示例**: 购买月卡并赠送5000字

---

## 二、使用次数规则

### 使用次数配置 (`maxUseCount`)

#### 1. 一次性卡密 (maxUseCount = 1)

- **默认值**: `1`
- **规则**: 只能被1个用户使用
- **典型场景**: 新用户注册礼包、活动单次奖励
- **示例**:
  - 创建: `maxUseCount = 1`
  - 用户A兑换成功 → 使用次数耗尽
  - 用户B尝试兑换 → 失败（达到最大使用次数）

#### 2. N次卡密 (maxUseCount = N)

- **规则**: 可以被N个不同用户使用
- **典型场景**: 限量推广活动、内测奖励
- **示例**:
  - 创建: `maxUseCount = 100`
  - 用户A、B、C...99、100都可以成功兑换
  - 第101个用户尝试兑换 → 失败（达到最大使用次数）

#### 3. 无限使用卡密 (maxUseCount = -1)

- **特殊值**: `-1`
- **规则**: 不限制总使用次数
- **典型场景**: 长期推广码、通用折扣码
- **示例**:
  - 创建: `maxUseCount = -1`
  - 理论上可以被无限个用户使用
  - **但是**: 仍然受"每账号限用一次"规则约束

---

## 三、每账号限用一次规则 ⚠️

### 核心规则

**无论 `maxUseCount` 是多少，每个用户账号都只能使用一次该卡密。**

### 判断逻辑

```typescript
// 在所有卡密类型中都执行此检查
const existingRecord = await manager.findOne(RedemptionRecord, {
  where: { codeId: redemptionCode.id, userId },
});

if (existingRecord) {
  throw new BadRequestException('该卡密您已使用过，每个账号仅限使用一次');
}
```

### 场景说明

#### 场景1: 一次性卡密

- 用户A兑换 → ✅ 成功
- 用户B兑换 → ✅ 成功（达到 maxUseCount，卡密失效）
- 用户A再次兑换同一卡密 → ❌ 失败（该卡密您已使用过）

#### 场景2: 100次卡密

- 用户A兑换 → ✅ 成功
- 用户B兑换 → ✅ 成功
- ...（最多100个不同用户）
- 用户A再次兑换同一卡密 → ❌ 失败（该卡密您已使用过）

#### 场景3: 无限使用卡密

- 用户A兑换 → ✅ 成功
- 用户B兑换 → ✅ 成功
- 用户C兑换 → ✅ 成功
- ...（无限用户）
- 用户A再次兑换同一卡密 → ❌ 失败（该卡密您已使用过）

### 为什么有这个规则？

1. **防刷机制**: 防止单个用户重复刷奖励
2. **公平性**: 确保每个用户只能获得一次奖励
3. **数据一致性**: 避免重复兑换导致的数据异常

---

## 四、有效期规则

### 生效时间 (`validFrom`)

- **类型**: Date | NULL
- **NULL**: 立即生效（默认）
- **有值**: 必须在此时间之后才能使用
- **错误**: "卡密尚未生效"

### 过期时间 (`validTo`)

- **类型**: Date | NULL
- **NULL**: 永久有效（默认）
- **有值**: 超过此时间后失效
- **错误**: "卡密已过期"

### 时间判断

```typescript
const now = new Date();

if (code.validFrom && code.validFrom > now) {
  throw new BadRequestException('卡密尚未生效');
}

if (code.validTo && code.validTo < now) {
  throw new BadRequestException('卡密已过期');
}
```

---

## 五、状态规则

### 启用状态 (`isActive`)

- **true**: 卡密可用（默认）
- **false**: 卡密已停用
- **错误**: "卡密已停用"
- **用途**: 紧急禁用某个卡密或批次

---

## 六、完整验证流程

### 兑换时的验证顺序

1. **基础验证**

   ```
   卡密是否存在？
   ↓ 否
   抛出: "卡密不存在"

   ↓ 是
   继续
   ```

2. **状态验证**

   ```
   卡密是否启用？(isActive = true)
   ↓ 否
   抛出: "卡密已停用"

   ↓ 是
   继续
   ```

3. **有效期验证**

   ```
   当前时间 >= 生效时间？(validFrom)
   ↓ 否
   抛出: "卡密尚未生效"

   ↓ 是
   继续

   当前时间 <= 过期时间？(validTo)
   ↓ 否
   抛出: "卡密已过期"

   ↓ 是
   继续
   ```

4. **每账号限用检查** ⚠️

   ```
   用户是否已使用过此卡密？
   ↓ 是
   抛出: "该卡密您已使用过，每个账号仅限使用一次"

   ↓ 否
   继续
   ```

5. **总次数限制检查**

   ```
   maxUseCount === -1（无限）？
   ↓ 是
   跳过检查，继续

   ↓ 否
   已使用次数 < 最大使用次数？(usedCount < maxUseCount)
   ↓ 否
   抛出: "卡密已达到最大使用次数"

   ↓ 是
   继续
   ```

6. **执行兑换**
   ```
   ├─ 兑换会员（如果是 membership 或 mixed 类型）
   ├─ 充值字数（如果是 token 或 mixed 类型）
   ├─ 更新卡密使用次数: usedCount += 1
   └─ 创建兑换记录
   ```

---

## 七、使用场景示例

### 场景1: 新用户注册礼包（一次性）

```json
{
  "type": "MIXED",
  "membershipPlanId": 1, // 7天VIP
  "tokenAmount": 10000, // 赠送1万字
  "maxUseCount": 1, // 只用1次
  "validFrom": null, // 立即生效
  "validTo": null, // 永久有效
  "isActive": true
}
```

**结果**: 只有第一个兑换的用户能成功，之后任何用户都无法使用。

### 场景2: 限量推广活动（100次）

```json
{
  "type": "TOKEN",
  "tokenAmount": 50000, // 5万字
  "maxUseCount": 100, // 100个用户可用
  "validFrom": "2025-11-01",
  "validTo": "2025-11-30", // 11月有效
  "isActive": true
}
```

**结果**:

- 前100个不同用户兑换成功
- 第101个用户失败（达到最大次数）
- 每个用户只能兑换一次

awan

### 场景3: 长期推广码（无限使用）

```json
{
  "type": "MEMBERSHIP",
  "membershipPlanId": 2, // 永久会员
  "maxUseCount": -1, // 无限使用
  "validFrom": null, // 立即生效
  "validTo": null, // 永久有效
  "isActive": true
}
```

**结果**:

- 任意多个用户都可以使用
- 但每个用户仍然只能使用一次

### 场景4: 限时折扣码

```json
{
  "type": "MIXED",
  "membershipPlanId": 1, // 月卡
  "tokenAmount": 20000, // 2万字
  "maxUseCount": -1, // 无限使用
  "validFrom": "2025-12-01",
  "validTo": "2025-12-07", // 限时7天
  "isActive": true
}
```

**结果**:

- 12月1日-7日期间，所有用户都可使用
- 每个用户限用一次
- 12月7日后失效

---

## 八、数据库记录

### RedemptionRecord 表

每次成功兑换都会创建一条记录：

```typescript
{
  codeId: 123,           // 卡密ID
  codeStr: "ABCD1234",   // 卡密码
  userId: 456,           // 用户ID
  membershipId: 789,     // 兑换的会员ID（如果有）
  tokenAmount: 10000,    // 兑换的字数（如果有）
  ipAddress: "1.1.1.1",  // IP地址
  userAgent: "...",      // 用户代理
  createdAt: "2025-10-27T..."
}
```

**用途**:

- 记录每次兑换行为
- 用于"每账号限用一次"的判断
- 用于数据分析和审计

---

## 九、常见问题

### Q1: 无限使用卡密用户可以重复使用吗？

**A**: 不可以。每个账号只能使用一次。"无限使用"指的是不限制总用户数，不是允许单个用户重复使用。

### Q2: 如何让同一用户可以多次使用同一个优惠？

**A**: 创建不同的卡密（不同的 `code` 值），每个卡密用户可以使用一次。

### Q3: maxUseCount = 1 和 maxUseCount = -1 有什么区别？

**A**:

- `1`: 只能1个用户使用，之后卡密失效
- `-1`: 无限个用户可以使用，但每个用户只能使用一次

### Q4: 如何限制某个卡密只能给特定用户使用？

**A**: 系统暂不支持"白名单"功能。如果需要，可以在兑换时增加业务逻辑判断。

### Q5: 如何紧急禁用某个卡密？

**A**: 设置 `isActive = false`，所有对该卡密的兑换请求都会失败。

### Q6: 批量创建的卡密如何管理？

lotsA\*\*: 使用 `batchId` 字段标识同一批次。可以批量禁用某个批次的所有卡密。

---

## 十、最佳实践

### 1. 命名规范

- 使用有意义的批次号: `batchId = "NEW_USER_2025_Q4"`
- 使用有意义的备注: `remark = "双十一活动，限量100份"`

### 2. 安全性

- 定期检查 `usedCount` 异常卡密
- 对于重要活动，建议设置 `maxUseCount` 限制总使用量
- 及时停用泄露的卡密 (`isActive = false`)

### 3. 监控指标

- 成功率: 成功兑换数 / 尝试兑换数
- 使用率: `usedCount / maxUseCount`（对非无限卡密）
- 异常IP: 同一IP多次尝试失败

### 4. 到期提醒

- 对于设置了 `validTo` 的卡密，提前通知用户
- 定期清理过期卡密（可选）

---

## 十一、API 接口

### 用户兑换

```
POST /api/redemption-codes/redeem
Body: { code: "ABCD1234" }
Response: {
  membershipId: 123,
  tokenAmount: 10000,
  message: "获得会员：月卡会员，获得字数：10,000"
}
```

### 查看兑换记录

```
GET /api/redemption-codes/records
```

---

## 总结

| 规则               | 说明                 |
| ------------------ | -------------------- |
| **每账号限用一次** | 所有卡密都强制遵守   |
| **使用次数限制**   | 仅对非无限卡密有效   |
| **有效期控制**     | 生效时间/过期时间    |
| **状态控制**       | isActive 开关        |
| **记录追踪**       | 所有兑换行为都有记录 |

关键点：**"无限使用"不等于"可重复使用"**，每个账号在任何情况下都只能使用一次同一卡密。
