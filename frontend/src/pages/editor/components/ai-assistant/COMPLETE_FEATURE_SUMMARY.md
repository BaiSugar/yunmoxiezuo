# ChatTab 完整功能总结

## 🎉 所有功能已完成

### 1. 📤 完整的消息发送机制

#### 数据结构

```typescript
onSendMessage(
  message: string,        // 用户输入
  mentions: string[],     // 保留参数（暂未使用）
  files: File[],         // 上传的文件
  config: {
    // 提示词相关
    promptId?: number;                    // 选中的提示词ID
    parameters?: Record<string, string>;  // 提示词参数

    // 提示词配置中的人物卡和世界观（单一用途）
    characterIds?: number[];              // 人物卡ID数组
    worldSettingIds?: number[];           // 世界观ID数组

    // @ 关联的内容（作为上下文）
    mentionedCharacterIds: number[];      // @ 关联的人物卡
    mentionedWorldSettingIds: number[];   // @ 关联的世界观
    mentionedMemoIds: number[];           // @ 关联的备忘录

    // 模型配置
    modelId?: number;                     // AI模型ID
    temperature: number;                  // 温度参数

    // 特殊标记
    useInputAsSystemPrompt: boolean;      // 是否将用户输入作为system提示词
  }
)
```

#### 两种使用模式

**模式 1：使用提示词**

```json
{
  "message": "请续写第一章",
  "config": {
    "promptId": 123,
    "parameters": {
      "主角名字": "张三",
      "故事背景": "现代都市"
    },
    "characterIds": [1, 3],
    "worldSettingIds": [2],
    "mentionedCharacterIds": [5, 6],
    "mentionedWorldSettingIds": [4],
    "mentionedMemoIds": [10],
    "modelId": 10,
    "temperature": 0.7,
    "useInputAsSystemPrompt": false
  }
}
```

**模式 2：不使用提示词（用户输入作为 system 提示）**

```json
{
  "message": "你是一个专业的小说作家，帮我续写第一章",
  "config": {
    "mentionedCharacterIds": [1, 2],
    "mentionedWorldSettingIds": [3],
    "mentionedMemoIds": [5],
    "modelId": 10,
    "temperature": 0.7,
    "useInputAsSystemPrompt": true  ← 关键标记
  }
}
```

### 2. 🏷️ @ 关联标签系统

#### 功能入口（两种方式）

**方式 1：在输入框输入 @**

```
┌─────────────────────────────┐
│ @                    [发送] │ ← 输入@自动弹出菜单
│                             │
│ [@] [📎]                    │
└─────────────────────────────┘
```

**方式 2：点击 @ 按钮**

```
┌─────────────────────────────┐
│                      [发送] │
│                             │
│ [@ ▼] [📎]                  │ ← 悬停显示菜单
└─────────────────────────────┘
```

#### @ 菜单浮窗

```
╔══════════════════╗
║ 选择关联类型     ║
╟──────────────────╢
║ 📦 👤 人物卡    ║ ← 蓝色悬停
║ 📦 🌍 世界观    ║ ← 靛蓝悬停
║ 📦 📝 备忘录    ║ ← 紫色悬停
╚══════════════════╝
```

**特点**：

- ✨ 输入 `@` 自动触发
- ✨ 浮窗定位在光标附近
- ✨ 点击外部自动关闭
- ✨ 选择后自动移除 `@` 符号
- ✨ 图标盒子设计

#### 标签显示

```
[@人物卡(张三)] [@人物卡(李四)] [@世界观(现代都市)] [@备忘录(大纲)]
┌─────────────────────────────────────────────────────┐
│ [输入框...]                                   [发送] │
└─────────────────────────────────────────────────────┘
```

**标签特点**：

- 🔵 人物卡：蓝色背景 `bg-blue-100 text-blue-700`
- 🟣 世界观：靛蓝背景 `bg-indigo-100 text-indigo-700`
- 🟣 备忘录：紫色背景 `bg-purple-100 text-purple-700`
- ✖️ 可点击删除（X 按钮）
- 📱 自动换行（flex-wrap）

### 3. 🎨 输入框 UI 全面升级

#### 外观

```
┌─────────────────────────────────────┐
│                            [发送🚀] │ ← 渐变背景
│                                     │   圆角xl
│                                     │   阴影
│ [@关联] [📎文件]                    │ ← 内嵌按钮
└─────────────────────────────────────┘
```

**特点**：

- 渐变背景：`from-white to-gray-50/30`
- 2px 边框：`border-2`
- 聚焦时：蓝色边框 + 光晕 + 阴影加深
- 底部留空间：`pb-12` 给按钮腾位置

#### 功能按钮（左下角）

- **@ 关联**：
  - 悬停显示下拉菜单
  - 蓝色主题
  - 手机端只显示 `@`
- **📎 文件**：
  - 蓝色主题
  - 手机端只显示 `📎`

#### 发送按钮（右下角）

- **渐变**：蓝 → 靛蓝
- **悬停**：放大 105% + 阴影加强
- **点击**：缩小 95%
- **禁用**：灰色渐变

### 4. 💫 对话图标脉动动画

```css
/* 4层动画 */
外层ping:  2秒持续扩散 (bg-blue-400/20)
外层pulse: 默认呼吸   (bg-blue-300/10)
中层:      3秒呼吸    (from-blue-100 to-indigo-100)
核心:      默认呼吸   (from-blue-400 to-indigo-500)
```

**效果**：

```
    ～～～～～～～～～～  ← ping扩散
  ╔═════════════════╗
  ║  ～～～～～～～  ║   ← pulse呼吸
  ║  ╔═══════════╗  ║
  ║  ║  ～～～～  ║  ║   ← 中层呼吸
  ║  ║  ╔═════╗  ║  ║
  ║  ║  ║ 💬  ║  ║  ║   ← 核心渐变+pulse
  ║  ║  ╚═════╝  ║  ║
  ║  ╚═══════════╝  ║
  ╚═════════════════╝
```

### 5. 🎯 @ 关联模态窗（3 个）

#### 人物卡模态窗

```
╔═══════════════════════════════════════╗
║ 👤 关联人物卡              ✕         ║ ← 蓝→靛蓝渐变
║    共5个 · 已选2个                    ║
╟───────────────────────────────────────╢
║ ┃ 主角 (2)                             ║ ← 分类（粘性）
║ ☑ 张三                                 ║
║ ☐ 李四                                 ║
║ ┃ 配角 (3)                             ║
║ ☑ 王五                                 ║
║ ☐ 赵六                                 ║
║ ☐ 钱七                                 ║
╟───────────────────────────────────────╢
║ [完成（已关联 2 个）]                  ║
╚═══════════════════════════════════════╝
```

#### 世界观模态窗

- 靛蓝 → 紫色渐变主题
- 其他设计一致

#### 备忘录模态窗

- 紫色 → 粉色渐变主题
- 显示备忘录标题和内容预览

**共同特点**：

- ✅ 按分类分组显示
- ✅ 分类标签粘性定位
- ✅ Checkbox 多选
- ✅ 实时显示已选数量
- ✅ 手机端全屏，PC 端固定宽度

### 6. 🎨 配置窗口优化

#### 外观

```
╔═══════════════════════════════════════╗
║ 🔷 ✨提示词配置         [清除]        ║ ← 三色渐变
║    小说开篇生成                        ║
╟───────────────────────────────────────╢
║ ┃ 参数设置                             ║
║   主角名字 * · 请输入主角姓名            ║
║   [多行输入框]                          ║
║   [...更多行]                           ║
╟───────────────────────────────────────╢
║ ┃ 👤 人物卡                           ║
║   [📦 已选择 2 个              →]      ║
║      张三、李四                         ║
╟───────────────────────────────────────╢
║ ┃ 🌍 世界观                           ║
║   [📦 已选择 1 个              →]      ║
║      现代都市                           ║
╚═══════════════════════════════════════╝
```

### 7. 📊 完整数据流

```
用户操作流程：
  ├─ 选择提示词（可选）
  │   └─ 自动加载详情 + 记录使用
  │
  ├─ 填写参数（如有）
  │   └─ 多行输入
  │
  ├─ 选择人物卡/世界观（如需要）
  │   └─ 从配置按钮选择
  │
  ├─ @ 关联内容（可选）
  │   ├─ 点击 @ 按钮
  │   ├─ 选择类型（人物卡/世界观/备忘录）
  │   └─ 多选相关内容
  │
  ├─ 输入消息
  │   └─ 在输入框中输入
  │
  └─ 点击发送
      └─ 所有数据打包发送到后端

后端接收：
  ├─ 如果有 promptId
  │   ├─ 加载提示词内容
  │   ├─ 替换参数占位符
  │   ├─ 加载配置的人物卡/世界观
  │   └─ 加载 @ 关联的内容（作为上下文）
  │
  └─ 如果没有 promptId (useInputAsSystemPrompt = true)
      ├─ 将用户输入作为 system 提示词
      └─ 加载 @ 关联的内容（作为上下文）
```

## 🎨 视觉设计系统

### 色彩规范

| 功能       | 主色 | 渐变           | 用途         |
| ---------- | ---- | -------------- | ------------ |
| 提示词配置 | 蓝色 | 蓝 → 靛蓝 → 紫 | 容器背景     |
| @ 人物卡   | 蓝色 | 蓝 → 靛蓝      | 标签、模态窗 |
| @ 世界观   | 靛蓝 | 靛蓝 → 紫      | 标签、模态窗 |
| @ 备忘录   | 紫色 | 紫 → 粉        | 标签、模态窗 |
| 输入框     | 蓝色 | 白 → 灰        | 背景渐变     |
| 发送按钮   | 蓝色 | 蓝 → 靛蓝      | 按钮背景     |

### 动画规范

| 元素         | 动画类型   | 时长  | 效果               |
| ------------ | ---------- | ----- | ------------------ |
| 对话图标外层 | ping       | 2s    | 持续扩散           |
| 对话图标中层 | pulse      | 3s    | 慢呼吸             |
| 对话图标核心 | pulse      | 默认  | 呼吸               |
| 发送按钮     | scale      | 即时  | 悬停放大、点击缩小 |
| 所有按钮     | transition | 默认  | 颜色、阴影过渡     |
| 模态窗       | fade-in    | 200ms | 淡入动画           |

## 📱 响应式设计

### 手机端（<640px）

- 模态窗全屏
- 按钮只显示图标
- @ 标签自动换行
- 输入框功能按钮紧凑

### PC 端（≥640px）

- 模态窗固定宽度 512px
- 按钮显示完整文字
- 更大的间距和触摸区域

## 🔄 数据持久化

### localStorage 存储

| Key                               | 数据           | 清除时机 |
| --------------------------------- | -------------- | -------- |
| `chatTab_selectedPrompt`          | 提示词完整数据 | 关闭页面 |
| `chatTab_promptParameters`        | 参数值         | 关闭页面 |
| `chatTab_selectedCharacterIds`    | 人物卡 ID 数组 | 关闭页面 |
| `chatTab_selectedWorldSettingIds` | 世界观 ID 数组 | 关闭页面 |
| `chatTab_selectedModel`           | 模型 ID        | 关闭页面 |
| `chatTab_temperature`             | 温度           | 关闭页面 |

**注意**：@ 关联的内容不持久化，每次发送后清空

## 🎯 使用场景示例

### 场景 1：使用提示词 + 配置 + @ 关联

```
1. 选择提示词："小说续写"
2. 填写参数：主角名字="张三"
3. 配置：选择人物卡[主角、配角]
4. @ 关联：@人物卡(反派) @备忘录(大纲)
5. 输入："续写第一章，增加冲突"
6. 发送
```

**后端接收**：

- 提示词内容 + 参数替换
- 配置的人物卡信息
- @ 关联的反派信息和大纲
- 用户输入作为 user 消息

### 场景 2：不用提示词，直接对话

```
1. 不选提示词
2. @ 关联：@人物卡(主角) @世界观(现代都市)
3. 输入："你是一个专业作家，帮我分析这个人物性格"
4. 发送
```

**后端接收**：

- 用户输入作为 system 提示词
- @ 关联的人物卡和世界观作为上下文

## 🛠️ 技术实现细节

### @ 关联实现

1. 点击 `@` 按钮显示下拉菜单
2. 选择类型后打开对应模态窗
3. 多选后点击完成
4. 在输入框上方显示彩色标签
5. 发送时将 ID 数组传递给后端

### 提示词配置实现

1. 选择提示词后调用详情 API
2. 分析 contents 提取配置需求
3. 动态显示参数/人物卡/世界观选择器
4. 用户填写/选择
5. 发送时一起打包

### 模态窗分类实现

```typescript
const grouped = items.reduce((acc, item) => {
  const category = item.category || "未分类";
  if (!acc[category]) acc[category] = [];
  acc[category].push(item);
  return acc;
}, {} as Record<string, Item[]>);
```

## 🎨 UI 亮点总结

### 1. 统一的设计语言

- 所有模态窗使用渐变头部
- 所有选择器使用 Checkbox 设计
- 所有按钮使用圆角和阴影
- 统一的配色系统

### 2. 丰富的微交互

- 悬停变色
- 缩放动画
- 阴影变化
- 图标旋转
- 脉动效果

### 3. 清晰的视觉层次

- 渐变背景区分层级
- 竖线分隔不同区块
- 阴影提升重要元素
- 色彩区分不同类型

### 4. 优秀的可访问性

- 足够大的触摸区域
- 清晰的状态反馈
- 明确的操作提示
- 键盘快捷键支持（Enter 发送）

## ✅ 完成度检查

- [x] 提示词选择和配置
- [x] 参数输入（多行）
- [x] 人物卡选择（多选、分类）
- [x] 世界观选择（多选、分类）
- [x] @ 关联系统
- [x] @ 标签显示
- [x] 输入框 UI 优化
- [x] 脉动动画
- [x] 发送数据完整传递
- [x] 数据持久化
- [x] 响应式适配
- [x] 无 linter 错误

## 🚀 后端对接要点

### 1. 处理 useInputAsSystemPrompt

```typescript
if (config.useInputAsSystemPrompt) {
  // 将 message 作为 system 提示词
  messages.push({ role: "system", content: message });
} else {
  // 使用提示词系统
  // 加载 promptId 对应的内容
}
```

### 2. 加载 @ 关联的内容

```typescript
// 加载人物卡
const characters = await loadCharacters(config.mentionedCharacterIds);

// 加载世界观
const worldSettings = await loadWorldSettings(config.mentionedWorldSettingIds);

// 加载备忘录
const memos = await loadMemos(config.mentionedMemoIds);

// 将这些作为上下文添加到消息中
```

### 3. 区分配置和关联

- **配置中的人物卡/世界观**（characterIds/worldSettingIds）：
  - 来自提示词配置要求
  - 用于替换提示词中的人物卡/世界观插槽
- **@ 关联的内容**（mentionedXxxIds）：
  - 来自用户主动 @ 关联
  - 作为额外的上下文信息

所有功能已完美实现！🎊
